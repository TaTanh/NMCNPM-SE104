<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>B√°o c√°o t·ªïng k·∫øt</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/layout/styles.css">
    <script src="/js/toast.js"></script>
    <script src="/js/auth.js"></script>
    <style>
        table { font-size: 13px !important; }
        /* Tinh ch·ªânh UI ri√™ng cho trang b√°o c√°o */
        .filters-row { gap: 10px; align-items: center; }
        .filters-row .btn { padding: 8px 14px; box-shadow: 0 8px 18px rgba(37,99,235,0.25); }
        .filters-row .btn-print { box-shadow: none; }
        .data-table th.col-name { width: 320px; }
        .data-table td.col-name { white-space: nowrap; }
    </style>
</head>

<body class="dashboard-body">

    <!-- SIDEBAR -->
    <aside class="sidebar">
        <div class="sidebar-logo">
            <img src="/assets/uit_logo.png" alt="UIT Logo">
            <span>QL H·ªçc Sinh</span>
        </div>

        <nav class="sidebar-menu">
            <a href="/pages/dashboard.html">Dashboard</a>
            <a href="/pages/students.html">Qu·∫£n l√Ω h·ªçc sinh</a>
            <a href="/pages/classes.html">Qu·∫£n l√Ω l·ªõp h·ªçc</a>
            <a href="/pages/subject_list.html">Qu·∫£n l√Ω m√¥n h·ªçc</a>
            <a href="/pages/grade_entry_select.html">Nh·∫≠p ƒëi·ªÉm</a>
            <a href="/pages/hanhkiem_entry.html">Nh·∫≠p h·∫°nh ki·ªÉm</a>
            <a href="/pages/grade_select.html">B·∫£ng ƒëi·ªÉm</a>
            <a href="/pages/student_transcript.html">Tra c·ª©u ƒëi·ªÉm HS</a>
            <a href="/pages/class_summary.html">T·ªïng k·∫øt l·ªõp</a>
            <a href="/pages/reports.html" class="active">B√°o c√°o t·ªïng k·∫øt</a>
            <a href="/pages/teaching_assignment.html" id="menuTeaching" style="display:none;">Ph√¢n c√¥ng gi·∫£ng d·∫°y</a>
            <a href="/pages/users.html" id="menuUsers" style="display:none;">Qu·∫£n l√Ω ng∆∞·ªùi d√πng</a>
        </nav>
    </aside>

    <!-- MAIN -->
    <div class="main">

        <!-- HEADER -->
        <header class="topbar">
            <div class="page-title">B√°o c√°o t·ªïng k·∫øt</div>
            <div class="user-info">
                <span id="userGreeting">Xin ch√†o, Admin</span>
                <img src="/assets/user.png" class="avatar" alt="user">
                <button class="btn btn-outline btn-sm" onclick="logout()" style="margin-left:10px;">ƒêƒÉng xu·∫•t</button>
            </div>
        </header>

        <!-- CONTENT -->
        <div class="content">

            <!-- T·ªîNG K·∫æT ƒêI·ªÇM THEO L·ªöP -->
            <h3 class="section-title">B·∫£ng t·ªïng k·∫øt ƒëi·ªÉm theo l·ªõp</h3>

            <div class="filters-row" style="gap: 10px; align-items: center;">
                <div class="filter-item">
                    <label class="filter-label" for="yearSelect">NƒÉm h·ªçc</label>
                    <select id="yearSelect">
                        <option value="">-- Ch·ªçn nƒÉm h·ªçc --</option>
                    </select>
                </div>

                <div class="filter-item">
                    <label class="filter-label" for="semesterSelect">H·ªçc k·ª≥</label>
                    <select id="semesterSelect">
                        <option value="">-- Ch·ªçn h·ªçc k·ª≥ --</option>
                        <option value="HK1">H·ªçc k·ª≥ 1</option>
                        <option value="HK2">H·ªçc k·ª≥ 2</option>
                        <option value="CN">C·∫£ nƒÉm</option>
                    </select>
                </div>

                <div class="filter-item">
                    <label class="filter-label" for="gradeSelect">Kh·ªëi</label>
                    <select id="gradeSelect">
                        <option value="">-- Ch·ªçn kh·ªëi --</option>
                    </select>
                </div>

                <div class="filter-item">
                    <label class="filter-label" for="classSelect">L·ªõp</label>
                    <select id="classSelect">
                        <option value="">-- Ch·ªçn l·ªõp --</option>
                    </select>
                </div>

                <button class="btn btn-primary" id="btnLoadReport" style="padding: 8px 20px;">Xem b·∫£ng</button>
                <button class="btn btn-print" id="btnPrintReport" style="padding: 8px 20px; display: none;">üñ®Ô∏è In</button>
            </div>

            <div class="table-wrapper" id="reportWrapper" style="display:none; overflow-x:auto;">
                <table class="data-table" id="reportTable">
                    <thead id="reportHead"></thead>
                    <tbody id="reportBody">
                        <tr><td colspan="3">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>
                    </tbody>
                </table>
            </div>

        </div><!-- content -->
    </div><!-- main -->

    <script>
        // Ki·ªÉm tra x√°c th·ª±c
        document.addEventListener('DOMContentLoaded', async () => {
            // Load filters tr∆∞·ªõc
            await loadFilters();
            
            // Sau ƒë√≥ check quy·ªÅn
            const user = getCurrentUser();
            if (!user || !user.maNguoiDung) {
                toastWarning('B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.');
                setTimeout(() => {
                    window.location.href = '/pages/login.html';
                }, 1500);
                return;
            }

            document.getElementById('userGreeting').textContent = `Xin ch√†o, ${user.hoTen || user.hotendangnhap || 'B·∫°n'}`;

            if (user.vaiTro === 'ADMIN') {
                document.getElementById('menuTeaching').style.display = 'block';
                document.getElementById('menuUsers').style.display = 'block';
            }
        });

        // ========== LOAD FILTERS ==========
        async function loadFilters() {
            try {
                // Load nƒÉm h·ªçc
                const yearRes = await fetch('/api/settings/school-years');
                const years = await yearRes.json();
                const yearSelect = document.getElementById('yearSelect');
                years.forEach(y => {
                    yearSelect.innerHTML += `<option value="${y.manamhoc}">${y.tennamhoc}</option>`;
                });

                // Load kh·ªëi
                const gradeRes = await fetch('/api/settings/grade-levels');
                const grades = await gradeRes.json();
                const gradeSelect = document.getElementById('gradeSelect');
                grades.forEach(g => {
                    gradeSelect.innerHTML += `<option value="${g.makhoilop}">${g.tenkhoilop}</option>`;
                });

                // Load l·ªõp khi ch·ªçn kh·ªëi
                gradeSelect.addEventListener('change', async () => {
                    const khoi = gradeSelect.value;
                    const classSelect = document.getElementById('classSelect');
                    classSelect.innerHTML = '<option value="">-- Ch·ªçn l·ªõp --</option>';
                    if (!khoi) return;
                    
                    try {
                        const res = await fetch(`/api/classes?khoi=${khoi}`);
                        const classList = await res.json();
                        console.log('Class list response:', classList);
                        classList.forEach(cls => {
                            console.log('Class object:', cls);
                            const maLop = cls.malop || cls.MaLop || cls.maLop;
                            const tenLop = cls.tenlop || cls.TenLop || cls.tenLop;
                            console.log('Using maLop:', maLop, 'tenLop:', tenLop);
                            classSelect.innerHTML += `<option value="${maLop}">${tenLop}</option>`;
                        });
                    } catch (error) {
                        console.error('L·ªói load l·ªõp:', error);
                    }
                });
            } catch (error) {
                console.error('L·ªói load filters:', error);
                toastError('L·ªói t·∫£i b·ªô l·ªçc');
            }
        }

        // ========== LOAD REPORT ==========
        document.getElementById('btnLoadReport').addEventListener('click', async () => {
            const year = document.getElementById('yearSelect').value;
            const semester = document.getElementById('semesterSelect').value;
            const grade = document.getElementById('gradeSelect').value;
            const cls = document.getElementById('classSelect').value;

            console.log('Button clicked - Values:', { year, semester, grade, cls });
            console.log('classSelect element:', document.getElementById('classSelect'));
            console.log('classSelect options:', document.getElementById('classSelect').options);

            if (!year || !semester || !grade || !cls) {
                toastWarning('Vui l√≤ng ch·ªçn ƒë·∫ßy ƒë·ªß: nƒÉm h·ªçc, h·ªçc k·ª≥, kh·ªëi v√† l·ªõp');
                return;
            }

            try {
                const url = `/api/reports/class-final?maLop=${cls}&namhoc=${year}`;
                console.log('Fetching URL:', url);
                const res = await fetch(url);
                const json = await res.json();
                console.log('Response:', json);
                const rows = json.data || [];
                
                if (rows.length === 0) {
                    toastInfo('Ch∆∞a c√≥ d·ªØ li·ªáu');
                    return;
                }

                // Define subject priority order (match with actual database names)
                const subjectPriority = {
                    'To√°n': 1,
                    'V·∫≠t L√Ω': 2,
                    'H√≥a H·ªçc': 3,
                    'Sinh H·ªçc': 4,
                    'Ng·ªØ VƒÉn': 5,
                    'L·ªãch S·ª≠': 6,
                    'ƒê·ªãa L√Ω': 7,
                    'Ti·∫øng Anh': 8,
                    'Gi√°o D·ª•c C√¥ng D√¢n': 9
                };
                
                // Get all unique subjects from data
                const allSubjects = Array.from(new Set(rows.map(r => r.tenmonhoc)));
                
                // Sort subjects according to priority, unknown subjects go to end
                const subjects = allSubjects.sort((a, b) => {
                    const priorityA = subjectPriority[a] ?? 999;
                    const priorityB = subjectPriority[b] ?? 999;
                    return priorityA - priorityB;
                });

                // Map semester choice to column (HK1=hk1, HK2=hk2, CN=cn)
                const semesterMap = { 'HK1': 'hk1', 'HK2': 'hk2', 'CN': 'cn' };
                const semesterKey = semesterMap[semester];
                const semesterLabel = semester === 'CN' ? 'C·∫£ nƒÉm' : semester;

                // Build header (single row)
                const head = document.getElementById('reportHead');
                const headRow = document.createElement('tr');
                headRow.innerHTML = `
                    <th style="width: 50px;">STT</th>
                    <th style="width: 80px;">M√£ HS</th>
                    <th style="width: 280px; white-space: nowrap;">H·ªç t√™n</th>
                `;
                subjects.forEach(sub => {
                    const label = (sub === 'Gi√°o D·ª•c C√¥ng D√¢n') ? 'GDCD' : sub;
                    headRow.innerHTML += `<th style="width: 70px;">${label}</th>`;
                });
                headRow.innerHTML += `
                    <th style="width: 100px;">ƒêi·ªÉm TK</th>
                    <th style="width: 110px;">H·ªçc l·ª±c</th>
                    <th style="width: 80px;">H·∫°nh ki·ªÉm</th>
                    <th style="width: 140px;">Danh hi·ªáu</th>
                    <th style="width: 80px;">X·∫øp h·∫°ng</th>
                `;

                head.innerHTML = '';
                head.appendChild(headRow);

                // Group by student
                const byStudent = new Map();
                rows.forEach(r => {
                    const key = r.mahocsinh;
                    if (!byStudent.has(key)) {
                        byStudent.set(key, { 
                            mahocsinh: r.mahocsinh, 
                            hoten: r.hoten, 
                            grades: {},
                            hanhkiemhk1: r.hanhkiemhk1,
                            hanhkiemhk2: r.hanhkiemhk2,
                            hanhkiemcn: r.hanhkiemcn
                        });
                    }
                    byStudent.get(key).grades[r.tenmonhoc] = {
                        hk1: r.diemtbhk1,
                        hk2: r.diemtbhk2,
                        cn: r.diemtbnam
                    };
                });

                // Render body - first collect all data with danh hi·ªáu
                const body = document.getElementById('reportBody');
                let index = 0;
                const studentsData = Array.from(byStudent.values()).map(st => {
                    index += 1;
                    
                    // Build subject score cells
                    const subjectCells = subjects.map(sub => {
                        const score = st.grades[sub]?.[semesterKey];
                        let displayScore = '-';
                        
                        if (score !== null && score !== undefined) {
                            const numScore = Number(score);
                            if (!isNaN(numScore)) {
                                displayScore = numScore.toFixed(2);
                            }
                        }
                        return `<td style="text-align: center;">${displayScore}</td>`;
                    }).join('');

                    // Get all valid scores for this semester, calculate average
                    const scoresList = [];
                    subjects.forEach(sub => {
                        const score = st.grades[sub]?.[semesterKey];
                        if (score !== null && score !== undefined) {
                            const numScore = Number(score);
                            if (!isNaN(numScore)) {
                                scoresList.push(numScore);
                            }
                        }
                    });
                    
                    // Calculate average (t·ªïng k·∫øt)
                    const avgNum = scoresList.length > 0 
                        ? (scoresList.reduce((a, b) => a + b, 0) / scoresList.length)
                        : null;
                    const avgScore = (avgNum !== null) ? avgNum.toFixed(2) : '-';

                    // H·ªçc l·ª±c theo TT58 (gi·∫£ ƒë·ªãnh c√°c m√¥n nh·∫≠n x√©t ƒë·ªÅu ƒê·∫°t)
                    const getHocLuc = () => {
                        if (avgNum === null) return '-';
                        const hasToan = subjects.includes('To√°n');
                        const hasVan = subjects.includes('Ng·ªØ VƒÉn');
                        const toan = hasToan ? st.grades['To√°n']?.[semesterKey] : undefined;
                        const van  = hasVan  ? st.grades['Ng·ªØ VƒÉn']?.[semesterKey] : undefined;
                        const minScore = scoresList.reduce((m, v) => Math.min(m, v), 10);
                        const anyBelow = (thr) => scoresList.some(v => v < thr);
                        const anyGE = (score, thr) => (score !== undefined && !isNaN(score) && score >= thr);

                        // Gi·ªèi
                        if (avgNum >= 8.0 && (anyGE(toan,8.0) || anyGE(van,8.0)) && !anyBelow(6.5)) return 'Gi·ªèi';
                        // Kh√°
                        if (avgNum >= 6.5 && (anyGE(toan,6.5) || anyGE(van,6.5)) && !anyBelow(5.0)) return 'Kh√°';
                        // Trung b√¨nh
                        if (avgNum >= 5.0 && (anyGE(toan,5.0) || anyGE(van,5.0)) && !anyBelow(3.5)) return 'Trung b√¨nh';
                        // Y·∫øu
                        if (avgNum >= 3.5 && !anyBelow(2.0)) return 'Y·∫øu';
                        // K√©m
                        return 'K√©m';
                    };
                    const hocLuc = getHocLuc();

                    // Get h·∫°nh ki·ªÉm theo semester
                    const hanhKiem = semester === 'HK1' ? st.hanhkiemhk1 
                                   : semester === 'HK2' ? st.hanhkiemhk2
                                   : st.hanhkiemcn;

                    // X√©t danh hi·ªáu theo TT58
                    const getDanhHieu = () => {
                        if (!hanhKiem || hocLuc === '-') return '-';
                        if (hocLuc === 'Gi·ªèi' && hanhKiem === 'T·ªët') return 'H·ªçc sinh gi·ªèi';
                        if (hocLuc === 'Kh√°' && hanhKiem === 'T·ªët') return 'H·ªçc sinh ti·∫øn ti·∫øn';
                        return '-';
                    };
                    const danhHieu = getDanhHieu();

                    return {
                        mahocsinh: st.mahocsinh,
                        hoten: st.hoten,
                        subjectCells,
                        avgNum,
                        avgScore,
                        hocLuc,
                        hanhKiem,
                        danhHieu,
                        index: index
                    };
                });

                // Calculate ranking without sorting the original list
                const hanhKiemOrder = { 'T·ªët': 4, 'Kh√°': 3, 'Trung b√¨nh': 2, 'Y·∫øu': 1 };
                const danhHieuOrder = { 'H·ªçc sinh gi·ªèi': 3, 'H·ªçc sinh ti·∫øn ti·∫øn': 2 };
                
                // Create a sorted copy for ranking calculation
                const sortedForRank = [...studentsData].sort((a, b) => {
                    const aHasHK = !!a.hanhKiem;
                    const bHasHK = !!b.hanhKiem;
                    
                    if (aHasHK && !bHasHK) return -1;
                    if (!aHasHK && bHasHK) return 1;
                    if (!aHasHK && !bHasHK) return 0;
                    
                    const aDH = danhHieuOrder[a.danhHieu] || 0;
                    const bDH = danhHieuOrder[b.danhHieu] || 0;
                    if (aDH !== bDH) return bDH - aDH;
                    
                    const aHK = hanhKiemOrder[a.hanhKiem] || 0;
                    const bHK = hanhKiemOrder[b.hanhKiem] || 0;
                    if (aHK !== bHK) return bHK - aHK;
                    
                    if (a.avgNum !== null && b.avgNum !== null) {
                        return b.avgNum - a.avgNum;
                    }
                    return 0;
                });
                
                // Assign ranks with tie handling (1, 2, 2, 4 - skip 3)
                const rankMap = new Map();
                let currentRank = 1;
                sortedForRank.forEach((st, idx) => {
                    if (!st.hanhKiem) {
                        rankMap.set(st.mahocsinh, '-');
                        return;
                    }
                    
                    // Check if tied with previous
                    if (idx > 0 && st.hanhKiem) {
                        const prev = sortedForRank[idx - 1];
                        const prevDH = danhHieuOrder[prev.danhHieu] || 0;
                        const currDH = danhHieuOrder[st.danhHieu] || 0;
                        const prevHK = hanhKiemOrder[prev.hanhKiem] || 0;
                        const currHK = hanhKiemOrder[st.hanhKiem] || 0;
                        
                        const isTied = prevDH === currDH && 
                                      prevHK === currHK && 
                                      prev.avgNum === st.avgNum &&
                                      prev.hanhKiem; // previous also has h·∫°nh ki·ªÉm
                        
                        if (!isTied) {
                            currentRank = idx + 1;
                        }
                    }
                    
                    rankMap.set(st.mahocsinh, currentRank);
                });

                // Render in original order
                body.innerHTML = studentsData.map((st, idx) => {
                    const displayRank = rankMap.get(st.mahocsinh) || '-';
                    return `
                        <tr>
                            <td style="text-align: center;">${idx + 1}</td>
                            <td style="text-align: center;">${st.mahocsinh}</td>
                            <td class="col-name">${st.hoten}</td>
                            ${st.subjectCells}
                            <td style="text-align: center;"><strong>${st.avgScore}</strong></td>
                            <td style="text-align: center;">${st.hocLuc}</td>
                            <td style="text-align: center;">${st.hanhKiem || '-'}</td>
                            <td style="text-align: center;">${st.danhHieu}</td>
                            <td style="text-align: center;"><strong>${displayRank}</strong></td>
                        </tr>
                    `;
                }).join('');

                document.getElementById('reportWrapper').style.display = 'block';
                document.getElementById('btnPrintReport').style.display = 'block';
                toastSuccess('ƒê√£ t·∫£i b·∫£ng t·ªïng k·∫øt');
            } catch (error) {
                console.error('L·ªói t·∫£i b√°o c√°o:', error);
                toastError('Kh√¥ng th·ªÉ t·∫£i b·∫£ng t·ªïng k·∫øt');
            }
        });

        // Print
        document.getElementById('btnPrintReport').addEventListener('click', () => {
            window.print();
        });
    </script>

</body>
</html>
