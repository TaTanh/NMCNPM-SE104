<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Báo cáo tổng kết</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/layout/styles.css">
    <script src="/js/toast.js"></script>
    <script src="/js/auth.js"></script>
    <style>
        table { font-size: 13px !important; }
        /* Tinh chỉnh UI riêng cho trang báo cáo */
        .filters-row { gap: 10px; align-items: center; }
        .filters-row .btn { padding: 8px 14px; box-shadow: 0 8px 18px rgba(37,99,235,0.25); }
        .filters-row .btn-print { box-shadow: none; }
        .data-table th.col-name { width: 280px; }
        .data-table td.col-name { white-space: nowrap; }
        
        /* Giảm khoảng cách giữa các cột */
        .data-table th, .data-table td { 
            vertical-align: middle; 
            padding: 8px 6px;
        }
        .data-table th {
            text-align: center;
        }
        .data-table td {
            text-align: center;
        }
        .data-table td.col-name {
            text-align: left;
        }
        .data-table td.col-hanhkiem,
        .data-table td.col-danhhieu {
            white-space: nowrap;
        }
    </style>
</head>

<body class="dashboard-body">

    <!-- SIDEBAR -->
    <aside class="sidebar">
        <div class="sidebar-logo">
            <img src="/assets/uit_logo.png" alt="UIT Logo">
            <span>QL Học Sinh</span>
        </div>

        <nav class="sidebar-menu">
            <a href="/pages/dashboard.html">Dashboard</a>
            <a href="/pages/students.html">Quản lý học sinh</a>
            <a href="/pages/classes.html">Quản lý lớp học</a>
            <a href="/pages/subject_list.html">Quản lý môn học</a>
            <a href="/pages/grade_entry_select.html">Nhập điểm</a>
            <a href="/pages/hanhkiem_entry.html">Nhập hạnh kiểm</a>
            <a href="/pages/grade_select.html">Bảng điểm</a>
            <a href="/pages/student_transcript.html">Tra cứu điểm HS</a>
            <a href="/pages/class_summary.html">Tổng kết lớp</a>
            <a href="/pages/reports.html" class="active">Báo cáo tổng kết</a>
            <a href="/pages/teaching_assignment.html" id="menuTeaching" style="display:none;">Phân công giảng dạy</a>
            <a href="/pages/users.html" id="menuUsers" style="display:none;">Quản lý người dùng</a>
        </nav>
    </aside>

    <!-- MAIN -->
    <div class="main">

        <!-- HEADER -->
        <header class="topbar">
            <div class="page-title">Báo cáo tổng kết</div>
            <div class="user-info">
                <span id="userGreeting">Xin chào, Admin</span>
                <img src="/assets/user.png" class="avatar" alt="user">
                <button class="btn btn-outline btn-sm" onclick="logout()" style="margin-left:10px;">Đăng xuất</button>
            </div>
        </header>

        <!-- CONTENT -->
        <div class="content">

            <!-- TỔNG KẾT ĐIỂM THEO LỚP -->
            <h3 class="section-title">Bảng tổng kết điểm theo lớp</h3>

            <div class="filters-row">
                <div class="filter-item">
                    <label class="filter-label" for="yearSelect">Năm học</label>
                    <select id="yearSelect">
                        <option value="">-- Chọn năm học --</option>
                    </select>
                </div>

                <div class="filter-item">
                    <label class="filter-label" for="semesterSelect">Học kỳ</label>
                    <select id="semesterSelect">
                        <option value="">-- Chọn học kỳ --</option>
                        <option value="HK1">Học kỳ 1</option>
                        <option value="HK2">Học kỳ 2</option>
                        <option value="CN">Cả năm</option>
                    </select>
                </div>

                <div class="filter-item">
                    <label class="filter-label" for="gradeSelect">Khối</label>
                    <select id="gradeSelect">
                        <option value="">-- Chọn khối --</option>
                    </select>
                </div>

                <div class="filter-item">
                    <label class="filter-label" for="classSelect">Lớp</label>
                    <select id="classSelect">
                        <option value="">-- Chọn lớp --</option>
                    </select>
                </div>

                <button class="btn btn-primary" id="btnLoadReport">Xem bảng</button>
                <button class="btn btn-print" id="btnPrintReport" style="display: none;">In</button>
            </div>

            <!-- Sắp xếp -->
            <div style="margin-bottom: 10px; display: none;" id="sortOptions">
                <label style="font-weight: 500; margin-right: 8px;">Sắp xếp theo:</label>
                <select id="sortSelect" style="padding: 6px 10px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="name">Tên học sinh (A-Z)</option>
                    <option value="rank">Xếp hạng (Cao → Thấp)</option>
                </select>
            </div>

            <div class="table-wrapper" id="reportWrapper" style="display:none; overflow-x:auto;">
                <table class="data-table" id="reportTable">
                    <thead id="reportHead"></thead>
                    <tbody id="reportBody">
                        <tr><td colspan="3">Chưa có dữ liệu</td></tr>
                    </tbody>
                </table>
            </div>

        </div><!-- content -->
    </div><!-- main -->

    <script>
        // Kiểm tra xác thực
        document.addEventListener('DOMContentLoaded', async () => {
            // Load filters trước
            await loadFilters();
            
            // Sau đó check quyền
            const user = getCurrentUser();
            if (!user || !user.maNguoiDung) {
                toastWarning('Bạn chưa đăng nhập. Vui lòng đăng nhập lại.');
                setTimeout(() => {
                    window.location.href = '/pages/login.html';
                }, 1500);
                return;
            }

            document.getElementById('userGreeting').textContent = `Xin chào, ${user.hoTen || user.hotendangnhap || 'Bạn'}`;

            if (user.vaiTro === 'ADMIN') {
                document.getElementById('menuTeaching').style.display = 'block';
                document.getElementById('menuUsers').style.display = 'block';
            }
        });

        // ========== LOAD FILTERS ==========
        async function loadFilters() {
            try {
                // Load năm học
                const yearRes = await fetch('/api/settings/school-years');
                const years = await yearRes.json();
                const yearSelect = document.getElementById('yearSelect');
                years.forEach(y => {
                    yearSelect.innerHTML += `<option value="${y.manamhoc}">${y.tennamhoc}</option>`;
                });

                // Load khối
                const gradeRes = await fetch('/api/settings/grade-levels');
                const grades = await gradeRes.json();
                const gradeSelect = document.getElementById('gradeSelect');
                grades.forEach(g => {
                    gradeSelect.innerHTML += `<option value="${g.makhoilop}">${g.tenkhoilop}</option>`;
                });

                // Load lớp khi chọn khối
                gradeSelect.addEventListener('change', async () => {
                    const khoi = gradeSelect.value;
                    const classSelect = document.getElementById('classSelect');
                    classSelect.innerHTML = '<option value="">-- Chọn lớp --</option>';
                    if (!khoi) return;
                    
                    try {
                        const res = await fetch(`/api/classes?khoi=${khoi}`);
                        const classList = await res.json();
                        console.log('Class list response:', classList);
                        classList.forEach(cls => {
                            console.log('Class object:', cls);
                            const maLop = cls.malop || cls.MaLop || cls.maLop;
                            const tenLop = cls.tenlop || cls.TenLop || cls.tenLop;
                            console.log('Using maLop:', maLop, 'tenLop:', tenLop);
                            classSelect.innerHTML += `<option value="${maLop}">${tenLop}</option>`;
                        });
                    } catch (error) {
                        console.error('Lỗi load lớp:', error);
                    }
                });
            } catch (error) {
                console.error('Lỗi load filters:', error);
                toastError('Lỗi tải bộ lọc');
            }
        }

        // ========== LOAD REPORT ==========
        document.getElementById('btnLoadReport').addEventListener('click', async () => {
            const year = document.getElementById('yearSelect').value;
            const semester = document.getElementById('semesterSelect').value;
            const grade = document.getElementById('gradeSelect').value;
            const cls = document.getElementById('classSelect').value;

            console.log('Button clicked - Values:', { year, semester, grade, cls });
            console.log('classSelect element:', document.getElementById('classSelect'));
            console.log('classSelect options:', document.getElementById('classSelect').options);

            if (!year || !semester || !grade || !cls) {
                toastWarning('Vui lòng chọn đầy đủ: năm học, học kỳ, khối và lớp');
                return;
            }

            try {
                const url = `/api/reports/class-final?maLop=${cls}&namhoc=${year}`;
                console.log('Fetching URL:', url);
                const res = await fetch(url);
                const json = await res.json();
                console.log('Response:', json);
                const rows = json.data || [];
                
                if (rows.length === 0) {
                    toastInfo('Chưa có dữ liệu');
                    return;
                }

                // Define subject priority order (match with actual database names)
                const subjectPriority = {
                    'Toán': 1,
                    'Vật Lý': 2,
                    'Hóa Học': 3,
                    'Sinh Học': 4,
                    'Ngữ Văn': 5,
                    'Lịch Sử': 6,
                    'Địa Lý': 7,
                    'Tiếng Anh': 8,
                    'Giáo Dục Công Dân': 9
                };
                
                // Get all unique subjects from data, filter out null/undefined
                const allSubjects = Array.from(new Set(rows.map(r => r.tenmonhoc).filter(name => name)));
                
                // Sort subjects according to priority, unknown subjects go to end
                const subjects = allSubjects.sort((a, b) => {
                    const priorityA = subjectPriority[a] ?? 999;
                    const priorityB = subjectPriority[b] ?? 999;
                    return priorityA - priorityB;
                });

                // Map semester choice to column (HK1=hk1, HK2=hk2, CN=cn)
                const semesterMap = { 'HK1': 'hk1', 'HK2': 'hk2', 'CN': 'cn' };
                const semesterKey = semesterMap[semester];
                const semesterLabel = semester === 'CN' ? 'Cả năm' : semester;

                // Build header (single row)
                const head = document.getElementById('reportHead');
                const headRow = document.createElement('tr');
                headRow.innerHTML = `
                    <th style="width: 50px;">STT</th>
                    <th style="width: 80px;">Mã HS</th>
                    <th style="width: 280px; white-space: nowrap;">Họ tên</th>
                `;
                subjects.forEach(sub => {
                    const label = (sub === 'Giáo Dục Công Dân') ? 'GDCD' : sub;
                    headRow.innerHTML += `<th style="width: 70px;">${label}</th>`;
                });
                headRow.innerHTML += `
                    <th style="width: 80px;">Điểm TK</th>
                    <th style="width: 95px;">Học lực</th>
                    <th style="width: 90px;">Hạnh kiểm</th>
                    <th style="width: 140px;">Danh hiệu</th>
                    <th style="width: 75px;">Xếp hạng</th>
                `;

                head.innerHTML = '';
                head.appendChild(headRow);

                // Group by student
                const byStudent = new Map();
                rows.forEach(r => {
                    const key = r.mahocsinh;
                    if (!byStudent.has(key)) {
                        byStudent.set(key, { 
                            mahocsinh: r.mahocsinh, 
                            hoten: r.hoten, 
                            grades: {},
                            hanhkiemhk1: r.hanhkiemhk1,
                            hanhkiemhk2: r.hanhkiemhk2,
                            hanhkiemcn: r.hanhkiemcn
                        });
                    }
                    byStudent.get(key).grades[r.tenmonhoc] = {
                        hk1: r.diemtbhk1,
                        hk2: r.diemtbhk2,
                        cn: r.diemtbnam
                    };
                });

                // Render body - first collect all data with danh hiệu
                const body = document.getElementById('reportBody');
                let index = 0;
                const studentsData = Array.from(byStudent.values()).map(st => {
                    index += 1;
                    
                    // Build subject score cells
                    const subjectCells = subjects.map(sub => {
                        const score = st.grades[sub]?.[semesterKey];
                        let displayScore = '-';
                        
                        if (score !== null && score !== undefined) {
                            const numScore = Number(score);
                            if (!isNaN(numScore)) {
                                displayScore = numScore.toFixed(2);
                            }
                        }
                        return `<td style="text-align: center;">${displayScore}</td>`;
                    }).join('');

                    // Get all valid scores for this semester, calculate average
                    const scoresList = [];
                    subjects.forEach(sub => {
                        const score = st.grades[sub]?.[semesterKey];
                        if (score !== null && score !== undefined) {
                            const numScore = Number(score);
                            if (!isNaN(numScore)) {
                                scoresList.push(numScore);
                            }
                        }
                    });
                    
                    // Calculate average (tổng kết)
                    const avgNum = scoresList.length > 0 
                        ? (scoresList.reduce((a, b) => a + b, 0) / scoresList.length)
                        : null;
                    const avgScore = (avgNum !== null) ? avgNum.toFixed(2) : '-';

                    // Học lực theo TT58 (giả định các môn nhận xét đều Đạt)
                    const getHocLuc = () => {
                        if (avgNum === null) return '-';
                        const hasToan = subjects.includes('Toán');
                        const hasVan = subjects.includes('Ngữ Văn');
                        const toan = hasToan ? st.grades['Toán']?.[semesterKey] : undefined;
                        const van  = hasVan  ? st.grades['Ngữ Văn']?.[semesterKey] : undefined;
                        const minScore = scoresList.reduce((m, v) => Math.min(m, v), 10);
                        const anyBelow = (thr) => scoresList.some(v => v < thr);
                        const anyGE = (score, thr) => (score !== undefined && !isNaN(score) && score >= thr);

                        // Giỏi
                        if (avgNum >= 8.0 && (anyGE(toan,8.0) || anyGE(van,8.0)) && !anyBelow(6.5)) return 'Giỏi';
                        // Khá
                        if (avgNum >= 6.5 && (anyGE(toan,6.5) || anyGE(van,6.5)) && !anyBelow(5.0)) return 'Khá';
                        // Trung bình
                        if (avgNum >= 5.0 && (anyGE(toan,5.0) || anyGE(van,5.0)) && !anyBelow(3.5)) return 'Trung bình';
                        // Yếu
                        if (avgNum >= 3.5 && !anyBelow(2.0)) return 'Yếu';
                        // Kém
                        return 'Kém';
                    };
                    const hocLuc = getHocLuc();

                    // Get hạnh kiểm theo semester
                    const hanhKiem = semester === 'HK1' ? st.hanhkiemhk1 
                                   : semester === 'HK2' ? st.hanhkiemhk2
                                   : st.hanhkiemcn;

                    // Xét danh hiệu theo TT58 đầy đủ
                    const getDanhHieu = () => {
                        if (!hanhKiem || hocLuc === '-') return '-';
                        
                        // Học sinh Giỏi: Giỏi + Tốt
                        if (hocLuc === 'Giỏi' && hanhKiem === 'Tốt') {
                            return 'Học sinh giỏi';
                        }
                        // Học sinh Khá: (Giỏi + Khá) OR (Khá + Tốt) OR (Khá + Khá)
                        else if (
                            (hocLuc === 'Giỏi' && hanhKiem === 'Khá') ||
                            (hocLuc === 'Khá' && (hanhKiem === 'Tốt' || hanhKiem === 'Khá'))
                        ) {
                            return 'Học sinh khá';
                        }
                        // Học sinh Trung bình: (Giỏi + TB) OR (TB + Tốt) OR (TB + Khá)
                        else if (
                            (hocLuc === 'Giỏi' && hanhKiem === 'Trung bình') ||
                            (hocLuc === 'Trung bình' && (hanhKiem === 'Tốt' || hanhKiem === 'Khá'))
                        ) {
                            return 'Học sinh trung bình';
                        }
                        // Các trường hợp còn lại
                        else {
                            return 'Học sinh yếu';
                        }
                    };
                    const danhHieu = getDanhHieu();

                    return {
                        mahocsinh: st.mahocsinh,
                        hoten: st.hoten,
                        subjectCells,
                        avgNum,
                        avgScore,
                        hocLuc,
                        hanhKiem,
                        danhHieu,
                        index: index
                    };
                });

                // Calculate ranking without sorting the original list
                const hanhKiemOrder = { 'Tốt': 4, 'Khá': 3, 'Trung bình': 2, 'Yếu': 1 };
                const danhHieuOrder = { 'Học sinh giỏi': 4, 'Học sinh khá': 3, 'Học sinh trung bình': 2, 'Học sinh yếu': 1 };
                
                // Create a sorted copy for ranking calculation
                const sortedForRank = [...studentsData].sort((a, b) => {
                    const aHasHK = !!a.hanhKiem;
                    const bHasHK = !!b.hanhKiem;
                    
                    if (aHasHK && !bHasHK) return -1;
                    if (!aHasHK && bHasHK) return 1;
                    if (!aHasHK && !bHasHK) return 0;
                    
                    const aDH = danhHieuOrder[a.danhHieu] || 0;
                    const bDH = danhHieuOrder[b.danhHieu] || 0;
                    if (aDH !== bDH) return bDH - aDH;
                    
                    const aHK = hanhKiemOrder[a.hanhKiem] || 0;
                    const bHK = hanhKiemOrder[b.hanhKiem] || 0;
                    if (aHK !== bHK) return bHK - aHK;
                    
                    if (a.avgNum !== null && b.avgNum !== null) {
                        return b.avgNum - a.avgNum;
                    }
                    return 0;
                });
                
                // Assign ranks with tie handling (1, 2, 2, 4 - skip 3)
                const rankMap = new Map();
                let currentRank = 1;
                sortedForRank.forEach((st, idx) => {
                    if (!st.hanhKiem) {
                        rankMap.set(st.mahocsinh, '-');
                        return;
                    }
                    
                    // Check if tied with previous
                    if (idx > 0 && st.hanhKiem) {
                        const prev = sortedForRank[idx - 1];
                        const prevDH = danhHieuOrder[prev.danhHieu] || 0;
                        const currDH = danhHieuOrder[st.danhHieu] || 0;
                        const prevHK = hanhKiemOrder[prev.hanhKiem] || 0;
                        const currHK = hanhKiemOrder[st.hanhKiem] || 0;
                        
                        const isTied = prevDH === currDH && 
                                      prevHK === currHK && 
                                      prev.avgNum === st.avgNum &&
                                      prev.hanhKiem; // previous also has hạnh kiểm
                        
                        if (!isTied) {
                            currentRank = idx + 1;
                        }
                    }
                    
                    rankMap.set(st.mahocsinh, currentRank);
                });

                // Lưu dữ liệu vào biến global để dùng cho sorting
                window.currentStudentsData = studentsData;
                window.currentRankMap = rankMap;
                
                // Hiển thị dropdown sắp xếp
                document.getElementById('sortOptions').style.display = 'block';
                
                // Render bảng
                renderTable();

                document.getElementById('reportWrapper').style.display = 'block';
                document.getElementById('btnPrintReport').style.display = 'block';
                toastSuccess('Đã tải bảng tổng kết');
            } catch (error) {
                console.error('Lỗi tải báo cáo:', error);
                toastError('Không thể tải bảng tổng kết');
            }
        });

        // Print
        document.getElementById('btnPrintReport').addEventListener('click', () => {
            window.print();
        });

        // ========== RENDER TABLE ==========
        function renderTable() {
            const sortBy = document.getElementById('sortSelect').value;
            const studentsData = window.currentStudentsData || [];
            const rankMap = window.currentRankMap || new Map();
            
            if (studentsData.length === 0) return;
            
            // Sắp xếp dữ liệu
            let dataToRender = [...studentsData];
            if (sortBy === 'rank') {
                // Sắp xếp theo xếp hạng (thấp -> cao, rank 1 lên đầu)
                dataToRender.sort((a, b) => {
                    const rankA = rankMap.get(a.mahocsinh);
                    const rankB = rankMap.get(b.mahocsinh);
                    
                    // Học sinh không có rank (-) xuống cuối
                    if (rankA === '-' && rankB !== '-') return 1;
                    if (rankA !== '-' && rankB === '-') return -1;
                    if (rankA === '-' && rankB === '-') return 0;
                    
                    return rankA - rankB;
                });
            }
            // else: giữ nguyên thứ tự theo tên (đã sort sẵn từ backend)
            
            // Render bảng
            const body = document.getElementById('reportBody');
            body.innerHTML = dataToRender.map((st, idx) => {
                const displayRank = rankMap.get(st.mahocsinh) || '-';
                return `
                    <tr>
                        <td>${idx + 1}</td>
                        <td>${st.mahocsinh}</td>
                        <td class="col-name">${st.hoten}</td>
                        ${st.subjectCells}
                        <td><strong>${st.avgScore}</strong></td>
                        <td>${st.hocLuc}</td>
                        <td class="col-hanhkiem">${st.hanhKiem || '-'}</td>
                        <td class="col-danhhieu">${st.danhHieu}</td>
                        <td><strong>${displayRank}</strong></td>
                    </tr>
                `;
            }).join('');
        }

        // Sort dropdown change event
        document.getElementById('sortSelect').addEventListener('change', renderTable);
    </script>

</body>
</html>
