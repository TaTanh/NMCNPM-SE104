<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>C√†i ƒë·∫∑t h·ªá th·ªëng</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/layout/styles.css">
</head>

<body class="dashboard-body">

    <!-- SIDEBAR -->
    <aside class="sidebar">
        <div class="sidebar-logo">
            <img src="/assets/uit_logo.png" alt="UIT Logo">
            <span>QL H·ªçc Sinh</span>
        </div>

        <nav class="sidebar-menu">
            <a href="/pages/dashboard.html">Dashboard</a>
            <a href="/pages/students.html">Qu·∫£n l√Ω h·ªçc sinh</a>
            <a href="/pages/classes.html">Qu·∫£n l√Ω l·ªõp h·ªçc</a>
            <a href="/pages/subject_list.html">Qu·∫£n l√Ω m√¥n h·ªçc</a>
            <a href="/pages/grade_select.html">B·∫£ng ƒëi·ªÉm</a>
            <a href="/pages/reports.html">B√°o c√°o t·ªïng k·∫øt</a>
            <a href="/pages/settings.html" class="active">C√†i ƒë·∫∑t h·ªá th·ªëng</a>
        </nav>
    </aside>

    <!-- MAIN -->
    <div class="main">

        <!-- HEADER -->
        <header class="topbar">
            <div class="page-title">C√†i ƒë·∫∑t h·ªá th·ªëng</div>
            <div class="user-info">
                <span id="userGreeting">Xin ch√†o, Admin</span>
                <img src="/assets/user.png" class="avatar" alt="user">
            </div>
        </header>

        <!-- CONTENT -->
        <div class="content">

            <!-- TH√îNG B√ÅO -->
            <div class="alert alert-info" id="settingsAlert" style="display: none;">
                <span id="alertMessage"></span>
                <button class="alert-close" onclick="this.parentElement.style.display='none'">&times;</button>
            </div>

            <!-- N√öT L∆ØU (ƒê·∫∂T ·ªû TR√äN) -->
            <div class="settings-footer" style="margin-bottom: 20px;">
                <button type="button" class="btn btn-outline" id="btnResetSettingsTop" onclick="document.getElementById('btnResetSettings').click()">Kh√¥i ph·ª•c m·∫∑c ƒë·ªãnh</button>
                <button type="button" class="btn btn-primary" onclick="document.getElementById('settingsForm').requestSubmit()">L∆∞u t·∫•t c·∫£ thay ƒë·ªïi</button>
            </div>

            <!-- FORM C√ÄI ƒê·∫∂T -->
            <form id="settingsForm">
                
                <!-- SECTION: QUY ƒê·ªäNH V·ªÄ ƒêI·ªÇM -->
                <div class="settings-section">
                    <h3 class="section-title">
                        <span class="section-icon">üìä</span>
                        Quy ƒë·ªãnh v·ªÅ ƒëi·ªÉm s·ªë
                    </h3>
                    
                    <div class="config-grid">
                        <div class="config-card">
                            <div class="config-label">ƒêi·ªÉm ƒë·∫°t m√¥n (DiemDatMon)</div>
                            <input type="number" id="diemDatMon" value="5" min="0" max="10" step="0.5">
                            <div class="config-hint">ƒêi·ªÉm t·ªëi thi·ªÉu ƒë·ªÉ ƒë·∫°t m√¥n h·ªçc</div>
                        </div>

                        <div class="config-card">
                            <div class="config-label">ƒêi·ªÉm ƒë·∫°t (DiemDat)</div>
                            <input type="number" id="diemDat" value="5" min="0" max="10" step="0.5">
                            <div class="config-hint">ƒêi·ªÉm t·ªëi thi·ªÉu ƒë·ªÉ ƒë·∫°t (c√≥ th·ªÉ kh√°c DiemDatMon)</div>
                        </div>

                        <div class="config-card">
                            <div class="config-label">ƒêi·ªÉm t·ªëi thi·ªÉu (DiemToiThieu)</div>
                            <input type="number" id="diemToiThieu" value="0" min="0" max="10" step="0.5">
                            <div class="config-hint">ƒêi·ªÉm th·∫•p nh·∫•t c√≥ th·ªÉ nh·∫≠p</div>
                        </div>

                        <div class="config-card">
                            <div class="config-label">ƒêi·ªÉm t·ªëi ƒëa (DiemToiDa)</div>
                            <input type="number" id="diemToiDa" value="10" min="0" max="10" step="0.5">
                            <div class="config-hint">ƒêi·ªÉm cao nh·∫•t c√≥ th·ªÉ nh·∫≠p</div>
                        </div>
                    </div>
                </div>

                <!-- SECTION: QUY ƒê·ªäNH V·ªÄ TU·ªîI -->
                <div class="settings-section">
                    <h3 class="section-title">
                        <span class="section-icon">üë§</span>
                        Quy ƒë·ªãnh v·ªÅ tu·ªïi h·ªçc sinh
                    </h3>
                    
                    <div class="config-grid">
                        <div class="config-card">
                            <div class="config-label">Tu·ªïi t·ªëi thi·ªÉu (TuoiToiThieu)</div>
                            <input type="number" id="tuoiToiThieu" value="15" min="1" max="25">
                            <div class="config-hint">Tu·ªïi t·ªëi thi·ªÉu khi nh·∫≠p h·ªçc</div>
                        </div>

                        <div class="config-card">
                            <div class="config-label">Tu·ªïi t·ªëi ƒëa (TuoiToiDa)</div>
                            <input type="number" id="tuoiToiDa" value="20" min="1" max="30">
                            <div class="config-hint">Tu·ªïi t·ªëi ƒëa khi nh·∫≠p h·ªçc</div>
                        </div>
                    </div>
                </div>

                <!-- SECTION: QUY ƒê·ªäNH V·ªÄ L·ªöP H·ªåC -->
                <div class="settings-section">
                    <h3 class="section-title">
                        <span class="section-icon">üè´</span>
                        Quy ƒë·ªãnh v·ªÅ l·ªõp h·ªçc
                    </h3>
                    
                    <div class="config-grid">
                        <div class="config-card">
                            <div class="config-label">Sƒ© s·ªë t·ªëi ƒëa (SiSoToiDa)</div>
                            <input type="number" id="siSoToiDa" value="40" min="1" max="60">
                            <div class="config-hint">S·ªë h·ªçc sinh t·ªëi ƒëa trong m·ªôt l·ªõp</div>
                        </div>
                    </div>
                </div>

                <!-- SECTION: H·ªÜ S·ªê ƒêI·ªÇM (LO·∫†I H√åNH KI·ªÇM TRA) -->
                <div class="settings-section">
                    <h3 class="section-title">
                        <span class="section-icon">üìù</span>
                        Lo·∫°i h√¨nh ki·ªÉm tra & H·ªá s·ªë
                    </h3>
                    <p class="section-desc">Qu·∫£n l√Ω c√°c lo·∫°i h√¨nh ki·ªÉm tra v√† h·ªá s·ªë t∆∞∆°ng ·ª©ng (b·∫£ng LOAIHINHKIEMTRA)</p>
                    
                    <div class="table-wrapper" style="margin-top: 12px;">
                        <table class="data-table" id="examTypeTable">
                            <thead>
                                <tr>
                                    <th>M√£ lo·∫°i</th>
                                    <th>T√™n lo·∫°i ki·ªÉm tra</th>
                                    <th>H·ªá s·ªë</th>
                                    <th style="width: 100px;">Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody id="examTypeBody">
                                <tr><td colspan="4" style="text-align: center;">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
                            </tbody>
                        </table>
                    </div>

                    <div style="margin-top: 12px;">
                        <button type="button" class="btn btn-outline" id="btnAddExamType">+ Th√™m lo·∫°i ki·ªÉm tra</button>
                    </div>
                </div>

                <!-- SECTION: QU·∫¢N L√ù H·ªåC K·ª≤ -->
                <div class="settings-section">
                    <h3 class="section-title">
                        <span class="section-icon">üìÖ</span>
                        Qu·∫£n l√Ω h·ªçc k·ª≥
                    </h3>
                    <p class="section-desc">Thi·∫øt l·∫≠p c√°c h·ªçc k·ª≥ trong nƒÉm h·ªçc (b·∫£ng HOCKY)</p>
                    
                    <div class="table-wrapper" style="margin-top: 12px;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>M√£ h·ªçc k·ª≥</th>
                                    <th>T√™n h·ªçc k·ª≥</th>
                                    <th style="width: 100px;">Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody id="semesterBody">
                                <tr><td colspan="3" style="text-align: center;">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
                            </tbody>
                        </table>
                    </div>

                    <div style="margin-top: 12px;">
                        <button type="button" class="btn btn-outline" id="btnAddSemester">+ Th√™m h·ªçc k·ª≥</button>
                    </div>
                </div>

                <!-- SECTION: QU·∫¢N L√ù NƒÇM H·ªåC -->
                <div class="settings-section">
                    <h3 class="section-title">
                        <span class="section-icon">üìÜ</span>
                        Qu·∫£n l√Ω nƒÉm h·ªçc
                    </h3>
                    <p class="section-desc">Thi·∫øt l·∫≠p c√°c nƒÉm h·ªçc (b·∫£ng NAMHOC)</p>
                    
                    <div class="table-wrapper" style="margin-top: 12px;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>M√£ nƒÉm h·ªçc</th>
                                    <th>NƒÉm b·∫Øt ƒë·∫ßu</th>
                                    <th>NƒÉm k·∫øt th√∫c</th>
                                    <th style="width: 100px;">Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody id="yearBody">
                                <tr><td colspan="4" style="text-align: center;">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
                            </tbody>
                        </table>
                    </div>

                    <div style="margin-top: 12px;">
                        <button type="button" class="btn btn-outline" id="btnAddYear">+ Th√™m nƒÉm h·ªçc</button>
                    </div>
                </div>

                <!-- N√öT L∆ØU -->
                <div class="settings-footer">
                    <button type="button" class="btn btn-outline" id="btnResetSettings">Kh√¥i ph·ª•c m·∫∑c ƒë·ªãnh</button>
                    <button type="submit" class="btn btn-primary">L∆∞u t·∫•t c·∫£ thay ƒë·ªïi</button>
                </div>

            </form>

        </div><!-- content -->
    </div><!-- main -->

    <!-- ======================== SCRIPT ======================== -->
    <script>
        // ========== LOAD THAM S·ªê T·ª™ DATABASE ==========
        async function loadSettings() {
            try {
                const response = await fetch('/api/settings/params');
                const params = await response.json();
                
                params.forEach(p => {
                    const fieldMap = {
                        'DiemDatMon': 'diemDatMon',
                        'DiemDat': 'diemDat',
                        'DiemToiThieu': 'diemToiThieu',
                        'DiemToiDa': 'diemToiDa',
                        'TuoiToiThieu': 'tuoiToiThieu',
                        'TuoiToiDa': 'tuoiToiDa',
                        'SiSoToiDa': 'siSoToiDa'
                    };
                    
                    const fieldId = fieldMap[p.tenthamso];
                    if (fieldId) {
                        const input = document.getElementById(fieldId);
                        if (input) input.value = p.giatri;
                    }
                });
            } catch (error) {
                console.error('L·ªói load tham s·ªë:', error);
            }
        }

        // ========== LOAD LO·∫†I H√åNH KI·ªÇM TRA ==========
        async function loadExamTypes() {
            try {
                const response = await fetch('/api/settings/exam-types');
                const examTypes = await response.json();
                
                const tbody = document.getElementById('examTypeBody');
                tbody.innerHTML = examTypes.map(et => `
                    <tr data-id="${et.malhkt}">
                        <td>${et.malhkt}</td>
                        <td>
                            <input type="text" class="inline-input" value="${et.tenlhkt}">
                        </td>
                        <td>
                            <input type="number" class="inline-input" value="${et.heso}" min="1" max="5" step="1">
                        </td>
                        <td>
                            <button type="button" class="btn btn-sm btn-danger btn-delete-exam">X√≥a</button>
                        </td>
                    </tr>
                `).join('');
                
                // Attach delete handlers
                tbody.querySelectorAll('.btn-delete-exam').forEach(btn => {
                    attachDeleteHandler(btn);
                });
            } catch (error) {
                console.error('L·ªói load lo·∫°i h√¨nh ki·ªÉm tra:', error);
            }
        }

        // ========== LOAD H·ªåC K·ª≤ ==========
        async function loadSemesters() {
            try {
                const response = await fetch('/api/settings/semesters');
                const semesters = await response.json();
                
                const tbody = document.getElementById('semesterBody');
                tbody.innerHTML = semesters.map(s => `
                    <tr data-id="${s.mahocky}">
                        <td>${s.mahocky}</td>
                        <td>
                            <input type="text" class="inline-input" value="${s.tenhocky}">
                        </td>
                        <td>
                            <button type="button" class="btn btn-sm btn-danger btn-delete-semester">X√≥a</button>
                        </td>
                    </tr>
                `).join('');
                
                tbody.querySelectorAll('.btn-delete-semester').forEach(btn => {
                    attachDeleteHandler(btn);
                });
            } catch (error) {
                console.error('L·ªói load h·ªçc k·ª≥:', error);
            }
        }

        // ========== LOAD NƒÇM H·ªåC ==========
        async function loadSchoolYears() {
            try {
                const response = await fetch('/api/settings/school-years');
                const years = await response.json();
                
                const tbody = document.getElementById('yearBody');
                tbody.innerHTML = years.map(y => {
                    const parts = y.tennamhoc.split('‚Äì');
                    const startYear = parts[0] || '';
                    const endYear = parts[1] || '';
                    return `
                        <tr data-id="${y.manamhoc}">
                            <td>${y.manamhoc}</td>
                            <td>
                                <input type="number" class="inline-input" value="${startYear.trim()}" min="2000" max="2100">
                            </td>
                            <td>
                                <input type="number" class="inline-input" value="${endYear.trim()}" min="2000" max="2100">
                            </td>
                            <td>
                                <button type="button" class="btn btn-sm btn-danger btn-delete-year">X√≥a</button>
                            </td>
                        </tr>
                    `;
                }).join('');
                
                tbody.querySelectorAll('.btn-delete-year').forEach(btn => {
                    attachDeleteHandler(btn);
                });
            } catch (error) {
                console.error('L·ªói load nƒÉm h·ªçc:', error);
            }
        }

        // ========== L∆ØU T·∫§T C·∫¢ THAY ƒê·ªîI ==========
        document.getElementById('settingsForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const settings = {
                DiemDatMon: document.getElementById('diemDatMon').value,
                DiemDat: document.getElementById('diemDat').value,
                DiemToiThieu: document.getElementById('diemToiThieu').value,
                DiemToiDa: document.getElementById('diemToiDa').value,
                TuoiToiThieu: document.getElementById('tuoiToiThieu').value,
                TuoiToiDa: document.getElementById('tuoiToiDa').value,
                SiSoToiDa: document.getElementById('siSoToiDa').value
            };

            try {
                // L∆∞u t·ª´ng tham s·ªë
                for (const [name, value] of Object.entries(settings)) {
                    await fetch(`/api/settings/params/${name}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ GiaTri: value })
                    });
                }

                // L∆∞u lo·∫°i h√¨nh ki·ªÉm tra
                const examRows = document.querySelectorAll('#examTypeBody tr');
                for (const row of examRows) {
                    const id = row.dataset.id;
                    const inputs = row.querySelectorAll('input');
                    if (id && !id.startsWith('NEW')) {
                        await fetch(`/api/settings/exam-types/${id}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                TenLHKT: inputs[0].value,
                                HeSo: inputs[1].value
                            })
                        });
                    }
                }

                showAlert('ƒê√£ l∆∞u thay ƒë·ªïi th√†nh c√¥ng!', 'success');
            } catch (error) {
                console.error('L·ªói:', error);
                showAlert('L·ªói khi l∆∞u thay ƒë·ªïi!', 'error');
            }
        });

        // Reset settings
        document.getElementById('btnResetSettings').addEventListener('click', () => {
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën kh√¥i ph·ª•c v·ªÅ c√†i ƒë·∫∑t m·∫∑c ƒë·ªãnh?')) {
                document.getElementById('diemDatMon').value = 5;
                document.getElementById('diemDat').value = 5;
                document.getElementById('diemToiThieu').value = 0;
                document.getElementById('diemToiDa').value = 10;
                document.getElementById('tuoiToiThieu').value = 15;
                document.getElementById('tuoiToiDa').value = 20;
                document.getElementById('siSoToiDa').value = 40;
                
                showAlert('ƒê√£ kh√¥i ph·ª•c v·ªÅ c√†i ƒë·∫∑t m·∫∑c ƒë·ªãnh!', 'info');
            }
        });

        // Add exam type
        document.getElementById('btnAddExamType').addEventListener('click', () => {
            const tbody = document.getElementById('examTypeBody');
            const newId = 'NEW' + Date.now();
            const tr = document.createElement('tr');
            tr.dataset.id = newId;
            tr.innerHTML = `
                <td><input type="text" class="inline-input" placeholder="M√£ lo·∫°i" style="width: 80px;"></td>
                <td><input type="text" class="inline-input" placeholder="T√™n lo·∫°i ki·ªÉm tra"></td>
                <td><input type="number" class="inline-input" value="1" min="1" max="5" step="1"></td>
                <td><button type="button" class="btn btn-sm btn-danger btn-delete-exam">X√≥a</button></td>
            `;
            tbody.appendChild(tr);
            attachDeleteHandler(tr.querySelector('.btn-delete-exam'));
        });

        // Add semester
        document.getElementById('btnAddSemester').addEventListener('click', () => {
            const tbody = document.getElementById('semesterBody');
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><input type="text" class="inline-input" placeholder="M√£ HK" style="width: 80px;"></td>
                <td><input type="text" class="inline-input" placeholder="T√™n h·ªçc k·ª≥"></td>
                <td><button type="button" class="btn btn-sm btn-danger btn-delete-semester">X√≥a</button></td>
            `;
            tbody.appendChild(tr);
            attachDeleteHandler(tr.querySelector('.btn-delete-semester'));
        });

        // Add year
        document.getElementById('btnAddYear').addEventListener('click', () => {
            const tbody = document.getElementById('yearBody');
            const currentYear = new Date().getFullYear();
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><input type="text" class="inline-input" placeholder="M√£ nƒÉm h·ªçc" style="width: 100px;"></td>
                <td><input type="number" class="inline-input" value="${currentYear}" min="2000" max="2100"></td>
                <td><input type="number" class="inline-input" value="${currentYear + 1}" min="2000" max="2100"></td>
                <td><button type="button" class="btn btn-sm btn-danger btn-delete-year">X√≥a</button></td>
            `;
            tbody.appendChild(tr);
            attachDeleteHandler(tr.querySelector('.btn-delete-year'));
        });

        // Delete handlers
        function attachDeleteHandler(btn) {
            btn.addEventListener('click', function() {
                if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a m·ª•c n√†y?')) {
                    this.closest('tr').remove();
                }
            });
        }

        // Show alert function
        function showAlert(message, type = 'info') {
            const alert = document.getElementById('settingsAlert');
            const alertMessage = document.getElementById('alertMessage');
            
            alertMessage.textContent = message;
            alert.className = 'alert alert-' + type;
            alert.style.display = 'flex';

            setTimeout(() => {
                alert.style.display = 'none';
            }, 3000);
        }

        // ========== KH·ªûI T·∫†O ==========
        document.addEventListener('DOMContentLoaded', () => {
            loadSettings();
            loadExamTypes();
            loadSemesters();
            loadSchoolYears();
        });
    </script>

</body>
</html>
