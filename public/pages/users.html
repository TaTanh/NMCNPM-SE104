<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Qu·∫£n l√Ω ng∆∞·ªùi d√πng</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/layout/styles.css">
    <script src="/js/toast.js"></script>
    <script src="/js/auth.js"></script>
</head>

<body class="dashboard-body">

    <!-- SIDEBAR -->
    <aside class="sidebar">
        <div class="sidebar-logo">
            <img src="/assets/uit_logo.png" alt="UIT Logo">
            <span>QL H·ªçc Sinh</span>
        </div>

        <nav class="sidebar-menu">
            <a href="/pages/dashboard.html">Dashboard</a>
            <a href="/pages/students.html">Qu·∫£n l√Ω h·ªçc sinh</a>
            <a href="/pages/classes.html" id="menuClasses" style="display:none;">Qu·∫£n l√Ω l·ªõp h·ªçc</a>
            <a href="/pages/subject_list.html" id="menuSubjects" style="display:none;">Qu·∫£n l√Ω m√¥n h·ªçc</a>
            <a href="/pages/grade_entry_select.html">Nh·∫≠p ƒëi·ªÉm</a>
            <a href="/pages/hanhkiem_entry.html" id="menuHanhKiem" style="display:none;">Nh·∫≠p h·∫°nh ki·ªÉm</a>
            <a href="/pages/grade_select.html">B·∫£ng ƒëi·ªÉm</a>
            <a href="/pages/student_transcript.html">Tra c·ª©u ƒëi·ªÉm HS</a>
            <a href="/pages/class_summary.html">T·ªïng k·∫øt l·ªõp</a>
            <a href="/pages/reports.html">B√°o c√°o t·ªïng k·∫øt</a>
            <a href="/pages/teaching_assignment.html" id="menuTeaching" style="display:none;">Ph√¢n c√¥ng gi·∫£ng d·∫°y</a>
            <a href="/pages/users.html" id="menuUsers" style="display:none;" class="active">Qu·∫£n l√Ω ng∆∞·ªùi d√πng</a>
        </nav>
    </aside>

    <!-- MAIN -->
    <div class="main">

        <!-- HEADER -->
        <header class="topbar">
            <div class="page-title">Qu·∫£n l√Ω ng∆∞·ªùi d√πng & Ph√¢n quy·ªÅn</div>
            <div class="user-info">
                <span id="userGreeting">Xin ch√†o, Admin</span>
                <img src="/assets/user.png" class="avatar" alt="user">
                <button class="btn btn-outline btn-sm" onclick="logout()" style="margin-left:10px;">ƒêƒÉng xu·∫•t</button>
            </div>
        </header>

        <!-- CONTENT -->
        <div class="content">

            <!-- TAB CH·ªåN -->
            <div class="report-tabs">
                <button class="tab-btn active" data-tab="users-tab">Danh s√°ch ng∆∞·ªùi d√πng</button>
                <button class="tab-btn" data-tab="roles-tab">Vai tr√≤ & Quy·ªÅn h·∫°n</button>
            </div>

            <!-- ========== TAB NG∆Ø·ªúI D√ôNG ========== -->
            <div class="report-section" id="users-tab">
                <h3 class="section-title">Danh s√°ch ng∆∞·ªùi d√πng</h3>

                <!-- TOOLBAR -->
                <div class="toolbar">
                    <div class="search-box">
                        <input type="text" id="searchUser" placeholder="T√¨m theo t√™n ho·∫∑c t√™n ƒëƒÉng nh·∫≠p...">
                    </div>

                    <div class="toolbar-actions">
                        <button class="btn btn-print" onclick="window.print()">In</button>
                        <button class="btn btn-primary" id="btnAddUser">Th√™m ng∆∞·ªùi d√πng</button>
                    </div>
                </div>

                <!-- B·∫¢NG -->
                <div class="table-wrapper">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>STT</th>
                                <th>T√™n ƒëƒÉng nh·∫≠p</th>
                                <th>H·ªç t√™n</th>
                                <th>Email</th>
                                <th>Vai tr√≤</th>
                                <th>Tr·∫°ng th√°i</th>
                                <th>Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody id="userTableBody">
                            <tr><td colspan="7" style="text-align:center;">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ========== TAB VAI TR√í ========== -->
            <div class="report-section" id="roles-tab" style="display: none;">
                <h3 class="section-title">Vai tr√≤ & Quy·ªÅn h·∫°n</h3>

                <div class="table-wrapper">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>M√£ vai tr√≤</th>
                                <th>T√™n vai tr√≤</th>
                                <th>M√¥ t·∫£</th>
                                <th>Quy·ªÅn h·∫°n</th>
                            </tr>
                        </thead>
                        <tbody id="roleTableBody">
                            <tr><td colspan="4" style="text-align:center;">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
                        </tbody>
                    </table>
                </div>

                <div class="settings-section" style="margin-top: 20px;">
                    <h3 class="section-title">
                        <span class="section-icon">üîê</span>
                        M√¥ t·∫£ quy·ªÅn h·∫°n
                    </h3>
                    <div class="config-grid">
                        <div class="config-card">
                            <div class="config-label">quanlyHocSinh</div>
                            <div class="config-hint">Qu·∫£n l√Ω th√¥ng tin h·ªçc sinh (th√™m/s·ª≠a/x√≥a)</div>
                        </div>
                        <div class="config-card">
                            <div class="config-label">quanlyLop</div>
                            <div class="config-hint">Qu·∫£n l√Ω l·ªõp h·ªçc (th√™m/s·ª≠a/x√≥a)</div>
                        </div>
                        <div class="config-card">
                            <div class="config-label">quanlyMonHoc</div>
                            <div class="config-hint">Qu·∫£n l√Ω m√¥n h·ªçc (th√™m/s·ª≠a/x√≥a)</div>
                        </div>
                        <div class="config-card">
                            <div class="config-label">nhapDiem</div>
                            <div class="config-hint">Nh·∫≠p v√† ch·ªânh s·ª≠a ƒëi·ªÉm h·ªçc sinh</div>
                        </div>
                        <div class="config-card">
                            <div class="config-label">baoCao</div>
                            <div class="config-hint">Xem b√°o c√°o t·ªïng k·∫øt</div>
                        </div>
                        <div class="config-card">
                            <div class="config-label">caiDat</div>
                            <div class="config-hint">Thay ƒë·ªïi c√†i ƒë·∫∑t h·ªá th·ªëng</div>
                        </div>
                        <div class="config-card">
                            <div class="config-label">phanQuyen</div>
                            <div class="config-hint">Qu·∫£n l√Ω ng∆∞·ªùi d√πng v√† ph√¢n quy·ªÅn</div>
                        </div>
                    </div>
                </div>
            </div>

        </div><!-- content -->
    </div><!-- main -->

    <!-- ========== POPUP TH√äM/S·ª¨A NG∆Ø·ªúI D√ôNG ========== -->
    <div class="modal-overlay" id="userModal">
        <div class="modal">
            <div class="modal-header">
                <h2 id="userModalTitle">Th√™m ng∆∞·ªùi d√πng</h2>
                <button class="modal-close" id="closeUserModal">&times;</button>
            </div>

            <div class="modal-body">
                <form id="userForm" novalidate>
                    <input type="hidden" id="userId">
                    <div class="modal-grid">
                        <div class="form-group">
                            <label class="required-label">T√™n ƒëƒÉng nh·∫≠p</label>
                            <input type="text" id="userUsername" required>
                            <span class="error-message">Vui l√≤ng nh·∫≠p t√™n ƒëƒÉng nh·∫≠p</span>
                        </div>

                        <div class="form-group" id="passwordGroup">
                            <label class="required-label">M·∫≠t kh·∫©u</label>
                            <input type="password" id="userPassword" required>
                            <span class="error-message">Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u</span>
                        </div>

                        <div class="form-group">
                            <label class="required-label">H·ªç t√™n</label>
                            <input type="text" id="userFullName" required>
                            <span class="error-message">Vui l√≤ng nh·∫≠p h·ªç t√™n</span>
                        </div>

                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="userEmail">
                            <span class="error-message">Email kh√¥ng h·ª£p l·ªá</span>
                        </div>

                        <div class="form-group">
                            <label class="required-label">Vai tr√≤</label>
                            <select id="userRole" required>
                                <option value="">-- Ch·ªçn vai tr√≤ --</option>
                            </select>
                            <span class="error-message">Vui l√≤ng ch·ªçn vai tr√≤</span>
                        </div>

                        <div class="form-group">
                            <label>Tr·∫°ng th√°i</label>
                            <select id="userStatus">
                                <option value="true">Ho·∫°t ƒë·ªông</option>
                                <option value="false">Kh√≥a</option>
                            </select>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline" id="cancelUserBtn">H·ªßy</button>
                        <button type="submit" class="btn btn-primary">L∆∞u</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- SCRIPT -->
    <script>
        // ========== KI·ªÇM TRA QUY·ªÄN ==========
        function checkPermission() {
            const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
            if (!userInfo.quyen || !userInfo.quyen.phanQuyen) {
                toastError('B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p trang n√†y!');
                window.location.href = '/pages/dashboard.html';
                return false;
            }
            document.getElementById('userGreeting').textContent = `Xin ch√†o, ${userInfo.hoTen || 'Admin'}`;
            return true;
        }

        // ========== LOAD DANH S√ÅCH NG∆Ø·ªúI D√ôNG ==========
        async function loadUsers() {
            try {
                const response = await authFetch('/api/auth/users');
                const users = await response.json();
                
                const tbody = document.getElementById('userTableBody');
                if (users.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>';
                    return;
                }
                
                // L·∫•y th√¥ng tin user hi·ªán t·∫°i
                const currentUser = JSON.parse(localStorage.getItem('userInfo') || '{}');
                const currentUserId = currentUser.maNguoiDung;
                
                tbody.innerHTML = users.map((u, index) => {
                    // üîí Ki·ªÉm tra xem c√≥ ph·∫£i super admin kh√¥ng (ID=1 ho·∫∑c username='admin')
                    const isSuperAdmin = (u.manguoidung === 1 || u.tendangnhap === 'admin');
                    const isCurrentUser = (u.manguoidung === currentUserId);
                    
                    // Disable n√∫t s·ª≠a/x√≥a n·∫øu l√† super admin ho·∫∑c ch√≠nh m√¨nh
                    const disableEdit = isSuperAdmin ? 'disabled title="Kh√¥ng th·ªÉ s·ª≠a super admin"' : '';
                    const disableDelete = (isSuperAdmin || isCurrentUser) ? 'disabled title="' + (isSuperAdmin ? 'Kh√¥ng th·ªÉ x√≥a super admin' : 'Kh√¥ng th·ªÉ x√≥a ch√≠nh m√¨nh') + '"' : '';
                    
                    return `
                        <tr data-id="${u.manguoidung}">
                            <td>${index + 1}${isSuperAdmin ? ' üîí' : ''}</td>
                            <td>${u.tendangnhap}</td>
                            <td>${u.hoten || ''}</td>
                            <td>${u.email || ''}</td>
                            <td><span class="badge badge-${u.mavaitro?.toLowerCase()}">${u.tenvaitro}</span></td>
                            <td>${u.trangthai ? '<span class="rate-good">Ho·∫°t ƒë·ªông</span>' : '<span class="rate-low">ƒê√£ kh√≥a</span>'}</td>
                            <td>
                                <button class="btn btn-sm btn-secondary" onclick="editUser(${u.manguoidung})" ${disableEdit}>S·ª≠a</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteUser(${u.manguoidung}, '${u.tendangnhap}')" ${disableDelete}>X√≥a</button>
                            </td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('L·ªói:', error);
            }
        }

        // ========== LOAD DANH S√ÅCH VAI TR√í ==========
        async function loadRoles() {
            try {
                const response = await authFetch('/api/auth/roles');
                const roles = await response.json();
                
                // Render b·∫£ng vai tr√≤
                const tbody = document.getElementById('roleTableBody');
                tbody.innerHTML = roles.map(r => {
                    const quyen = typeof r.quyen === 'string' ? JSON.parse(r.quyen) : r.quyen;
                    const quyenList = Object.entries(quyen)
                        .filter(([k, v]) => v === true)
                        .map(([k]) => `<span class="badge">${k}</span>`)
                        .join(' ');
                    
                    // Th√™m ghi ch√∫ cho GVCN
                    const note = r.mavaitro === 'GVCN' ? '<br><small style="color: #6b7280;">‚ö†Ô∏è Vai tr√≤ n√†y ƒë∆∞·ª£c g√°n t·ª± ƒë·ªông t·ª´ trang Qu·∫£n l√Ω L·ªõp</small>' : '';
                    
                    return `
                        <tr>
                            <td>${r.mavaitro}</td>
                            <td>${r.tenvaitro}${note}</td>
                            <td>${r.mota || ''}</td>
                            <td>${quyenList || 'Kh√¥ng c√≥'}</td>
                        </tr>
                    `;
                }).join('');
                
                // Render dropdown vai tr√≤ (lo·∫°i b·ªè GVCN v√¨ ƒë∆∞·ª£c ph√¢n ·ªü qu·∫£n l√Ω l·ªõp)
                const select = document.getElementById('userRole');
                select.innerHTML = '<option value="">-- Ch·ªçn vai tr√≤ --</option>';
                roles.forEach(r => {
                    // üö´ Kh√¥ng cho ph√©p g√°n GVCN th·ªß c√¥ng - ph·∫£i ƒë∆∞·ª£c ph√¢n c√¥ng t·ª´ trang Qu·∫£n l√Ω L·ªõp
                    if (r.mavaitro === 'GVCN') {
                        return; // Skip GVCN role
                    }
                    select.innerHTML += `<option value="${r.mavaitro}">${r.tenvaitro}</option>`;
                });
            } catch (error) {
                console.error('L·ªói:', error);
            }
        }

        // ========== TAB SWITCHING ==========
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                const tabId = btn.dataset.tab;
                document.querySelectorAll('.report-section').forEach(sec => sec.style.display = 'none');
                document.getElementById(tabId).style.display = 'block';
            });
        });

        // ========== MODAL NG∆Ø·ªúI D√ôNG ==========
        const userModal = document.getElementById('userModal');
        const userForm = document.getElementById('userForm');
        let isEditMode = false;

        document.getElementById('btnAddUser').addEventListener('click', () => {
            isEditMode = false;
            document.getElementById('userModalTitle').textContent = 'Th√™m ng∆∞·ªùi d√πng';
            document.getElementById('passwordGroup').style.display = 'block';
            document.getElementById('userUsername').readOnly = false;
            userForm.reset();
            userModal.classList.add('show');
        });

        document.getElementById('closeUserModal').onclick =
        document.getElementById('cancelUserBtn').onclick = () => {
            userModal.classList.remove('show');
            userForm.reset();
        };

        async function editUser(id) {
            try {
                const response = await authFetch('/api/auth/users');
                const users = await response.json();
                const user = users.find(u => u.manguoidung === id);
                
                if (user) {
                    // üîí Ki·ªÉm tra super admin
                    if (user.manguoidung === 1 || user.tendangnhap === 'admin') {
                        toastError('Kh√¥ng th·ªÉ s·ª≠a th√¥ng tin super admin!');
                        return;
                    }
                    
                    isEditMode = true;
                    document.getElementById('userModalTitle').textContent = 'S·ª≠a ng∆∞·ªùi d√πng';
                    document.getElementById('passwordGroup').style.display = 'none';
                    document.getElementById('userId').value = id;
                    document.getElementById('userUsername').value = user.tendangnhap;
                    document.getElementById('userUsername').readOnly = true;
                    document.getElementById('userFullName').value = user.hoten || '';
                    document.getElementById('userEmail').value = user.email || '';
                    document.getElementById('userRole').value = user.mavaitro;
                    document.getElementById('userStatus').value = user.trangthai.toString();
                    
                    // üîí Ki·ªÉm tra n·∫øu ƒëang s·ª≠a ch√≠nh m√¨nh v√† l√† admin th√¨ disable dropdown vai tr√≤
                    const currentUser = JSON.parse(localStorage.getItem('userInfo') || '{}');
                    const roleSelect = document.getElementById('userRole');
                    if (user.manguoidung === currentUser.maNguoiDung && user.mavaitro === 'ADMIN') {
                        roleSelect.disabled = true;
                        roleSelect.title = 'B·∫°n kh√¥ng th·ªÉ h·∫° quy·ªÅn ch√≠nh m√¨nh';
                    } else {
                        roleSelect.disabled = false;
                        roleSelect.title = '';
                    }
                    
                    userModal.classList.add('show');
                }
            } catch (error) {
                toastError(error.message);
            }
        }

        async function deleteUser(id, username) {
            if (!confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ng∆∞·ªùi d√πng "${username}"?`)) return;
            
            try {
                const response = await authFetch(`/api/auth/users/${id}`, { method: 'DELETE' });
                const result = await response.json();
                
                if (!response.ok) throw new Error(result.error);
                
                toastSuccess('ƒê√£ x√≥a ng∆∞·ªùi d√πng!');
                loadUsers();
            } catch (error) {
                toastError(error.message);
            }
        }

        userForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const data = {
                TenDangNhap: document.getElementById('userUsername').value,
                HoTen: document.getElementById('userFullName').value,
                Email: document.getElementById('userEmail').value,
                MaVaiTro: document.getElementById('userRole').value,
                TrangThai: document.getElementById('userStatus').value === 'true'
            };
            
            if (!isEditMode) {
                data.MatKhau = document.getElementById('userPassword').value;
            }
            
            try {
                const url = isEditMode 
                    ? `/api/auth/users/${document.getElementById('userId').value}`
                    : '/api/auth/users';
                    
                const response = await authFetch(url, {
                    method: isEditMode ? 'PUT' : 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (!response.ok) throw new Error(result.error);
                
                toastSuccess(isEditMode ? 'C·∫≠p nh·∫≠t th√†nh c√¥ng!' : 'Th√™m ng∆∞·ªùi d√πng th√†nh c√¥ng!');
                userModal.classList.remove('show');
                loadUsers();
            } catch (error) {
                toastError(error.message);
            }
        });

        // ========== T√åM KI·∫æM ==========
        document.getElementById('searchUser').addEventListener('input', (e) => {
            const keyword = e.target.value.toLowerCase();
            const rows = document.querySelectorAll('#userTableBody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(keyword) ? '' : 'none';
            });
        });

        // ========== KH·ªûI T·∫†O ==========
        document.addEventListener('DOMContentLoaded', () => {
            // checkPermission(); // Uncomment khi mu·ªën b·∫≠t ki·ªÉm tra quy·ªÅn
            loadUsers();
            loadRoles();
            
            // Ki·ªÉm tra role v√† hi·ªÉn th·ªã menu cho ADMIN
            const user = getCurrentUser();
            if (user && user.vaiTro === 'ADMIN') {
                document.getElementById('menuClasses').style.display = 'block';
                document.getElementById('menuSubjects').style.display = 'block';
                document.getElementById('menuHanhKiem').style.display = 'block';
                document.getElementById('menuTeaching').style.display = 'block';

                document.getElementById('menuUsers').style.display = 'block';
            }
        });
    </script>

    <style>
        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            background: #e5e7eb;
            color: #374151;
        }
        .badge-admin { background: #fef3c7; color: #92400e; }
        .badge-teacher { background: #dbeafe; color: #1e40af; }
        .badge-student { background: #d1fae5; color: #065f46; }
    </style>

</body>
</html>
