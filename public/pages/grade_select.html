<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Nh·∫≠p ƒëi·ªÉm ‚Äì Ch·ªçn l·ªõp</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/layout/styles.css">
    <script src="/js/toast.js"></script>
</head>

<body class="dashboard-body">

    <!-- SIDEBAR -->
    <aside class="sidebar">
        <div class="sidebar-logo">
            <img src="/assets/uit_logo.png" alt="UIT Logo">
            <span>QL H·ªçc Sinh</span>
        </div>

        <nav class="sidebar-menu">
            <a href="/pages/dashboard.html">Dashboard</a>
            <a href="/pages/students.html">Qu·∫£n l√Ω h·ªçc sinh</a>
            <a href="/pages/classes.html">Qu·∫£n l√Ω l·ªõp h·ªçc</a>
            <a href="/pages/subject_list.html">Qu·∫£n l√Ω m√¥n h·ªçc</a>
            <a href="/pages/grade_select.html" class="active">B·∫£ng ƒëi·ªÉm</a>
            <a href="/pages/reports.html">B√°o c√°o t·ªïng k·∫øt</a>
        </nav>

    </aside>

    <!-- MAIN -->
    <div class="main">

        <!-- HEADER -->
        <header class="topbar">
            <div class="page-title">B·∫£ng ƒëi·ªÉm</div>
            <div class="user-info">
                <span>Xin ch√†o, Admin</span>
                <img src="/assets/user.png" class="avatar" alt="user">
            </div>
        </header>

        <!-- CONTENT -->
        <div class="content">

            <!-- Filters: NƒÉm h·ªçc + H·ªçc k·ª≥ + Kh·ªëi + L·ªõp -->
            <div class="filters-row">
                <div class="filter-item">
                    <label class="filter-label" for="yearSelect">NƒÉm h·ªçc</label>
                    <select id="yearSelect">
                        <option value="">-- Ch·ªçn nƒÉm h·ªçc --</option>
                    </select>
                </div>

                <div class="filter-item">
                    <label class="filter-label" for="semesterSelect">H·ªçc k·ª≥</label>
                    <select id="semesterSelect">
                        <option value="">-- Ch·ªçn h·ªçc k·ª≥ --</option>
                    </select>
                </div>

                <div class="filter-item">
                    <label class="filter-label" for="gradeSelect">Kh·ªëi</label>
                    <select id="gradeSelect">
                        <option value="">-- Ch·ªçn kh·ªëi --</option>
                    </select>
                </div>

                <div class="filter-item">
                    <label class="filter-label" for="classSelect">L·ªõp</label>
                    <select id="classSelect">
                        <option value="">-- Ch·ªçn l·ªõp --</option>
                    </select>
                </div>

                <div class="filter-item" style="display:flex; align-items:flex-end;">
                    <button class="btn btn-outline" id="btnSemesterRules">‚öôÔ∏è Qu·∫£n l√Ω h·ªçc k·ª≥</button>
                </div>
            </div>

            <!-- B·∫£ng danh s√°ch m√¥n ƒë·ªÉ nh·∫≠p ƒëi·ªÉm -->
            <div class="table-wrapper">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>M√£ m√¥n</th>
                            <th>T√™n m√¥n</th>
                            <th>H·ªá s·ªë</th>
                            <th>H·ªçc k·ª≥</th>
                            <th style="width: 120px; text-align: right;">Thao t√°c</th>
                        </tr>
                    </thead>
                    <tbody id="subjectGradeBody">
                        <tr><td colspan="5" style="text-align:center;">Vui l√≤ng ch·ªçn l·ªõp v√† h·ªçc k·ª≥</td></tr>
                    </tbody>
                </table>
            </div>

        </div><!-- content -->
    </div><!-- main -->

    <!-- ========== POPUP QU·∫¢N L√ù H·ªåC K·ª≤ ========== -->
    <div class="modal-overlay" id="semesterRulesModal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h2>üìÖ Qu·∫£n l√Ω h·ªçc k·ª≥</h2>
                <button class="modal-close" id="closeSemesterRulesBtn">&times;</button>
            </div>

            <div class="modal-body">
                <div class="table-wrapper">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>M√£ h·ªçc k·ª≥</th>
                                <th>T√™n h·ªçc k·ª≥</th>
                                <th style="width:60px;">X√≥a</th>
                            </tr>
                        </thead>
                        <tbody id="semesterListBody">
                            <tr><td colspan="3" style="text-align:center;">ƒêang t·∫£i...</td></tr>
                        </tbody>
                    </table>
                </div>

                <div style="margin-top:16px; padding-top:16px; border-top:1px solid #e5e7eb;">
                    <h4 style="font-size:14px; margin-bottom:8px;">Th√™m h·ªçc k·ª≥ m·ªõi</h4>
                    <div style="display:flex; gap:8px;">
                        <input type="text" id="newSemesterId" placeholder="M√£ (VD: HK3)" style="flex:1; padding:8px; border:1px solid #d1d5db; border-radius:6px;">
                        <input type="text" id="newSemesterName" placeholder="T√™n (VD: H·ªçc k·ª≥ 3)" style="flex:2; padding:8px; border:1px solid #d1d5db; border-radius:6px;">
                        <button class="btn btn-primary" id="btnAddSemester">Th√™m</button>
                    </div>
                </div>

                <div class="modal-footer" style="margin-top: 16px;">
                    <button type="button" class="btn btn-outline" id="btnCloseSemesterRules">ƒê√≥ng</button>
                </div>
            </div>
        </div>
    </div>

    <!-- SCRIPT -->
    <script>
        // ========== LOAD DROPDOWNS ==========
        async function loadDropdowns() {
            try {
                // Load nƒÉm h·ªçc
                const yearRes = await fetch('/api/settings/school-years');
                const years = await yearRes.json();
                const yearSelect = document.getElementById('yearSelect');
                years.forEach(y => {
                    yearSelect.innerHTML += `<option value="${y.manamhoc}">${y.tennamhoc}</option>`;
                });

                // Load h·ªçc k·ª≥
                const semRes = await fetch('/api/settings/semesters');
                const semesters = await semRes.json();
                const semesterSelect = document.getElementById('semesterSelect');
                semesters.forEach(s => {
                    semesterSelect.innerHTML += `<option value="${s.mahocky}">${s.tenhocky}</option>`;
                });

                // Load kh·ªëi
                const gradeRes = await fetch('/api/settings/grade-levels');
                const grades = await gradeRes.json();
                const gradeSelect = document.getElementById('gradeSelect');
                grades.forEach(g => {
                    gradeSelect.innerHTML += `<option value="${g.makhoilop}">${g.tenkhoilop}</option>`;
                });
            } catch (error) {
                console.error('L·ªói load dropdowns:', error);
            }
        }

        // ========== LOAD L·ªöP THEO KH·ªêI ==========
        async function loadClasses() {
            const khoi = document.getElementById('gradeSelect').value;
            const namhoc = document.getElementById('yearSelect').value;
            const classSelect = document.getElementById('classSelect');
            
            classSelect.innerHTML = '<option value="">-- Ch·ªçn l·ªõp --</option>';
            
            if (!khoi) return;

            try {
                let url = '/api/classes';
                const params = new URLSearchParams();
                if (khoi) params.append('khoi', khoi);
                if (namhoc) params.append('namhoc', namhoc);
                if (params.toString()) url += '?' + params.toString();

                const response = await fetch(url);
                const classes = await response.json();
                
                classes.forEach(c => {
                    classSelect.innerHTML += `<option value="${c.malop}">${c.tenlop}</option>`;
                });
            } catch (error) {
                console.error('L·ªói load l·ªõp:', error);
            }
        }

        // ========== LOAD DANH S√ÅCH M√îN ƒê·ªÇ NH·∫¨P ƒêI·ªÇM ==========
        async function loadSubjectsForGrade() {
            const classId = document.getElementById('classSelect').value;
            const semester = document.getElementById('semesterSelect').value;
            const tbody = document.getElementById('subjectGradeBody');
            
            if (!classId || !semester) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Vui l√≤ng ch·ªçn l·ªõp v√† h·ªçc k·ª≥</td></tr>';
                return;
            }

            try {
                const response = await fetch('/api/subjects');
                const subjects = await response.json();
                
                if (subjects.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Kh√¥ng c√≥ m√¥n h·ªçc</td></tr>';
                    return;
                }

                tbody.innerHTML = subjects.map(mh => `
                    <tr>
                        <td>${mh.mamonhoc}</td>
                        <td>${mh.tenmonhoc}</td>
                        <td>${mh.heso}</td>
                        <td>${semester}</td>
                        <td style="text-align: right;">
                            <a href="/pages/grade_details.html?subject=${mh.mamonhoc}&class=${classId}&semester=${semester}" 
                               class="btn btn-primary" style="padding:6px 14px; font-size:14px;">Nh·∫≠p ƒëi·ªÉm</a>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('L·ªói:', error);
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:red;">L·ªói t·∫£i d·ªØ li·ªáu</td></tr>';
            }
        }

        // ========== EVENT LISTENERS ==========
        document.addEventListener('DOMContentLoaded', () => {
            loadDropdowns();
            
            document.getElementById('gradeSelect').addEventListener('change', loadClasses);
            document.getElementById('yearSelect').addEventListener('change', loadClasses);
            document.getElementById('classSelect').addEventListener('change', loadSubjectsForGrade);
            document.getElementById('semesterSelect').addEventListener('change', loadSubjectsForGrade);
        });

        // ========== POPUP QU·∫¢N L√ù H·ªåC K·ª≤ ==========
        const semesterRulesModal = document.getElementById('semesterRulesModal');
        
        async function loadSemesterList() {
            try {
                const response = await fetch('/api/settings/semesters');
                const semesters = await response.json();
                const tbody = document.getElementById('semesterListBody');
                
                if (semesters.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;">Ch∆∞a c√≥ h·ªçc k·ª≥</td></tr>';
                } else {
                    tbody.innerHTML = semesters.map(s => `
                        <tr>
                            <td>${s.mahocky}</td>
                            <td>${s.tenhocky}</td>
                            <td><button class="btn btn-danger" style="padding:4px 8px;font-size:12px;" onclick="deleteSemester('${s.mahocky}')">X√≥a</button></td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('L·ªói:', error);
            }
        }

        async function deleteSemester(id) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a h·ªçc k·ª≥ n√†y?')) return;
            
            try {
                const response = await fetch(`/api/settings/semesters/${id}`, { method: 'DELETE' });
                if (!response.ok) {
                    const result = await response.json();
                    throw new Error(result.error || 'L·ªói x√≥a');
                }
                loadSemesterList();
                loadDropdowns(); // Refresh dropdown
            } catch (error) {
                toastError(error.message);
            }
        }

        document.getElementById('btnAddSemester').onclick = async () => {
            const id = document.getElementById('newSemesterId').value.trim();
            const name = document.getElementById('newSemesterName').value.trim();
            
            if (!id || !name) {
                toastWarning('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß m√£ v√† t√™n h·ªçc k·ª≥!');
                return;
            }

            try {
                const response = await fetch('/api/settings/semesters', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ MaHocKy: id, TenHocKy: name })
                });
                
                if (!response.ok) {
                    const result = await response.json();
                    throw new Error(result.error || 'L·ªói th√™m');
                }
                
                document.getElementById('newSemesterId').value = '';
                document.getElementById('newSemesterName').value = '';
                loadSemesterList();
                loadDropdowns();
            } catch (error) {
                toastError(error.message);
            }
        };

        document.getElementById('btnSemesterRules').onclick = () => {
            loadSemesterList();
            semesterRulesModal.classList.add('show');
        };
        
        document.getElementById('closeSemesterRulesBtn').onclick = 
        document.getElementById('btnCloseSemesterRules').onclick = () => {
            semesterRulesModal.classList.remove('show');
        };
        
        semesterRulesModal.onclick = (e) => {
            if (e.target === semesterRulesModal) semesterRulesModal.classList.remove('show');
        };
    </script>

</body>
</html>
