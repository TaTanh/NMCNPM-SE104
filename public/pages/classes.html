<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Quản lý lớp học</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/layout/styles.css">
</head>

<body class="dashboard-body">

    <!-- SIDEBAR -->
    <aside class="sidebar">
        <div class="sidebar-logo">
            <img src="/assets/uit_logo.png" alt="UIT Logo">
            <span>QL Học Sinh</span>
        </div>

        <nav class="sidebar-menu">
            <a href="/pages/dashboard.html">Dashboard</a>
            <a href="/pages/students.html">Quản lý học sinh</a>
            <a href="/pages/classes.html" class="active">Quản lý lớp học</a>
            <a href="/pages/subject_list.html">Quản lý môn học</a>
            <a href="/pages/grade_select.html">Bảng điểm</a>
            <a href="/pages/reports.html">Báo cáo tổng kết</a>
            <a href="/pages/settings.html">Cài đặt hệ thống</a>
        </nav>
    </aside>

    <!-- MAIN -->
    <div class="main">

        <!-- HEADER -->
        <header class="topbar">
            <div class="page-title">Danh sách lớp</div>
            <div class="user-info">
                <span>Xin chào, Admin</span>
                <img src="/assets/user.png" class="avatar" alt="user">
            </div>
        </header>

        <!-- CONTENT -->
        <div class="content">

            <!-- TOOLBAR -->
            <div class="toolbar">
                <div class="search-box">
                    <input type="text" placeholder="Tìm theo tên hoặc mã lớp...">
                </div>

                <div class="toolbar-actions">
                    <button class="btn btn-outline" id="btnExportClass">Xuất Excel</button>

                    <div class="toolbar-actions-main">
                        <button class="btn btn-primary" id="btnAddClass">Thêm</button>
                        <button class="btn btn-edit" id="btnToggleEditClass">Sửa đổi</button>
                    </div>
                </div>
            </div>

            <!-- THANH SỬA / XÓA – hiện khi bấm Sửa đổi -->
            <div class="edit-actions" id="classEditActions">
                <button class="btn btn-secondary" id="btnEditClass">Sửa</button>
                <button class="btn btn-danger" id="btnDeleteClass">Xóa</button>
            </div>

            <!-- BẢNG DANH SÁCH LỚP -->
            <div class="table-wrapper">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th class="select-col"></th>
                            <th>Mã lớp</th>
                            <th>Tên lớp</th>
                            <th>Khối</th>
                            <th>Sĩ số</th>
                            <th>GVCN</th>
                            <th>Năm học</th>
                        </tr>
                    </thead>
                    <tbody id="classTableBody">
                        <tr><td colspan="7" style="text-align:center;">Đang tải dữ liệu...</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- PHÂN TRANG -->
            <div class="pagination">
                <a href="#" class="page-link disabled">&laquo;</a>
                <a href="#" class="page-link active">1</a>
                <a href="#" class="page-link">2</a>
                <a href="#" class="page-link">&raquo;</a>
            </div>

        </div><!-- /content -->

    </div><!-- /main -->

    <!-- ========== POPUP THÊM LỚP ========== -->
    <div class="modal-overlay" id="addClassModal">
        <div class="modal">
            <div class="modal-header">
                <h2>Thêm lớp mới</h2>
                <button class="modal-close" id="closeAddClassModalBtn">&times;</button>
            </div>

            <div class="modal-body">
                <form id="addClassForm">
                    <div class="modal-grid">
                        <div class="form-group">
                            <label>Mã lớp</label>
                            <input type="text" id="classCodeAdd" placeholder="VD: 10A3" required>
                        </div>

                        <div class="form-group">
                            <label>Tên lớp</label>
                            <input type="text" id="classNameAdd" placeholder="VD: Lớp 10A3" required>
                        </div>

                        <div class="form-group">
                            <label>Khối</label>
                            <select id="gradeLevelAdd" required>
                                <option value="">-- Chọn khối --</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Sĩ số</label>
                            <input type="number" id="classSizeAdd" placeholder="VD: 40" min="0" max="60" value="0">
                        </div>

                        <div class="form-group">
                            <label>Giáo viên chủ nhiệm</label>
                            <input type="text" id="homeroomTeacherAdd" placeholder="Tên GVCN">
                        </div>

                        <div class="form-group">
                            <label>Năm học</label>
                            <select id="schoolYearAdd" required>
                                <option value="">-- Chọn năm học --</option>
                            </select>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline" id="cancelAddClassBtn">Hủy</button>
                        <button type="submit" class="btn btn-primary">Lưu</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ========== POPUP SỬA LỚP ========== -->
    <div class="modal-overlay" id="editClassModal">
        <div class="modal">
            <div class="modal-header">
                <h2>Sửa lớp</h2>
                <button class="modal-close" id="closeEditClassModalBtn">&times;</button>
            </div>

            <div class="modal-body">
                <form id="editClassForm">
                    <div class="modal-grid">
                        <div class="form-group">
                            <label>Mã lớp</label>
                            <input type="text" id="classCodeEdit" readonly>
                        </div>

                        <div class="form-group">
                            <label>Tên lớp</label>
                            <input type="text" id="classNameEdit">
                        </div>

                        <div class="form-group">
                            <label>Khối</label>
                            <input type="number" id="gradeLevelEdit" min="1" max="12">
                        </div>

                        <div class="form-group">
                            <label>Sĩ số</label>
                            <input type="number" id="classSizeEdit" min="0" max="60">
                        </div>

                        <div class="form-group">
                            <label>Giáo viên chủ nhiệm</label>
                            <input type="text" id="homeroomTeacherEdit">
                        </div>

                        <div class="form-group">
                            <label>Năm học</label>
                            <input type="text" id="schoolYearEdit" placeholder="2024–2025">
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline" id="cancelEditClassBtn">Hủy</button>
                        <button type="submit" class="btn btn-primary">Lưu</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ========== POPUP XÓA LỚP ========== -->
    <div class="modal-overlay" id="deleteClassModal">
        <div class="modal">
            <div class="modal-header">
                <h2>Xóa lớp</h2>
                <button class="modal-close" id="closeDeleteClassModalBtn">&times;</button>
            </div>

            <div class="modal-body">
                <p id="deleteClassMessage">
                    Bạn có chắc chắn muốn xóa lớp này không?
                </p>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline" id="cancelDeleteClassBtn">Hủy</button>
                    <button type="button" class="btn btn-danger" id="btnConfirmDeleteClass">Xóa</button>
                </div>
            </div>
        </div>
    </div>

    <!-- SCRIPT -->
    <script>
        // ====== Lấy các phần tử cần dùng ======
        const classTableBody   = document.getElementById('classTableBody');

        const btnAddClass      = document.getElementById('btnAddClass');
        const btnToggleClass   = document.getElementById('btnToggleEditClass');
        const btnEditClass     = document.getElementById('btnEditClass');
        const btnDeleteClass   = document.getElementById('btnDeleteClass');

        // Modal
        const addClassModal    = document.getElementById('addClassModal');
        const editClassModal   = document.getElementById('editClassModal');
        const deleteClassModal = document.getElementById('deleteClassModal');

        const closeAddClassModalBtn    = document.getElementById('closeAddClassModalBtn');
        const cancelAddClassBtn        = document.getElementById('cancelAddClassBtn');

        const closeEditClassModalBtn   = document.getElementById('closeEditClassModalBtn');
        const cancelEditClassBtn       = document.getElementById('cancelEditClassBtn');

        const closeDeleteClassModalBtn = document.getElementById('closeDeleteClassModalBtn');
        const cancelDeleteClassBtn     = document.getElementById('cancelDeleteClassBtn');
        const deleteClassMessage       = document.getElementById('deleteClassMessage');
        const btnConfirmDeleteClass    = document.getElementById('btnConfirmDeleteClass');

        // Input trong form Sửa lớp
        const classCodeEdit       = document.getElementById('classCodeEdit');
        const classNameEdit       = document.getElementById('classNameEdit');
        const gradeLevelEdit      = document.getElementById('gradeLevelEdit');
        const homeroomTeacherEdit = document.getElementById('homeroomTeacherEdit');
        const schoolYearEdit      = document.getElementById('schoolYearEdit');

        let classSelectedRow  = null;
        let classSelectModeOn = false;

        // ========== LOAD DỮ LIỆU TỪ DATABASE ==========
        async function loadClasses() {
            try {
                const response = await fetch('/api/classes');
                if (!response.ok) throw new Error('Lỗi tải dữ liệu');
                
                const classes = await response.json();
                renderClassTable(classes);
            } catch (error) {
                console.error('Lỗi:', error);
                classTableBody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:red;">Lỗi kết nối database</td></tr>';
            }
        }

        function renderClassTable(classes) {
            if (classes.length === 0) {
                classTableBody.innerHTML = '<tr><td colspan="7" style="text-align:center;">Không có dữ liệu</td></tr>';
                return;
            }
            
            classTableBody.innerHTML = classes.map(lop => `
                <tr data-id="${lop.malop}">
                    <td class="select-cell">
                        <input type="checkbox" class="row-select-checkbox">
                    </td>
                    <td>${lop.malop}</td>
                    <td>${lop.tenlop}</td>
                    <td>${lop.khoi || ''}</td>
                    <td>${lop.siso || 0}</td>
                    <td></td>
                    <td>${lop.namhoc || ''}</td>
                </tr>
            `).join('');
            
            attachRowEvents();
        }

        // ========== LOAD KHỐI VÀ NĂM HỌC CHO DROPDOWN ==========
        async function loadDropdowns() {
            try {
                // Load khối lớp
                const khoiRes = await fetch('/api/settings/grade-levels');
                const khoiList = await khoiRes.json();
                const gradeLevelAdd = document.getElementById('gradeLevelAdd');
                gradeLevelAdd.innerHTML = '<option value="">-- Chọn khối --</option>';
                khoiList.forEach(k => {
                    gradeLevelAdd.innerHTML += `<option value="${k.makhoilop}">${k.tenkhoilop}</option>`;
                });
                
                // Load năm học
                const yearRes = await fetch('/api/settings/school-years');
                const yearList = await yearRes.json();
                const schoolYearAdd = document.getElementById('schoolYearAdd');
                schoolYearAdd.innerHTML = '<option value="">-- Chọn năm học --</option>';
                yearList.forEach(y => {
                    schoolYearAdd.innerHTML += `<option value="${y.manamhoc}">${y.tennamhoc}</option>`;
                });
            } catch (error) {
                console.error('Lỗi load dropdowns:', error);
            }
        }

        // ========== GẮN EVENT CHO ROWS ==========
        function attachRowEvents() {
            const rows = classTableBody.querySelectorAll('tr');
            const checkboxes = classTableBody.querySelectorAll('.row-select-checkbox');
            
            checkboxes.forEach(cb => {
                cb.addEventListener('change', () => {
                    if (!classSelectModeOn) {
                        cb.checked = false;
                        return;
                    }
                    if (cb.checked) {
                        checkboxes.forEach(other => {
                            if (other !== cb) {
                                other.checked = false;
                                other.closest('tr').classList.remove('row-selected');
                            }
                        });
                        classSelectedRow = cb.closest('tr');
                        classSelectedRow.classList.add('row-selected');
                    } else {
                        cb.closest('tr').classList.remove('row-selected');
                        if (classSelectedRow === cb.closest('tr')) classSelectedRow = null;
                    }
                });
            });

            rows.forEach(row => {
                row.addEventListener('click', (e) => {
                    if (!classSelectModeOn) return;
                    if (e.target.classList.contains('row-select-checkbox')) return;

                    const cb = row.querySelector('.row-select-checkbox');
                    if (cb) {
                        cb.checked = !cb.checked;
                        cb.dispatchEvent(new Event('change'));
                    }
                });
            });
        }

        function resetClassSelection() {
            classSelectedRow = null;
            const checkboxes = classTableBody.querySelectorAll('.row-select-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = false;
                cb.closest('tr').classList.remove('row-selected');
            });
        }

        function enterClassSelectMode() {
            classSelectModeOn = true;
            document.body.classList.add('select-mode');
            btnToggleClass.classList.add('btn-toggle-active');
            resetClassSelection();
        }

        function exitClassSelectMode() {
            classSelectModeOn = false;
            document.body.classList.remove('select-mode');
            btnToggleClass.classList.remove('btn-toggle-active');
            resetClassSelection();
        }

        // Bấm nút "Sửa đổi"
        btnToggleClass.addEventListener('click', (e) => {
            e.preventDefault();
            if (classSelectModeOn) {
                exitClassSelectMode();
            } else {
                enterClassSelectMode();
            }
        });

        // ========= POPUP THÊM LỚP =========
        const addClassForm = document.getElementById('addClassForm');

        btnAddClass.addEventListener('click', (e) => {
            e.preventDefault();
            addClassModal.classList.add('show');
        });

        function closeAddClassModal() {
            addClassModal.classList.remove('show');
            addClassForm.reset();
        }

        closeAddClassModalBtn.addEventListener('click', closeAddClassModal);
        cancelAddClassBtn.addEventListener('click', closeAddClassModal);

        addClassModal.addEventListener('click', (e) => {
            if (e.target === addClassModal) {
                closeAddClassModal();
            }
        });

        addClassForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const data = {
                MaLop: document.getElementById('classCodeAdd').value,
                TenLop: document.getElementById('classNameAdd').value,
                MaKhoiLop: document.getElementById('gradeLevelAdd').value,
                MaNamHoc: document.getElementById('schoolYearAdd').value,
                SiSo: document.getElementById('classSizeAdd').value || 0
            };
            
            try {
                const response = await fetch('/api/classes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || 'Lỗi thêm lớp');
                }
                
                alert('Thêm lớp thành công!');
                closeAddClassModal();
                loadClasses();
            } catch (error) {
                alert('Lỗi: ' + error.message);
            }
        });

        // ========= POPUP SỬA LỚP =========
        const editClassForm = document.getElementById('editClassForm');

        btnEditClass.addEventListener('click', (e) => {
            e.preventDefault();

            if (!classSelectModeOn) {
                alert('Hãy bấm "Sửa đổi" và chọn một lớp trước.');
                return;
            }
            if (!classSelectedRow) {
                alert('Vui lòng chọn một lớp để sửa.');
                return;
            }

            const cells = classSelectedRow.querySelectorAll('td');
            const maLop  = cells[1].textContent.trim();
            const tenLop = cells[2].textContent.trim();
            const khoi   = cells[3].textContent.trim();
            const siSo   = cells[4].textContent.trim();
            const gvcn   = cells[5].textContent.trim();
            const namHoc = cells[6].textContent.trim();

            classCodeEdit.value       = maLop;
            classNameEdit.value       = tenLop;
            gradeLevelEdit.value      = khoi;
            document.getElementById('classSizeEdit').value = siSo;
            homeroomTeacherEdit.value = gvcn;
            schoolYearEdit.value      = namHoc;

            editClassModal.classList.add('show');
        });

        function closeEditClassModal() {
            editClassModal.classList.remove('show');
            editClassForm.reset();
        }

        closeEditClassModalBtn.addEventListener('click', closeEditClassModal);
        cancelEditClassBtn.addEventListener('click', closeEditClassModal);

        editClassModal.addEventListener('click', (e) => {
            if (e.target === editClassModal) {
                closeEditClassModal();
            }
        });

        editClassForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const maLop = classCodeEdit.value;
            const data = {
                TenLop: classNameEdit.value,
                MaKhoiLop: gradeLevelEdit.value,
                MaNamHoc: schoolYearEdit.value,
                SiSo: document.getElementById('classSizeEdit').value || 0
            };
            
            try {
                const response = await fetch(`/api/classes/${maLop}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || 'Lỗi cập nhật lớp');
                }
                
                alert('Cập nhật lớp thành công!');
                closeEditClassModal();
                exitClassSelectMode();
                loadClasses();
            } catch (error) {
                alert('Lỗi: ' + error.message);
            }
        });

        // ========= POPUP XÓA LỚP =========
        btnDeleteClass.addEventListener('click', (e) => {
            e.preventDefault();

            if (!classSelectModeOn) {
                alert('Hãy bấm "Sửa đổi" và chọn một lớp trước.');
                return;
            }
            if (!classSelectedRow) {
                alert('Vui lòng chọn một lớp để xóa.');
                return;
            }

            const cells = classSelectedRow.querySelectorAll('td');
            const maLop  = cells[1].textContent.trim();
            const tenLop = cells[2].textContent.trim();

            deleteClassMessage.textContent =
                `Bạn có chắc chắn muốn xóa lớp ${tenLop} (Mã lớp: ${maLop}) không?`;

            deleteClassModal.classList.add('show');
        });

        function closeDeleteClassModal() {
            deleteClassModal.classList.remove('show');
        }

        closeDeleteClassModalBtn.addEventListener('click', closeDeleteClassModal);
        cancelDeleteClassBtn.addEventListener('click', closeDeleteClassModal);

        deleteClassModal.addEventListener('click', (e) => {
            if (e.target === deleteClassModal) {
                closeDeleteClassModal();
            }
        });

        btnConfirmDeleteClass.addEventListener('click', async () => {
            const maLop = classSelectedRow.querySelectorAll('td')[1].textContent.trim();
            
            try {
                const response = await fetch(`/api/classes/${maLop}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || 'Lỗi xóa lớp');
                }
                
                alert('Đã xóa lớp!');
                closeDeleteClassModal();
                exitClassSelectMode();
                loadClasses();
            } catch (error) {
                alert('Lỗi: ' + error.message);
            }
        });

        // ========== KHỞI TẠO ==========
        document.addEventListener('DOMContentLoaded', () => {
            loadDropdowns();
            loadClasses();
        });
    </script>

</body>
</html>
