<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Qu·∫£n l√Ω l·ªõp h·ªçc</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/layout/styles.css">
    <script src="/js/toast.js"></script>
</head>

<body class="dashboard-body">

    <!-- SIDEBAR -->
    <aside class="sidebar">
        <div class="sidebar-logo">
            <img src="/assets/uit_logo.png" alt="UIT Logo">
            <span>QL H·ªçc Sinh</span>
        </div>

        <nav class="sidebar-menu">
            <a href="/pages/dashboard.html">Dashboard</a>
            <a href="/pages/students.html">Qu·∫£n l√Ω h·ªçc sinh</a>
            <a href="/pages/classes.html" class="active">Qu·∫£n l√Ω l·ªõp h·ªçc</a>
            <a href="/pages/subject_list.html">Qu·∫£n l√Ω m√¥n h·ªçc</a>
            <a href="/pages/grade_select.html">B·∫£ng ƒëi·ªÉm</a>
            <a href="/pages/reports.html">B√°o c√°o t·ªïng k·∫øt</a>
        </nav>
    </aside>

    <!-- MAIN -->
    <div class="main">

        <!-- HEADER -->
        <header class="topbar">
            <div class="page-title">Danh s√°ch l·ªõp</div>
            <div class="user-info">
                <span>Xin ch√†o, Admin</span>
                <img src="/assets/user.png" class="avatar" alt="user">
            </div>
        </header>

        <!-- CONTENT -->
        <div class="content">

            <!-- TOOLBAR -->
            <div class="toolbar">
                <div class="search-box">
                    <input type="text" placeholder="T√¨m theo t√™n ho·∫∑c m√£ l·ªõp...">
                </div>

                <div class="toolbar-actions">
                    <button class="btn btn-outline" id="btnClassRules">Thay ƒë·ªïi quy ƒë·ªãnh</button>
                    <button class="btn btn-print" onclick="window.print()">üñ®Ô∏è In</button>
                    <button class="btn btn-outline" id="btnExportClass">Xu·∫•t Excel</button>

                    <div class="toolbar-actions-main">
                        <button class="btn btn-primary" id="btnAddClass">Th√™m</button>
                        <button class="btn btn-edit" id="btnToggleEditClass">S·ª≠a ƒë·ªïi</button>
                    </div>
                </div>
            </div>

            <!-- THANH S·ª¨A / X√ìA ‚Äì hi·ªán khi b·∫•m S·ª≠a ƒë·ªïi -->
            <div class="edit-actions" id="classEditActions">
                <button class="btn btn-secondary" id="btnEditClass">S·ª≠a</button>
                <button class="btn btn-danger" id="btnDeleteClass">X√≥a</button>
            </div>

            <!-- B·∫¢NG DANH S√ÅCH L·ªöP -->
            <div class="table-wrapper">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th class="select-col"></th>
                            <th>M√£ l·ªõp</th>
                            <th>T√™n l·ªõp</th>
                            <th>Kh·ªëi</th>
                            <th>Sƒ© s·ªë</th>
                            <th>GVCN</th>
                            <th>NƒÉm h·ªçc</th>
                            <th>H·ªçc sinh</th>
                        </tr>
                    </thead>
                    <tbody id="classTableBody">
                        <tr><td colspan="8" style="text-align:center;">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- PH√ÇN TRANG -->
            <div class="pagination">
                <a href="#" class="page-link disabled">&laquo;</a>
                <a href="#" class="page-link active">1</a>
                <a href="#" class="page-link">2</a>
                <a href="#" class="page-link">&raquo;</a>
            </div>

        </div><!-- /content -->

    </div><!-- /main -->

    <!-- ========== POPUP TH√äM L·ªöP ========== -->
    <div class="modal-overlay" id="addClassModal">
        <div class="modal">
            <div class="modal-header">
                <h2>Th√™m l·ªõp m·ªõi</h2>
                <button class="modal-close" id="closeAddClassModalBtn">&times;</button>
            </div>

            <div class="modal-body">
                <form id="addClassForm" novalidate>
                    <div class="modal-grid">
                        <div class="form-group">
                            <label class="required-label">M√£ l·ªõp</label>
                            <input type="text" id="classCodeAdd" placeholder="VD: 10A3" required>
                            <span class="error-message">Vui l√≤ng nh·∫≠p m√£ l·ªõp</span>
                        </div>

                        <div class="form-group">
                            <label class="required-label">T√™n l·ªõp</label>
                            <input type="text" id="classNameAdd" placeholder="VD: L·ªõp 10A3" required>
                            <span class="error-message">Vui l√≤ng nh·∫≠p t√™n l·ªõp</span>
                        </div>

                        <div class="form-group">
                            <label class="required-label">Kh·ªëi</label>
                            <select id="gradeLevelAdd" required>
                                <option value="">-- Ch·ªçn kh·ªëi --</option>
                            </select>
                            <span class="error-message">Vui l√≤ng ch·ªçn kh·ªëi</span>
                        </div>

                        <div class="form-group">
                            <label>Sƒ© s·ªë</label>
                            <input type="number" id="classSizeAdd" placeholder="VD: 40" min="0" max="60" value="0">
                            <span class="input-hint">T·ªëi ƒëa 60 h·ªçc sinh</span>
                        </div>

                        <div class="form-group">
                            <label>Gi√°o vi√™n ch·ªß nhi·ªám</label>
                            <input type="text" id="homeroomTeacherAdd" placeholder="T√™n GVCN">
                        </div>

                        <div class="form-group">
                            <label class="required-label">NƒÉm h·ªçc</label>
                            <select id="schoolYearAdd" required>
                                <option value="">-- Ch·ªçn nƒÉm h·ªçc --</option>
                            </select>
                            <span class="error-message">Vui l√≤ng ch·ªçn nƒÉm h·ªçc</span>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline" id="cancelAddClassBtn">H·ªßy</button>
                        <button type="submit" class="btn btn-primary">L∆∞u</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ========== POPUP S·ª¨A L·ªöP ========== -->
    <div class="modal-overlay" id="editClassModal">
        <div class="modal">
            <div class="modal-header">
                <h2>S·ª≠a l·ªõp</h2>
                <button class="modal-close" id="closeEditClassModalBtn">&times;</button>
            </div>

            <div class="modal-body">
                <form id="editClassForm">
                    <div class="modal-grid">
                        <div class="form-group">
                            <label>M√£ l·ªõp</label>
                            <input type="text" id="classCodeEdit" readonly>
                        </div>

                        <div class="form-group">
                            <label>T√™n l·ªõp</label>
                            <input type="text" id="classNameEdit">
                        </div>

                        <div class="form-group">
                            <label>Kh·ªëi</label>
                            <input type="number" id="gradeLevelEdit" min="1" max="12">
                        </div>

                        <div class="form-group">
                            <label>Sƒ© s·ªë</label>
                            <input type="number" id="classSizeEdit" min="0" max="60">
                        </div>

                        <div class="form-group">
                            <label>Gi√°o vi√™n ch·ªß nhi·ªám</label>
                            <input type="text" id="homeroomTeacherEdit">
                        </div>

                        <div class="form-group">
                            <label>NƒÉm h·ªçc</label>
                            <input type="text" id="schoolYearEdit" placeholder="2024‚Äì2025">
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline" id="cancelEditClassBtn">H·ªßy</button>
                        <button type="submit" class="btn btn-primary">L∆∞u</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ========== POPUP X√ìA L·ªöP ========== -->
    <div class="modal-overlay" id="deleteClassModal">
        <div class="modal">
            <div class="modal-header">
                <h2>X√≥a l·ªõp</h2>
                <button class="modal-close" id="closeDeleteClassModalBtn">&times;</button>
            </div>

            <div class="modal-body">
                <p id="deleteClassMessage">
                    B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a l·ªõp n√†y kh√¥ng?
                </p>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline" id="cancelDeleteClassBtn">H·ªßy</button>
                    <button type="button" class="btn btn-danger" id="btnConfirmDeleteClass">X√≥a</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== POPUP XEM DANH S√ÅCH H·ªåC SINH ========== -->
    <div class="modal-overlay" id="viewStudentsModal">
        <div class="modal modal-large">
            <div class="modal-header">
                <h2 id="viewStudentsTitle">Danh s√°ch h·ªçc sinh l·ªõp</h2>
                <button class="modal-close" id="closeViewStudentsModalBtn">&times;</button>
            </div>

            <div class="modal-body">
                <div class="table-wrapper">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>STT</th>
                                <th>M√£ HS</th>
                                <th>H·ªç t√™n</th>
                                <th>Gi·ªõi t√≠nh</th>
                                <th>Ng√†y sinh</th>
                                <th>ƒê·ªãa ch·ªâ</th>
                                <th>Email</th>
                            </tr>
                        </thead>
                        <tbody id="classStudentsTableBody">
                            <tr><td colspan="7" style="text-align:center;">ƒêang t·∫£i...</td></tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="modal-footer" style="margin-top: 16px;">
                    <span id="studentCountInfo" style="margin-right: auto; color: #666;"></span>
                    <button type="button" class="btn btn-outline" id="closeViewStudentsBtn">ƒê√≥ng</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== POPUP QUY ƒê·ªäNH L·ªöP H·ªåC ========== -->
    <div class="modal-overlay" id="classRulesModal">
        <div class="modal" style="max-width: 480px;">
            <div class="modal-header">
                <h2>‚öôÔ∏è Quy ƒë·ªãnh v·ªÅ l·ªõp h·ªçc</h2>
                <button class="modal-close" id="closeClassRulesBtn">&times;</button>
            </div>

            <div class="modal-body">
                <div class="config-grid">
                    <div class="config-card">
                        <div class="config-label">Sƒ© s·ªë t·ªëi ƒëa</div>
                        <input type="number" id="ruleSiSoToiDa" value="40" min="1" max="60">
                        <div class="config-hint">S·ªë h·ªçc sinh t·ªëi ƒëa trong m·ªôt l·ªõp</div>
                    </div>
                </div>

                <h3 style="margin-top: 20px; margin-bottom: 12px; font-size: 15px;">Danh s√°ch kh·ªëi l·ªõp</h3>
                <div class="table-wrapper">
                    <table class="data-table" id="khoiLopTable">
                        <thead>
                            <tr>
                                <th>M√£ kh·ªëi</th>
                                <th>T√™n kh·ªëi</th>
                            </tr>
                        </thead>
                        <tbody id="khoiLopBody">
                            <tr><td colspan="2" style="text-align:center;">ƒêang t·∫£i...</td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- Qu·∫£n l√Ω nƒÉm h·ªçc -->
                <h3 style="margin-top: 24px; margin-bottom: 12px; font-size: 15px;">üìÖ Qu·∫£n l√Ω nƒÉm h·ªçc</h3>
                <div class="table-wrapper">
                    <table class="data-table" id="namHocTable">
                        <thead>
                            <tr>
                                <th>M√£ nƒÉm h·ªçc</th>
                                <th>T√™n nƒÉm h·ªçc</th>
                                <th style="width: 100px;">Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody id="namHocBody">
                            <tr><td colspan="3" style="text-align:center;">ƒêang t·∫£i...</td></tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Form th√™m nƒÉm h·ªçc m·ªõi -->
                <div style="margin-top: 12px; padding: 12px; background: #f8f9fa; border-radius: 8px;">
                    <div style="font-weight: 500; margin-bottom: 8px;">‚ûï Th√™m nƒÉm h·ªçc m·ªõi</div>
                    <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                        <input type="text" id="newMaNamHoc" placeholder="M√£ nƒÉm h·ªçc (VD: 2024-2025)" style="flex: 1; min-width: 150px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <input type="text" id="newTenNamHoc" placeholder="T√™n nƒÉm h·ªçc (VD: NƒÉm h·ªçc 2024-2025)" style="flex: 1; min-width: 180px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <button type="button" class="btn btn-primary" onclick="addSchoolYear()" style="white-space: nowrap;">Th√™m</button>
                    </div>
                </div>

                <div class="modal-footer" style="margin-top: 16px;">
                    <button type="button" class="btn btn-outline" id="btnCancelClassRules">H·ªßy</button>
                    <button type="button" class="btn btn-primary" id="btnSaveClassRules">L∆∞u thay ƒë·ªïi</button>
                </div>
            </div>
        </div>
    </div>

    <!-- SCRIPT -->
    <script>
        // ====== L·∫•y c√°c ph·∫ßn t·ª≠ c·∫ßn d√πng ======
        const classTableBody   = document.getElementById('classTableBody');
        const searchInput      = document.querySelector('.search-box input');

        const btnAddClass      = document.getElementById('btnAddClass');
        const btnToggleClass   = document.getElementById('btnToggleEditClass');
        const btnEditClass     = document.getElementById('btnEditClass');
        const btnDeleteClass   = document.getElementById('btnDeleteClass');

        // Modal
        const addClassModal    = document.getElementById('addClassModal');
        const editClassModal   = document.getElementById('editClassModal');
        const deleteClassModal = document.getElementById('deleteClassModal');

        const closeAddClassModalBtn    = document.getElementById('closeAddClassModalBtn');
        const cancelAddClassBtn        = document.getElementById('cancelAddClassBtn');

        const closeEditClassModalBtn   = document.getElementById('closeEditClassModalBtn');
        const cancelEditClassBtn       = document.getElementById('cancelEditClassBtn');

        const closeDeleteClassModalBtn = document.getElementById('closeDeleteClassModalBtn');
        const cancelDeleteClassBtn     = document.getElementById('cancelDeleteClassBtn');
        const deleteClassMessage       = document.getElementById('deleteClassMessage');
        const btnConfirmDeleteClass    = document.getElementById('btnConfirmDeleteClass');

        // Input trong form S·ª≠a l·ªõp
        const classCodeEdit       = document.getElementById('classCodeEdit');
        const classNameEdit       = document.getElementById('classNameEdit');
        const gradeLevelEdit      = document.getElementById('gradeLevelEdit');
        const homeroomTeacherEdit = document.getElementById('homeroomTeacherEdit');
        const schoolYearEdit      = document.getElementById('schoolYearEdit');

        let classSelectedRow  = null;
        let classSelectModeOn = false;
        let allClasses = []; // L∆∞u to√†n b·ªô d·ªØ li·ªáu ƒë·ªÉ t√¨m ki·∫øm

        // ========== T√åM KI·∫æM L·ªöP H·ªåC ==========
        searchInput.addEventListener('input', () => {
            const keyword = searchInput.value.toLowerCase().trim();
            if (!keyword) {
                renderClassTable(allClasses);
                return;
            }
            const filtered = allClasses.filter(lop => 
                lop.malop.toLowerCase().includes(keyword) ||
                lop.tenlop.toLowerCase().includes(keyword) ||
                (lop.khoi && lop.khoi.toString().includes(keyword)) ||
                (lop.namhoc && lop.namhoc.toLowerCase().includes(keyword))
            );
            renderClassTable(filtered);
        });

        // ========== LOAD D·ªÆ LI·ªÜU T·ª™ DATABASE ==========
        async function loadClasses() {
            try {
                const response = await fetch('/api/classes');
                if (!response.ok) throw new Error('L·ªói t·∫£i d·ªØ li·ªáu');
                
                const classes = await response.json();
                allClasses = classes; // L∆∞u l·∫°i ƒë·ªÉ t√¨m ki·∫øm
                renderClassTable(classes);
            } catch (error) {
                console.error('L·ªói:', error);
                classTableBody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:red;">L·ªói k·∫øt n·ªëi database</td></tr>';
            }
        }

        function renderClassTable(classes) {
            if (classes.length === 0) {
                classTableBody.innerHTML = '<tr><td colspan="8" style="text-align:center;">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>';
                return;
            }
            
            classTableBody.innerHTML = classes.map(lop => `
                <tr data-id="${lop.malop}">
                    <td class="select-cell">
                        <input type="checkbox" class="row-select-checkbox">
                    </td>
                    <td>${lop.malop}</td>
                    <td>${lop.tenlop}</td>
                    <td>${lop.khoi || ''}</td>
                    <td>${lop.siso || 0}</td>
                    <td></td>
                    <td>${lop.namhoc || ''}</td>
                    <td>
                        <button class="btn-view-students" onclick="viewClassStudents('${lop.malop}', '${lop.tenlop}')">
                            üëÅ Xem
                        </button>
                    </td>
                </tr>
            `).join('');
            
            attachRowEvents();
        }

        // ========== LOAD KH·ªêI V√Ä NƒÇM H·ªåC CHO DROPDOWN ==========
        async function loadDropdowns() {
            try {
                // Load kh·ªëi l·ªõp
                const khoiRes = await fetch('/api/settings/grade-levels');
                const khoiList = await khoiRes.json();
                const gradeLevelAdd = document.getElementById('gradeLevelAdd');
                gradeLevelAdd.innerHTML = '<option value="">-- Ch·ªçn kh·ªëi --</option>';
                khoiList.forEach(k => {
                    gradeLevelAdd.innerHTML += `<option value="${k.makhoilop}">${k.tenkhoilop}</option>`;
                });
                
                // Load nƒÉm h·ªçc
                const yearRes = await fetch('/api/settings/school-years');
                const yearList = await yearRes.json();
                const schoolYearAdd = document.getElementById('schoolYearAdd');
                schoolYearAdd.innerHTML = '<option value="">-- Ch·ªçn nƒÉm h·ªçc --</option>';
                yearList.forEach(y => {
                    schoolYearAdd.innerHTML += `<option value="${y.manamhoc}">${y.tennamhoc}</option>`;
                });
            } catch (error) {
                console.error('L·ªói load dropdowns:', error);
            }
        }

        // ========== G·∫ÆN EVENT CHO ROWS ==========
        function attachRowEvents() {
            const rows = classTableBody.querySelectorAll('tr');
            const checkboxes = classTableBody.querySelectorAll('.row-select-checkbox');
            
            checkboxes.forEach(cb => {
                cb.addEventListener('change', () => {
                    if (!classSelectModeOn) {
                        cb.checked = false;
                        return;
                    }
                    if (cb.checked) {
                        checkboxes.forEach(other => {
                            if (other !== cb) {
                                other.checked = false;
                                other.closest('tr').classList.remove('row-selected');
                            }
                        });
                        classSelectedRow = cb.closest('tr');
                        classSelectedRow.classList.add('row-selected');
                    } else {
                        cb.closest('tr').classList.remove('row-selected');
                        if (classSelectedRow === cb.closest('tr')) classSelectedRow = null;
                    }
                });
            });

            rows.forEach(row => {
                row.addEventListener('click', (e) => {
                    if (!classSelectModeOn) return;
                    if (e.target.classList.contains('row-select-checkbox')) return;

                    const cb = row.querySelector('.row-select-checkbox');
                    if (cb) {
                        cb.checked = !cb.checked;
                        cb.dispatchEvent(new Event('change'));
                    }
                });
            });
        }

        function resetClassSelection() {
            classSelectedRow = null;
            const checkboxes = classTableBody.querySelectorAll('.row-select-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = false;
                cb.closest('tr').classList.remove('row-selected');
            });
        }

        function enterClassSelectMode() {
            classSelectModeOn = true;
            document.body.classList.add('select-mode');
            btnToggleClass.classList.add('btn-toggle-active');
            resetClassSelection();
        }

        function exitClassSelectMode() {
            classSelectModeOn = false;
            document.body.classList.remove('select-mode');
            btnToggleClass.classList.remove('btn-toggle-active');
            resetClassSelection();
        }

        // B·∫•m n√∫t "S·ª≠a ƒë·ªïi"
        btnToggleClass.addEventListener('click', (e) => {
            e.preventDefault();
            if (classSelectModeOn) {
                exitClassSelectMode();
            } else {
                enterClassSelectMode();
            }
        });

        // ========= POPUP TH√äM L·ªöP =========
        const addClassForm = document.getElementById('addClassForm');

        btnAddClass.addEventListener('click', (e) => {
            e.preventDefault();
            addClassModal.classList.add('show');
        });

        function closeAddClassModal() {
            addClassModal.classList.remove('show');
            addClassForm.reset();
        }

        closeAddClassModalBtn.addEventListener('click', closeAddClassModal);
        cancelAddClassBtn.addEventListener('click', closeAddClassModal);

        addClassModal.addEventListener('click', (e) => {
            if (e.target === addClassModal) {
                closeAddClassModal();
            }
        });

        addClassForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const data = {
                MaLop: document.getElementById('classCodeAdd').value,
                TenLop: document.getElementById('classNameAdd').value,
                MaKhoiLop: document.getElementById('gradeLevelAdd').value,
                MaNamHoc: document.getElementById('schoolYearAdd').value,
                SiSo: document.getElementById('classSizeAdd').value || 0
            };
            
            try {
                const response = await fetch('/api/classes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || 'L·ªói th√™m l·ªõp');
                }
                
                toastSuccess('Th√™m l·ªõp th√†nh c√¥ng!');
                closeAddClassModal();
                loadClasses();
            } catch (error) {
                toastError(error.message);
            }
        });

        // ========= POPUP S·ª¨A L·ªöP =========
        const editClassForm = document.getElementById('editClassForm');

        btnEditClass.addEventListener('click', (e) => {
            e.preventDefault();

            if (!classSelectModeOn) {
                toastWarning('H√£y b·∫•m "S·ª≠a ƒë·ªïi" v√† ch·ªçn m·ªôt l·ªõp tr∆∞·ªõc.');
                return;
            }
            if (!classSelectedRow) {
                toastWarning('Vui l√≤ng ch·ªçn m·ªôt l·ªõp ƒë·ªÉ s·ª≠a.');
                return;
            }

            const cells = classSelectedRow.querySelectorAll('td');
            const maLop  = cells[1].textContent.trim();
            const tenLop = cells[2].textContent.trim();
            const khoi   = cells[3].textContent.trim();
            const siSo   = cells[4].textContent.trim();
            const gvcn   = cells[5].textContent.trim();
            const namHoc = cells[6].textContent.trim();

            classCodeEdit.value       = maLop;
            classNameEdit.value       = tenLop;
            gradeLevelEdit.value      = khoi;
            document.getElementById('classSizeEdit').value = siSo;
            homeroomTeacherEdit.value = gvcn;
            schoolYearEdit.value      = namHoc;

            editClassModal.classList.add('show');
        });

        function closeEditClassModal() {
            editClassModal.classList.remove('show');
            editClassForm.reset();
        }

        closeEditClassModalBtn.addEventListener('click', closeEditClassModal);
        cancelEditClassBtn.addEventListener('click', closeEditClassModal);

        editClassModal.addEventListener('click', (e) => {
            if (e.target === editClassModal) {
                closeEditClassModal();
            }
        });

        editClassForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const maLop = classCodeEdit.value;
            const data = {
                TenLop: classNameEdit.value,
                MaKhoiLop: gradeLevelEdit.value,
                MaNamHoc: schoolYearEdit.value,
                SiSo: document.getElementById('classSizeEdit').value || 0
            };
            
            try {
                const response = await fetch(`/api/classes/${maLop}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || 'L·ªói c·∫≠p nh·∫≠t l·ªõp');
                }
                
                toastSuccess('C·∫≠p nh·∫≠t l·ªõp th√†nh c√¥ng!');
                closeEditClassModal();
                exitClassSelectMode();
                loadClasses();
            } catch (error) {
                toastError(error.message);
            }
        });

        // ========= POPUP X√ìA L·ªöP =========
        btnDeleteClass.addEventListener('click', (e) => {
            e.preventDefault();

            if (!classSelectModeOn) {
                toastWarning('H√£y b·∫•m "S·ª≠a ƒë·ªïi" v√† ch·ªçn m·ªôt l·ªõp tr∆∞·ªõc.');
                return;
            }
            if (!classSelectedRow) {
                toastWarning('Vui l√≤ng ch·ªçn m·ªôt l·ªõp ƒë·ªÉ x√≥a.');
                return;
            }

            const cells = classSelectedRow.querySelectorAll('td');
            const maLop  = cells[1].textContent.trim();
            const tenLop = cells[2].textContent.trim();

            deleteClassMessage.textContent =
                `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a l·ªõp ${tenLop} (M√£ l·ªõp: ${maLop}) kh√¥ng?`;

            deleteClassModal.classList.add('show');
        });

        function closeDeleteClassModal() {
            deleteClassModal.classList.remove('show');
        }

        closeDeleteClassModalBtn.addEventListener('click', closeDeleteClassModal);
        cancelDeleteClassBtn.addEventListener('click', closeDeleteClassModal);

        deleteClassModal.addEventListener('click', (e) => {
            if (e.target === deleteClassModal) {
                closeDeleteClassModal();
            }
        });

        btnConfirmDeleteClass.addEventListener('click', async () => {
            const maLop = classSelectedRow.querySelectorAll('td')[1].textContent.trim();
            
            try {
                const response = await fetch(`/api/classes/${maLop}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || 'L·ªói x√≥a l·ªõp');
                }
                
                toastSuccess('ƒê√£ x√≥a l·ªõp!');
                closeDeleteClassModal();
                exitClassSelectMode();
                loadClasses();
            } catch (error) {
                toastError(error.message);
            }
        });

        // ========== KH·ªûI T·∫†O ==========
        document.addEventListener('DOMContentLoaded', () => {
            loadDropdowns();
            loadClasses();
        });

        /* ========= POPUP XEM DANH S√ÅCH H·ªåC SINH ========= */
        const viewStudentsModal = document.getElementById('viewStudentsModal');
        const classStudentsTableBody = document.getElementById('classStudentsTableBody');

        function formatDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        async function viewClassStudents(maLop, tenLop) {
            document.getElementById('viewStudentsTitle').textContent = `Danh s√°ch h·ªçc sinh l·ªõp ${tenLop}`;
            classStudentsTableBody.innerHTML = '<tr><td colspan="7" style="text-align:center;">ƒêang t·∫£i...</td></tr>';
            viewStudentsModal.classList.add('show');
            
            try {
                const response = await fetch(`/api/classes/${maLop}/students`);
                if (!response.ok) throw new Error('L·ªói t·∫£i d·ªØ li·ªáu');
                
                const students = await response.json();
                
                if (students.length === 0) {
                    classStudentsTableBody.innerHTML = '<tr><td colspan="7" style="text-align:center;">L·ªõp ch∆∞a c√≥ h·ªçc sinh n√†o</td></tr>';
                    document.getElementById('studentCountInfo').textContent = 'Sƒ© s·ªë: 0 h·ªçc sinh';
                    return;
                }
                
                classStudentsTableBody.innerHTML = students.map((hs, index) => `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${hs.mahocsinh}</td>
                        <td>${hs.hoten}</td>
                        <td>${hs.gioitinh || ''}</td>
                        <td>${formatDate(hs.ngaysinh)}</td>
                        <td>${hs.diachi || ''}</td>
                        <td>${hs.email || ''}</td>
                    </tr>
                `).join('');
                
                document.getElementById('studentCountInfo').textContent = `Sƒ© s·ªë: ${students.length} h·ªçc sinh`;
            } catch (error) {
                console.error('L·ªói:', error);
                classStudentsTableBody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:red;">L·ªói t·∫£i d·ªØ li·ªáu</td></tr>';
            }
        }

        function closeViewStudentsModal() {
            viewStudentsModal.classList.remove('show');
        }

        document.getElementById('closeViewStudentsModalBtn').onclick = closeViewStudentsModal;
        document.getElementById('closeViewStudentsBtn').onclick = closeViewStudentsModal;

        viewStudentsModal.addEventListener('click', (e) => {
            if (e.target === viewStudentsModal) {
                closeViewStudentsModal();
            }
        });

        // ========== POPUP QUY ƒê·ªäNH L·ªöP H·ªåC ==========
        const classRulesModal = document.getElementById('classRulesModal');
        const btnClassRules = document.getElementById('btnClassRules');
        
        async function loadClassRules() {
            try {
                // Load sƒ© s·ªë t·ªëi ƒëa
                const paramsRes = await fetch('/api/settings/params');
                const params = await paramsRes.json();
                
                params.forEach(p => {
                    if (p.tenthamso === 'SiSoToiDa') {
                        document.getElementById('ruleSiSoToiDa').value = p.giatri;
                    }
                });

                // Load danh s√°ch kh·ªëi l·ªõp
                const khoiRes = await fetch('/api/settings/grade-levels');
                const khoiList = await khoiRes.json();
                
                const khoiBody = document.getElementById('khoiLopBody');
                if (khoiList.length === 0) {
                    khoiBody.innerHTML = '<tr><td colspan="2" style="text-align:center;">Ch∆∞a c√≥ kh·ªëi l·ªõp</td></tr>';
                } else {
                    khoiBody.innerHTML = khoiList.map(k => `
                        <tr>
                            <td>${k.makhoilop}</td>
                            <td>${k.tenkhoilop}</td>
                        </tr>
                    `).join('');
                }

                // Load danh s√°ch nƒÉm h·ªçc
                await loadSchoolYears();
            } catch (error) {
                console.error('L·ªói load quy ƒë·ªãnh:', error);
            }
        }

        // ====== QU·∫¢N L√ù NƒÇM H·ªåC ======
        async function loadSchoolYears() {
            try {
                const res = await fetch('/api/settings/school-years');
                const years = await res.json();
                
                const tbody = document.getElementById('namHocBody');
                if (years.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;">Ch∆∞a c√≥ nƒÉm h·ªçc</td></tr>';
                } else {
                    tbody.innerHTML = years.map(y => `
                        <tr data-id="${y.manamhoc}">
                            <td>
                                <input type="text" class="edit-manamhoc" value="${y.manamhoc}" 
                                    style="width: 100%; padding: 4px; border: 1px solid #ddd; border-radius: 4px;" readonly>
                            </td>
                            <td>
                                <input type="text" class="edit-tennamhoc" value="${y.tennamhoc || ''}" 
                                    style="width: 100%; padding: 4px; border: 1px solid #ddd; border-radius: 4px;">
                            </td>
                            <td style="text-align: center;">
                                <button class="btn btn-primary" onclick="saveSchoolYear('${y.manamhoc}')" style="padding: 4px 8px; font-size: 12px; margin-right: 4px;">L∆∞u</button>
                                <button class="btn btn-danger" onclick="deleteSchoolYear('${y.manamhoc}')" style="padding: 4px 8px; font-size: 12px;">X√≥a</button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('L·ªói load nƒÉm h·ªçc:', error);
            }
        }

        async function addSchoolYear() {
            const maNamHoc = document.getElementById('newMaNamHoc').value.trim();
            const tenNamHoc = document.getElementById('newTenNamHoc').value.trim();
            
            if (!maNamHoc) {
                toastWarning('Vui l√≤ng nh·∫≠p m√£ nƒÉm h·ªçc!');
                return;
            }

            try {
                const res = await fetch('/api/settings/school-years', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ MaNamHoc: maNamHoc, TenNamHoc: tenNamHoc })
                });
                
                if (res.ok) {
                    document.getElementById('newMaNamHoc').value = '';
                    document.getElementById('newTenNamHoc').value = '';
                    await loadSchoolYears();
                    toastSuccess('Th√™m nƒÉm h·ªçc th√†nh c√¥ng!');
                } else {
                    const err = await res.json();
                    toastError(err.message || 'Kh√¥ng th·ªÉ th√™m nƒÉm h·ªçc');
                }
            } catch (error) {
                console.error('L·ªói:', error);
                toastError('L·ªói khi th√™m nƒÉm h·ªçc!');
            }
        }

        async function saveSchoolYear(id) {
            const row = document.querySelector(`#namHocBody tr[data-id="${id}"]`);
            const tenNamHoc = row.querySelector('.edit-tennamhoc').value.trim();

            try {
                const res = await fetch(`/api/settings/school-years/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ TenNamHoc: tenNamHoc })
                });
                
                if (res.ok) {
                    toastSuccess('C·∫≠p nh·∫≠t nƒÉm h·ªçc th√†nh c√¥ng!');
                } else {
                    toastError('L·ªói khi c·∫≠p nh·∫≠t nƒÉm h·ªçc!');
                }
            } catch (error) {
                console.error('L·ªói:', error);
                toastError('L·ªói khi c·∫≠p nh·∫≠t nƒÉm h·ªçc!');
            }
        }

        async function deleteSchoolYear(id) {
            if (!confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a nƒÉm h·ªçc "${id}"?`)) return;

            try {
                const res = await fetch(`/api/settings/school-years/${id}`, {
                    method: 'DELETE'
                });
                
                if (res.ok) {
                    await loadSchoolYears();
                    toastSuccess('X√≥a nƒÉm h·ªçc th√†nh c√¥ng!');
                } else {
                    const err = await res.json();
                    toastError(err.message || 'Kh√¥ng th·ªÉ x√≥a nƒÉm h·ªçc');
                }
            } catch (error) {
                console.error('L·ªói:', error);
                toastError('L·ªói khi x√≥a nƒÉm h·ªçc!');
            }
        }

        async function saveClassRules() {
            const siSoToiDa = document.getElementById('ruleSiSoToiDa').value;
            
            if (parseInt(siSoToiDa) < 1) {
                toastWarning('Sƒ© s·ªë t·ªëi ƒëa ph·∫£i l·ªõn h∆°n 0!');
                return;
            }

            try {
                await fetch('/api/settings/params/SiSoToiDa', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ GiaTri: siSoToiDa })
                });
                
                toastSuccess('ƒê√£ l∆∞u quy ƒë·ªãnh th√†nh c√¥ng!');
                classRulesModal.classList.remove('show');
            } catch (error) {
                console.error('L·ªói:', error);
                toastError('L·ªói khi l∆∞u quy ƒë·ªãnh!');
            }
        }

        btnClassRules.onclick = () => {
            loadClassRules();
            classRulesModal.classList.add('show');
        };
        
        document.getElementById('closeClassRulesBtn').onclick = 
        document.getElementById('btnCancelClassRules').onclick = () => {
            classRulesModal.classList.remove('show');
        };
        
        document.getElementById('btnSaveClassRules').onclick = saveClassRules;
        
        classRulesModal.onclick = (e) => {
            if (e.target === classRulesModal) classRulesModal.classList.remove('show');
        };
    </script>

</body>
</html>
