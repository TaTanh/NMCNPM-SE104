<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Nh·∫≠p ƒëi·ªÉm ‚Äì Ch·ªçn l·ªõp</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/layout/styles.css">
    <script src="/js/toast.js"></script>
    <script src="/js/auth.js"></script>
</head>

<body class="dashboard-body">

    <!-- SIDEBAR -->
    <aside class="sidebar">
        <div class="sidebar-logo">
            <img src="/assets/uit_logo.png" alt="UIT Logo">
            <span>QL H·ªçc Sinh</span>
        </div>

        <nav class="sidebar-menu">
            <a href="/pages/dashboard.html">Dashboard</a>
            <a href="/pages/students.html">Qu·∫£n l√Ω h·ªçc sinh</a>
            <a href="/pages/classes.html" id="menuClasses" style="display:none;">Qu·∫£n l√Ω l·ªõp h·ªçc</a>
            <a href="/pages/subject_list.html" id="menuSubjects" style="display:none;">Qu·∫£n l√Ω m√¥n h·ªçc</a>
            <a href="/pages/grade_entry_select.html" class="active">Nh·∫≠p ƒëi·ªÉm</a>
            <a href="/pages/hanhkiem_entry.html" id="menuHanhKiem" style="display:none;">Nh·∫≠p h·∫°nh ki·ªÉm</a>
            <a href="/pages/grade_select.html">B·∫£ng ƒëi·ªÉm</a>
            <a href="/pages/student_transcript.html">Tra c·ª©u ƒëi·ªÉm HS</a>
            <a href="/pages/class_summary.html">T·ªïng k·∫øt l·ªõp</a>
            <a href="/pages/reports.html">B√°o c√°o t·ªïng k·∫øt</a>
            <a href="/pages/teaching_assignment.html" id="menuTeaching" style="display:none;">Ph√¢n c√¥ng gi·∫£ng d·∫°y</a>
            <a href="/pages/exam_types.html" id="menuExamTypes" style="display:none;">Lo·∫°i h√¨nh ki·ªÉm tra</a>
            <a href="/pages/users.html" id="menuUsers" style="display:none;">Qu·∫£n l√Ω ng∆∞·ªùi d√πng</a>
        </nav>
    </aside>

    <!-- MAIN -->
    <div class="main">

        <!-- HEADER -->
        <header class="topbar">
            <div class="page-title">Nh·∫≠p ƒëi·ªÉm</div>
            <div class="user-info">
                <span id="userGreeting">Xin ch√†o, Admin</span>
                <img src="/assets/user.png" class="avatar" alt="user">
                <button class="btn btn-outline btn-sm" onclick="logout()" style="margin-left:10px;">ƒêƒÉng xu·∫•t</button>
            </div>
        </header>

        <!-- CONTENT -->
        <div class="content">

            <!-- Filters: NƒÉm h·ªçc + H·ªçc k·ª≥ + Kh·ªëi + L·ªõp -->
            <div class="filters-row" style="justify-content: space-between;">
                <div style="display: flex; gap: 12px; flex-wrap: wrap; align-items: flex-end;">
                    <div class="filter-item">
                        <label class="filter-label" for="yearSelect">NƒÉm h·ªçc</label>
                        <select id="yearSelect">
                            <option value="">-- Ch·ªçn nƒÉm h·ªçc --</option>
                        </select>
                    </div>

                    <div class="filter-item">
                        <label class="filter-label" for="semesterSelect">H·ªçc k·ª≥</label>
                        <select id="semesterSelect">
                            <option value="">-- Ch·ªçn h·ªçc k·ª≥ --</option>
                        </select>
                    </div>

                    <div class="filter-item">
                        <label class="filter-label" for="gradeSelect">Kh·ªëi</label>
                        <select id="gradeSelect">
                            <option value="">-- Ch·ªçn kh·ªëi --</option>
                        </select>
                    </div>

                    <div class="filter-item">
                        <label class="filter-label" for="classSelect">L·ªõp</label>
                        <select id="classSelect">
                            <option value="">-- Ch·ªçn l·ªõp --</option>
                        </select>
                    </div>
                </div>

                <div style="display:flex; align-items:flex-end; gap: 8px;">
                    <button class="btn btn-outline" id="btnGradeRules">‚öôÔ∏è Quy ƒë·ªãnh ƒëi·ªÉm</button>
                    <button class="btn btn-outline" id="btnSemesterRules">üìÖ Qu·∫£n l√Ω h·ªçc k·ª≥</button>
                </div>
            </div>

            <!-- B·∫£ng danh s√°ch m√¥n ƒë·ªÉ nh·∫≠p ƒëi·ªÉm -->
            <div class="table-wrapper">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>M√£ m√¥n</th>
                            <th>T√™n m√¥n</th>
                            <th>H·ªá s·ªë</th>
                            <th>H·ªçc k·ª≥</th>
                            <th style="width: 120px; text-align: right;">Thao t√°c</th>
                        </tr>
                    </thead>
                    <tbody id="subjectGradeBody">
                        <tr><td colspan="5" style="text-align:center;">Vui l√≤ng ch·ªçn l·ªõp v√† h·ªçc k·ª≥</td></tr>
                    </tbody>
                </table>
            </div>

        </div><!-- content -->
    </div><!-- main -->

    <!-- ========== POPUP QUY ƒê·ªäNH ƒêI·ªÇM ========== -->
    <div class="modal-overlay" id="gradeRulesModal">
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header">
                <h2>‚öôÔ∏è Quy ƒë·ªãnh v·ªÅ ƒëi·ªÉm s·ªë</h2>
                <button class="modal-close" id="closeGradeRulesBtn">&times;</button>
            </div>

            <div class="modal-body">
                <!-- PH·∫¶N 1: ƒêI·ªÇM S·ªê -->
                <h3 style="font-size:14px; color:#374151; margin-bottom:12px;">Gi·ªõi h·∫°n ƒëi·ªÉm</h3>
                <div class="config-grid">
                    <div class="config-card">
                        <div class="config-label">ƒêi·ªÉm t·ªëi thi·ªÉu</div>
                        <input type="number" id="ruleDiemToiThieu" value="0" min="0" max="10" step="0.5">
                        <div class="config-hint">ƒêi·ªÉm th·∫•p nh·∫•t c√≥ th·ªÉ nh·∫≠p</div>
                    </div>

                    <div class="config-card">
                        <div class="config-label">ƒêi·ªÉm t·ªëi ƒëa</div>
                        <input type="number" id="ruleDiemToiDa" value="10" min="0" max="10" step="0.5">
                        <div class="config-hint">ƒêi·ªÉm cao nh·∫•t c√≥ th·ªÉ nh·∫≠p</div>
                    </div>

                    <div class="config-card">
                        <div class="config-label">ƒêi·ªÉm ƒë·∫°t m√¥n</div>
                        <input type="number" id="ruleDiemDatMon" value="5" min="0" max="10" step="0.5">
                        <div class="config-hint">ƒêi·ªÉm t·ªëi thi·ªÉu ƒë·ªÉ ƒë·∫°t m√¥n h·ªçc</div>
                    </div>

                    <div class="config-card">
                        <div class="config-label">ƒêi·ªÉm ƒë·∫°t (x·∫øp lo·∫°i)</div>
                        <input type="number" id="ruleDiemDat" value="5" min="0" max="10" step="0.5">
                        <div class="config-hint">ƒêi·ªÉm t·ªëi thi·ªÉu ƒë·ªÉ x·∫øp lo·∫°i ƒë·∫°t</div>
                    </div>
                </div>

                <!-- PH·∫¶N 2: LO·∫†I H√åNH KI·ªÇM TRA -->
                <h3 style="font-size:14px; color:#374151; margin:20px 0 12px;">Lo·∫°i h√¨nh ki·ªÉm tra & H·ªá s·ªë</h3>
                <div class="table-wrapper">
                    <table class="data-table" id="examTypeTable">
                        <thead>
                            <tr>
                                <th>M√£</th>
                                <th>T√™n lo·∫°i ki·ªÉm tra</th>
                                <th>H·ªá s·ªë</th>
                                <th style="width:40px;">X√≥a</th>
                            </tr>
                        </thead>
                        <tbody id="examTypeBody">
                            <tr><td colspan="4" style="text-align:center;">ƒêang t·∫£i...</td></tr>
                        </tbody>
                        <tfoot>
                            <tr id="addExamTypeRow">
                                <td><input type="text" id="newExamId" placeholder="M√£" style="width:70px; padding:4px 8px;"></td>
                                <td><input type="text" id="newExamName" placeholder="T√™n lo·∫°i ki·ªÉm tra" style="width:100%; padding:4px 8px;"></td>
                                <td><input type="number" id="newExamHeso" placeholder="H·ªá s·ªë" min="1" max="5" value="1" style="width:60px; padding:4px 8px;"></td>
                                <td><button class="btn btn-primary" id="btnAddExamType">Th√™m</button></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <div class="modal-footer" style="margin-top: 16px;">
                    <button type="button" class="btn btn-outline" id="btnCancelGradeRules">H·ªßy</button>
                    <button type="button" class="btn btn-primary" id="btnSaveGradeRules">L∆∞u thay ƒë·ªïi</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== POPUP QU·∫¢N L√ù H·ªåC K·ª≤ ========== -->
    <div class="modal-overlay" id="semesterRulesModal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h2>üìÖ Qu·∫£n l√Ω h·ªçc k·ª≥</h2>
                <button class="modal-close" id="closeSemesterRulesBtn">&times;</button>
            </div>

            <div class="modal-body">
                <div class="table-wrapper">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>M√£ h·ªçc k·ª≥</th>
                                <th>T√™n h·ªçc k·ª≥</th>
                                <th style="width:60px;">X√≥a</th>
                            </tr>
                        </thead>
                        <tbody id="semesterListBody">
                            <tr><td colspan="3" style="text-align:center;">ƒêang t·∫£i...</td></tr>
                        </tbody>
                    </table>
                </div>

                <div style="margin-top:16px; padding-top:16px; border-top:1px solid #e5e7eb;">
                    <h4 style="font-size:14px; margin-bottom:8px;">Th√™m h·ªçc k·ª≥ m·ªõi</h4>
                    <div style="display:flex; gap:8px;">
                        <input type="text" id="newSemesterId" placeholder="M√£ (VD: HK3)" style="flex:1; padding:8px; border:1px solid #d1d5db; border-radius:6px;">
                        <input type="text" id="newSemesterName" placeholder="T√™n (VD: H·ªçc k·ª≥ 3)" style="flex:2; padding:8px; border:1px solid #d1d5db; border-radius:6px;">
                        <button class="btn btn-primary" id="btnAddSemester">Th√™m</button>
                    </div>
                </div>

                <div class="modal-footer" style="margin-top: 16px;">
                    <button type="button" class="btn btn-outline" id="btnCloseSemesterRules">ƒê√≥ng</button>
                </div>
            </div>
        </div>
    </div>

    <!-- SCRIPT -->
    <script>
        // ========== LOAD DROPDOWNS ==========
        async function loadDropdowns() {
            try {
                // Load nƒÉm h·ªçc
                const yearRes = await authFetch('/api/settings/school-years');
                const years = await yearRes.json();
                const yearSelect = document.getElementById('yearSelect');
                years.forEach(y => {
                    yearSelect.innerHTML += `<option value="${y.manamhoc}">${y.tennamhoc}</option>`;
                });

                // Load h·ªçc k·ª≥ (CH·ªà HK1, HK2 - kh√¥ng c√≥ "C·∫£ nƒÉm" v√¨ ƒëi·ªÉm c·∫£ nƒÉm ƒë∆∞·ª£c t√≠nh t·ª± ƒë·ªông)
                const semRes = await authFetch('/api/settings/semesters');
                const semesters = await semRes.json();
                const semesterSelect = document.getElementById('semesterSelect');
                semesters.filter(s => s.mahocky !== 'CN').forEach(s => {
                    semesterSelect.innerHTML += `<option value="${s.mahocky}">${s.tenhocky}</option>`;
                });

                // Load kh·ªëi
                const gradeRes = await authFetch('/api/settings/grade-levels');
                const grades = await gradeRes.json();
                const gradeSelect = document.getElementById('gradeSelect');
                grades.forEach(g => {
                    gradeSelect.innerHTML += `<option value="${g.makhoilop}">${g.tenkhoilop}</option>`;
                });
            } catch (error) {
                console.error('L·ªói load dropdowns:', error);
            }
        }

        // ========== LOAD L·ªöP THEO KH·ªêI ==========
        async function loadClasses() {
            const khoi = document.getElementById('gradeSelect').value;
            const namhoc = document.getElementById('yearSelect').value;
            const classSelect = document.getElementById('classSelect');
            
            classSelect.innerHTML = '<option value="">-- Ch·ªçn l·ªõp --</option>';
            
            if (!khoi) return;

            try {
                let url = '/api/classes';
                const params = new URLSearchParams();
                if (khoi) params.append('khoi', khoi);
                if (namhoc) params.append('namhoc', namhoc);
                if (params.toString()) url += '?' + params.toString();

                const response = await authFetch(url);
                const classes = await response.json();
                
                classes.forEach(c => {
                    classSelect.innerHTML += `<option value="${c.malop}">${c.tenlop}</option>`;
                });
            } catch (error) {
                console.error('L·ªói load l·ªõp:', error);
            }
        }

        // ========== LOAD DANH S√ÅCH M√îN ƒê·ªÇ NH·∫¨P ƒêI·ªÇM ==========
        async function loadSubjectsForGrade() {
            const classId = document.getElementById('classSelect').value;
            const semester = document.getElementById('semesterSelect').value;
            const year = document.getElementById('yearSelect').value;
            const tbody = document.getElementById('subjectGradeBody');
            
            if (!classId || !semester || !year) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Vui l√≤ng ch·ªçn l·ªõp, nƒÉm h·ªçc v√† h·ªçc k·ª≥</td></tr>';
                return;
            }

            try {
                const user = getCurrentUser();
                if (!user) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:red;">B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p</td></tr>';
                    return;
                }

                let mySubjects;
                const isAdmin = user.maVaiTro === 'Admin' || user.vaiTro === 'Admin' || 
                               user.maVaiTro === 'ADMIN' || user.vaiTro === 'ADMIN';

                if (isAdmin) {
                    // Admin: l·∫•y T·∫§T C·∫¢ m√¥n h·ªçc (kh√¥ng ph·ª• thu·ªôc v√†o ph√¢n c√¥ng)
                    const subjectsRes = await authFetch('/api/subjects');
                    const allSubjects = await subjectsRes.json();
                    mySubjects = allSubjects.map(s => ({
                        mamonhoc: s.mamonhoc || s.MaMonHoc,
                        tenmonhoc: s.tenmonhoc || s.TenMonHoc,
                        heso: s.heso || s.HeSo || 1
                    }));
                } else {
                    // GVBM: ch·ªâ l·∫•y m√¥n m√¨nh ƒë∆∞·ª£c ph√¢n c√¥ng d·∫°y
                    const url = `/api/giangday/lop/${classId}?maNamHoc=${encodeURIComponent(year)}&maHocKy=${encodeURIComponent(semester)}`;
                    const token = getAuthToken();
                    const res = await authFetch(url, { 
                        headers: { 'Authorization': `Bearer ${token}` } 
                    });
                    const json = await res.json();
                    const assignments = json && json.data ? json.data : [];
                    
                    mySubjects = assignments.filter(a => {
                        const gvId = a.magiaovien || a.MaGiaoVien;
                        return String(gvId) === String(user.maNguoiDung || user.maNguoidung);
                    }).map(a => ({
                        mamonhoc: a.mamonhoc || a.MaMonHoc,
                        tenmonhoc: a.tenmonhoc || a.TenMonHoc,
                        heso: a.heso || a.HeSo || 1
                    }));
                }

                if (mySubjects.length === 0) {
                    const message = isAdmin ? 
                        'Ch∆∞a c√≥ m√¥n h·ªçc n√†o trong h·ªá th·ªëng' : 
                        'B·∫°n kh√¥ng c√≥ ph√¢n c√¥ng d·∫°y m√¥n n√†o cho l·ªõp n√†y trong h·ªçc k·ª≥/nƒÉm h·ªçc ƒë√£ ch·ªçn';
                    tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;">${message}</td></tr>`;
                    return;
                }

                tbody.innerHTML = mySubjects.map(mh => `
                    <tr>
                        <td>${mh.mamonhoc}</td>
                        <td>${mh.tenmonhoc}</td>
                        <td>${mh.heso}</td>
                        <td>${semester}</td>
                        <td style="text-align: right;">
                            <a href="/pages/grade_entry.html?subject=${mh.mamonhoc}&class=${classId}&semester=${semester}&year=${year}" 
                               class="btn btn-primary" style="padding:6px 14px; font-size:14px;">Nh·∫≠p ƒëi·ªÉm</a>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('L·ªói:', error);
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:red;">L·ªói t·∫£i d·ªØ li·ªáu</td></tr>';
            }
        }

        // ========== EVENT LISTENERS ==========
        document.addEventListener('DOMContentLoaded', () => {
            loadDropdowns();
            
            document.getElementById('gradeSelect').addEventListener('change', loadClasses);
            document.getElementById('yearSelect').addEventListener('change', loadClasses);
            document.getElementById('classSelect').addEventListener('change', loadSubjectsForGrade);
            document.getElementById('semesterSelect').addEventListener('change', loadSubjectsForGrade);
            
            // Ki·ªÉm tra role v√† hi·ªÉn th·ªã menu cho ADMIN
            const user = getCurrentUser();
            if (user && user.vaiTro === 'ADMIN') {
                document.getElementById('menuClasses').style.display = 'block';
                document.getElementById('menuSubjects').style.display = 'block';
                document.getElementById('menuHanhKiem').style.display = 'block';
                document.getElementById('menuTeaching').style.display = 'block';
                document.getElementById('menuExamTypes').style.display = 'block';
                document.getElementById('menuConductRules').style.display = 'block';
                document.getElementById('menuUsers').style.display = 'block';
            }
        });

        // ========== POPUP QUY ƒê·ªäNH ƒêI·ªÇM ==========
        const gradeRulesModal = document.getElementById('gradeRulesModal');

        async function loadGradeRules() {
            try {
                // Load tham s·ªë ƒëi·ªÉm
                const response = await authFetch('/api/settings/params');
                const params = await response.json();
                
                params.forEach(p => {
                    const map = {
                        'DiemToiThieu': 'ruleDiemToiThieu',
                        'DiemToiDa': 'ruleDiemToiDa',
                        'DiemDatMon': 'ruleDiemDatMon',
                        'DiemDat': 'ruleDiemDat'
                    };
                    if (map[p.tenthamso]) {
                        document.getElementById(map[p.tenthamso]).value = p.giatri;
                    }
                });

                // Load lo·∫°i h√¨nh ki·ªÉm tra
                const examRes = await authFetch('/api/settings/exam-types');
                const examTypes = await examRes.json();
                const examBody = document.getElementById('examTypeBody');
                
                if (examTypes.length === 0) {
                    examBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Ch∆∞a c√≥ lo·∫°i h√¨nh ki·ªÉm tra</td></tr>';
                } else {
                    examBody.innerHTML = examTypes.map(et => {
                        if (window.confirmDeleteId === et.malhkt) {
                            return `<tr data-id="${et.malhkt}">
                                <td colspan="4" style="background:#fff0f0; color:#b91c1c; text-align:center;">
                                    X√°c nh·∫≠n xo√° lo·∫°i ki·ªÉm tra <b>${et.tenlhkt}</b>? 
                                    <button class='btn btn-danger btn-confirm-delete' style='margin-left:8px;'>Xo√°</button>
                                    <button class='btn btn-outline btn-cancel-delete' style='margin-left:4px;'>Hu·ª∑</button>
                                </td>
                            </tr>`;
                        } else {
                            return `<tr data-id="${et.malhkt}">
                                <td>${et.malhkt}</td>
                                <td><input type="text" class="exam-name" value="${et.tenlhkt}" style="width:100%;padding:4px 8px;border:1px solid #d1d5db;border-radius:4px;"></td>
                                <td><input type="number" class="exam-heso" value="${et.heso}" min="1" max="5" style="width:60px;padding:4px 8px;border:1px solid #d1d5db;border-radius:4px;"></td>
                                <td><button class="btn btn-danger btn-delete-examtype" style="padding:4px 8px;font-size:12px;">X√≥a</button></td>
                            </tr>`;
                        }
                    }).join('');
                }
                // G·∫Øn event x√°c nh·∫≠n xo√°
                document.querySelectorAll('.btn-delete-examtype').forEach(btn => {
                    btn.onclick = function() {
                        const row = btn.closest('tr');
                        window.confirmDeleteId = row.dataset.id;
                        loadGradeRules();
                    };
                });
                document.querySelectorAll('.btn-cancel-delete').forEach(btn => {
                    btn.onclick = function() {
                        window.confirmDeleteId = null;
                        loadGradeRules();
                    };
                });
                document.querySelectorAll('.btn-confirm-delete').forEach(btn => {
                    btn.onclick = async function() {
                        const row = btn.closest('tr');
                        const id = row.dataset.id;
                        try {
                            const res = await authFetch(`/api/settings/exam-types/${id}`, { method: 'DELETE' });
                            if (!res.ok) {
                                const result = await res.json();
                                let msg = result.error || result.message || 'L·ªói x√≥a';
                                if (msg.includes('violates') || msg.includes('constraint')) {
                                    msg = 'Kh√¥ng th·ªÉ xo√° v√¨ ƒë√£ c√≥ d·ªØ li·ªáu li√™n quan.';
                                }
                                toastError(msg);
                            } else {
                                toastSuccess('ƒê√£ xo√° th√†nh c√¥ng!');
                            }
                            window.confirmDeleteId = null;
                            loadGradeRules();
                        } catch (err) {
                            toastError('L·ªói kh√¥ng x√°c ƒë·ªãnh khi xo√°!');
                            window.confirmDeleteId = null;
                            loadGradeRules();
                        }
                    };
                });
                    // Th√™m lo·∫°i ki·ªÉm tra m·ªõi
                    document.getElementById('btnAddExamType').onclick = async () => {
                        const id = document.getElementById('newExamId').value.trim();
                        const name = document.getElementById('newExamName').value.trim();
                        const heso = document.getElementById('newExamHeso').value.trim();
                        if (!id || !name || !heso) {
                            toastWarning('Vui l√≤ng nh·∫≠p ƒë·ªß m√£, t√™n v√† h·ªá s·ªë!');
                            return;
                        }
                        if (isNaN(heso) || parseInt(heso) < 1) {
                            toastWarning('H·ªá s·ªë ph·∫£i l√† s·ªë nguy√™n >= 1');
                            return;
                        }
                        try {
                            const res = await authFetch('/api/settings/exam-types', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ MaLHKT: id, TenLHKT: name, HeSo: parseInt(heso) })
                            });
                            if (!res.ok) {
                                const result = await res.json();
                                throw new Error(result.message || result.error || 'L·ªói th√™m');
                            }
                            document.getElementById('newExamId').value = '';
                            document.getElementById('newExamName').value = '';
                            document.getElementById('newExamHeso').value = '1';
                            toastSuccess('ƒê√£ th√™m lo·∫°i ki·ªÉm tra!');
                            loadGradeRules();
                        } catch (err) {
                            toastError(err.message);
                        }
                    };
            } catch (error) {
                console.error('L·ªói load quy ƒë·ªãnh:', error);
            }
        }

        async function saveGradeRules() {
            const rules = [
                { name: 'DiemToiThieu', value: document.getElementById('ruleDiemToiThieu').value },
                { name: 'DiemToiDa', value: document.getElementById('ruleDiemToiDa').value },
                { name: 'DiemDatMon', value: document.getElementById('ruleDiemDatMon').value },
                { name: 'DiemDat', value: document.getElementById('ruleDiemDat').value }
            ];

            try {
                for (const rule of rules) {
                    await authFetch(`/api/settings/params/${rule.name}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ GiaTri: rule.value })
                    });
                }

                // L∆∞u lo·∫°i h√¨nh ki·ªÉm tra
                const examRows = document.querySelectorAll('#examTypeBody tr');
                for (const row of examRows) {
                    const id = row.dataset.id;
                    const name = row.querySelector('.exam-name')?.value;
                    const heso = row.querySelector('.exam-heso')?.value;
                    
                    if (id && name && heso) {
                        await authFetch(`/api/settings/exam-types/${id}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ TenLHKT: name, HeSo: heso })
                        });
                    }
                }

                toastSuccess('ƒê√£ l∆∞u quy ƒë·ªãnh th√†nh c√¥ng!');
                gradeRulesModal.classList.remove('show');
            } catch (error) {
                console.error('L·ªói l∆∞u quy ƒë·ªãnh:', error);
                toastError('L·ªói khi l∆∞u quy ƒë·ªãnh!');
            }
        }

        document.getElementById('btnGradeRules').onclick = () => {
            loadGradeRules();
            gradeRulesModal.classList.add('show');
        };
        
        document.getElementById('closeGradeRulesBtn').onclick = 
        document.getElementById('btnCancelGradeRules').onclick = () => {
            gradeRulesModal.classList.remove('show');
        };

        document.getElementById('btnSaveGradeRules').onclick = saveGradeRules;

        gradeRulesModal.onclick = (e) => {
            if (e.target === gradeRulesModal) gradeRulesModal.classList.remove('show');
        };

        // ========== POPUP QU·∫¢N L√ù H·ªåC K·ª≤ ==========
        const semesterRulesModal = document.getElementById('semesterRulesModal');
        
        async function loadSemesterList() {
            try {
                const response = await authFetch('/api/settings/semesters');
                const semesters = await response.json();
                const tbody = document.getElementById('semesterListBody');
                
                if (semesters.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;">Ch∆∞a c√≥ h·ªçc k·ª≥</td></tr>';
                } else {
                    tbody.innerHTML = semesters.map(s => `
                        <tr>
                            <td>${s.mahocky}</td>
                            <td>${s.tenhocky}</td>
                            <td><button class="btn btn-danger" style="padding:4px 8px;font-size:12px;" onclick="deleteSemester('${s.mahocky}')">X√≥a</button></td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('L·ªói:', error);
            }
        }

        async function deleteSemester(id) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a h·ªçc k·ª≥ n√†y?')) return;
            
            try {
                const response = await authFetch(`/api/settings/semesters/${id}`, { method: 'DELETE' });
                if (!response.ok) {
                    const result = await response.json();
                    throw new Error(result.error || 'L·ªói x√≥a');
                }
                loadSemesterList();
                loadDropdowns();
            } catch (error) {
                toastError(error.message);
            }
        }

        document.getElementById('btnAddSemester').onclick = async () => {
            const id = document.getElementById('newSemesterId').value.trim();
            const name = document.getElementById('newSemesterName').value.trim();
            
            if (!id || !name) {
                toastWarning('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß m√£ v√† t√™n h·ªçc k·ª≥!');
                return;
            }

            try {
                const response = await authFetch('/api/settings/semesters', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ MaHocKy: id, TenHocKy: name })
                });
                
                if (!response.ok) {
                    const result = await response.json();
                    throw new Error(result.error || 'L·ªói th√™m');
                }
                
                document.getElementById('newSemesterId').value = '';
                document.getElementById('newSemesterName').value = '';
                loadSemesterList();
                loadDropdowns();
            } catch (error) {
                toastError(error.message);
            }
        };

        document.getElementById('btnSemesterRules').onclick = () => {
            loadSemesterList();
            semesterRulesModal.classList.add('show');
        };
        
        document.getElementById('closeSemesterRulesBtn').onclick = 
        document.getElementById('btnCloseSemesterRules').onclick = () => {
            semesterRulesModal.classList.remove('show');
        };
        
        semesterRulesModal.onclick = (e) => {
            if (e.target === semesterRulesModal) semesterRulesModal.classList.remove('show');
        };
    </script>

</body>
</html>
