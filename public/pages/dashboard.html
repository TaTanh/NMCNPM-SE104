<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Dashboard – Quản lý học sinh</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/layout/styles.css">
    <script src="/js/toast.js"></script>
    <script src="/js/auth.js"></script>
</head>

<body class="dashboard-body">

    <!-- SIDEBAR -->
    <aside class="sidebar">
        <div class="sidebar-logo">
            <img src="/assets/uit_logo.png" alt="UIT Logo">
            <span>QL Học Sinh</span>
        </div>

        <nav class="sidebar-menu">
            <a href="/pages/dashboard.html" class="active">Dashboard</a>
            <a href="/pages/students.html">Quản lý học sinh</a>
            <a href="/pages/classes.html" id="menuClasses" style="display:none;">Quản lý lớp học</a>
            <a href="/pages/subject_list.html" id="menuSubjects" style="display:none;">Quản lý môn học</a>
            <a href="/pages/grade_entry_select.html">Nhập điểm</a>
            <a href="/pages/hanhkiem_entry.html" id="menuHanhKiem" style="display:none;">Nhập hạnh kiểm</a>
            <a href="/pages/grade_select.html">Bảng điểm</a>
            <a href="/pages/student_transcript.html">Tra cứu điểm HS</a>
            <a href="/pages/class_summary.html">Tổng kết lớp</a>
            <a href="/pages/reports.html">Báo cáo tổng kết</a>
            <a href="/pages/teaching_assignment.html" id="menuTeaching" style="display:none;">Phân công giảng dạy</a>
            <a href="/pages/users.html" id="menuUsers" style="display:none;">Quản lý người dùng</a>
        </nav>
    </aside>

    <!-- MAIN CONTENT -->
    <div class="main">

        <!-- HEADER -->
        <header class="topbar">
            <div></div>
            <div class="user-info">
                <span id="userGreeting">Xin chào, Admin</span>
                <img src="/assets/user.png" class="avatar" alt="user">
                <button class="btn btn-outline btn-sm" onclick="logout()" style="margin-left:10px;">Đăng xuất</button>
            </div>
        </header>

        <!-- CONTENT -->
        <div class="content">

            <!-- STAT CARDS -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Học sinh</h3>
                    <p id="statStudents">--</p>
                </div>

                <div class="stat-card">
                    <h3>Giáo viên</h3>
                    <p id="statTeachers">--</p>
                </div>

                <div class="stat-card">
                    <h3>Lớp học</h3>
                    <p id="statClasses">--</p>
                </div>

                <div class="stat-card">
                    <h3>Môn học</h3>
                    <p id="statSubjects">--</p>
                </div>
            </div>

            <!-- THỐNG KÊ THEO KHỐI LỚP -->
            <h2 class="page-title" style="margin-top: 24px; margin-bottom: 12px;">
                Thống kê theo Khối lớp
            </h2>

            <div class="stats-grid" id="gradeStatsGrid">
                <!-- Sẽ được load từ API -->
            </div>

            <!-- PHÂN BỐ XẾP LOẠI HỌC LỰC -->
            <h2 class="page-title" style="margin-top: 24px; margin-bottom: 12px;">
                Phân bố Xếp loại Học lực (Năm học hiện tại)
            </h2>

            <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));" id="gradeDistributionGrid">
                <!-- Sẽ được load từ API -->
            </div>

            <!-- HOẠT ĐỘNG GẦN ĐÂY -->
            <h2 class="page-title" style="margin-top: 24px; margin-bottom: 12px;">
                Hoạt động gần đây
            </h2>

            <div class="table-wrapper">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Thời gian</th>
                            <th>Người thực hiện</th>
                            <th>Hành động</th>
                            <th>Đối tượng</th>
                        </tr>
                    </thead>
                    <tbody id="activityTableBody">
                        <tr>
                            <td colspan="4" style="text-align:center;">Đang tải...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

        </div>

    </div>

    <script>
        // ========== LOAD THỐNG KÊ DASHBOARD ==========
        async function loadDashboardStats() {
            try {
                const response = await authFetch('/api/dashboard/stats');
                const stats = await response.json();
                
                document.getElementById('statStudents').textContent = stats.students || 0;
                document.getElementById('statTeachers').textContent = stats.teachers || 0;
                document.getElementById('statClasses').textContent = stats.classes || 0;
                document.getElementById('statSubjects').textContent = stats.subjects || 0;
            } catch (error) {
                console.error('Lỗi load thống kê:', error);
            }
        }

        // ========== LOAD THỐNG KÊ THEO KHỐI LỚP ==========
        async function loadGradeStats() {
            try {
                const response = await authFetch('/api/dashboard/stats-by-grade');
                const stats = await response.json();
                
                const grid = document.getElementById('gradeStatsGrid');
                
                if (stats.length === 0) {
                    grid.innerHTML = '<p style="grid-column: 1/-1; text-align:center;">Chưa có dữ liệu</p>';
                    return;
                }
                
                grid.innerHTML = stats.map(grade => `
                    <div class="stat-card">
                        <h3>${grade.tenkhoilop}</h3>
                        <p style="font-size: 24px; font-weight: bold; color: #2563eb; margin: 8px 0;">
                            ${grade.soluonglop} lớp
                        </p>
                        <div style="font-size: 14px; color: #64748b; margin-top: 8px;">
                            <div>${grade.soluonghocsinh} học sinh</div>
                            <div>TB: ${grade.sisotrungbinh || 0} HS/lớp</div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Lỗi load thống kê khối:', error);
            }
        }

        // ========== LOAD PHÂN BỐ XẾP LOẠI ==========
        async function loadGradeDistribution() {
            try {
                const response = await authFetch('/api/dashboard/grade-distribution');
                const distribution = await response.json();
                
                const grid = document.getElementById('gradeDistributionGrid');
                
                if (distribution.length === 0) {
                    grid.innerHTML = '<p style="grid-column: 1/-1; text-align:center;">Chưa có dữ liệu xếp loại</p>';
                    return;
                }
                
                const colorMap = {
                    'Giỏi': '#10b981',
                    'Khá': '#3b82f6',
                    'Trung bình': '#f59e0b',
                    'Yếu': '#ef4444',
                    'Kém': '#991b1b'
                };
                
                grid.innerHTML = distribution.map(item => `
                    <div class="stat-card" style="border-left: 4px solid ${colorMap[item.xeploaihocluc] || '#6b7280'};">
                        <h3 style="color: ${colorMap[item.xeploaihocluc] || '#6b7280'};">
                            ${item.xeploaihocluc}
                        </h3>
                        <p style="font-size: 28px; font-weight: bold; color: #1e293b; margin: 8px 0;">
                            ${item.soluong}
                        </p>
                        <p style="font-size: 14px; color: #64748b;">
                            ${item.tile}% tổng số
                        </p>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Lỗi load phân bố xếp loại:', error);
            }
        }

        // ========== LOAD HOẠT ĐỘNG GẦN ĐÂY ==========
        async function loadRecentActivities() {
            try {
                const response = await authFetch('/api/dashboard/recent-activities?limit=10');
                const activities = await response.json();
                
                const tbody = document.getElementById('activityTableBody');
                
                if (activities.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Chưa có hoạt động nào</td></tr>';
                    return;
                }
                
                const actionMap = {
                    'CREATE': 'Tạo mới',
                    'UPDATE': 'Cập nhật',
                    'DELETE': 'Xóa',
                    'LOGIN': 'Đăng nhập',
                    'LOGOUT': 'Đăng xuất',
                    'ASSIGN_GVCN': 'Phân công GVCN',
                    'UNASSIGN_GVCN': 'Bỏ phân công GVCN'
                };
                
                const tableMap = {
                    'HOCSINH': 'Học sinh',
                    'LOP': 'Lớp',
                    'MONHOC': 'Môn học',
                    'BANGDIEMMON': 'Bảng điểm',
                    'HANHKIEM': 'Hạnh kiểm',
                    'NGUOIDUNG': 'Người dùng'
                };
                
                tbody.innerHTML = activities.map(act => {
                    const date = new Date(act.ngaytao);
                    const timeStr = date.toLocaleString('vi-VN', { 
                        day: '2-digit', 
                        month: '2-digit', 
                        year: 'numeric',
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });
                    
                    return `
                        <tr>
                            <td>${timeStr}</td>
                            <td>${act.nguoithuchien || 'Hệ thống'}</td>
                            <td>${actionMap[act.hanhdong] || act.hanhdong}</td>
                            <td>${tableMap[act.bangmuc] || act.bangmuc} ${act.madoituong ? `(${act.madoituong})` : ''}</td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('Lỗi load hoạt động:', error);
                document.getElementById('activityTableBody').innerHTML = 
                    '<tr><td colspan="4" style="text-align:center; color:#ef4444;">Lỗi tải dữ liệu</td></tr>';
            }
        }

        // Khởi tạo khi trang load
        document.addEventListener('DOMContentLoaded', () => {
            loadDashboardStats();
            loadGradeStats();
            loadGradeDistribution();
            loadRecentActivities();
            updateUIByPermission();
            
            // Kiểm tra role và hiển thị menu cho ADMIN
            const user = getCurrentUser();
            if (user && user.vaiTro === 'ADMIN') {
                document.getElementById('menuClasses').style.display = 'block';
                document.getElementById('menuSubjects').style.display = 'block';
                document.getElementById('menuHanhKiem').style.display = 'block';
                document.getElementById('menuTeaching').style.display = 'block';
                document.getElementById('menuUsers').style.display = 'block';
            }
        });
    </script>

</body>
</html>
