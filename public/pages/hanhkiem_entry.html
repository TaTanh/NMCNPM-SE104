<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Nh·∫≠p h·∫°nh ki·ªÉm</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/layout/styles.css">
    <script src="/js/toast.js"></script>
    <script src="/js/auth.js"></script>
    <style>
        /* MODAL STYLES */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            overflow-y: auto;
        }
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: white;
            padding: 32px;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid #e5e7eb;
        }
        .modal-header h2 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
            color: #374151;
        }
        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #9ca3af;
        }
        .modal-close:hover {
            color: #374151;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
            font-size: 14px;
        }
        .form-group input {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }
        .form-group input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid #e5e7eb;
        }

        /* TABLE STYLES */
        .hk-input {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 14px;
            text-align: center;
            background: #fff;
            font-weight: 500;
        }
        .hk-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        }
        .hk-input.filled {
            background-color: #f0fdf4;
        }
        table tbody tr {
            border-bottom: 1px solid #e5e7eb;
        }
        table tbody tr:hover {
            background-color: #f9fafb;
        }
        table td {
            padding: 12px;
        }

        /* TOOLBAR */
        .toolbar-rules {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding: 12px 16px;
            background: #eff6ff;
            border-left: 4px solid #3b82f6;
            border-radius: 4px;
        }
        .toolbar-rules-text {
            flex: 1;
            font-size: 13px;
            color: #1e40af;
        }
    </style>
</head>

<body class="dashboard-body">

    <!-- SIDEBAR -->
    <aside class="sidebar">
        <div class="sidebar-logo">
            <img src="/assets/uit_logo.png" alt="UIT Logo">
            <span>QL H·ªçc Sinh</span>
        </div>

        <nav class="sidebar-menu">
            <a href="/pages/dashboard.html">Dashboard</a>
            <a href="/pages/students.html">Qu·∫£n l√Ω h·ªçc sinh</a>
            <a href="/pages/classes.html" id="menuClasses" style="display:none;">Qu·∫£n l√Ω l·ªõp h·ªçc</a>
            <a href="/pages/subject_list.html" id="menuSubjects" style="display:none;">Qu·∫£n l√Ω m√¥n h·ªçc</a>
            <a href="/pages/grade_entry_select.html">Nh·∫≠p ƒëi·ªÉm</a>
            <a href="/pages/hanhkiem_entry.html" id="menuHanhKiem" style="display:none;" class="active">Nh·∫≠p h·∫°nh ki·ªÉm</a>
            <a href="/pages/grade_select.html">B·∫£ng ƒëi·ªÉm</a>
            <a href="/pages/student_transcript.html">Tra c·ª©u ƒëi·ªÉm HS</a>
            <a href="/pages/class_summary.html">T·ªïng k·∫øt l·ªõp</a>
            <a href="/pages/reports.html">B√°o c√°o t·ªïng k·∫øt</a>
            <a href="/pages/teaching_assignment.html" id="menuTeaching" style="display:none;">Ph√¢n c√¥ng gi·∫£ng d·∫°y</a>
            <a href="/pages/exam_types.html" id="menuExamTypes" style="display:none;">Lo·∫°i h√¨nh ki·ªÉm tra</a>
            <a href="/pages/users.html" id="menuUsers" style="display:none;">Qu·∫£n l√Ω ng∆∞·ªùi d√πng</a>
        </nav>
    </aside>

    <!-- MAIN -->
    <div class="main">

        <!-- HEADER -->
        <header class="topbar">
            <div class="page-title">Nh·∫≠p h·∫°nh ki·ªÉm</div>
            <div class="user-info">
                <span id="userGreeting">Xin ch√†o, GVCN</span>
                <img src="/assets/user.png" class="avatar" alt="user">
                <button class="btn btn-outline btn-sm" onclick="logout()" style="margin-left:10px;">ƒêƒÉng xu·∫•t</button>
            </div>
        </header>

        <!-- CONTENT -->
        <div class="content">
            
            <!-- FILTERS -->
            <div class="filters-row">
                <div class="filter-item">
                    <label class="filter-label">NƒÉm h·ªçc</label>
                    <select id="selectYear">
                        <option value="">-- Ch·ªçn --</option>
                    </select>
                </div>

                <div class="filter-item">
                    <label class="filter-label">H·ªçc k·ª≥</label>
                    <select id="selectSemester">
                        <option value="">-- Ch·ªçn --</option>
                        <option value="HK1">H·ªçc k·ª≥ 1</option>
                        <option value="HK2">H·ªçc k·ª≥ 2</option>
                    </select>
                </div>

                <div class="filter-item">
                    <label class="filter-label">Kh·ªëi</label>
                    <select id="selectGrade">
                        <option value="">-- Ch·ªçn --</option>
                    </select>
                </div>

                <div class="filter-item">
                    <label class="filter-label">L·ªõp</label>
                    <select id="selectClass">
                        <option value="">-- Ch·ªçn --</option>
                    </select>
                </div>

                <button class="btn btn-primary" id="btnLoad" style="margin-top: 24px;">T·∫£i danh s√°ch</button>
                <button class="btn btn-success" id="btnSave" style="margin-top: 24px; display: none;">L∆∞u h·∫°nh ki·ªÉm</button>
            </div>

            <!-- CLASS INFO BOX -->
            <div id="classInfoBox" style="display: none; margin-bottom: 15px; padding: 12px; background: #f0f9ff; border-left: 4px solid #0284c7; border-radius: 4px;">
                <div style="display: flex; justify-content: space-between; align-items: center; gap: 16px;">
                    <span id="classInfoText" style="color: #0c4a6e; font-size: 14px; font-weight: 500;"></span>
                    <span style="color: #059669; font-size: 14px; font-weight: 500;">‚úì B·∫°n c√≥ quy·ªÅn nh·∫≠p h·∫°nh ki·ªÉm</span>
                </div>
            </div>

            <!-- QUYNH ƒê·ªäNH TOOLBAR -->
            <div class="toolbar-rules" id="toolbarRules" style="display: none;">
                <div class="toolbar-rules-text">
                    <strong>üìã Quy ƒë·ªãnh x·∫øp lo·∫°i:</strong> <span id="rulesDisplay">ƒêang t·∫£i...</span>
                </div>
                <button class="btn btn-outline btn-sm" id="btnEditRules" style="margin-left: 12px;">‚öôÔ∏è Thay ƒë·ªïi</button>
            </div>

            <!-- TABLE -->
            <div class="table-wrapper" style="background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow: hidden;">
                <table class="data-table" style="width: 100%; border-collapse: collapse;">
                    <thead style="background: #f3f4f6; border-bottom: 2px solid #e5e7eb;">
                        <tr>
                            <th style="padding: 12px; text-align: center; width: 50px;">STT</th>
                            <th style="padding: 12px; text-align: left; width: 110px;">M√£ HS</th>
                            <th style="padding: 12px; text-align: left; width: 180px;">H·ªç t√™n</th>
                            <th style="padding: 12px; text-align: center; width: 100px;">Ng√†y sinh</th>
                            <th style="padding: 12px; text-align: center; width: 100px;">ƒêi·ªÉm H.Ki·ªÉm</th>
                            <th style="padding: 12px; text-align: center; width: 120px;">X·∫øp lo·∫°i</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr>
                            <td colspan="6" style="padding: 20px; text-align: center; color: #999;">Ch∆∞a c√≥ d·ªØ li·ªáu</td>
                        </tr>
                    </tbody>
                </table>
            </div>

        </div><!-- content -->
    </div><!-- main -->

    <!-- MODAL THAY ƒê·ªîI QUY ƒê·ªäNH -->
    <div id="rulesModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚öôÔ∏è Thay ƒë·ªïi quy ƒë·ªãnh x·∫øp lo·∫°i h·∫°nh ki·ªÉm</h2>
                <button class="modal-close" onclick="closeRulesModal()">&times;</button>
            </div>

            <form id="rulesForm" onsubmit="handleSaveRules(event)">
                <div class="form-group">
                    <label>üåü H·∫°nh ki·ªÉm T·ªët: t·ª´ <span id="totVal">80</span> ƒë·∫øn 100 ƒëi·ªÉm</label>
                    <input type="number" id="inputTot" min="0" max="100" required>
                </div>

                <div class="form-group">
                    <label>‚≠ê H·∫°nh ki·ªÉm Kh√°: t·ª´ <span id="khaVal">65</span> ƒë·∫øn <span id="khaMaxVal">79</span> ƒëi·ªÉm</label>
                    <input type="number" id="inputKha" min="0" max="100" required>
                </div>

                <div class="form-group">
                    <label>üìä H·∫°nh ki·ªÉm Trung b√¨nh: t·ª´ <span id="tbVal">50</span> ƒë·∫øn <span id="tbMaxVal">64</span> ƒëi·ªÉm</label>
                    <input type="number" id="inputTB" min="0" max="100" required>
                </div>

                <div class="form-group">
                    <label>‚ö†Ô∏è H·∫°nh ki·ªÉm Y·∫øu: t·ª´ <span id="yeuVal">20</span> ƒë·∫øn <span id="yeuMaxVal">49</span> ƒëi·ªÉm</label>
                    <input type="number" id="inputYeu" min="0" max="100" required>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-outline" onclick="closeRulesModal()">H·ªßy</button>
                    <button type="submit" class="btn btn-primary">üíæ L∆∞u thay ƒë·ªïi</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let currentData = [];
        let conductRules = { tot: 80, kha: 65, tb: 50, yeu: 20 };

        // ========== LOAD QUY ƒê·ªäNH ==========
        async function loadConductRules() {
            try {
                const res = await authFetch('/api/settings/params');
                const params = await res.json();
                conductRules.tot = parseInt(params.find(p => p.tenthamso === 'DiemHKTot')?.giatri || 80);
                conductRules.kha = parseInt(params.find(p => p.tenthamso === 'DiemHKKha')?.giatri || 65);
                conductRules.tb = parseInt(params.find(p => p.tenthamso === 'DiemHKTrungBinh')?.giatri || 50);
                conductRules.yeu = parseInt(params.find(p => p.tenthamso === 'DiemHKYeu')?.giatri || 20);
                updateRulesDisplay();
            } catch (error) {
                console.error('L·ªói load quy ƒë·ªãnh:', error);
            }
        }

        function updateRulesDisplay() {
            const display = document.getElementById('rulesDisplay');
            if (display) {
                display.textContent = `${conductRules.tot}-100: T·ªët | ${conductRules.kha}-${conductRules.tot-1}: Kh√° | ${conductRules.tb}-${conductRules.kha-1}: Trung b√¨nh | ${conductRules.yeu}-${conductRules.tb-1}: Y·∫øu`;
            }
        }

        function getHKRank(diem) {
            if (!diem || diem < conductRules.yeu) return '';
            if (diem >= conductRules.tot) return 'T·ªët';
            if (diem >= conductRules.kha) return 'Kh√°';
            if (diem >= conductRules.tb) return 'Trung b√¨nh';
            if (diem >= conductRules.yeu) return 'Y·∫øu';
            return '';
        }

        function openRulesModal() {
            document.getElementById('inputTot').value = conductRules.tot;
            document.getElementById('inputKha').value = conductRules.kha;
            document.getElementById('inputTB').value = conductRules.tb;
            document.getElementById('inputYeu').value = conductRules.yeu;
            updateRulesPreview();
            document.getElementById('rulesModal').classList.add('active');
        }

        function closeRulesModal() {
            document.getElementById('rulesModal').classList.remove('active');
        }

        function updateRulesPreview() {
            const tot = parseInt(document.getElementById('inputTot').value) || conductRules.tot;
            const kha = parseInt(document.getElementById('inputKha').value) || conductRules.kha;
            const tb = parseInt(document.getElementById('inputTB').value) || conductRules.tb;
            
            document.getElementById('totVal').textContent = tot;
            document.getElementById('khaVal').textContent = kha;
            document.getElementById('khaMaxVal').textContent = tot - 1;
            document.getElementById('tbVal').textContent = tb;
            document.getElementById('tbMaxVal').textContent = kha - 1;
            document.getElementById('yeuVal').textContent = parseInt(document.getElementById('inputYeu').value) || conductRules.yeu;
            document.getElementById('yeuMaxVal').textContent = tb - 1;
        }

        async function handleSaveRules(e) {
            e.preventDefault();
            
            const tot = parseInt(document.getElementById('inputTot').value);
            const kha = parseInt(document.getElementById('inputKha').value);
            const tb = parseInt(document.getElementById('inputTB').value);
            const yeu = parseInt(document.getElementById('inputYeu').value);
            
            if (tot <= kha || kha <= tb || tb <= yeu) {
                toastWarning('Ng∆∞·ª°ng ph·∫£i gi·∫£m d·∫ßn: T·ªët > Kh√° > Trung b√¨nh > Y·∫øu');
                return;
            }
            
            try {
                const updates = [
                    authFetch('/api/settings/params/DiemHKTot', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ GiaTri: tot.toString() })
                    }),
                    authFetch('/api/settings/params/DiemHKKha', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ GiaTri: kha.toString() })
                    }),
                    authFetch('/api/settings/params/DiemHKTrungBinh', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ GiaTri: tb.toString() })
                    }),
                    authFetch('/api/settings/params/DiemHKYeu', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ GiaTri: yeu.toString() })
                    })
                ];

                await Promise.all(updates);
                
                conductRules = { tot, kha, tb, yeu };
                updateRulesDisplay();
                closeRulesModal();
                toastSuccess('ƒê√£ c·∫≠p nh·∫≠t quy ƒë·ªãnh!');
                
                // T√≠nh l·∫°i x·∫øp lo·∫°i
                currentData.forEach(s => {
                    if (s.diemhanhkiem) {
                        s.xeploai = getHKRank(s.diemhanhkiem);
                    }
                });
                renderTable();
            } catch (error) {
                console.error('L·ªói:', error);
                toastError('L·ªói khi l∆∞u quy ƒë·ªãnh');
            }
        }

        window.onclick = function(event) {
            const modal = document.getElementById('rulesModal');
            if (event.target === modal) closeRulesModal();
        }

        // ========== KH·ªûI T·∫†O ==========
        document.addEventListener('DOMContentLoaded', async () => {
            const user = getCurrentUser();
            if (!user || (user.vaiTro !== 'GVCN' && user.vaiTro !== 'ADMIN')) {
                toastError('Kh√¥ng c√≥ quy·ªÅn truy c·∫≠p');
                setTimeout(() => window.location.href = '/pages/dashboard.html', 1500);
                return;
            }

            document.getElementById('userGreeting').textContent = `Xin ch√†o, ${user.hoTen}`;
            
            if (user.vaiTro === 'ADMIN') {
                ['menuClasses', 'menuSubjects', 'menuHanhKiem', 'menuTeaching', 'menuExamTypes', 'menuConductRules', 'menuUsers'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.style.display = 'block';
                });
            } else if (user.vaiTro === 'GVCN') {
                document.getElementById('menuHanhKiem').style.display = 'block';
            }

            await loadConductRules();
            await loadDropdowns();

            document.getElementById('selectGrade').addEventListener('change', loadClasses);
            document.getElementById('btnLoad').addEventListener('click', onLoadClick);
            document.getElementById('btnSave').addEventListener('click', onSaveClick);
            document.getElementById('btnEditRules').addEventListener('click', openRulesModal);
            ['inputTot', 'inputKha', 'inputTB', 'inputYeu'].forEach(id => {
                document.getElementById(id).addEventListener('input', updateRulesPreview);
            });
        });

        async function loadDropdowns() {
            try {
                const [yearsRes, gradesRes] = await Promise.all([
                    authFetch('/api/settings/school-years'),
                    authFetch('/api/settings/grade-levels')
                ]);

                const [years, grades] = await Promise.all([yearsRes.json(), gradesRes.json()]);

                document.getElementById('selectYear').innerHTML = '<option value="">-- Ch·ªçn --</option>' +
                    years.map(y => `<option value="${y.manamhoc}">${y.tennamhoc}</option>`).join('');

                document.getElementById('selectGrade').innerHTML = '<option value="">-- Ch·ªçn --</option>' +
                    grades.map(g => `<option value="${g.makhoilop}">${g.tenkhoilop}</option>`).join('');
            } catch (error) {
                console.error('L·ªói load dropdowns:', error);
            }
        }

        async function loadClasses() {
            const grade = document.getElementById('selectGrade').value;
            if (!grade) {
                document.getElementById('selectClass').innerHTML = '<option value="">-- Ch·ªçn --</option>';
                return;
            }

            try {
                const res = await authFetch(`/api/classes?khoilop=${grade}`);
                const classes = await res.json();
                document.getElementById('selectClass').innerHTML = '<option value="">-- Ch·ªçn --</option>' +
                    classes.map(c => `<option value="${c.malop}">${c.malop}</option>`).join('');
            } catch (error) {
                console.error('L·ªói load classes:', error);
            }
        }

        async function onLoadClick() {
            const year = document.getElementById('selectYear').value;
            const semester = document.getElementById('selectSemester').value;
            const classId = document.getElementById('selectClass').value;

            if (!year || !semester || !classId) {
                toastWarning('Ch·ªçn ƒë·∫ßy ƒë·ªß th√¥ng tin');
                return;
            }

            window.currentYear = year;
            window.currentSemesterRaw = semester;

            try {
                const [studentsRes, hkRes] = await Promise.all([
                    authFetch(`/api/classes/${classId}/students`),
                    authFetch(`/api/hanhkiem/lop/${classId}?maNamHoc=${year}&maHocKy=${semester}`)
                ]);

                const students = await studentsRes.json();
                const hkData = (await hkRes.json()).data || [];

                const hkMap = {};
                hkData.forEach(row => {
                    const mhs = row.mahocsinh;
                    hkMap[mhs] = { diemhanhkiem: row.diemhanhkiem || '', xeploai: row.xeploai || '' };
                });

                currentData = students.map(s => {
                    const mhs = s.mahocsinh;
                    const hkInfo = hkMap[mhs] || { diemhanhkiem: '', xeploai: '' };
                    return {
                        mahocsinh: mhs,
                        hoten: s.hoten,
                        ngaysinh: s.ngaysinh || '',
                        diemhanhkiem: hkInfo.diemhanhkiem,
                        xeploai: hkInfo.xeploai
                    };
                });

                currentData.sort((a, b) => a.hoten.localeCompare(b.hoten, 'vi'));

                document.getElementById('classInfoBox').style.display = 'block';
                document.getElementById('toolbarRules').style.display = 'flex';
                document.getElementById('btnSave').style.display = 'inline-block';
                document.getElementById('classInfoText').textContent = `L·ªõp: ${classId} - ${semester}`;

                renderTable();
            } catch (error) {
                console.error('L·ªói:', error);
                toastError('L·ªói t·∫£i d·ªØ li·ªáu: ' + error.message);
            }
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            
            if (currentData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="padding: 20px; text-align: center;">Kh√¥ng c√≥ h·ªçc sinh</td></tr>';
                return;
            }

            tbody.innerHTML = currentData.map((s, idx) => {
                const diem = s.diemhanhkiem || '';
                const xepLoai = s.xeploai || '';
                let xepLoaiStyle = '';
                if (xepLoai === 'T·ªët') xepLoaiStyle = 'background:#d1fae5;color:#065f46';
                else if (xepLoai === 'Kh√°') xepLoaiStyle = 'background:#dbeafe;color:#1e40af';
                else if (xepLoai === 'Trung b√¨nh') xepLoaiStyle = 'background:#fef3c7;color:#92400e';
                else if (xepLoai === 'Y·∫øu') xepLoaiStyle = 'background:#fee2e2;color:#991b1b';

                const ngaysinh = s.ngaysinh ? new Date(s.ngaysinh).toLocaleDateString('vi-VN') : '-';

                return `
                    <tr>
                        <td style="text-align:center;">${idx + 1}</td>
                        <td><strong>${s.mahocsinh}</strong></td>
                        <td>${s.hoten}</td>
                        <td style="text-align:center;">${ngaysinh}</td>
                        <td style="text-align:center;">
                            <input type="number" class="hk-input ${diem ? 'filled' : ''}" 
                                   data-mhs="${s.mahocsinh}" value="${diem}"
                                   placeholder="0-100" min="0" max="100" step="0.01"
                                   onchange="handleDiemChange(this)">
                        </td>
                        <td style="text-align:center;">
                            <span class="xeploai-display" data-mhs="${s.mahocsinh}" 
                                  style="padding:4px 12px;border-radius:4px;font-weight:500;font-size:13px;display:inline-block;${xepLoaiStyle}">
                                ${xepLoai || '-'}
                            </span>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function handleDiemChange(input) {
            const mhs = input.dataset.mhs;
            let diem = parseFloat(input.value) || 0;
            
            if (diem > 100) diem = 100;
            if (diem < 0) diem = 0;
            input.value = diem;
            
            const student = currentData.find(s => s.mahocsinh === mhs);
            if (student) {
                student.diemhanhkiem = diem > 0 ? diem : null;
                student.xeploai = getHKRank(diem);
                
                const xepLoaiDisplay = input.closest('tr').querySelector('.xeploai-display');
                xepLoaiDisplay.textContent = student.xeploai || '-';
                xepLoaiDisplay.style.background = '';
                xepLoaiDisplay.style.color = '';
                
                if (student.xeploai === 'T·ªët') {
                    xepLoaiDisplay.style.background = '#d1fae5';
                    xepLoaiDisplay.style.color = '#065f46';
                } else if (student.xeploai === 'Kh√°') {
                    xepLoaiDisplay.style.background = '#dbeafe';
                    xepLoaiDisplay.style.color = '#1e40af';
                } else if (student.xeploai === 'Trung b√¨nh') {
                    xepLoaiDisplay.style.background = '#fef3c7';
                    xepLoaiDisplay.style.color = '#92400e';
                } else if (student.xeploai === 'Y·∫øu') {
                    xepLoaiDisplay.style.background = '#fee2e2';
                    xepLoaiDisplay.style.color = '#991b1b';
                }
                
                input.classList.toggle('filled', diem > 0);
            }
        }

        async function onSaveClick() {
            const toSave = currentData
                .filter(s => s.diemhanhkiem && s.diemhanhkiem > 0)
                .map(s => ({
                    maHocSinh: s.mahocsinh,
                    maNamHoc: window.currentYear,
                    maHocKy: window.currentSemesterRaw,
                    diemHanhKiem: s.diemhanhkiem,
                    xepLoai: getHKRank(s.diemhanhkiem),
                    ghiChu: null
                }));
            
            if (toSave.length === 0) {
                toastWarning('Ch∆∞a nh·∫≠p ƒëi·ªÉm h·∫°nh ki·ªÉm cho h·ªçc sinh n√†o');
                return;
            }

            try {
                for (const item of toSave) {
                    await authFetch('/api/hanhkiem/update', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(item)
                    });
                }
                toastSuccess(`ƒê√£ l∆∞u h·∫°nh ki·ªÉm cho ${toSave.length} h·ªçc sinh!`);
            } catch (error) {
                console.error('L·ªói:', error);
                toastError('L·ªói khi l∆∞u d·ªØ li·ªáu');
            }
        }
    </script>

</body>
</html>
