<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Nh·∫≠p h·∫°nh ki·ªÉm</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/layout/styles.css">
    <script src="/js/toast.js"></script>
    <script src="/js/auth.js"></script>
</head>

<body class="dashboard-body">

    <!-- SIDEBAR -->
    <aside class="sidebar">
        <div class="sidebar-logo">
            <img src="/assets/uit_logo.png" alt="UIT Logo">
            <span>QL H·ªçc Sinh</span>
        </div>

        <nav class="sidebar-menu">
            <a href="/pages/dashboard.html">Dashboard</a>
            <a href="/pages/students.html">Qu·∫£n l√Ω h·ªçc sinh</a>
            <a href="/pages/classes.html">Qu·∫£n l√Ω l·ªõp h·ªçc</a>
            <a href="/pages/subject_list.html">Qu·∫£n l√Ω m√¥n h·ªçc</a>
            <a href="/pages/grade_entry_select.html">Nh·∫≠p ƒëi·ªÉm</a>
            <a href="/pages/hanhkiem_entry.html" class="active">Nh·∫≠p h·∫°nh ki·ªÉm</a>
            <a href="/pages/grade_select.html">B·∫£ng ƒëi·ªÉm</a>
            <a href="/pages/student_transcript.html">Tra c·ª©u ƒëi·ªÉm HS</a>
            <a href="/pages/class_summary.html">T·ªïng k·∫øt l·ªõp</a>
            <a href="/pages/reports.html">B√°o c√°o t·ªïng k·∫øt</a>
            <a href="/pages/teaching_assignment.html" id="menuTeaching" style="display:none;">Ph√¢n c√¥ng gi·∫£ng d·∫°y</a>
            <a href="/pages/users.html" id="menuUsers" style="display:none;">Qu·∫£n l√Ω ng∆∞·ªùi d√πng</a>
        </nav>
    </aside>

    <!-- MAIN -->
    <div class="main">

        <!-- HEADER -->
        <header class="topbar">
            <div class="page-title">Nh·∫≠p h·∫°nh ki·ªÉm</div>
            <div class="user-info">
                <span id="userGreeting">Xin ch√†o, GVCN</span>
                <img src="/assets/user.png" class="avatar" alt="user">
                <button class="btn btn-outline btn-sm" onclick="logout()" style="margin-left:10px;">ƒêƒÉng xu·∫•t</button>
            </div>
        </header>

        <!-- CONTENT -->
        <div class="content">
            
            <!-- FILTERS -->
            <div class="filters-row" style="justify-content: flex-start; gap: 12px;">
                <div class="filter-item">
                    <label class="filter-label" for="selectYear">NƒÉm h·ªçc</label>
                    <select id="selectYear">
                        <option value="">-- Ch·ªçn nƒÉm h·ªçc --</option>
                    </select>
                </div>

                <div class="filter-item">
                    <label class="filter-label" for="selectSemester">H·ªçc k·ª≥</label>
                    <select id="selectSemester">
                        <option value="">-- Ch·ªçn h·ªçc k·ª≥ --</option>
                        <option value="HK1">H·ªçc k·ª≥ 1</option>
                        <option value="HK2">H·ªçc k·ª≥ 2</option>
                    </select>
                </div>

                <div class="filter-item">
                    <label class="filter-label" for="selectGrade">Kh·ªëi</label>
                    <select id="selectGrade">
                        <option value="">-- Ch·ªçn kh·ªëi --</option>
                    </select>
                </div>

                <div class="filter-item">
                    <label class="filter-label" for="selectClass">L·ªõp</label>
                    <select id="selectClass">
                        <option value="">-- Ch·ªçn l·ªõp --</option>
                    </select>
                </div>

                <button class="btn btn-primary" id="btnLoad" style="margin-top: 24px;">üìÇ T·∫£i danh s√°ch</button>
            </div>

            <!-- INFO -->
            <div id="classInfoBox" style="margin-bottom: 15px; padding: 12px; background: #f0f9ff; border-left: 4px solid #0284c7; border-radius: 4px; display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span id="classInfoText" style="color: #0c4a6e; font-size: 14px; font-weight: 500;"></span>
                    <span id="teacherInfo" style="color: #0c4a6e; font-size: 14px;"></span>
                    <span style="color: #059669; font-size: 14px; font-weight: 500;">Quy·ªÅn h·∫°n: B·∫°n c√≥ quy·ªÅn nh·∫≠p H·∫°nh ki·ªÉm</span>
                </div>
            </div>

            <!-- KEYBOARD SHORTCUTS -->
            <div id="keyboardHints" style="margin-bottom: 15px; padding: 10px; background: #fef3c7; border-left: 4px solid #f59e0b; border-radius: 4px; display: none;">
                <span style="color: #dc2626; font-size: 13px; font-weight: 500;">
                    C√°ch nh·∫≠p b·∫±ng ph√≠m t·∫Øt: <strong>[T·ªët]</strong> = 1, T, t·ªët, t&nbsp;&nbsp;&nbsp;<strong>[Kh√°]</strong> = 2, K, kh√°, k&nbsp;&nbsp;&nbsp;<strong>[Trung b√¨nh]</strong> = 3, Tb, trung b√¨nh, tb, b, B&nbsp;&nbsp;&nbsp;<strong>[Y·∫øu]</strong> = 4, Y, y·∫øu, y
                </span>
            </div>

            <!-- TABLE -->
            <div class="table-wrapper" style="background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow: hidden;">
                <table class="data-table" style="width: 100%; border-collapse: collapse;">
                    <thead style="background: #f3f4f6; border-bottom: 2px solid #e5e7eb;">
                        <tr>
                            <th style="padding: 12px; text-align: center; font-weight: 600; color: #374151; width: 50px;">STT</th>
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #374151; width: 110px;">M√£ h·ªçc sinh</th>
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #374151; width: 200px;">H·ªç v√† t√™n</th>
                            <th style="padding: 12px; text-align: center; font-weight: 600; color: #374151; width: 110px;">Ng√†y sinh</th>
                            <th style="padding: 12px; text-align: center; font-weight: 600; color: #374151; width: 90px;">ƒêi·ªÉm TK</th>
                            <th style="padding: 12px; text-align: center; font-weight: 600; color: #374151; width: 100px;">H·ªçc l·ª±c</th>
                            <th style="padding: 12px; text-align: center; font-weight: 600; color: #374151; width: 150px;">H·∫°nh ki·ªÉm</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr>
                            <td colspan="7" style="padding: 20px; text-align: center; color: #999;">Ch∆∞a c√≥ d·ªØ li·ªáu</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- BUTTONS -->
            <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn btn-success" id="btnSave" style="display: none; padding: 10px 20px;">üíæ L∆∞u h·∫°nh ki·ªÉm</button>
            </div>

        </div><!-- content -->
    </div><!-- main -->

    <style>
        .hk-input {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 15px;
            text-align: center;
            background: #fff;
            font-weight: 500;
        }
        .hk-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        }
        .hk-input.filled {
            background-color: #f0fdf4;
            font-weight: 500;
        }
        .hk-input.disabled-input {
            background-color: #f3f4f6;
            color: #9ca3af;
            cursor: not-allowed;
            border-color: #e5e7eb;
        }
        .hk-input.disabled-input::placeholder {
            color: #9ca3af;
        }
        table tbody tr {
            border-bottom: 1px solid #e5e7eb;
        }
        table tbody tr:hover {
            background-color: #f9fafb;
        }
        table td {
            padding: 12px;
        }
    </style>

    <script>
        let currentData = [];

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const user = getCurrentUser();
                if (!user) {
                    toastWarning('Ch∆∞a ƒëƒÉng nh·∫≠p');
                    setTimeout(() => window.location.href = '/pages/login.html', 1500);
                    return;
                }

                if (user.vaiTro !== 'GVCN' && user.vaiTro !== 'ADMIN') {
                    toastError('Kh√¥ng c√≥ quy·ªÅn');
                    setTimeout(() => window.location.href = '/pages/dashboard.html', 1500);
                    return;
                }

                document.getElementById('userGreeting').textContent = `Xin ch√†o, ${user.hoTen}`;
                if (user.vaiTro === 'ADMIN') {
                    document.getElementById('menuTeaching').style.display = 'block';
                    document.getElementById('menuUsers').style.display = 'block';
                }

                await loadDropdowns();

                document.getElementById('selectYear').addEventListener('change', loadClasses);
                document.getElementById('selectGrade').addEventListener('change', loadClasses);
                document.getElementById('btnLoad').addEventListener('click', onLoadClick);
                document.getElementById('btnSave').addEventListener('click', onSaveClick);

            } catch (error) {
                console.error(error);
                toastError('L·ªói: ' + error.message);
            }
        });

        async function loadDropdowns() {
            try {
                const userId = getUserIdOrThrow();
                const authHeaders = { 'x-user-id': userId };

                const [yRes, sRes, gRes] = await Promise.all([
                    fetch('/api/settings/school-years', { headers: authHeaders }),
                    fetch('/api/settings/semesters', { headers: authHeaders }),
                    fetch('/api/settings/grade-levels', { headers: authHeaders })
                ]);

                if (!yRes.ok || !sRes.ok || !gRes.ok) {
                    throw new Error('Kh√¥ng th·ªÉ t·∫£i danh s√°ch nƒÉm h·ªçc/k·ª≥/kh·ªëi');
                }

                const [years, semesters, grades] = await Promise.all([
                    yRes.json(), sRes.json(), gRes.json()
                ]);

                const yearSel = document.getElementById('selectYear');
                years.forEach(y => {
                    const opt = document.createElement('option');
                    opt.value = y.manamhoc;
                    opt.textContent = y.tennamhoc;
                    yearSel.appendChild(opt);
                });

                const semSel = document.getElementById('selectSemester');
                semSel.innerHTML = '<option value="">-- Ch·ªçn h·ªçc k·ª≥ --</option>';

                const getOrder = (val) => {
                    if (val === 'HK1' || val === '1' || val === 1) return 1;
                    if (val === 'HK2' || val === '2' || val === 2) return 2;
                    // ƒê·ªÉ C·∫£ nƒÉm xu·ªëng cu·ªëi
                    if (val === 'Nam' || val === 'CN' || val === '0' || val === 0) return 99;
                    return 50;
                };

                semesters
                    .map(s => ({
                        value: s.mahocky || s.maHocKy || s.MaHocKy || s.id,
                        text: s.tenhocky || s.tenHocKy || s.TenHocKy || s.name
                    }))
                    .sort((a, b) => getOrder(a.value) - getOrder(b.value))
                    .forEach(s => {
                        const opt = document.createElement('option');
                        opt.value = s.value;
                        opt.textContent = s.text;
                        semSel.appendChild(opt);
                    });

                const gradeSel = document.getElementById('selectGrade');
                gradeSel.innerHTML = '<option value="">-- Ch·ªçn kh·ªëi --</option>';
                grades.forEach(g => {
                    const opt = document.createElement('option');
                    const value = g.makhoilop || g.maKhoiLop || g.MaKhoiLop;
                    opt.value = value;
                    opt.textContent = g.tenkhoilop || g.tenKhoiLop || g.TenKhoiLop || ('Kh·ªëi ' + value);
                    gradeSel.appendChild(opt);
                });
            } catch (error) {
                console.error(error);
                toastError('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu: ' + error.message);
            }
        }

        async function loadClasses() {
            const year = document.getElementById('selectYear').value;
            const grade = document.getElementById('selectGrade').value;
            const classEl = document.getElementById('selectClass');

            classEl.innerHTML = '<option value="">-- Ch·ªçn l·ªõp --</option>';

            if (!year || !grade) return;

            try {
                const userId = getUserIdOrThrow();
                const params = new URLSearchParams({ khoi: grade, namhoc: year });
                const res = await fetch('/api/classes?' + params.toString(), {
                    headers: { 'x-user-id': userId }
                });
                if (!res.ok) throw new Error('Cannot load classes');
                const classes = await res.json();

                classes.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c.malop || c.MaLop;
                    opt.textContent = c.tenlop || c.TenLop;
                    classEl.appendChild(opt);
                });
            } catch (error) {
                console.error(error);
                toastError('Kh√¥ng th·ªÉ t·∫£i l·ªõp: ' + error.message);
            }
        }

        function normalizeSemester(semRaw) {
            if (semRaw === 'HK1' || semRaw === '1' || semRaw === 1) return 1;
            if (semRaw === 'HK2' || semRaw === '2' || semRaw === 2) return 2;
            if (semRaw === 'Nam' || semRaw === 'CN' || semRaw === '0' || semRaw === 0) return 0;
            const num = parseInt(semRaw);
            return Number.isNaN(num) ? null : num;
        }

        function getUserIdOrThrow() {
            const user = getCurrentUser();
            const userId = user?.maNguoiDung || user?.manguoidung || user?.MaNguoiDung;
            if (!user || !userId) {
                toastError('Kh√¥ng t√¨m th·∫•y th√¥ng tin ng∆∞·ªùi d√πng. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.');
                throw new Error('Missing user or maNguoiDung in local storage');
            }
            return userId.toString();
        }

        async function onLoadClick() {
            const year = document.getElementById('selectYear').value;
            const cls = document.getElementById('selectClass').value;
            const semRaw = document.getElementById('selectSemester').value;

            if (!year || !cls || !semRaw) {
                toastWarning('Ch·ªçn nƒÉm h·ªçc, l·ªõp v√† h·ªçc k·ª≥');
                return;
            }

            // Store for later use in save
            window.currentYear = year;
            window.currentSemesterRaw = semRaw;

            try {
                const userId = getUserIdOrThrow();
                const authHeaders = { 'x-user-id': userId };

                // Load students
                const sRes = await fetch(`/api/classes/${cls}/students`, { headers: authHeaders });
                if (!sRes.ok) throw new Error('Cannot load students');
                const students = await sRes.json();

                // Load scores AND hanhkiem using the SAME API as reports page (which works!)
                // This API already includes hanhkiemhk1, hanhkiemhk2, hanhkiemcn
                const scoresRes = await fetch(`/api/reports/class-final?maLop=${cls}&namhoc=${year}`, { headers: authHeaders });
                const scoresData = scoresRes.ok ? await scoresRes.json() : { success: false, data: [] };

                console.log('Scores API response:', scoresData);

                // Map semester to column name
                const semesterKey = semRaw || 'HK1';

                // Build score map AND hanhkiem map from the SAME response - SAME logic as reports page
                const scoreMap = {};
                const hkMap = {}; // H·∫°nh ki·ªÉm t·ª´ c√πng API
                
                if (scoresData.success && scoresData.data) {
                    scoresData.data.forEach(row => {
                        const mhs = row.mahocsinh || row.MaHocSinh;
                        const tenMon = row.tenmonhoc || row.TenMonHoc;
                        
                        // Get the score for the selected semester
                        let diemRaw;
                        if (semesterKey === 'HK1') {
                            diemRaw = row.diemtbhk1 || row.DiemTBHK1;
                        } else if (semesterKey === 'HK2') {
                            diemRaw = row.diemtbhk2 || row.DiemTBHK2;
                        } else {
                            diemRaw = row.diemtbnam || row.DiemTBNam;
                        }
                        
                        const diem = typeof diemRaw === 'number' ? diemRaw : parseFloat(diemRaw);
                        
                        if (!scoreMap[mhs]) {
                            scoreMap[mhs] = { grades: {}, list: [] };
                        }
                        if (!isNaN(diem) && diem !== null) {
                            scoreMap[mhs].grades[tenMon] = diem;
                            scoreMap[mhs].list.push(diem);
                        }
                        
                        // L·∫•y h·∫°nh ki·ªÉm t·ª´ C√ôNG response - gi·ªëng b√°o c√°o t·ªïng k·∫øt
                        if (!hkMap[mhs]) {
                            let hkValue = '';
                            if (semesterKey === 'HK1') {
                                hkValue = row.hanhkiemhk1 || row.HanhKiemHK1 || '';
                            } else if (semesterKey === 'HK2') {
                                hkValue = row.hanhkiemhk2 || row.HanhKiemHK2 || '';
                            } else {
                                hkValue = row.hanhkiemcn || row.HanhKiemCN || '';
                            }
                            hkMap[mhs] = hkValue;
                        }
                    });
                }

                console.log('Score map:', scoreMap);
                console.log('HanhKiem map:', hkMap);

                // Compute DiemTK and HocLuc - EXACT same logic as reports page
                Object.keys(scoreMap).forEach(mhs => {
                    const info = scoreMap[mhs];
                    const scores = info.list || [];
                    const avgNum = scores.length > 0 ? (scores.reduce((a,b)=>a+b,0) / scores.length) : null;
                    info.diemtk = avgNum !== null ? avgNum.toFixed(2) : '-';

                    const hasToan = 'To√°n' in info.grades;
                    const hasVan = 'Ng·ªØ VƒÉn' in info.grades;
                    const toan = hasToan ? info.grades['To√°n'] : undefined;
                    const van = hasVan ? info.grades['Ng·ªØ VƒÉn'] : undefined;
                    const anyBelow = (thr) => scores.some(v => v < thr);
                    const anyGE = (score, thr) => (score !== undefined && !isNaN(score) && score >= thr);

                    let hocLuc = '-';
                    if (avgNum !== null) {
                        if (avgNum >= 8.0 && (anyGE(toan,8.0) || anyGE(van,8.0)) && !anyBelow(6.5)) hocLuc = 'Gi·ªèi';
                        else if (avgNum >= 6.5 && (anyGE(toan,6.5) || anyGE(van,6.5)) && !anyBelow(5.0)) hocLuc = 'Kh√°';
                        else if (avgNum >= 5.0 && (anyGE(toan,5.0) || anyGE(van,5.0)) && !anyBelow(3.5)) hocLuc = 'Trung b√¨nh';
                        else if (avgNum >= 3.5 && !anyBelow(2.0)) hocLuc = 'Y·∫øu';
                        else hocLuc = 'K√©m';
                    }
                    info.hocluc = hocLuc;
                });

                currentData = students.map(s => {
                    const mhs = s.mahocsinh || s.MaHocSinh;
                    return {
                        mahocsinh: mhs,
                        hoten: s.hoten || s.HoTen,
                        ngaysinh: s.ngaysinh || s.NgaySinh || '',
                        diemtk: scoreMap[mhs]?.diemtk || '-',
                        hocluc: scoreMap[mhs]?.hocluc || '-',
                        xeploai: hkMap[mhs] || '' // hkMap[mhs] l√† string tr·ª±c ti·∫øp (T·ªët, Kh√°, ...)
                    };
                });

                renderTable();
                document.getElementById('btnSave').style.display = 'inline-block';
                document.getElementById('keyboardHints').style.display = 'block';
                
                const clsName = document.getElementById('selectClass').selectedOptions[0].text;
                const semName = semesterKey === 'HK1' ? 'H·ªçc k·ª≥ 1' : semesterKey === 'HK2' ? 'H·ªçc k·ª≥ 2' : 'C·∫£ nƒÉm';
                
                document.getElementById('classInfoBox').style.display = 'block';
                document.getElementById('classInfoText').textContent = `L·ªõp: ${clsName} - ${semName}`;
                
                const user = getCurrentUser();
                document.getElementById('teacherInfo').textContent = `Gi√°o vi√™n ch·ªß nhi·ªám: ${user.hoTen}`;
            } catch (error) {
                console.error(error);
                toastError('L·ªói: ' + error.message);
            }
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody');

            if (currentData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">Kh√¥ng c√≥ h·ªçc sinh</td></tr>';
                return;
            }

            tbody.innerHTML = currentData.map((s, idx) => {
                const ngaysinh = s.ngaysinh ? new Date(s.ngaysinh).toLocaleDateString('vi-VN') : '';
                const hasGrades = s.diemtk !== '-';
                const disabledAttr = '';
                const disabledClass = '';
                const disabledTitle = hasGrades ? '' : 'title="H·ªçc sinh ch∆∞a c√≥ ƒëi·ªÉm t·ªïng k·∫øt h·ªçc k·ª≥ - v·∫´n c√≥ th·ªÉ nh·∫≠p"';
                
                return `
                <tr>
                    <td style="text-align:center;">${idx + 1}</td>
                    <td>${s.mahocsinh}</td>
                    <td>${s.hoten}</td>
                    <td style="text-align:center;">${ngaysinh}</td>
                    <td style="text-align:center; font-weight: 500;">${s.diemtk}</td>
                    <td style="text-align:center;">${s.hocluc}</td>
                    <td style="text-align:center;">
                           <input type="text" 
                               class="hk-input ${s.xeploai ? 'filled' : ''} ${disabledClass}" 
                               data-mhs="${s.mahocsinh}"
                               value="${hasGrades ? s.xeploai : ''}"
                               placeholder="${hasGrades ? '' : 'Ch∆∞a c√≥ ƒëi·ªÉm'}"
                               maxlength="15"
                               ${disabledAttr}
                               ${disabledTitle}>
                    </td>
                </tr>
            `}).join('');

            // Add keyboard event listeners
            tbody.querySelectorAll('.hk-input').forEach(input => {
                if (!input.disabled) {
                    input.addEventListener('keydown', (e) => {
                        if (e.key === 'ArrowDown') {
                            e.preventDefault();
                            const inputs = Array.from(document.querySelectorAll('.hk-input:not([disabled])'));
                            const currentIndex = inputs.indexOf(e.target);
                            if (currentIndex < inputs.length - 1) {
                                inputs[currentIndex + 1].focus();
                            }
                        } else if (e.key === 'ArrowUp') {
                            e.preventDefault();
                            const inputs = Array.from(document.querySelectorAll('.hk-input:not([disabled])'));
                            const currentIndex = inputs.indexOf(e.target);
                            if (currentIndex > 0) {
                                inputs[currentIndex - 1].focus();
                            }
                        } else if (e.key === 'Enter') {
                            e.preventDefault();
                            e.target.blur();
                            setTimeout(() => {
                                const inputs = Array.from(document.querySelectorAll('.hk-input:not([disabled])'));
                                const currentIndex = inputs.indexOf(e.target);
                                if (currentIndex < inputs.length - 1) {
                                    inputs[currentIndex + 1].focus();
                                }
                            }, 0);
                        }
                    });
                    
                    input.addEventListener('blur', (e) => {
                        const val = e.target.value.trim().toLowerCase();
                        const mhs = e.target.dataset.mhs;
                        const s = currentData.find(x => x.mahocsinh === mhs);
                        
                        if (!val) {
                            if (s) s.xeploai = '';
                            e.target.classList.remove('filled');
                            return;
                        }
                        
                        // Map shortcuts to values
                        let mappedValue = '';
                        if (val === '1' || val === 't' || val === 't·ªët') {
                            mappedValue = 'T·ªët';
                        } else if (val === '2' || val === 'k' || val === 'kh√°') {
                            mappedValue = 'Kh√°';
                        } else if (val === '3' || val === 'tb' || val === 'trung b√¨nh' || val === 'b') {
                            mappedValue = 'Trung b√¨nh';
                        } else if (val === '4' || val === 'y' || val === 'y·∫øu') {
                            mappedValue = 'Y·∫øu';
                        } else {
                            toastWarning('Gi√° tr·ªã kh√¥ng h·ª£p l·ªá. Ch·ªâ nh·∫≠p: T·ªët, Kh√°, Trung b√¨nh, Y·∫øu ho·∫∑c 1,2,3,4');
                            e.target.value = '';
                            if (s) s.xeploai = '';
                            e.target.classList.remove('filled');
                            return;
                        }
                        
                        e.target.value = mappedValue;
                        if (s) s.xeploai = mappedValue;
                        e.target.classList.add('filled');
                    });
                }
            });
        }

        function validateHanhKiemValue(value) {
            const valid = ['T·ªët', 'Kh√°', 'Trung b√¨nh', 'Y·∫øu', ''];
            return valid.includes(value);
        }

        async function onSaveClick() {
            // Force blur on current focused input to save its value
            if (document.activeElement && document.activeElement.classList.contains('hk-input')) {
                document.activeElement.blur();
                // Wait a moment for blur event to complete
                await new Promise(resolve => setTimeout(resolve, 100));
            }

            // Sync currentData with actual input values before saving
            document.querySelectorAll('.hk-input').forEach(input => {
                const mhs = input.dataset.mhs;
                const s = currentData.find(x => x.mahocsinh === mhs);
                if (s) {
                    const val = input.value.trim();
                    s.xeploai = val || '';
                }
            });

            // G·ª≠i T·∫§T C·∫¢ h·ªçc sinh - backend s·∫Ω x√≥a nh·ªØng b·∫£n ghi c√≥ xepLoai r·ªóng
            const toSave = currentData.map(s => ({
                maHocSinh: s.mahocsinh,
                maNamHoc: window.currentYear,
                maHocKy: window.currentSemesterRaw,
                xepLoai: s.xeploai ? s.xeploai.trim() : null, // null = x√≥a
                diemHanhKiem: null,
                ghiChu: null
            }));
            
            // Ch·ªâ c·∫£nh b√°o n·∫øu kh√¥ng c√≥ h·ªçc sinh n√†o
            if (toSave.length === 0) {
                toastWarning('Kh√¥ng c√≥ h·ªçc sinh trong danh s√°ch');
                return;
            }

            try {
                // Use VARCHAR values from dropdown, not integers
                const maNamHoc = window.currentYear; // e.g., "2024-2025"
                const maHocKy = window.currentSemesterRaw; // e.g., "HK1" or "HK2"

                const payload = {
                    hanhKiemList: toSave
                };

                // Count saves and deletes for message
                const actualSaves = toSave.filter(s => s.xepLoai);
                const deletes = toSave.filter(s => !s.xepLoai);

                console.log('Saving payload:', JSON.stringify(payload, null, 2));

                const user = getCurrentUser();
                const userId = user.maNguoiDung || user.manguoidung || user.MaNguoiDung;
                if (!user || !userId) {
                    toastError('Kh√¥ng t√¨m th·∫•y th√¥ng tin ng∆∞·ªùi d√πng. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.');
                    console.error('User data:', user);
                    return;
                }

                console.log('User info:', { 
                    maNguoiDung: userId, 
                    vaiTro: user.vaiTro, 
                    hoTen: user.hoTen 
                });

                const res = await fetch('/api/hanhkiem/bulk-upsert', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-user-id': userId.toString()
                    },
                    body: JSON.stringify(payload)
                });

                if (!res.ok) {
                    let errText = 'Save failed';
                    try {
                        const err = await res.json();
                        errText = err.error || err.message || errText;
                    } catch (_) {}
                    console.error('Save error status:', res.status, 'message:', errText);
                    toastError(`L·ªói (${res.status}): ${errText}`);
                    return;
                }

                toastSuccess('ƒê√£ l∆∞u h·∫°nh ki·ªÉm th√†nh c√¥ng');
                await onLoadClick();
            } catch (error) {
                console.error(error);
                toastError('L·ªói: ' + error.message);
            }
        }
    </script>

</body>
</html>
