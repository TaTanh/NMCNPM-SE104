<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Nh·∫≠p h·∫°nh ki·ªÉm</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/layout/styles.css">
    <script src="/js/toast.js"></script>
    <script src="/js/auth.js"></script>
</head>

<body class="dashboard-body">

    <!-- SIDEBAR -->
    <aside class="sidebar">
        <div class="sidebar-logo">
            <img src="/assets/uit_logo.png" alt="UIT Logo">
            <span>QL H·ªçc Sinh</span>
        </div>

        <nav class="sidebar-menu">
            <a href="/pages/dashboard.html">Dashboard</a>
            <a href="/pages/students.html">Qu·∫£n l√Ω h·ªçc sinh</a>
            <a href="/pages/classes.html">Qu·∫£n l√Ω l·ªõp h·ªçc</a>
            <a href="/pages/subject_list.html">Qu·∫£n l√Ω m√¥n h·ªçc</a>
            <a href="/pages/grade_entry_select.html">Nh·∫≠p ƒëi·ªÉm</a>
            <a href="/pages/hanhkiem_entry.html" class="active">Nh·∫≠p h·∫°nh ki·ªÉm</a>
            <a href="/pages/grade_select.html">B·∫£ng ƒëi·ªÉm</a>
            <a href="/pages/student_transcript.html">Tra c·ª©u ƒëi·ªÉm HS</a>
            <a href="/pages/class_summary.html">T·ªïng k·∫øt l·ªõp</a>
            <a href="/pages/reports.html">B√°o c√°o t·ªïng k·∫øt</a>
            <a href="/pages/teaching_assignment.html" id="menuTeaching" style="display:none;">Ph√¢n c√¥ng gi·∫£ng d·∫°y</a>
            <a href="/pages/users.html" id="menuUsers" style="display:none;">Qu·∫£n l√Ω ng∆∞·ªùi d√πng</a>
        </nav>

    </aside>

    <!-- MAIN -->
    <div class="main">

        <!-- HEADER -->
        <header class="topbar">
            <div class="page-title">Nh·∫≠p h·∫°nh ki·ªÉm</div>
            <div class="user-info">
                <span id="userGreeting">Xin ch√†o, GVCN</span>
                <img src="/assets/user.png" class="avatar" alt="user">
                <button class="btn btn-outline btn-sm" onclick="logout()" style="margin-left:10px;">ƒêƒÉng xu·∫•t</button>
            </div>
        </header>

        <!-- CONTENT -->
        <div class="content">
            <!-- FILTER: L·ªöP + H·ªåC K·ª≤ + NƒÇM H·ªåC -->
            <div class="filters-row">
                <div class="filter-item">
                    <label class="filter-label" for="classFilter">L·ªõp <span style="color:red">*</span></label>
                    <select id="classFilter" required>
                        <option value="">-- Ch·ªçn l·ªõp --</option>
                    </select>
                </div>

                <div class="filter-item">
                    <label class="filter-label" for="yearFilter">NƒÉm h·ªçc <span style="color:red">*</span></label>
                    <select id="yearFilter" required>
                        <option value="">-- Ch·ªçn nƒÉm h·ªçc --</option>
                    </select>
                </div>

                <div class="filter-item">
                    <label class="filter-label" for="semesterFilter">H·ªçc k·ª≥ <span style="color:red">*</span></label>
                    <select id="semesterFilter" required>
                        <option value="">-- Ch·ªçn h·ªçc k·ª≥ --</option>
                        <option value="1">H·ªçc k·ª≥ 1</option>
                        <option value="2">H·ªçc k·ª≥ 2</option>
                    </select>
                </div>

                <div class="filter-item" style="display:flex; align-items:flex-end;">
                    <button class="btn btn-primary" id="btnLoadHanhKiem">T·∫£i danh s√°ch</button>
                </div>
            </div>

            <!-- TOOLBAR -->
            <div class="toolbar">
                <div class="toolbar-info">
                    <span id="classInfo">Ch·ªçn l·ªõp ƒë·ªÉ nh·∫≠p h·∫°nh ki·ªÉm</span>
                </div>

                <div class="toolbar-actions">
                    <button class="btn btn-success" id="btnSaveAll">üíæ L∆∞u t·∫•t c·∫£</button>
                    <button class="btn btn-outline" id="btnStats">üìä Th·ªëng k√™</button>
                </div>
            </div>

            <!-- TABLE -->
            <div class="table-wrapper">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th style="width:50px;">STT</th>
                            <th style="width:120px;">M√£ HS</th>
                            <th style="width:200px;">H·ªç t√™n</th>
                            <th style="width:80px;">Gi·ªõi t√≠nh</th>
                            <th style="width:120px;">ƒêi·ªÉm h·∫°nh ki·ªÉm</th>
                            <th style="width:150px;">X·∫øp lo·∫°i h·∫°nh ki·ªÉm</th>
                            <th>Ghi ch√∫</th>
                        </tr>
                    </thead>

                    <tbody id="hanhkiemTableBody">
                        <tr>
                            <td colspan="6" style="text-align:center;">Vui l√≤ng ch·ªçn l·ªõp, nƒÉm h·ªçc v√† h·ªçc k·ª≥</td>
                        </tr>
                    </tbody>
                </table>
            </div>

        </div><!-- content -->
    </div><!-- main -->

    <!-- ========== MODAL TH·ªêNG K√ä ========== -->
    <div class="modal-overlay" id="statsModal">
        <div class="modal" style="max-width:600px;">
            <div class="modal-header">
                <h2>Th·ªëng k√™ h·∫°nh ki·ªÉm l·ªõp</h2>
                <button class="modal-close" id="closeStatsBtn">&times;</button>
            </div>

            <div class="modal-body">
                <div id="statsContent" style="padding:20px;">
                    <p style="text-align:center;">ƒêang t·∫£i th·ªëng k√™...</p>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-outline" id="btnCloseStats">ƒê√≥ng</button>
            </div>
        </div>
    </div>

    <script>
        // ========== KI·ªÇM TRA QUY·ªÄN TRUY C·∫¨P ==========
        document.addEventListener('DOMContentLoaded', () => {
            const user = getCurrentUser();
            if (!user) {
                window.location.href = '/pages/login.html';
                return;
            }

            // Ch·ªâ GVCN v√† ADMIN m·ªõi ƒë∆∞·ª£c nh·∫≠p h·∫°nh ki·ªÉm
            if (user.vaiTro !== 'GVCN' && user.vaiTro !== 'ADMIN') {
                toastError('B·∫°n kh√¥ng c√≥ quy·ªÅn nh·∫≠p h·∫°nh ki·ªÉm');
                setTimeout(() => {
                    window.location.href = '/pages/dashboard.html';
                }, 2000);
                return;
            }

            document.getElementById('userGreeting').textContent = `Xin ch√†o, ${user.hoTen}`;
            
            // Show menu ph√¢n c√¥ng gi·∫£ng d·∫°y cho Admin
            if (user.vaiTro === 'ADMIN') {
                document.getElementById('menuTeaching').style.display = 'block';
                document.getElementById('menuUsers').style.display = 'block';
            }

            loadFilters();
        });

        // ========== LOAD FILTERS ==========
        async function loadFilters() {
            try {
                // Load l·ªõp
                const classesRes = await fetch('/api/classes');
                const classes = await classesRes.json();
                const classSelect = document.getElementById('classFilter');
                classes.forEach(c => {
                    const option = document.createElement('option');
                    option.value = c.malop;
                    option.textContent = c.tenlop;
                    classSelect.appendChild(option);
                });

                // Load nƒÉm h·ªçc
                const yearsRes = await fetch('/api/settings/school-years');
                const years = await yearsRes.json();
                const yearSelect = document.getElementById('yearFilter');
                years.forEach(y => {
                    const option = document.createElement('option');
                    option.value = y.manamhoc;
                    option.textContent = y.tennamhoc;
                    yearSelect.appendChild(option);
                });

                // Set nƒÉm h·ªçc hi·ªán t·∫°i
                if (years.length > 0) {
                    yearSelect.value = years[0].manamhoc;
                }
            } catch (error) {
                console.error('L·ªói load filters:', error);
                toastError('Kh√¥ng th·ªÉ t·∫£i danh s√°ch l·ªõp v√† nƒÉm h·ªçc');
            }
        }

        // ========== LOAD DANH S√ÅCH H·∫†NH KI·ªÇM ==========
        let currentStudents = [];

        document.getElementById('btnLoadHanhKiem').addEventListener('click', loadHanhKiem);

        async function loadHanhKiem() {
            const maLop = document.getElementById('classFilter').value;
            const maNamHoc = document.getElementById('yearFilter').value;
            const maHocKy = document.getElementById('semesterFilter').value;

            if (!maLop || !maNamHoc || !maHocKy) {
                toastWarning('Vui l√≤ng ch·ªçn ƒë·∫ßy ƒë·ªß l·ªõp, nƒÉm h·ªçc v√† h·ªçc k·ª≥');
                return;
            }

            try {
                // L·∫•y danh s√°ch h·ªçc sinh trong l·ªõp
                const studentsRes = await fetch(`/api/classes/${maLop}/students`);
                if (!studentsRes.ok) throw new Error('Kh√¥ng th·ªÉ t·∫£i danh s√°ch h·ªçc sinh');
                const students = await studentsRes.json();

                // L·∫•y h·∫°nh ki·ªÉm ƒë√£ nh·∫≠p
                const hanhkiemRes = await fetch(`/api/hanhkiem/lop/${maLop}?maNamHoc=${maNamHoc}&maHocKy=${maHocKy}`);
                const hanhkiemData = await hanhkiemRes.json();

                const hanhkiemMap = {};
                if (hanhkiemData.success && hanhkiemData.data) {
                    hanhkiemData.data.forEach(hk => {
                        hanhkiemMap[hk.mahocsinh] = {
                            diemhanhkiem: hk.diemhanhkiem || '',
                            xeploai: hk.xeploai,
                            ghichu: hk.ghichu || ''
                        };
                    });
                }

                currentStudents = students.map(hs => ({
                    ...hs,
                    diemhanhkiem: hanhkiemMap[hs.mahocsinh]?.diemhanhkiem || '',
                    xeploai: hanhkiemMap[hs.mahocsinh]?.xeploai || '',
                    ghichu: hanhkiemMap[hs.mahocsinh]?.ghichu || ''
                }));

                // S·∫Øp x·∫øp theo t√™n (ph·∫ßn cu·ªëi c√πng c·ªßa h·ªç t√™n)
                currentStudents.sort((a, b) => {
                    const tenA = a.hoten.trim().split(' ').pop().toLowerCase();
                    const tenB = b.hoten.trim().split(' ').pop().toLowerCase();
                    return tenA.localeCompare(tenB, 'vi');
                });

                renderHanhKiemTable();

                const className = document.getElementById('classFilter').selectedOptions[0].text;
                const yearName = document.getElementById('yearFilter').selectedOptions[0].text;
                const semester = maHocKy == 1 ? 'H·ªçc k·ª≥ 1' : 'H·ªçc k·ª≥ 2';
                document.getElementById('classInfo').textContent = `${className} - ${yearName} - ${semester} (${currentStudents.length} h·ªçc sinh)`;

            } catch (error) {
                console.error('L·ªói:', error);
                toastError('L·ªói khi t·∫£i danh s√°ch: ' + error.message);
            }
        }

        // ========== H√ÄM T√çNH X·∫æP LO·∫†I T·ª™ ƒêI·ªÇM ==========
        function tinhXepLoaiTuDiem(diem) {
            if (!diem || diem === '') return '';
            const diemNum = parseFloat(diem);
            if (isNaN(diemNum)) return '';
            
            if (diemNum >= 80) return 'T·ªët';
            if (diemNum >= 65) return 'Kh√°';
            if (diemNum >= 50) return 'Trung b√¨nh';
            return 'Y·∫øu';
        }

        // ========== RENDER B·∫¢NG ==========
        function renderHanhKiemTable() {
            const tbody = document.getElementById('hanhkiemTableBody');

            if (currentStudents.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">Kh√¥ng c√≥ h·ªçc sinh trong l·ªõp</td></tr>';
                return;
            }

            tbody.innerHTML = currentStudents.map((hs, index) => `
                <tr>
                    <td style="text-align:center;">${index + 1}</td>
                    <td>${hs.mahocsinh}</td>
                    <td>${hs.hoten}</td>
                    <td>${hs.gioitinh || ''}</td>
                    <td>
                        <input type="number" 
                               class="form-control hanhkiem-diem" 
                               data-mahocsinh="${hs.mahocsinh}"
                               value="${hs.diemhanhkiem || ''}"
                               min="0" 
                               max="100" 
                               step="1"
                               placeholder="0-100"
                               style="width:100px;">
                    </td>
                    <td>
                        <span class="hanhkiem-xeploai" data-mahocsinh="${hs.mahocsinh}" style="font-weight:500;">
                            ${hs.xeploai || ''}
                        </span>
                    </td>
                    <td>
                        <input type="text" class="form-control hanhkiem-note" 
                               data-mahocsinh="${hs.mahocsinh}" 
                               value="${hs.ghichu || ''}" 
                               placeholder="Ghi ch√∫ (n·∫øu c√≥)">
                    </td>
                </tr>
            `).join('');

            // G·∫Øn event cho input ƒëi·ªÉm - t·ª± ƒë·ªông t√≠nh x·∫øp lo·∫°i
            tbody.querySelectorAll('.hanhkiem-diem').forEach(input => {
                input.addEventListener('input', (e) => {
                    const maHocSinh = e.target.dataset.mahocsinh;
                    const diem = e.target.value;
                    const student = currentStudents.find(s => s.mahocsinh == maHocSinh);
                    
                    if (student) {
                        student.diemhanhkiem = diem;
                        student.xeploai = tinhXepLoaiTuDiem(diem);
                        
                        // C·∫≠p nh·∫≠t span x·∫øp lo·∫°i
                        const spanElement = e.target.closest('tr').querySelector('.hanhkiem-xeploai');
                        if (spanElement) {
                            spanElement.textContent = student.xeploai;
                        }
                    }
                });
            });

            tbody.querySelectorAll('.hanhkiem-note').forEach(input => {
                input.addEventListener('change', (e) => {
                    const maHocSinh = e.target.dataset.mahocsinh;
                    const student = currentStudents.find(s => s.mahocsinh == maHocSinh);
                    if (student) {
                        student.ghichu = e.target.value;
                    }
                });
            });
        }

        // ========== L∆ØU T·∫§T C·∫¢ ==========
        document.getElementById('btnSaveAll').addEventListener('click', async () => {
            const maLop = document.getElementById('classFilter').value;
            const maNamHoc = document.getElementById('yearFilter').value;
            const maHocKy = document.getElementById('semesterFilter').value;

            if (!maLop || !maNamHoc || !maHocKy) {
                toastWarning('Vui l√≤ng ch·ªçn l·ªõp, nƒÉm h·ªçc v√† h·ªçc k·ª≥ tr∆∞·ªõc');
                return;
            }

            // L·ªçc ch·ªâ h·ªçc sinh ƒë√£ nh·∫≠p ƒëi·ªÉm h·∫°nh ki·ªÉm
            const hanhKiemList = currentStudents
                .filter(hs => hs.diemhanhkiem && hs.diemhanhkiem !== '')
                .map(hs => ({
                    maHocSinh: hs.mahocsinh,
                    maNamHoc: parseInt(maNamHoc),
                    maHocKy: parseInt(maHocKy),
                    diemHanhKiem: parseFloat(hs.diemhanhkiem),
                    xepLoai: hs.xeploai,
                    ghiChu: hs.ghichu || null
                }));

            if (hanhKiemList.length === 0) {
                toastWarning('Ch∆∞a c√≥ h·ªçc sinh n√†o ƒë∆∞·ª£c nh·∫≠p ƒëi·ªÉm h·∫°nh ki·ªÉm');
                return;
            }

            try {
                const user = getCurrentUser();
                const response = await fetch('/api/hanhkiem/bulk-upsert', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'x-user-id': user.maNguoiDung
                    },
                    body: JSON.stringify({ hanhKiemList })
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.message || 'L·ªói khi l∆∞u h·∫°nh ki·ªÉm');
                }

                toastSuccess(`ƒê√£ l∆∞u h·∫°nh ki·ªÉm cho ${hanhKiemList.length} h·ªçc sinh`);
                loadHanhKiem(); // Reload ƒë·ªÉ c·∫≠p nh·∫≠t

            } catch (error) {
                console.error('L·ªói:', error);
                toastError('L·ªói: ' + error.message);
            }
        });

        // ========== TH·ªêNG K√ä ==========
        document.getElementById('btnStats').addEventListener('click', async () => {
            const maLop = document.getElementById('classFilter').value;
            const maNamHoc = document.getElementById('yearFilter').value;
            const maHocKy = document.getElementById('semesterFilter').value;

            if (!maLop || !maNamHoc || !maHocKy) {
                toastWarning('Vui l√≤ng ch·ªçn l·ªõp, nƒÉm h·ªçc v√† h·ªçc k·ª≥ tr∆∞·ªõc');
                return;
            }

            try {
                const response = await fetch(`/api/hanhkiem/thongke/lop/${maLop}?maNamHoc=${maNamHoc}&maHocKy=${maHocKy}`);
                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.message || 'L·ªói khi l·∫•y th·ªëng k√™');
                }

                const stats = result.data;
                const total = stats.reduce((sum, item) => sum + parseInt(item.soluong), 0);

                let html = `
                    <table class="data-table" style="margin-top:0;">
                        <thead>
                            <tr>
                                <th>X·∫øp lo·∫°i</th>
                                <th>S·ªë l∆∞·ª£ng</th>
                                <th>T·ª∑ l·ªá</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                stats.forEach(item => {
                    html += `
                        <tr>
                            <td><strong>${item.xeploai}</strong></td>
                            <td style="text-align:center;">${item.soluong}</td>
                            <td style="text-align:center;">${item.tile}%</td>
                        </tr>
                    `;
                });

                html += `
                        <tr style="background-color:#f0f0f0; font-weight:bold;">
                            <td>T·ªïng</td>
                            <td style="text-align:center;">${total}</td>
                            <td style="text-align:center;">100%</td>
                        </tr>
                    </tbody>
                    </table>
                `;

                document.getElementById('statsContent').innerHTML = html;
                document.getElementById('statsModal').classList.add('show');

            } catch (error) {
                console.error('L·ªói:', error);
                toastError('L·ªói: ' + error.message);
            }
        });

        document.getElementById('closeStatsBtn').onclick = 
        document.getElementById('btnCloseStats').onclick = () => {
            document.getElementById('statsModal').classList.remove('show');
        };

        document.getElementById('statsModal').addEventListener('click', (e) => {
            if (e.target.id === 'statsModal') {
                document.getElementById('statsModal').classList.remove('show');
            }
        });
    </script>

</body>
</html>
