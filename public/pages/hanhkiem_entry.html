<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Nhập hạnh kiểm</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/layout/styles.css">
    <script src="/js/toast.js"></script>
    <script src="/js/auth.js"></script>
</head>

<body class="dashboard-body">

    <!-- SIDEBAR -->
    <aside class="sidebar">
        <div class="sidebar-logo">
            <img src="/assets/uit_logo.png" alt="UIT Logo">
            <span>QL Học Sinh</span>
        </div>

        <nav class="sidebar-menu">
            <a href="/pages/dashboard.html">Dashboard</a>
            <a href="/pages/students.html">Quản lý học sinh</a>
            <a href="/pages/classes.html">Quản lý lớp học</a>
            <a href="/pages/subject_list.html">Quản lý môn học</a>
            <a href="/pages/grade_entry_select.html">Nhập điểm</a>
            <a href="/pages/hanhkiem_entry.html" class="active">Nhập hạnh kiểm</a>
            <a href="/pages/grade_select.html">Bảng điểm</a>
            <a href="/pages/student_transcript.html">Tra cứu điểm HS</a>
            <a href="/pages/class_summary.html">Tổng kết lớp</a>
            <a href="/pages/reports.html">Báo cáo tổng kết</a>
            <a href="/pages/teaching_assignment.html" id="menuTeaching" style="display:none;">Phân công giảng dạy</a>
            <a href="/pages/users.html" id="menuUsers" style="display:none;">Quản lý người dùng</a>
        </nav>
    </aside>

    <!-- MAIN -->
    <div class="main">

        <!-- HEADER -->
        <header class="topbar">
            <div class="page-title">Nhập hạnh kiểm</div>
            <div class="user-info">
                <span id="userGreeting">Xin chào, GVCN</span>
                <img src="/assets/user.png" class="avatar" alt="user">
                <button class="btn btn-outline btn-sm" onclick="logout()" style="margin-left:10px;">Đăng xuất</button>
            </div>
        </header>

        <!-- CONTENT -->
        <div class="content">
            
            <!-- FILTERS -->
            <div class="filters-row" style="justify-content: flex-start; gap: 12px;">
                <div class="filter-item">
                    <label class="filter-label" for="selectYear">Năm học</label>
                    <select id="selectYear">
                        <option value="">-- Chọn năm học --</option>
                    </select>
                </div>

                <div class="filter-item">
                    <label class="filter-label" for="selectSemester">Học kỳ</label>
                    <select id="selectSemester">
                        <option value="">-- Chọn học kỳ --</option>
                        <option value="HK1">Học kỳ 1</option>
                        <option value="HK2">Học kỳ 2</option>
                        <!-- KHÔNG có "Cả năm" - điểm cả năm tính tự động từ HK1 và HK2 -->
                    </select>
                </div>

                <div class="filter-item">
                    <label class="filter-label" for="selectGrade">Khối</label>
                    <select id="selectGrade">
                        <option value="">-- Chọn khối --</option>
                    </select>
                </div>

                <div class="filter-item">
                    <label class="filter-label" for="selectClass">Lớp</label>
                    <select id="selectClass">
                        <option value="">-- Chọn lớp --</option>
                    </select>
                </div>

                <button class="btn btn-primary" id="btnLoad" style="margin-top: 24px;">Tải danh sách</button>
                <button class="btn btn-success" id="btnSave" style="margin-top: 24px; display: none;">Lưu hạnh kiểm</button>
            </div>

            <!-- CLASS INFO BOX -->
            <div id="classInfoBox" style="display: none; margin-bottom: 15px; padding: 12px; background: #f0f9ff; border-left: 4px solid #0284c7; border-radius: 4px;">
                <div style="display: flex; justify-content: space-between; align-items: center; gap: 16px;">
                    <span id="classInfoText" style="color: #0c4a6e; font-size: 14px; font-weight: 500;"></span>
                    <span id="teacherInfo" style="color: #0c4a6e; font-size: 14px; font-weight: 500;"></span>
                    <span style="color: #059669; font-size: 14px; font-weight: 500;">✓ Ban có quyền nhập Hạnh kiểm</span>
                </div>
            </div>

            <!-- HƯỚNG DẪN NHẬP ĐIỂM HẠNH KIỂM -->
            <div id="keyboardHints" style="margin-bottom: 15px; padding: 10px; background: #fef3c7; border-left: 4px solid #f59e0b; border-radius: 4px; display: none;">
                <span style="color: #dc2626; font-size: 13px; font-weight: 500;">
                    Cách nhập hạnh kiểm: Nhập điểm từ <strong>0-100</strong> &nbsp;|&nbsp; Hệ thống tự động xếp loại: <strong>80-100 = Tốt</strong>, <strong>65-79 = Khá</strong>, <strong>50-64 = Trung bình</strong>, <strong>20-49 = Yếu</strong>, <strong>0-19 = Kém</strong>
                </span>
            </div>

            <!-- TABLE -->
            <div class="table-wrapper" style="background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow: hidden;">
                <table class="data-table" style="width: 100%; border-collapse: collapse;">
                    <thead style="background: #f3f4f6; border-bottom: 2px solid #e5e7eb;">
                        <tr>
                            <th style="padding: 12px; text-align: center; font-weight: 600; color: #374151; width: 50px;">STT</th>
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #374151; width: 110px;">Mã học sinh</th>
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: #374151; width: 200px;">Họ và tên</th>
                            <th style="padding: 12px; text-align: center; font-weight: 600; color: #374151; width: 110px;">Ngày sinh</th>
                            <th style="padding: 12px; text-align: center; font-weight: 600; color: #374151; width: 90px;">Điểm TK</th>
                            <th style="padding: 12px; text-align: center; font-weight: 600; color: #374151; width: 100px;">Học lực</th>
                            <th style="padding: 12px; text-align: center; font-weight: 600; color: #374151; width: 110px;">Điểm H.Kiểm</th>
                            <th style="padding: 12px; text-align: center; font-weight: 600; color: #374151; width: 120px;">Xếp loại</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr>
                            <td colspan="8" style="padding: 20px; text-align: center; color: #999;">Chưa có dữ liệu</td>
                        </tr>
                    </tbody>
                </table>
            </div>

        </div><!-- content -->
    </div><!-- main -->

    <style>
        .hk-input {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 15px;
            text-align: center;
            background: #fff;
            font-weight: 500;
        }
        .hk-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        }
        .hk-input.filled {
            background-color: #f0fdf4;
            font-weight: 500;
        }
        .hk-input.disabled-input {
            background-color: #f3f4f6;
            color: #9ca3af;
            cursor: not-allowed;
            border-color: #e5e7eb;
        }
        .hk-input.disabled-input::placeholder {
            color: #9ca3af;
        }
        table tbody tr {
            border-bottom: 1px solid #e5e7eb;
        }
        table tbody tr:hover {
            background-color: #f9fafb;
        }
        table td {
            padding: 12px;
        }
    </style>

    <script>
        let currentData = [];

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const user = getCurrentUser();
                if (!user) {
                    toastWarning('Chưa đăng nhập');
                    setTimeout(() => window.location.href = '/pages/login.html', 1500);
                    return;
                }

                if (user.vaiTro !== 'GVCN' && user.vaiTro !== 'ADMIN') {
                    toastError('Không có quyền');
                    setTimeout(() => window.location.href = '/pages/dashboard.html', 1500);
                    return;
                }

                document.getElementById('userGreeting').textContent = `Xin chào, ${user.hoTen}`;
                if (user.vaiTro === 'ADMIN') {
                    document.getElementById('menuTeaching').style.display = 'block';
                    document.getElementById('menuUsers').style.display = 'block';
                }

                await loadDropdowns();

                document.getElementById('selectYear').addEventListener('change', loadClasses);
                document.getElementById('selectGrade').addEventListener('change', loadClasses);
                document.getElementById('btnLoad').addEventListener('click', onLoadClick);
                document.getElementById('btnSave').addEventListener('click', onSaveClick);

            } catch (error) {
                console.error(error);
                toastError('Lỗi: ' + error.message);
            }
        });

        async function loadDropdowns() {
            try {
                const token = getAuthToken();
                const authHeaders = { 'Authorization': `Bearer ${token}` };

                const [yRes, sRes, gRes] = await Promise.all([
                    fetch('/api/settings/school-years', { headers: authHeaders }),
                    fetch('/api/settings/semesters', { headers: authHeaders }),
                    fetch('/api/settings/grade-levels', { headers: authHeaders })
                ]);

                if (!yRes.ok || !sRes.ok || !gRes.ok) {
                    throw new Error('Không thể tải danh sách năm học/kỳ/khối');
                }

                const [years, semesters, grades] = await Promise.all([
                    yRes.json(), sRes.json(), gRes.json()
                ]);

                const yearSel = document.getElementById('selectYear');
                years.forEach(y => {
                    const opt = document.createElement('option');
                    opt.value = y.manamhoc;
                    opt.textContent = y.tennamhoc;
                    yearSel.appendChild(opt);
                });

                const semSel = document.getElementById('selectSemester');
                semSel.innerHTML = '<option value="">-- Chọn học kỳ --</option>';

                const getOrder = (val) => {
                    if (val === 'HK1' || val === '1' || val === 1) return 1;
                    if (val === 'HK2' || val === '2' || val === 2) return 2;
                    // Để Cả năm xuống cuối
                    if (val === 'Nam' || val === 'CN' || val === '0' || val === 0) return 99;
                    return 50;
                };

                semesters
                    .map(s => ({
                        value: s.mahocky || s.maHocKy || s.MaHocKy || s.id,
                        text: s.tenhocky || s.tenHocKy || s.TenHocKy || s.name
                    }))
                    .filter(s => s.value !== 'CN' && s.value !== 'Nam' && s.value !== '0' && s.value !== 0)
                    .sort((a, b) => getOrder(a.value) - getOrder(b.value))
                    .forEach(s => {
                        const opt = document.createElement('option');
                        opt.value = s.value;
                        opt.textContent = s.text;
                        semSel.appendChild(opt);
                    });

                const gradeSel = document.getElementById('selectGrade');
                gradeSel.innerHTML = '<option value="">-- Chọn khối --</option>';
                grades.forEach(g => {
                    const opt = document.createElement('option');
                    const value = g.makhoilop || g.maKhoiLop || g.MaKhoiLop;
                    opt.value = value;
                    opt.textContent = g.tenkhoilop || g.tenKhoiLop || g.TenKhoiLop || ('Khối ' + value);
                    gradeSel.appendChild(opt);
                });
            } catch (error) {
                console.error(error);
                toastError('Không thể tải dữ liệu: ' + error.message);
            }
        }

        async function loadClasses() {
            const year = document.getElementById('selectYear').value;
            const grade = document.getElementById('selectGrade').value;
            const classEl = document.getElementById('selectClass');

            classEl.innerHTML = '<option value="">-- Chọn lớp --</option>';

            if (!year || !grade) return;

            try {
                const token = getAuthToken();
                const params = new URLSearchParams({ khoi: grade, namhoc: year });
                const res = await fetch('/api/classes?' + params.toString(), {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) throw new Error('Cannot load classes');
                const classes = await res.json();

                classes.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c.malop || c.MaLop;
                    opt.textContent = c.tenlop || c.TenLop;
                    classEl.appendChild(opt);
                });
            } catch (error) {
                console.error(error);
                toastError('Không thể tải lớp: ' + error.message);
            }
        }

        function normalizeSemester(semRaw) {
            if (semRaw === 'HK1' || semRaw === '1' || semRaw === 1) return 1;
            if (semRaw === 'HK2' || semRaw === '2' || semRaw === 2) return 2;
            if (semRaw === 'Nam' || semRaw === 'CN' || semRaw === '0' || semRaw === 0) return 0;
            const num = parseInt(semRaw);
            return Number.isNaN(num) ? null : num;
        }

        function getUserIdOrThrow() {
            const user = getCurrentUser();
            const userId = user?.maNguoiDung || user?.manguoidung || user?.MaNguoiDung;
            if (!user || !userId) {
                toastError('Không tìm thấy thông tin người dùng. Vui lòng đăng nhập lại.');
                throw new Error('Missing user or maNguoiDung in local storage');
            }
            return userId.toString();
        }

        async function onLoadClick() {
            const year = document.getElementById('selectYear').value;
            const cls = document.getElementById('selectClass').value;
            const semRaw = document.getElementById('selectSemester').value;

            if (!year || !cls || !semRaw) {
                toastWarning('Chọn năm học, lớp và học kỳ');
                return;
            }

            // Store for later use in save
            window.currentYear = year;
            window.currentSemesterRaw = semRaw;

            try {
                const token = getAuthToken();
                const authHeaders = { 'Authorization': `Bearer ${token}` };

                // Load students
                const sRes = await fetch(`/api/classes/${cls}/students`, { headers: authHeaders });
                if (!sRes.ok) throw new Error('Cannot load students');
                const students = await sRes.json();

                // Load hanhkiem data from dedicated API
                const hanhkiemRes = await fetch(`/api/hanhkiem/lop/${cls}?maNamHoc=${year}&maHocKy=${semRaw}`, { headers: authHeaders });
                const hanhkiemData = hanhkiemRes.ok ? await hanhkiemRes.json() : { success: false, data: [] };

                console.log('Hanhkiem API response:', hanhkiemData);

                // Build hanhkiem map from API response
                const hkMap = {}; // Map MaHocSinh -> {diemhanhkiem, xeploai}
                
                if (hanhkiemData.success && hanhkiemData.data) {
                    hanhkiemData.data.forEach(row => {
                        const mhs = row.mahocsinh || row.MaHocSinh;
                        const diem = row.diemhanhkiem || row.DiemHanhKiem || '';
                        const xeploai = row.xeploai || row.XepLoai || '';
                        hkMap[mhs] = { diemhanhkiem: diem, xeploai: xeploai };
                    });
                }

                // Load scores for calculating DiemTK and HocLuc
                const scoresRes = await fetch(`/api/reports/class-final?maLop=${cls}&namhoc=${year}`, { headers: authHeaders });
                const scoresData = scoresRes.ok ? await scoresRes.json() : { success: false, data: [] };
                
                const scoreMap = {};
                if (scoresData.success && scoresData.data) {
                    scoresData.data.forEach(row => {
                        const mhs = row.mahocsinh || row.MaHocSinh;
                        const tenMon = row.tenmonhoc || row.TenMonHoc;
                        
                        // Get score for selected semester
                        let diemRaw;
                        if (semRaw === 'HK1') {
                            diemRaw = row.diemtbhk1 || row.DiemTBHK1;
                        } else if (semRaw === 'HK2') {
                            diemRaw = row.diemtbhk2 || row.DiemTBHK2;
                        } else {
                            diemRaw = row.diemtbnam || row.DiemTBNam;
                        }
                        
                        const diem = typeof diemRaw === 'number' ? diemRaw : parseFloat(diemRaw);
                        
                        if (!scoreMap[mhs]) {
                            scoreMap[mhs] = { grades: {}, list: [] };
                        }
                        if (!isNaN(diem) && diem !== null) {
                            scoreMap[mhs].grades[tenMon] = diem;
                            scoreMap[mhs].list.push(diem);
                        }
                    });
                }

                console.log('Score map:', scoreMap);
                console.log('HanhKiem map:', hkMap);

                // Compute DiemTK and HocLuc - EXACT same logic as reports page
                Object.keys(scoreMap).forEach(mhs => {
                    const info = scoreMap[mhs];
                    const scores = info.list || [];
                    const avgNum = scores.length > 0 ? (scores.reduce((a,b)=>a+b,0) / scores.length) : null;
                    info.diemtk = avgNum !== null ? avgNum.toFixed(2) : '-';

                    const hasToan = 'Toán' in info.grades;
                    const hasVan = 'Ngữ Văn' in info.grades;
                    const toan = hasToan ? info.grades['Toán'] : undefined;
                    const van = hasVan ? info.grades['Ngữ Văn'] : undefined;
                    const anyBelow = (thr) => scores.some(v => v < thr);
                    const anyGE = (score, thr) => (score !== undefined && !isNaN(score) && score >= thr);

                    let hocLuc = '-';
                    if (avgNum !== null) {
                        if (avgNum >= 8.0 && (anyGE(toan,8.0) || anyGE(van,8.0)) && !anyBelow(6.5)) hocLuc = 'Giỏi';
                        else if (avgNum >= 6.5 && (anyGE(toan,6.5) || anyGE(van,6.5)) && !anyBelow(5.0)) hocLuc = 'Khá';
                        else if (avgNum >= 5.0 && (anyGE(toan,5.0) || anyGE(van,5.0)) && !anyBelow(3.5)) hocLuc = 'Trung bình';
                        else if (avgNum >= 3.5 && !anyBelow(2.0)) hocLuc = 'Yếu';
                        else hocLuc = 'Kém';
                    }
                    info.hocluc = hocLuc;
                });

                currentData = students.map(s => {
                    const mhs = s.mahocsinh || s.MaHocSinh;
                    const hkInfo = hkMap[mhs] || { diemhanhkiem: '', xeploai: '' };
                    
                    return {
                        mahocsinh: mhs,
                        hoten: s.hoten || s.HoTen,
                        ngaysinh: s.ngaysinh || s.NgaySinh || '',
                        diemtk: scoreMap[mhs]?.diemtk || '-',
                        hocluc: scoreMap[mhs]?.hocluc || '-',
                        diemhanhkiem: hkInfo.diemhanhkiem,
                        xeploai: hkInfo.xeploai
                    };
                });

                renderTable();
                document.getElementById('btnSave').style.display = 'inline-block';
                document.getElementById('keyboardHints').style.display = 'block';
                
                const clsName = document.getElementById('selectClass').selectedOptions[0].text;
                const semName = semRaw === 'HK1' ? 'Học kỳ 1' : semRaw === 'HK2' ? 'Học kỳ 2' : 'Cả năm';
                
                document.getElementById('classInfoBox').style.display = 'block';
                document.getElementById('classInfoText').textContent = `Lớp: ${clsName} - ${semName}`;
                
                const user = getCurrentUser();
                document.getElementById('teacherInfo').textContent = `Giáo viên chủ nhiệm: ${user.hoTen}`;
            } catch (error) {
                console.error(error);
                toastError('Lỗi: ' + error.message);
            }
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody');

            if (currentData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">Không có học sinh</td></tr>';
                return;
            }

            tbody.innerHTML = currentData.map((s, idx) => {
                const ngaysinh = s.ngaysinh ? new Date(s.ngaysinh).toLocaleDateString('vi-VN') : '';
                const hasGrades = s.diemtk !== '-';
                const disabledAttr = '';
                const disabledClass = '';
                const disabledTitle = hasGrades ? '' : 'title="Học sinh chưa có điểm tổng kết học kỳ - vẫn có thể nhập"';
                
                // Nếu có điểm hạnh kiểm, parse và hiển thị
                const diemHanhKiem = s.diemhanhkiem || '';
                const xepLoai = s.xeploai || '';
                
                return `
                <tr>
                    <td style="text-align:center;">${idx + 1}</td>
                    <td>${s.mahocsinh}</td>
                    <td>${s.hoten}</td>
                    <td style="text-align:center;">${ngaysinh}</td>
                    <td style="text-align:center; font-weight: 500;">${s.diemtk}</td>
                    <td style="text-align:center;">${s.hocluc}</td>
                    <td style="text-align:center;">
                           <input type="number" 
                               class="hk-input ${diemHanhKiem ? 'filled' : ''} ${disabledClass}" 
                               data-mhs="${s.mahocsinh}"
                               value="${diemHanhKiem}"
                               placeholder="0-100"
                               min="0"
                               max="100"
                               step="0.01"
                               ${disabledAttr}
                               ${disabledTitle}>
                    </td>
                    <td style="text-align:center;">
                           <span class="xeploai-display" data-mhs="${s.mahocsinh}" 
                                 style="display:inline-block; padding:4px 12px; border-radius:12px; font-size:13px; font-weight:500;
                                        ${xepLoai === 'Tốt' ? 'background:#d1fae5;color:#065f46' : ''}
                                        ${xepLoai === 'Khá' ? 'background:#dbeafe;color:#1e40af' : ''}
                                        ${xepLoai === 'Trung bình' ? 'background:#fed7aa;color:#9a3412' : ''}
                                        ${xepLoai === 'Yếu' ? 'background:#fecaca;color:#991b1b' : ''}
                                        ${xepLoai === 'Kém' ? 'background:#fca5a5;color:#7f1d1d' : ''}
                                 ">
                                 ${xepLoai || '-'}
                           </span>
                    </td>
                </tr>
            `}).join('');

            // Add input event listeners for auto-calculate xếp loại
            tbody.querySelectorAll('.hk-input').forEach(input => {
                if (!input.disabled) {
                    // Arrow navigation
                    input.addEventListener('keydown', (e) => {
                        if (e.key === 'ArrowDown') {
                            e.preventDefault();
                            const inputs = Array.from(document.querySelectorAll('.hk-input:not([disabled])'));
                            const currentIndex = inputs.indexOf(e.target);
                            if (currentIndex < inputs.length - 1) {
                                inputs[currentIndex + 1].focus();
                            }
                        } else if (e.key === 'ArrowUp') {
                            e.preventDefault();
                            const inputs = Array.from(document.querySelectorAll('.hk-input:not([disabled])'));
                            const currentIndex = inputs.indexOf(e.target);
                            if (currentIndex > 0) {
                                inputs[currentIndex - 1].focus();
                            }
                        } else if (e.key === 'Enter') {
                            e.preventDefault();
                            e.target.blur();
                            setTimeout(() => {
                                const inputs = Array.from(document.querySelectorAll('.hk-input:not([disabled])'));
                                const currentIndex = inputs.indexOf(e.target);
                                if (currentIndex < inputs.length - 1) {
                                    inputs[currentIndex + 1].focus();
                                }
                            }, 0);
                        }
                    });
                    
                    // Auto-calculate xếp loại on input change
                    input.addEventListener('input', (e) => {
                        const mhs = e.target.dataset.mhs;
                        const diem = parseFloat(e.target.value) || 0;
                        const s = currentData.find(x => x.mahocsinh === mhs);
                        
                        // Tính xếp loại từ điểm (theo seed.sql)
                        let xepLoai = '';
                        if (diem >= 80) xepLoai = 'Tốt';
                        else if (diem >= 65) xepLoai = 'Khá';
                        else if (diem >= 50) xepLoai = 'Trung bình';
                        else if (diem >= 20) xepLoai = 'Yếu';
                        else if (diem > 0) xepLoai = 'Kém';
                        
                        // Cập nhật data
                        if (s) {
                            s.diemhanhkiem = diem > 0 ? diem : null;
                            s.xeploai = xepLoai;
                        }
                        
                        // Cập nhật hiển thị xếp loại
                        const xepLoaiDisplay = document.querySelector(`.xeploai-display[data-mhs="${mhs}"]`);
                        if (xepLoaiDisplay) {
                            xepLoaiDisplay.textContent = xepLoai || '-';
                            
                            // Reset style
                            xepLoaiDisplay.style.background = '';
                            xepLoaiDisplay.style.color = '';
                            
                            // Apply color based on xếp loại
                            if (xepLoai === 'Tốt') {
                                xepLoaiDisplay.style.background = '#d1fae5';
                                xepLoaiDisplay.style.color = '#065f46';
                            } else if (xepLoai === 'Khá') {
                                xepLoaiDisplay.style.background = '#dbeafe';
                                xepLoaiDisplay.style.color = '#1e40af';
                            } else if (xepLoai === 'Trung bình') {
                                xepLoaiDisplay.style.background = '#fed7aa';
                                xepLoaiDisplay.style.color = '#9a3412';
                            } else if (xepLoai === 'Yếu') {
                                xepLoaiDisplay.style.background = '#fecaca';
                                xepLoaiDisplay.style.color = '#991b1b';
                            } else if (xepLoai === 'Kém') {
                                xepLoaiDisplay.style.background = '#fca5a5';
                                xepLoaiDisplay.style.color = '#7f1d1d';
                            }
                        }
                        
                        // Toggle filled class
                        if (diem > 0) {
                            e.target.classList.add('filled');
                        } else {
                            e.target.classList.remove('filled');
                        }
                    });
                }
            });
        }

        // VĂN BẢN KHÔNG SỬ DỤNG NỮA - ĐÃ ĐỔI SANG NHẬP ĐIỂM 0-100
        // function validateHanhKiemValue(value) {
        //     const valid = ['Tốt', 'Khá', 'Trung bình', 'Yếu', ''];
        //     return valid.includes(value);
        // }

        async function onSaveClick() {
            // Force blur on current focused input to save its value
            if (document.activeElement && document.activeElement.classList.contains('hk-input')) {
                document.activeElement.blur();
                // Wait a moment for blur event to complete
                await new Promise(resolve => setTimeout(resolve, 100));
            }

            // Thu thập dữ liệu từ input (Điểm Hạnh Kiểm 0-100)
            const toSave = currentData.map(s => {
                const input = document.querySelector(`.hk-input[data-mhs="${s.mahocsinh}"]`);
                const diem = input ? parseFloat(input.value) || null : null;
                
                // Tính xếp loại từ điểm
                let xepLoai = null;
                if (diem !== null && diem >= 0 && diem <= 100) {
                    if (diem >= 80) xepLoai = 'Tốt';
                    else if (diem >= 65) xepLoai = 'Khá';
                    else if (diem >= 50) xepLoai = 'Trung bình';
                    else if (diem >= 20) xepLoai = 'Yếu';
                    else xepLoai = 'Kém';
                }
                
                return {
                    maHocSinh: s.mahocsinh,
                    maNamHoc: window.currentYear,
                    maHocKy: window.currentSemesterRaw,
                    diemHanhKiem: diem, // GỬI ĐIỂM (0-100)
                    xepLoai: xepLoai,   // Backend cũng tính nhưng frontend gửi để sync
                    ghiChu: null
                };
            });
            
            // Chỉ cảnh báo nếu không có học sinh nào
            if (toSave.length === 0) {
                toastWarning('Không có học sinh trong danh sách');
                return;
            }

            try {
                // Use VARCHAR values from dropdown, not integers
                const maNamHoc = window.currentYear; // e.g., "2024-2025"
                const maHocKy = window.currentSemesterRaw; // e.g., "HK1" or "HK2"

                const payload = {
                    hanhKiemList: toSave
                };

                // Count saves and deletes for message
                const actualSaves = toSave.filter(s => s.xepLoai);
                const deletes = toSave.filter(s => !s.xepLoai);

                console.log('Saving payload:', JSON.stringify(payload, null, 2));

                const user = getCurrentUser();
                const userId = user.maNguoiDung || user.manguoidung || user.MaNguoiDung;
                if (!user || !userId) {
                    toastError('Không tìm thấy thông tin người dùng. Vui lòng đăng nhập lại.');
                    console.error('User data:', user);
                    return;
                }

                console.log('User info:', { 
                    maNguoiDung: userId, 
                    vaiTro: user.vaiTro, 
                    hoTen: user.hoTen 
                });

                const res = await fetch('/api/hanhkiem/bulk-upsert', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getAuthToken()}`
                    },
                    body: JSON.stringify(payload)
                });

                if (!res.ok) {
                    let errText = 'Save failed';
                    try {
                        const err = await res.json();
                        errText = err.error || err.message || errText;
                    } catch (_) {}
                    console.error('Save error status:', res.status, 'message:', errText);
                    toastError(`Lỗi (${res.status}): ${errText}`);
                    return;
                }

                toastSuccess('Đã lưu hạnh kiểm thành công');
                await onLoadClick();
            } catch (error) {
                console.error(error);
                toastError('Lỗi: ' + error.message);
            }
        }
    </script>

</body>
</html>
