<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Tra c·ª©u ƒëi·ªÉm h·ªçc sinh</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/layout/styles.css">
    <script src="/js/toast.js"></script>
    <script src="/js/auth.js"></script>
</head>

<body class="dashboard-body">

    <!-- SIDEBAR -->
    <aside class="sidebar">
        <div class="sidebar-logo">
            <img src="/assets/uit_logo.png" alt="UIT Logo">
            <span>QL H·ªçc Sinh</span>
        </div>

        <nav class="sidebar-menu">
            <a href="/pages/dashboard.html">Dashboard</a>
            <a href="/pages/students.html">Qu·∫£n l√Ω h·ªçc sinh</a>
            <a href="/pages/classes.html">Qu·∫£n l√Ω l·ªõp h·ªçc</a>
            <a href="/pages/subject_list.html">Qu·∫£n l√Ω m√¥n h·ªçc</a>
            <a href="/pages/grade_entry_select.html">Nh·∫≠p ƒëi·ªÉm</a>
            <a href="/pages/grade_select.html">B·∫£ng ƒëi·ªÉm</a>
            <a href="/pages/student_transcript.html" class="active">Tra c·ª©u ƒëi·ªÉm HS</a>
            <a href="/pages/reports.html">B√°o c√°o t·ªïng k·∫øt</a>
            <a href="/pages/users.html" id="menuUsers" style="display:none;">Qu·∫£n l√Ω ng∆∞·ªùi d√πng</a>
        </nav>
    </aside>

    <!-- MAIN -->
    <div class="main">

        <!-- HEADER -->
        <header class="topbar">
            <div class="page-title">Tra c·ª©u ƒëi·ªÉm h·ªçc sinh</div>
            <div class="user-info">
                <span id="userGreeting">Xin ch√†o, Admin</span>
                <img src="/assets/user.png" class="avatar" alt="user">
                <button class="btn btn-outline btn-sm" onclick="logout()" style="margin-left:10px;">ƒêƒÉng xu·∫•t</button>
            </div>
        </header>

        <!-- CONTENT - SPLIT LAYOUT -->
        <div class="content">
            <div class="split-container">
                
                <!-- LEFT PANEL: DANH S√ÅCH H·ªåC SINH -->
                <div class="left-panel">
                    <div class="panel-header">
                        <h3>üìã Danh s√°ch h·ªçc sinh</h3>
                    </div>
                    
                    <!-- B·ªô l·ªçc -->
                    <div class="filter-compact">
                        <select id="yearSelect" title="NƒÉm h·ªçc">
                            <option value="">-- NƒÉm h·ªçc --</option>
                        </select>
                        <select id="gradeSelect" title="Kh·ªëi">
                            <option value="">-- Kh·ªëi --</option>
                        </select>
                        <select id="classSelect" title="L·ªõp">
                            <option value="">-- L·ªõp --</option>
                        </select>
                    </div>
                    
                    <!-- T√¨m ki·∫øm -->
                    <div class="search-box">
                        <input type="text" id="searchStudent" placeholder="üîç T√¨m t√™n ho·∫∑c m√£ HS...">
                    </div>
                    
                    <!-- Danh s√°ch h·ªçc sinh -->
                    <div class="student-list" id="studentList">
                        <div class="empty-state">
                            <p>Ch·ªçn l·ªõp ho·∫∑c t√¨m ki·∫øm ƒë·ªÉ xem danh s√°ch h·ªçc sinh</p>
                        </div>
                    </div>
                </div>
                
                <!-- RIGHT PANEL: CHI TI·∫æT ƒêI·ªÇM -->
                <div class="right-panel">
                    <!-- Placeholder khi ch∆∞a ch·ªçn h·ªçc sinh -->
                    <div id="placeholder" class="placeholder-state">
                        <div class="placeholder-icon">üìä</div>
                        <h3>Ch·ªçn h·ªçc sinh ƒë·ªÉ xem ƒëi·ªÉm</h3>
                        <p>Ch·ªçn m·ªôt h·ªçc sinh t·ª´ danh s√°ch b√™n tr√°i ƒë·ªÉ xem b·∫£ng ƒëi·ªÉm chi ti·∫øt</p>
                    </div>
                    
                    <!-- Chi ti·∫øt ƒëi·ªÉm (·∫©n m·∫∑c ƒë·ªãnh) -->
                    <div id="studentDetail" style="display: none;">
                        <!-- Th√¥ng tin h·ªçc sinh -->
                        <div class="student-info-header">
                            <div class="student-avatar">üë§</div>
                            <div class="student-info-text">
                                <h2 id="infoHoTen">-</h2>
                                <div class="student-meta">
                                    <span><strong>M√£ HS:</strong> <span id="infoMaHS">-</span></span>
                                    <span><strong>L·ªõp:</strong> <span id="infoLop">-</span></span>
                                    <span><strong>Ng√†y sinh:</strong> <span id="infoNgaySinh">-</span></span>
                                </div>
                            </div>
                            <button class="btn btn-print" onclick="window.print()" title="In phi·∫øu ƒëi·ªÉm">üñ®Ô∏è In</button>
                        </div>
                        
                        <!-- Filter h·ªçc k·ª≥ -->
                        <div class="semester-filter">
                            <label>H·ªçc k·ª≥:</label>
                            <select id="semesterFilter">
                                <option value="">-- T·∫•t c·∫£ --</option>
                            </select>
                        </div>
                        
                        <!-- B·∫£ng ƒëi·ªÉm -->
                        <div class="table-wrapper">
                            <table class="data-table transcript-table">
                                <thead>
                                    <tr id="transcriptHead">
                                        <th>M√¥n h·ªçc</th>
                                        <th>H·ªçc k·ª≥</th>
                                        <th>ƒêTB M√¥n</th>
                                    </tr>
                                </thead>
                                <tbody id="transcriptBody">
                                    <tr><td colspan="3" style="text-align:center;">ƒêang t·∫£i...</td></tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- T·ªïng k·∫øt -->
                        <div class="summary-cards">
                            <div class="summary-card blue">
                                <div class="summary-label">ƒêi·ªÉm TB</div>
                                <div class="summary-value" id="avgScore">-</div>
                            </div>
                            <div class="summary-card green">
                                <div class="summary-label">X·∫øp lo·∫°i</div>
                                <div class="summary-value" id="ranking">-</div>
                            </div>
                            <div class="summary-card yellow">
                                <div class="summary-label">M√¥n ƒë·∫°t</div>
                                <div class="summary-value" id="passedSubjects">-</div>
                            </div>
                        </div>
                    </div>
                </div>
                
            </div>
        </div><!-- content -->
    </div><!-- main -->

    <!-- SCRIPT -->
    <script>
        let selectedStudent = null;
        let examTypes = [];
        let allStudents = [];

        // ========== LOAD DROPDOWNS ==========
        async function loadDropdowns() {
            try {
                // Load nƒÉm h·ªçc
                const yearRes = await fetch('/api/settings/school-years');
                const years = await yearRes.json();
                const yearSelect = document.getElementById('yearSelect');
                years.forEach(y => {
                    yearSelect.innerHTML += `<option value="${y.manamhoc}">${y.tennamhoc}</option>`;
                });

                // Load kh·ªëi
                const gradeRes = await fetch('/api/settings/grade-levels');
                const grades = await gradeRes.json();
                const gradeSelect = document.getElementById('gradeSelect');
                grades.forEach(g => {
                    gradeSelect.innerHTML += `<option value="${g.makhoilop}">${g.tenkhoilop}</option>`;
                });

                // Load h·ªçc k·ª≥
                const semRes = await fetch('/api/settings/semesters');
                const semesters = await semRes.json();
                const semesterFilter = document.getElementById('semesterFilter');
                semesters.forEach(s => {
                    semesterFilter.innerHTML += `<option value="${s.mahocky}">${s.tenhocky}</option>`;
                });

                // Load lo·∫°i h√¨nh ki·ªÉm tra
                const examRes = await fetch('/api/grades/exam-types');
                examTypes = await examRes.json();
            } catch (error) {
                console.error('L·ªói load dropdowns:', error);
            }
        }

        // ========== LOAD L·ªöP THEO KH·ªêI ==========
        async function loadClasses() {
            const khoi = document.getElementById('gradeSelect').value;
            const namhoc = document.getElementById('yearSelect').value;
            const classSelect = document.getElementById('classSelect');
            
            classSelect.innerHTML = '<option value="">-- L·ªõp --</option>';
            
            try {
                let url = '/api/classes';
                const params = new URLSearchParams();
                if (khoi) params.append('khoi', khoi);
                if (namhoc) params.append('namhoc', namhoc);
                if (params.toString()) url += '?' + params.toString();

                const response = await fetch(url);
                const classes = await response.json();
                
                classes.forEach(c => {
                    classSelect.innerHTML += `<option value="${c.malop}">${c.tenlop}</option>`;
                });
            } catch (error) {
                console.error('L·ªói load l·ªõp:', error);
            }
        }

        // ========== T√åM KI·∫æM H·ªåC SINH ==========
        async function searchStudents() {
            const keyword = document.getElementById('searchStudent').value.trim();
            const classId = document.getElementById('classSelect').value;
            const gradeLevel = document.getElementById('gradeSelect').value;
            const namhoc = document.getElementById('yearSelect').value;
            
            // N·∫øu kh√¥ng c√≥ filter n√†o, kh√¥ng t√¨m
            if (!keyword && !classId && !gradeLevel) {
                document.getElementById('studentList').innerHTML = `
                    <div class="empty-state">
                        <p>Ch·ªçn l·ªõp ho·∫∑c nh·∫≠p t·ª´ kh√≥a ƒë·ªÉ t√¨m ki·∫øm</p>
                    </div>
                `;
                return;
            }
            
            try {
                let url = '/api/students?';
                const params = new URLSearchParams();
                if (keyword) params.append('search', keyword);
                if (classId) params.append('lop', classId);
                if (gradeLevel) params.append('khoi', gradeLevel);
                if (namhoc) params.append('namhoc', namhoc);
                
                url += params.toString();
                
                const response = await fetch(url);
                const students = await response.json();
                
                allStudents = students;
                renderStudentList(students);
            } catch (error) {
                console.error('L·ªói t√¨m ki·∫øm:', error);
                toastError('L·ªói t√¨m ki·∫øm h·ªçc sinh');
            }
        }

        function renderStudentList(students) {
            const listDiv = document.getElementById('studentList');
            
            if (students.length === 0) {
                listDiv.innerHTML = `
                    <div class="empty-state">
                        <p>Kh√¥ng t√¨m th·∫•y h·ªçc sinh</p>
                    </div>
                `;
                return;
            }
            
            listDiv.innerHTML = students.map(hs => `
                <div class="student-item ${selectedStudent?.mahocsinh === hs.mahocsinh ? 'active' : ''}" 
                     onclick="selectStudent('${hs.mahocsinh}')" data-id="${hs.mahocsinh}">
                    <div class="student-item-avatar">${hs.gioitinh === 'Nam' ? 'üë®' : 'üë©'}</div>
                    <div class="student-item-info">
                        <div class="student-item-name">${hs.hoten}</div>
                        <div class="student-item-meta">${hs.mahocsinh} ‚Ä¢ ${hs.tenlop || '-'}</div>
                    </div>
                </div>
            `).join('');
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('vi-VN');
        }

        // ========== CH·ªåN H·ªåC SINH ==========
        async function selectStudent(maHocSinh) {
            try {
                // Highlight trong danh s√°ch
                document.querySelectorAll('.student-item').forEach(item => {
                    item.classList.remove('active');
                    if (item.dataset.id === maHocSinh) {
                        item.classList.add('active');
                    }
                });
                
                // L·∫•y th√¥ng tin h·ªçc sinh
                const student = allStudents.find(s => s.mahocsinh === maHocSinh);
                if (!student) {
                    const res = await fetch(`/api/students/${maHocSinh}`);
                    selectedStudent = await res.json();
                } else {
                    selectedStudent = student;
                }
                
                // Hi·ªÉn th·ªã th√¥ng tin
                document.getElementById('infoMaHS').textContent = selectedStudent.mahocsinh;
                document.getElementById('infoHoTen').textContent = selectedStudent.hoten;
                document.getElementById('infoNgaySinh').textContent = formatDate(selectedStudent.ngaysinh);
                document.getElementById('infoLop').textContent = selectedStudent.tenlop || selectedStudent.malop || '-';
                
                // ·∫®n placeholder, hi·ªán chi ti·∫øt
                document.getElementById('placeholder').style.display = 'none';
                document.getElementById('studentDetail').style.display = 'block';
                
                // Load ƒëi·ªÉm
                await loadStudentGrades(maHocSinh);
            } catch (error) {
                console.error('L·ªói:', error);
                toastError('L·ªói t·∫£i th√¥ng tin h·ªçc sinh');
            }
        }

        async function loadStudentGrades(maHocSinh) {
            const semester = document.getElementById('semesterFilter').value;
            
            try {
                let url = `/api/grades/student/${maHocSinh}`;
                if (semester) url += `?hocky=${semester}`;
                
                const response = await fetch(url);
                const grades = await response.json();
                
                renderTranscript(grades);
            } catch (error) {
                console.error('L·ªói load ƒëi·ªÉm:', error);
                document.getElementById('transcriptBody').innerHTML = 
                    '<tr><td colspan="10" style="text-align:center;color:red;">L·ªói t·∫£i d·ªØ li·ªáu ƒëi·ªÉm</td></tr>';
            }
        }

        function renderTranscript(grades) {
            const thead = document.getElementById('transcriptHead');
            const tbody = document.getElementById('transcriptBody');
            
            // Header
            thead.innerHTML = `
                <th>M√¥n h·ªçc</th>
                <th>H·ªçc k·ª≥</th>
                ${examTypes.map(et => `<th>${et.tenlhkt}<br><small>(x${et.heso})</small></th>`).join('')}
                <th class="col-avg">ƒêTB M√¥n</th>
            `;
            
            if (grades.length === 0) {
                tbody.innerHTML = '<tr><td colspan="' + (examTypes.length + 3) + '" style="text-align:center;">Ch∆∞a c√≥ d·ªØ li·ªáu ƒëi·ªÉm</td></tr>';
                document.getElementById('avgScore').textContent = '-';
                document.getElementById('ranking').textContent = '-';
                document.getElementById('passedSubjects').textContent = '-';
                return;
            }
            
            let totalAvg = 0;
            let countAvg = 0;
            let passedCount = 0;
            
            tbody.innerHTML = grades.map(mon => {
                const gradeDisplay = examTypes.map(et => {
                    const diemArr = mon.Diem[et.tenlhkt];
                    if (diemArr && diemArr.length > 0) {
                        return `<td>${diemArr.map(d => d.diem).join(', ')}</td>`;
                    }
                    return '<td class="no-grade">‚Äì</td>';
                }).join('');
                
                // T√≠nh ƒêTB
                let avg = '‚Äì';
                let avgNum = null;
                let totalWeight = 0;
                let totalScore = 0;
                
                examTypes.forEach(et => {
                    const diemArr = mon.Diem[et.tenlhkt];
                    if (diemArr && diemArr.length > 0) {
                        diemArr.forEach(d => {
                            totalScore += d.diem * et.heso;
                            totalWeight += et.heso;
                        });
                    }
                });
                
                if (totalWeight > 0) {
                    avgNum = totalScore / totalWeight;
                    avg = avgNum.toFixed(1);
                    totalAvg += avgNum;
                    countAvg++;
                    if (avgNum >= 5) passedCount++;
                }
                
                let avgClass = '';
                if (avgNum !== null) {
                    if (avgNum >= 8) avgClass = 'rate-excellent';
                    else if (avgNum >= 6.5) avgClass = 'rate-good';
                    else if (avgNum >= 5) avgClass = 'rate-average';
                    else avgClass = 'rate-low';
                }
                
                return `
                    <tr>
                        <td><strong>${mon.TenMonHoc}</strong></td>
                        <td>${mon.TenHocKy || mon.MaHocKy}</td>
                        ${gradeDisplay}
                        <td class="col-avg"><span class="${avgClass}">${avg}</span></td>
                    </tr>
                `;
            }).join('');
            
            // T·ªïng k·∫øt
            if (countAvg > 0) {
                const finalAvg = totalAvg / countAvg;
                document.getElementById('avgScore').textContent = finalAvg.toFixed(2);
                
                let ranking = '';
                if (finalAvg >= 8) ranking = 'Gi·ªèi';
                else if (finalAvg >= 6.5) ranking = 'Kh√°';
                else if (finalAvg >= 5) ranking = 'TB';
                else ranking = 'Y·∫øu';
                document.getElementById('ranking').textContent = ranking;
                document.getElementById('passedSubjects').textContent = `${passedCount}/${countAvg}`;
            } else {
                document.getElementById('avgScore').textContent = '-';
                document.getElementById('ranking').textContent = '-';
                document.getElementById('passedSubjects').textContent = '-';
            }
        }

        // ========== EVENT LISTENERS ==========
        document.addEventListener('DOMContentLoaded', () => {
            loadDropdowns();
            
            document.getElementById('gradeSelect').addEventListener('change', () => {
                loadClasses();
                searchStudents();
            });
            document.getElementById('yearSelect').addEventListener('change', () => {
                loadClasses();
                searchStudents();
            });
            document.getElementById('classSelect').addEventListener('change', searchStudents);
            
            // T√¨m ki·∫øm realtime
            let searchTimeout;
            document.getElementById('searchStudent').addEventListener('input', () => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(searchStudents, 300);
            });
            
            document.getElementById('semesterFilter').addEventListener('change', () => {
                if (selectedStudent) {
                    loadStudentGrades(selectedStudent.mahocsinh);
                }
            });
        });
    </script>

    <style>
        /* ===== SPLIT LAYOUT ===== */
        .split-container {
            display: flex;
            gap: 20px;
            height: calc(100vh - 140px);
            min-height: 500px;
        }
        
        /* LEFT PANEL */
        .left-panel {
            width: 320px;
            min-width: 280px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .panel-header {
            padding: 16px;
            border-bottom: 1px solid #e5e7eb;
            background: #f8fafc;
        }
        
        .panel-header h3 {
            margin: 0;
            font-size: 16px;
            color: #1f2937;
        }
        
        .filter-compact {
            display: flex;
            gap: 8px;
            padding: 12px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .filter-compact select {
            flex: 1;
            padding: 8px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 12px;
            background: white;
        }
        
        .search-box {
            padding: 12px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .search-box input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .search-box input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59,130,246,0.1);
        }
        
        /* Student List */
        .student-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }
        
        .student-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s;
            margin-bottom: 4px;
        }
        
        .student-item:hover {
            background: #f3f4f6;
        }
        
        .student-item.active {
            background: #dbeafe;
            border: 1px solid #3b82f6;
        }
        
        .student-item-avatar {
            font-size: 24px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f3f4f6;
            border-radius: 50%;
        }
        
        .student-item.active .student-item-avatar {
            background: #bfdbfe;
        }
        
        .student-item-info {
            flex: 1;
            min-width: 0;
        }
        
        .student-item-name {
            font-weight: 600;
            color: #1f2937;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .student-item-meta {
            font-size: 12px;
            color: #6b7280;
            margin-top: 2px;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #9ca3af;
        }
        
        /* RIGHT PANEL */
        .right-panel {
            flex: 1;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            overflow-y: auto;
            padding: 20px;
        }
        
        .placeholder-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #9ca3af;
            text-align: center;
        }
        
        .placeholder-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }
        
        .placeholder-state h3 {
            margin: 0 0 8px;
            color: #6b7280;
        }
        
        /* Student Info Header */
        .student-info-header {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            margin-bottom: 20px;
            color: white;
        }
        
        .student-avatar {
            font-size: 48px;
            width: 70px;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
        }
        
        .student-info-text {
            flex: 1;
        }
        
        .student-info-text h2 {
            margin: 0 0 8px;
            font-size: 22px;
        }
        
        .student-meta {
            display: flex;
            gap: 20px;
            font-size: 14px;
            opacity: 0.9;
        }
        
        .student-info-header .btn-print {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
        }
        
        .student-info-header .btn-print:hover {
            background: rgba(255,255,255,0.3);
        }
        
        /* Semester Filter */
        .semester-filter {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .semester-filter label {
            font-weight: 500;
            color: #374151;
        }
        
        .semester-filter select {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
        }
        
        /* Transcript Table */
        .transcript-table th, .transcript-table td {
            padding: 10px 8px;
            font-size: 13px;
        }
        
        .col-avg {
            background: #e0f2fe !important;
            font-weight: 600;
        }
        
        .no-grade {
            color: #9ca3af;
        }
        
        .rate-excellent { color: #059669; font-weight: 600; }
        .rate-good { color: #2563eb; font-weight: 600; }
        .rate-average { color: #d97706; font-weight: 600; }
        .rate-low { color: #dc2626; font-weight: 600; }
        
        /* Summary Cards */
        .summary-cards {
            display: flex;
            gap: 16px;
            margin-top: 20px;
        }
        
        .summary-card {
            flex: 1;
            padding: 16px;
            border-radius: 12px;
            text-align: center;
        }
        
        .summary-card.blue { background: #dbeafe; }
        .summary-card.green { background: #d1fae5; }
        .summary-card.yellow { background: #fef3c7; }
        
        .summary-label {
            font-size: 13px;
            color: #6b7280;
            margin-bottom: 4px;
        }
        
        .summary-value {
            font-size: 28px;
            font-weight: 700;
        }
        
        .summary-card.blue .summary-value { color: #1e40af; }
        .summary-card.green .summary-value { color: #059669; }
        .summary-card.yellow .summary-value { color: #d97706; }
        
        /* Print */
        @media print {
            .sidebar, .topbar, .left-panel { display: none !important; }
            .main { margin-left: 0 !important; }
            .content { padding: 0 !important; }
            .split-container { display: block; }
            .right-panel { box-shadow: none; padding: 0; }
            .student-info-header { background: #333 !important; -webkit-print-color-adjust: exact; }
        }
        
        /* Responsive */
        @media (max-width: 900px) {
            .split-container {
                flex-direction: column;
                height: auto;
            }
            .left-panel {
                width: 100%;
                max-height: 300px;
            }
        }
    </style>

</body>
</html>
