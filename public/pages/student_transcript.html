<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Tra c·ª©u ƒëi·ªÉm h·ªçc sinh</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/layout/styles.css">
    <script src="/js/toast.js"></script>
    <script src="/js/auth.js"></script>
</head>

<body class="dashboard-body">

    <!-- SIDEBAR -->
    <aside class="sidebar">
        <div class="sidebar-logo">
            <img src="/assets/uit_logo.png" alt="UIT Logo">
            <span>QL H·ªçc Sinh</span>
        </div>

        <nav class="sidebar-menu">
            <a href="/pages/dashboard.html">Dashboard</a>
            <a href="/pages/students.html">Qu·∫£n l√Ω h·ªçc sinh</a>
            <a href="/pages/classes.html">Qu·∫£n l√Ω l·ªõp h·ªçc</a>
            <a href="/pages/subject_list.html">Qu·∫£n l√Ω m√¥n h·ªçc</a>
            <a href="/pages/grade_entry_select.html">Nh·∫≠p ƒëi·ªÉm</a>
            <a href="/pages/hanhkiem_entry.html">Nh·∫≠p h·∫°nh ki·ªÉm</a>
            <a href="/pages/grade_select.html">B·∫£ng ƒëi·ªÉm</a>
            <a href="/pages/student_transcript.html" class="active">Tra c·ª©u ƒëi·ªÉm HS</a>
            <a href="/pages/class_summary.html">T·ªïng k·∫øt l·ªõp</a>
            <a href="/pages/reports.html">B√°o c√°o t·ªïng k·∫øt</a>
            <a href="/pages/teaching_assignment.html">Ph√¢n c√¥ng gi·∫£ng d·∫°y</a>
            <a href="/pages/users.html" id="menuUsers" style="display:none;">Qu·∫£n l√Ω ng∆∞·ªùi d√πng</a>
        </nav>
    </aside>

    <!-- MAIN -->
    <div class="main">

        <!-- HEADER -->
        <header class="topbar">
            <div class="page-title">Tra c·ª©u ƒëi·ªÉm h·ªçc sinh</div>
            <div class="user-info">
                <span id="userGreeting">Xin ch√†o, Admin</span>
                <img src="/assets/user.png" class="avatar" alt="user">
                <button class="btn btn-outline btn-sm" onclick="logout()" style="margin-left:10px;">ƒêƒÉng xu·∫•t</button>
            </div>
        </header>

        <!-- CONTENT - SPLIT LAYOUT -->
        <div class="content">
            <div class="split-container">
                
                <!-- LEFT PANEL: DANH S√ÅCH H·ªåC SINH -->
                <div class="left-panel">
                    <div class="panel-top">
                        <div class="panel-title">Danh s√°ch h·ªçc sinh <button class="btn-refresh" onclick="resetFilters()" title="L√†m m·ªõi">L√†m m·ªõi</button></div>
                        <div class="filter-row">
                            <select id="yearSelect"><option value="">NƒÉm h·ªçc</option></select>
                            <select id="gradeSelect"><option value="">Kh·ªëi</option></select>
                            <select id="classSelect"><option value="">L·ªõp</option></select>
                        </div>
                        <input type="text" id="searchStudent" class="search-input" placeholder="üîç T√¨m t√™n ho·∫∑c m√£ HS...">
                    </div>
                    <div class="student-list" id="studentList">
                        <div class="empty-state">
                            <p>Ch·ªçn l·ªõp ho·∫∑c t√¨m ki·∫øm ƒë·ªÉ xem danh s√°ch h·ªçc sinh</p>
                        </div>
                    </div>
                </div>
                
                <!-- RIGHT PANEL: CHI TI·∫æT ƒêI·ªÇM -->
                <div class="right-panel">
                    <!-- Placeholder khi ch∆∞a ch·ªçn h·ªçc sinh -->
                    <div id="placeholder" class="placeholder-state">
                        <div class="placeholder-icon"></div>
                        <h3>Ch·ªçn h·ªçc sinh ƒë·ªÉ xem ƒëi·ªÉm</h3>
                        <p>Ch·ªçn m·ªôt h·ªçc sinh t·ª´ danh s√°ch b√™n tr√°i ƒë·ªÉ xem b·∫£ng ƒëi·ªÉm chi ti·∫øt</p>
                    </div>
                    
                    <!-- Chi ti·∫øt ƒëi·ªÉm (·∫©n m·∫∑c ƒë·ªãnh) -->
                    <div id="studentDetail" style="display: none;">
                        <!-- Th√¥ng tin h·ªçc sinh -->
                        <div class="student-info-header">
                            <div class="student-avatar">üë§</div>
                            <div class="student-info-text">
                                <h2 id="infoHoTen">-</h2>
                                <div class="student-meta">
                                    <span><strong>M√£ HS:</strong> <span id="infoMaHS">-</span></span>
                                    <span><strong>L·ªõp:</strong> <span id="infoLop">-</span></span>
                                    <span><strong>Ng√†y sinh:</strong> <span id="infoNgaySinh">-</span></span>
                                </div>
                            </div>
                            <button class="btn btn-print" onclick="window.print()" title="In phi·∫øu ƒëi·ªÉm">In</button>
                        </div>
                        
                        <!-- Filter h·ªçc k·ª≥ -->
                        <div class="semester-filter">
                            <label>H·ªçc k·ª≥:</label>
                            <select id="semesterFilter">
                                <option value="HK1">H·ªçc k·ª≥ 1</option>
                                <option value="HK2">H·ªçc k·ª≥ 2</option>
                                <option value="CANAM">C·∫£ nƒÉm</option>
                            </select>
                        </div>
                        
                        <!-- B·∫£ng ƒëi·ªÉm -->
                        <div class="table-wrapper">
                            <table class="data-table transcript-table">
                                <thead>
                                    <tr id="transcriptHead">
                                        <th>M√¥n h·ªçc</th>
                                        <th>H·ªçc k·ª≥</th>
                                        <th>ƒêTB M√¥n</th>
                                    </tr>
                                </thead>
                                <tbody id="transcriptBody">
                                    <tr><td colspan="3" style="text-align:center;">ƒêang t·∫£i...</td></tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- T·ªïng k·∫øt -->
                        <div class="summary-cards">
                            <div class="summary-card blue">
                                <div class="summary-label">ƒêi·ªÉm TB</div>
                                <div class="summary-value" id="avgScore">-</div>
                            </div>
                            <div class="summary-card green">
                                <div class="summary-label">X·∫øp lo·∫°i</div>
                                <div class="summary-value" id="ranking">-</div>
                            </div>
                            <div class="summary-card yellow">
                                <div class="summary-label">M√¥n ƒë·∫°t</div>
                                <div class="summary-value" id="passedSubjects">-</div>
                            </div>
                            <div class="summary-card purple">
                                <div class="summary-label">H·∫°nh ki·ªÉm</div>
                                <div class="summary-value" id="hanhkiem">-</div>
                            </div>
                            <div class="summary-card orange">
                                <div class="summary-label">Danh hi·ªáu</div>
                                <div class="summary-value" id="danhhieu">-</div>
                            </div>
                        </div>
                    </div>
                </div>
                
            </div>
        </div><!-- content -->
    </div><!-- main -->

    <!-- SCRIPT -->
    <script>
        let selectedStudent = null;
        let examTypes = [];
        let allStudents = [];

        // ========== LOAD DROPDOWNS ==========
        async function loadDropdowns() {
            try {
                // Load nƒÉm h·ªçc
                const yearRes = await authFetch('/api/settings/school-years');
                const years = await yearRes.json();
                const yearSelect = document.getElementById('yearSelect');
                years.forEach(y => {
                    yearSelect.innerHTML += `<option value="${y.manamhoc}">${y.tennamhoc}</option>`;
                });

                // Load kh·ªëi
                const gradeRes = await authFetch('/api/settings/grade-levels');
                const grades = await gradeRes.json();
                const gradeSelect = document.getElementById('gradeSelect');
                grades.forEach(g => {
                    gradeSelect.innerHTML += `<option value="${g.makhoilop}">${g.tenkhoilop}</option>`;
                });

                // H·ªçc k·ª≥ dropdown ƒë√£ ƒë∆∞·ª£c set c·ªë ƒë·ªãnh trong HTML (HK1, HK2, C·∫£ nƒÉm)

                // Load lo·∫°i h√¨nh ki·ªÉm tra
                const examRes = await authFetch('/api/grades/exam-types');
                examTypes = await examRes.json();
            } catch (error) {
                console.error('L·ªói load dropdowns:', error);
            }
        }

        // ========== LOAD L·ªöP THEO KH·ªêI ==========
        async function loadClasses() {
            const khoi = document.getElementById('gradeSelect').value;
            const namhoc = document.getElementById('yearSelect').value;
            const classSelect = document.getElementById('classSelect');
            
            classSelect.innerHTML = '<option value="">-- L·ªõp --</option>';
            
            try {
                let url = '/api/classes';
                const params = new URLSearchParams();
                if (khoi) params.append('khoi', khoi);
                if (namhoc) params.append('namhoc', namhoc);
                if (params.toString()) url += '?' + params.toString();

                const response = await authFetch(url);
                const classes = await response.json();
                
                classes.forEach(c => {
                    classSelect.innerHTML += `<option value="${c.malop}">${c.tenlop}</option>`;
                });
            } catch (error) {
                console.error('L·ªói load l·ªõp:', error);
            }
        }

        // ========== T√åM KI·∫æM H·ªåC SINH ==========
        async function searchStudents() {
            const keyword = document.getElementById('searchStudent').value.trim();
            const classId = document.getElementById('classSelect').value;
            const gradeLevel = document.getElementById('gradeSelect').value;
            const namhoc = document.getElementById('yearSelect').value;
            
            // N·∫øu kh√¥ng c√≥ filter n√†o, kh√¥ng t√¨m
            if (!keyword && !classId && !gradeLevel) {
                document.getElementById('studentList').innerHTML = `
                    <div class="empty-state">
                        <p>Ch·ªçn l·ªõp ho·∫∑c nh·∫≠p t·ª´ kh√≥a ƒë·ªÉ t√¨m ki·∫øm</p>
                    </div>
                `;
                return;
            }
            
            try {
                // KH√îNG g·ª≠i keyword l√™n server - ch·ªâ filter ·ªü frontend ƒë·ªÉ h·ªó tr·ª£ kh√¥ng d·∫•u
                let url = '/api/students?';
                const params = new URLSearchParams();
                // B·ªè search param - s·∫Ω filter ·ªü frontend
                if (classId) params.append('lop', classId);
                if (gradeLevel) params.append('khoi', gradeLevel);
                if (namhoc) params.append('namhoc', namhoc);
                
                url += params.toString();
                
                const response = await authFetch(url);
                const students = await response.json();
                
                allStudents = students;
                // Filter ·ªü frontend v·ªõi h·ªó tr·ª£ kh√¥ng d·∫•u
                renderStudentList(students, keyword);
            } catch (error) {
                console.error('L·ªói t√¨m ki·∫øm:', error);
                toastError('L·ªói t√¨m ki·∫øm h·ªçc sinh');
            }
        }

        // H√†m lo·∫°i b·ªè d·∫•u ti·∫øng Vi·ªát ƒë·ªÉ t√¨m ki·∫øm
        function removeVietnameseDiacritics(str) {
            if (!str) return '';
            return str.normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')
                .replace(/ƒë/g, 'd')
                .replace(/ƒê/g, 'D')
                .toLowerCase();
        }

        function renderStudentList(students, filterKeyword = '') {
            const listDiv = document.getElementById('studentList');
            
            // L·ªçc theo keyword (h·ªó tr·ª£ kh√¥ng d·∫•u)
            let filteredStudents = students;
            if (filterKeyword) {
                const searchNormalized = removeVietnameseDiacritics(filterKeyword);
                filteredStudents = students.filter(hs => {
                    const hotenNormalized = removeVietnameseDiacritics(hs.hoten);
                    const maHsNormalized = (hs.mahocsinh || '').toLowerCase();
                    return hotenNormalized.includes(searchNormalized) || maHsNormalized.includes(searchNormalized);
                });
            }
            
            if (filteredStudents.length === 0) {
                listDiv.innerHTML = `
                    <div class="empty-state">
                        <p>Kh√¥ng t√¨m th·∫•y h·ªçc sinh</p>
                    </div>
                `;
                return;
            }
            
            // S·∫Øp x·∫øp theo t√™n (ph·∫ßn cu·ªëi c√πng c·ªßa h·ªç t√™n)
            filteredStudents.sort((a, b) => {
                const tenA = a.hoten.trim().split(' ').pop().toLowerCase();
                const tenB = b.hoten.trim().split(' ').pop().toLowerCase();
                return tenA.localeCompare(tenB, 'vi');
            });
            
            listDiv.innerHTML = filteredStudents.map(hs => `
                <div class="student-item ${selectedStudent?.mahocsinh === hs.mahocsinh ? 'active' : ''}" 
                     onclick="selectStudent('${hs.mahocsinh}')" data-id="${hs.mahocsinh}">
                    <div class="student-item-avatar">${hs.gioitinh === 'Nam' ? 'üë®' : 'üë©'}</div>
                    <div class="student-item-info">
                        <div class="student-item-name">${hs.hoten}</div>
                        <div class="student-item-meta">${hs.mahocsinh} ‚Ä¢ ${hs.tenlop || '-'}</div>
                    </div>
                </div>
            `).join('');

            // Scroll l√™n ƒë·∫ßu danh s√°ch sau m·ªói l·∫ßn render ƒë·ªÉ tr√°nh c·∫£m gi√°c b·ªã ƒë·∫©y xu·ªëng cu·ªëi
            listDiv.scrollTop = 0;
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('vi-VN');
        }

        // ========== DI CHUY·ªÇN B·∫∞NG PH√çM L√äN/XU·ªêNG TRONG DANH S√ÅCH HS ==========
        function moveSelection(offset) {
            if (!allStudents || allStudents.length === 0) return;
            const currentId = selectedStudent?.mahocsinh;
            const currentIndex = allStudents.findIndex(s => s.mahocsinh === currentId);
            let nextIndex = 0;
            if (currentIndex === -1) {
                nextIndex = offset > 0 ? 0 : allStudents.length - 1;
            } else {
                nextIndex = currentIndex + offset;
                if (nextIndex < 0) nextIndex = 0;
                if (nextIndex >= allStudents.length) nextIndex = allStudents.length - 1;
            }
            const nextStudent = allStudents[nextIndex];
            if (nextStudent) {
                selectStudent(nextStudent.mahocsinh);
                // ƒê·∫£m b·∫£o item ƒë∆∞·ª£c scroll v√†o v√πng hi·ªÉn th·ªã
                const listDiv = document.getElementById('studentList');
                const activeEl = listDiv.querySelector('.student-item.active');
                if (activeEl) {
                    const rect = activeEl.getBoundingClientRect();
                    const parentRect = listDiv.getBoundingClientRect();
                    if (rect.top < parentRect.top) {
                        listDiv.scrollTop -= (parentRect.top - rect.top) + 8;
                    } else if (rect.bottom > parentRect.bottom) {
                        listDiv.scrollTop += (rect.bottom - parentRect.bottom) + 8;
                    }
                }
            }
        }

        // ========== CH·ªåN H·ªåC SINH ==========
        async function selectStudent(maHocSinh) {
            try {
                // Highlight trong danh s√°ch
                document.querySelectorAll('.student-item').forEach(item => {
                    item.classList.remove('active');
                    if (item.dataset.id === maHocSinh) {
                        item.classList.add('active');
                    }
                });
                
                // L·∫•y th√¥ng tin h·ªçc sinh
                const student = allStudents.find(s => s.mahocsinh === maHocSinh);
                if (!student) {
                    const res = await authFetch(`/api/students/${maHocSinh}`);
                    selectedStudent = await res.json();
                } else {
                    selectedStudent = student;
                }
                
                // Hi·ªÉn th·ªã th√¥ng tin
                document.getElementById('infoMaHS').textContent = selectedStudent.mahocsinh;
                document.getElementById('infoHoTen').textContent = selectedStudent.hoten;
                document.getElementById('infoNgaySinh').textContent = formatDate(selectedStudent.ngaysinh);
                document.getElementById('infoLop').textContent = selectedStudent.tenlop || selectedStudent.malop || '-';
                
                // ·∫®n placeholder, hi·ªán chi ti·∫øt
                document.getElementById('placeholder').style.display = 'none';
                document.getElementById('studentDetail').style.display = 'block';
                
                // Load ƒëi·ªÉm
                await loadStudentGrades(maHocSinh);
            } catch (error) {
                console.error('L·ªói:', error);
                toastError('L·ªói t·∫£i th√¥ng tin h·ªçc sinh');
            }
        }

        async function loadStudentGrades(maHocSinh) {
            const semester = document.getElementById('semesterFilter').value;
            
            try {
                // Lu√¥n load t·∫•t c·∫£ ƒëi·ªÉm (HK1 v√† HK2) ƒë·ªÉ t√≠nh c·∫£ nƒÉm
                let url = `/api/grades/student/${maHocSinh}`;
                
                const response = await authFetch(url);
                const allGrades = await response.json();
                
                // Render ƒëi·ªÉm TR∆Ø·ªöC (ƒë·ªÉ hi·ªÉn th·ªã x·∫øp lo·∫°i h·ªçc l·ª±c)
                renderTranscript(allGrades, semester);
                
                // Load h·∫°nh ki·ªÉm SAU v√† t√≠nh l·∫°i danh hi·ªáu
                await loadHanhKiem(maHocSinh, semester);
            } catch (error) {
                console.error('L·ªói load ƒëi·ªÉm:', error);
                document.getElementById('transcriptBody').innerHTML = 
                    '<tr><td colspan="10" style="text-align:center;color:red;">L·ªói t·∫£i d·ªØ li·ªáu ƒëi·ªÉm</td></tr>';
            }
        }

        async function loadHanhKiem(maHocSinh, semester) {
            try {
                // Get year from filter (ho·∫∑c nƒÉm hi·ªán t·∫°i n·∫øu kh√¥ng c√≥)
                const namHoc = document.getElementById('yearSelect').value;
                if (!namHoc) {
                    document.getElementById('hanhkiem').textContent = '-';
                    document.getElementById('danhhieu').textContent = '-';
                    return;
                }
                
                // Load danh s√°ch l·ªõp c·ªßa h·ªçc sinh ƒë·ªÉ l·∫•y maLop
                let maLop = null;
                let tenLop = '-';
                try {
                    const classRes = await authFetch(`/api/classes?namhoc=${namHoc}`);
                    const classes = await classRes.json();
                    
                    console.log('Classes for student:', classes);
                    
                    if (classes && classes.length > 0) {
                        // N·∫øu c√≥ nhi·ªÅu l·ªõp (chuy·ªÉn l·ªõp, h·ªçc nhi·ªÅu nƒÉm), t√¨m l·ªõp kh·ªõp v·ªõi selectedStudent.tenlop
                        // ho·∫∑c l·∫•y l·ªõp ƒë·∫ßu ti√™n n·∫øu kh√¥ng c√≥ th√¥ng tin
                        const studentTenLop = selectedStudent?.tenlop || selectedStudent?.TenLop;
                        
                        if (studentTenLop) {
                            // T√¨m l·ªõp kh·ªõp v·ªõi t√™n l·ªõp c·ªßa h·ªçc sinh
                            const matchedClass = classes.find(c => 
                                (c.tenlop || c.TenLop) === studentTenLop
                            );
                            if (matchedClass) {
                                maLop = matchedClass.malop || matchedClass.MaLop;
                                tenLop = matchedClass.tenlop || matchedClass.TenLop;
                            }
                        }
                        
                        // Fallback: l·∫•y l·ªõp ƒë·∫ßu ti√™n n·∫øu kh√¥ng t√¨m th·∫•y
                        if (!maLop) {
                            maLop = classes[0]?.malop || classes[0]?.MaLop;
                            tenLop = classes[0]?.tenlop || classes[0]?.TenLop || '-';
                        }
                    }
                } catch (error) {
                    console.error('L·ªói load l·ªõp:', error);
                }
                
                if (!maLop) {
                    console.log('No maLop found for student');
                    document.getElementById('hanhkiem').textContent = '-';
                    document.getElementById('danhhieu').textContent = '-';
                    document.getElementById('infoLop').textContent = '-';
                    return;
                }
                
                // C·∫≠p nh·∫≠t t√™n l·ªõp l√™n UI
                document.getElementById('infoLop').textContent = tenLop;

                // Map semester filter to column key
                let hkKey = 'hk1';
                if (semester === 'HK2') hkKey = 'hk2';
                else if (semester === 'CANAM') hkKey = 'cn';

                // D√πng C√ôNG API nh∆∞ b√°o c√°o t·ªïng k·∫øt - ƒë√£ ho·∫°t ƒë·ªông t·ªët
                const url = `/api/reports/class-final?maLop=${maLop}&namhoc=${namHoc}`;
                const response = await authFetch(url);
                const result = await response.json();

                if (result.success && result.data && result.data.length > 0) {
                    // T√¨m h·∫°nh ki·ªÉm c·ªßa h·ªçc sinh n√†y t·ª´ response
                    const studentRow = result.data.find(r => 
                        (r.mahocsinh || r.MaHocSinh) === maHocSinh
                    );
                    
                    if (studentRow) {
                        let xepLoai = '-';
                        if (hkKey === 'hk1') {
                            xepLoai = studentRow.hanhkiemhk1 || studentRow.HanhKiemHK1 || '-';
                        } else if (hkKey === 'hk2') {
                            xepLoai = studentRow.hanhkiemhk2 || studentRow.HanhKiemHK2 || '-';
                        } else {
                            xepLoai = studentRow.hanhkiemcn || studentRow.HanhKiemCN || '-';
                        }
                        
                        document.getElementById('hanhkiem').textContent = xepLoai;

                        // Update danh hi·ªáu sau khi c√≥ h·∫°nh ki·ªÉm
                        const ranking = document.getElementById('ranking').textContent;
                        updateDanhHieu(ranking);
                    } else {
                        document.getElementById('hanhkiem').textContent = '-';
                        document.getElementById('danhhieu').textContent = '-';
                    }
                } else {
                    document.getElementById('hanhkiem').textContent = '-';
                    document.getElementById('danhhieu').textContent = '-';
                }
            } catch (error) {
                console.error('L·ªói load h·∫°nh ki·ªÉm:', error);
                document.getElementById('hanhkiem').textContent = '-';
                document.getElementById('danhhieu').textContent = '-';
            }
        }

        function renderTranscript(allGrades, semesterFilter) {
            const thead = document.getElementById('transcriptHead');
            const tbody = document.getElementById('transcriptBody');
            
            if (allGrades.length === 0) {
                tbody.innerHTML = '<tr><td colspan="' + (examTypes.length + 3) + '" style="text-align:center;">Ch∆∞a c√≥ d·ªØ li·ªáu ƒëi·ªÉm</td></tr>';
                document.getElementById('avgScore').textContent = '-';
                document.getElementById('ranking').textContent = '-';
                document.getElementById('passedSubjects').textContent = '-';
                return;
            }
            
            // Nh√≥m ƒëi·ªÉm theo m√¥n h·ªçc
            const groupedBySubject = {};
            allGrades.forEach(mon => {
                const key = mon.MaMonHoc || mon.TenMonHoc;
                if (!groupedBySubject[key]) {
                    groupedBySubject[key] = {
                        tenMonHoc: mon.TenMonHoc,
                        hk1: null,
                        hk2: null
                    };
                }
                
                // T√≠nh ƒëi·ªÉm TB cho h·ªçc k·ª≥ n√†y
                let totalWeight = 0;
                let totalScore = 0;
                
                examTypes.forEach(et => {
                    const diemArr = mon.Diem[et.tenlhkt];
                    if (diemArr && diemArr.length > 0) {
                        diemArr.forEach(d => {
                            totalScore += d.diem * et.heso;
                            totalWeight += et.heso;
                        });
                    }
                });
                
                const avgNum = totalWeight > 0 ? totalScore / totalWeight : null;
                
                // Ph√¢n lo·∫°i theo h·ªçc k·ª≥
                const hocKy = mon.MaHocKy || '';
                if (hocKy.includes('1')) {
                    groupedBySubject[key].hk1 = { data: mon, avg: avgNum };
                } else if (hocKy.includes('2')) {
                    groupedBySubject[key].hk2 = { data: mon, avg: avgNum };
                }
            });
            
            // Render theo filter
            if (semesterFilter === 'HK1') {
                renderSemester(groupedBySubject, 'hk1', 'H·ªçc k·ª≥ 1', thead, tbody);
            } else if (semesterFilter === 'HK2') {
                renderSemester(groupedBySubject, 'hk2', 'H·ªçc k·ª≥ 2', thead, tbody);
            } else if (semesterFilter === 'CANAM') {
                renderYearSummary(groupedBySubject, thead, tbody);
            }
        }
        
        function renderSemester(groupedBySubject, hkKey, hkLabel, thead, tbody) {
            // Define subject order
            const subjectOrder = ['To√°n', 'V·∫≠t L√Ω', 'H√≥a H·ªçc', 'Sinh H·ªçc', 'Ng·ªØ VƒÉn', 'L·ªãch S·ª≠', 'ƒê·ªãa L√Ω', 'Ti·∫øng Anh', 'Gi√°o D·ª•c C√¥ng D√¢n'];
            
            // Sort subjects
            const sortedSubjects = Object.keys(groupedBySubject).sort((a, b) => {
                const subjectA = groupedBySubject[a].tenMonHoc;
                const subjectB = groupedBySubject[b].tenMonHoc;
                const indexA = subjectOrder.indexOf(subjectA);
                const indexB = subjectOrder.indexOf(subjectB);
                
                if (indexA === -1 && indexB === -1) return 0;
                if (indexA === -1) return 1;
                if (indexB === -1) return -1;
                return indexA - indexB;
            });
            
            // Header
            thead.innerHTML = `
                <th>M√¥n h·ªçc</th>
                ${examTypes.map(et => `<th>${et.tenlhkt}<br><small>(x${et.heso})</small></th>`).join('')}
                <th class="col-avg">ƒêTB M√¥n</th>
            `;
            
            let totalAvg = 0;
            let countAvg = 0;
            let passedCount = 0;
            let toanAvg = null;
            let vanAvg = null;
            let minAvg = 10;
            
            const rows = [];
            
            sortedSubjects.forEach(key => {
                const subject = groupedBySubject[key];
                
                if (subject[hkKey]) {
                    const mon = subject[hkKey].data;
                    const avgNum = subject[hkKey].avg;
                    const avg = avgNum ? avgNum.toFixed(2) : '‚Äì';
                    const avgClass = avgNum ? getAvgClass(avgNum) : '';
                    
                    if (avgNum) {
                        totalAvg += avgNum;
                        countAvg++;
                        if (avgNum >= 5) passedCount++;
                        
                        // L∆∞u ƒëi·ªÉm To√°n, VƒÉn v√† ƒëi·ªÉm th·∫•p nh·∫•t (ƒë·ªÉ x√©t h·ªçc l·ª±c theo TT58)
                        if (subject.tenMonHoc === 'To√°n') toanAvg = avgNum;
                        if (subject.tenMonHoc === 'Ng·ªØ VƒÉn') vanAvg = avgNum;
                        if (avgNum < minAvg) minAvg = avgNum;
                    }
                    
                    const gradeDisplay = examTypes.map(et => {
                        const diemArr = mon.Diem[et.tenlhkt];
                        if (diemArr && diemArr.length > 0) {
                            return `<td>${diemArr.map(d => d.diem).join(', ')}</td>`;
                        }
                        return '<td class="no-grade">‚Äì</td>';
                    }).join('');
                    
                    rows.push(`
                        <tr>
                            <td><strong>${subject.tenMonHoc}</strong></td>
                            ${gradeDisplay}
                            <td class="col-avg"><span class="${avgClass}">${avg}</span></td>
                        </tr>
                    `);
                }
            });
            
            tbody.innerHTML = rows.join('');
            
            // T·ªïng k·∫øt
            if (countAvg > 0) {
                const finalAvg = totalAvg / countAvg;
                document.getElementById('avgScore').textContent = finalAvg.toFixed(2);
                
                // X√©t h·ªçc l·ª±c theo TT58/2011 (HK1 ho·∫∑c HK2)
                let ranking = '';
                if (finalAvg >= 8.0 && (toanAvg >= 8.0 || vanAvg >= 8.0) && minAvg >= 6.5) {
                    ranking = 'Gi·ªèi';
                } else if (finalAvg >= 6.5 && (toanAvg >= 6.5 || vanAvg >= 6.5) && minAvg >= 5.0) {
                    ranking = 'Kh√°';
                } else if (finalAvg >= 5.0 && (toanAvg >= 5.0 || vanAvg >= 5.0) && minAvg >= 3.5) {
                    ranking = 'TB';
                } else if (finalAvg >= 3.5 && minAvg >= 2.0) {
                    ranking = 'Y·∫øu';
                } else {
                    ranking = 'K√©m';
                }
                
                document.getElementById('ranking').textContent = ranking;
                document.getElementById('passedSubjects').textContent = `${passedCount}/${countAvg}`;
                
                // KH√îNG g·ªçi updateDanhHieu() ·ªü ƒë√¢y - s·∫Ω g·ªçi sau khi load xong h·∫°nh ki·ªÉm
            } else {
                document.getElementById('avgScore').textContent = '-';
                document.getElementById('ranking').textContent = '-';
                document.getElementById('passedSubjects').textContent = '-';
                document.getElementById('danhhieu').textContent = '-';
            }
        }
        
        function renderYearSummary(groupedBySubject, thead, tbody) {
            // Define subject order
            const subjectOrder = ['To√°n', 'V·∫≠t L√Ω', 'H√≥a H·ªçc', 'Sinh H·ªçc', 'Ng·ªØ VƒÉn', 'L·ªãch S·ª≠', 'ƒê·ªãa L√Ω', 'Ti·∫øng Anh', 'Gi√°o D·ª•c C√¥ng D√¢n'];
            
            // Sort subjects
            const sortedSubjects = Object.keys(groupedBySubject).sort((a, b) => {
                const subjectA = groupedBySubject[a].tenMonHoc;
                const subjectB = groupedBySubject[b].tenMonHoc;
                const indexA = subjectOrder.indexOf(subjectA);
                const indexB = subjectOrder.indexOf(subjectB);
                
                if (indexA === -1 && indexB === -1) return 0;
                if (indexA === -1) return 1;
                if (indexB === -1) return -1;
                return indexA - indexB;
            });
            
            // Header cho c·∫£ nƒÉm
            thead.innerHTML = `
                <th>M√¥n h·ªçc</th>
                <th>ƒêTB HK1</th>
                <th>ƒêTB HK2</th>
                <th class="col-avg">ƒêTB C·∫£ nƒÉm<br><small>(HK1 + HK2√ó2)/3</small></th>
            `;
            
            let totalYearAvg = 0;
            let countYearAvg = 0;
            let passedCount = 0;
            let toanAvg = null;
            let vanAvg = null;
            let minAvg = 10;
            
            const rows = [];
            
            sortedSubjects.forEach(key => {
                const subject = groupedBySubject[key];
                
                if (subject.hk1 && subject.hk2 && subject.hk1.avg !== null && subject.hk2.avg !== null) {
                    const hk1Avg = subject.hk1.avg;
                    const hk2Avg = subject.hk2.avg;
                    // C√¥ng th·ª©c: (HK1 + HK2 * 2) / 3
                    const yearAvg = (hk1Avg + hk2Avg * 2) / 3;
                    const avgClass = getAvgClass(yearAvg);
                    
                    totalYearAvg += yearAvg;
                    countYearAvg++;
                    if (yearAvg >= 5) passedCount++;
                    
                    // L∆∞u ƒëi·ªÉm To√°n, VƒÉn v√† ƒëi·ªÉm th·∫•p nh·∫•t (ƒë·ªÉ x√©t h·ªçc l·ª±c theo TT58)
                    if (subject.tenMonHoc === 'To√°n') toanAvg = yearAvg;
                    if (subject.tenMonHoc === 'Ng·ªØ VƒÉn') vanAvg = yearAvg;
                    if (yearAvg < minAvg) minAvg = yearAvg;
                    
                    rows.push(`
                        <tr>
                            <td><strong>${subject.tenMonHoc}</strong></td>
                            <td>${hk1Avg.toFixed(2)}</td>
                            <td>${hk2Avg.toFixed(2)}</td>
                            <td class="col-avg"><strong><span class="${avgClass}">${yearAvg.toFixed(2)}</span></strong></td>
                        </tr>
                    `);
                }
            });
            
            tbody.innerHTML = rows.join('');
            
            // T·ªïng k·∫øt c·∫£ nƒÉm
            if (countYearAvg > 0) {
                const finalAvg = totalYearAvg / countYearAvg;
                document.getElementById('avgScore').textContent = finalAvg.toFixed(2);
                
                // X√©t h·ªçc l·ª±c theo TT58/2011 (c·∫£ nƒÉm)
                let ranking = '';
                if (finalAvg >= 8.0 && (toanAvg >= 8.0 || vanAvg >= 8.0) && minAvg >= 6.5) {
                    ranking = 'Gi·ªèi';
                } else if (finalAvg >= 6.5 && (toanAvg >= 6.5 || vanAvg >= 6.5) && minAvg >= 5.0) {
                    ranking = 'Kh√°';
                } else if (finalAvg >= 5.0 && (toanAvg >= 5.0 || vanAvg >= 5.0) && minAvg >= 3.5) {
                    ranking = 'TB';
                } else if (finalAvg >= 3.5 && minAvg >= 2.0) {
                    ranking = 'Y·∫øu';
                } else {
                    ranking = 'K√©m';
                }
                
                document.getElementById('ranking').textContent = ranking;
                document.getElementById('passedSubjects').textContent = `${passedCount}/${countYearAvg}`;
                
                // KH√îNG g·ªçi updateDanhHieu() ·ªü ƒë√¢y - s·∫Ω g·ªçi sau khi load xong h·∫°nh ki·ªÉm
            } else {
                document.getElementById('avgScore').textContent = '-';
                document.getElementById('ranking').textContent = '-';
                document.getElementById('passedSubjects').textContent = '-';
                document.getElementById('danhhieu').textContent = '-';
            }
        }
        
        function getAvgClass(avgNum) {
            if (avgNum >= 8) return 'rate-excellent';
            if (avgNum >= 6.5) return 'rate-good';
            if (avgNum >= 5) return 'rate-average';
            return 'rate-low';
        }
        
        /**
         * T√≠nh danh hi·ªáu theo quy ƒë·ªãnh TT 58/2011/TT-BGDƒêT (NGHI√äM NG·∫∂T)
         * 
         * H·ªçc sinh Gi·ªèi: 
         *   - H·ªçc l·ª±c Gi·ªèi + H·∫°nh ki·ªÉm T·ªët (CH·∫∂T CH·∫º - CH·ªà T·ªët m·ªõi ƒë∆∞·ª£c)
         * 
         * H·ªçc sinh Kh√°:
         *   - H·ªçc l·ª±c Gi·ªèi + H·∫°nh ki·ªÉm Kh√° (kh√¥ng ƒë·∫°t HS Gi·ªèi v√¨ HK kh√¥ng T·ªët)
         *   - H·ªçc l·ª±c Kh√° + H·∫°nh ki·ªÉm T·ªët
         *   - H·ªçc l·ª±c Kh√° + H·∫°nh ki·ªÉm Kh√°
         * 
         * H·ªçc sinh Trung b√¨nh:
         *   - H·ªçc l·ª±c TB + H·∫°nh ki·ªÉm T·ªët
         *   - H·ªçc l·ª±c TB + H·∫°nh ki·ªÉm Kh√°
         * 
         * H·ªçc sinh Y·∫øu: C√°c tr∆∞·ªùng h·ª£p c√≤n l·∫°i
         */
        function updateDanhHieu(hocLuc) {
            const hanhKiem = document.getElementById('hanhkiem').textContent.trim();
            let danhHieu = '-';
            
            // N·∫øu kh√¥ng c√≥ h·∫°nh ki·ªÉm ho·∫∑c h·ªçc l·ª±c, kh√¥ng t√≠nh danh hi·ªáu
            if (!hanhKiem || hanhKiem === '-' || !hocLuc || hocLuc === '-') {
                document.getElementById('danhhieu').textContent = danhHieu;
                return;
            }
            
            // Chu·∫©n h√≥a x·∫øp lo·∫°i (b·ªè c√°c k√Ω t·ª± ƒë·∫∑c bi·ªát)
            const hl = hocLuc.replace(' ‚≠ê', '').replace(' (kh√¥ng ƒë·∫°t HS Gi·ªèi)', '').trim();
            const hk = hanhKiem.trim();
            
            // X√©t danh hi·ªáu theo quy ƒë·ªãnh TT 58/2011 (NGHI√äM NG·∫∂T)
            if (hl === 'Gi·ªèi' && hk === 'T·ªët') {
                // CH·ªà Gi·ªèi + T·ªët m·ªõi ƒë∆∞·ª£c HS Gi·ªèi
                danhHieu = 'H·ªçc sinh gi·ªèi';
            } else if (
                (hl === 'Gi·ªèi' && hk === 'Kh√°') ||  // Gi·ªèi + Kh√° ‚Üí Kh√° (do HK kh√¥ng T·ªët)
                (hl === 'Kh√°' && hk === 'T·ªët') ||   // Kh√° + T·ªët ‚Üí Kh√°
                (hl === 'Kh√°' && hk === 'Kh√°')      // Kh√° + Kh√° ‚Üí Kh√°
            ) {
                danhHieu = 'H·ªçc sinh kh√°';
            } else if (
                (hl === 'Gi·ªèi' && hk === 'Trung b√¨nh') ||  // Gi·ªèi + TB ‚Üí TB
                (hl === 'TB' && hk === 'T·ªët') ||    // TB + T·ªët ‚Üí TB
                (hl === 'TB' && hk === 'Kh√°')       // TB + Kh√° ‚Üí TB
            ) {
                danhHieu = 'H·ªçc sinh trung b√¨nh';
            } else {
                // C√°c tr∆∞·ªùng h·ª£p c√≤n l·∫°i: Y·∫øu + b·∫•t k·ª≥, ho·∫∑c b·∫•t k·ª≥ + TB/Y·∫øu/K√©m
                danhHieu = 'H·ªçc sinh y·∫øu';
            }
            
            document.getElementById('danhhieu').textContent = danhHieu;
        }

        // ========== RESET FILTERS ==========
        function resetFilters() {
            // Reset dropdowns
            document.getElementById('yearSelect').value = '';
            document.getElementById('gradeSelect').value = '';
            document.getElementById('classSelect').innerHTML = '<option value="">-- L·ªõp --</option>';
            
            // Reset search
            document.getElementById('searchStudent').value = '';
            
            // Reset danh s√°ch h·ªçc sinh
            document.getElementById('studentList').innerHTML = `
                <div class="empty-state">
                    <p>Ch·ªçn l·ªõp ho·∫∑c t√¨m ki·∫øm ƒë·ªÉ xem danh s√°ch h·ªçc sinh</p>
                </div>
            `;
            
            // Reset panel ph·∫£i
            document.getElementById('placeholder').style.display = 'flex';
            document.getElementById('studentDetail').style.display = 'none';
            
            // Reset bi·∫øn
            selectedStudent = null;
            allStudents = [];
        }

        // ========== EVENT LISTENERS ==========
        document.addEventListener('DOMContentLoaded', () => {
            loadDropdowns();
            
            document.getElementById('gradeSelect').addEventListener('change', () => {
                loadClasses();
                searchStudents();
            });
            document.getElementById('yearSelect').addEventListener('change', () => {
                loadClasses();
                searchStudents();
            });
            document.getElementById('classSelect').addEventListener('change', searchStudents);
            
            // T√¨m ki·∫øm realtime
            let searchTimeout;
            document.getElementById('searchStudent').addEventListener('input', () => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(searchStudents, 300);
            });

            // ƒêi·ªÅu h∆∞·ªõng danh s√°ch b·∫±ng ph√≠m m≈©i t√™n
            document.getElementById('searchStudent').addEventListener('keydown', (e) => {
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    moveSelection(1);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    moveSelection(-1);
                }
            });
            
            document.getElementById('semesterFilter').addEventListener('change', () => {
                if (selectedStudent) {
                    loadStudentGrades(selectedStudent.mahocsinh);
                }
            });
        });
    </script>

    <style>
        /* ===== SPLIT LAYOUT ===== */
        .split-container {
            display: flex;
            gap: 20px;
            height: calc(100vh - 140px);
            min-height: 500px;
        }
        
        /* LEFT PANEL */
        .left-panel {
            width: 320px;
            min-width: 280px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .panel-top {
            padding: 8px 10px;
            border-bottom: 1px solid #e5e7eb;
            background: #f8fafc;
        }
        
        .panel-title {
            font-size: 13px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .btn-refresh {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 12px;
            padding: 2px 4px;
        }
        
        .filter-row {
            display: flex;
            gap: 4px;
            margin-bottom: 6px;
        }
        
        .filter-row select {
            flex: 1;
            padding: 4px 6px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 11px;
            background: white;
        }
        
        .search-input {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 12px;
            box-sizing: border-box;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #3b82f6;
        }
        
        /* Student List */
        .student-list {
            flex: 1;
            overflow-y: auto;
            padding: 4px 8px;
            display: flex;
            flex-direction: column;
            gap: 3px;
            justify-content: flex-start;
        }
        
        .student-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .student-item:hover {
            background: #f3f4f6;
        }
        
        .student-item.active {
            background: #dbeafe;
            border: 1px solid #3b82f6;
        }
        
        .student-item-avatar {
            font-size: 24px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f3f4f6;
            border-radius: 50%;
        }
        
        .student-item.active .student-item-avatar {
            background: #bfdbfe;
        }
        
        .student-item-info {
            flex: 1;
            min-width: 0;
        }
        
        .student-item-name {
            font-weight: 600;
            color: #1f2937;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .student-item-meta {
            font-size: 12px;
            color: #6b7280;
            margin-top: 2px;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #9ca3af;
        }
        
        /* RIGHT PANEL */
        .right-panel {
            flex: 1;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            overflow-y: auto;
            padding: 14px;
        }
        
        .placeholder-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #9ca3af;
            text-align: center;
        }
        
        .placeholder-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }
        
        .placeholder-state h3 {
            margin: 0 0 8px;
            color: #6b7280;
        }
        
        /* Student Info Header */
        .student-info-header {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            margin-bottom: 20px;
            color: white;
        }
        
        .student-avatar {
            font-size: 48px;
            width: 70px;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
        }
        
        .student-info-text {
            flex: 1;
        }
        
        .student-info-text h2 {
            margin: 0 0 8px;
            font-size: 22px;
        }
        
        .student-meta {
            display: flex;
            gap: 20px;
            font-size: 14px;
            opacity: 0.9;
        }
        
        .student-info-header .btn-print {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
        }
        
        .student-info-header .btn-print:hover {
            background: rgba(255,255,255,0.3);
        }
        
        /* Semester Filter */
        .semester-filter {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .semester-filter label {
            font-weight: 500;
            color: #374151;
        }
        
        .semester-filter select {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
        }
        
        /* Transcript Table */
        .transcript-table th, .transcript-table td {
            padding: 8px 6px;
            font-size: 12px;
        }
        
        .col-avg {
            background: #e0f2fe !important;
            font-weight: 600;
        }
        
        .no-grade {
            color: #9ca3af;
        }
        
        .rate-excellent { color: #059669; font-weight: 600; }
        .rate-good { color: #2563eb; font-weight: 600; }
        .rate-average { color: #d97706; font-weight: 600; }
        .rate-low { color: #dc2626; font-weight: 600; }
        
        /* Summary Cards */
        .summary-cards {
            display: flex;
            gap: 16px;
            margin-top: 20px;
        }
        
        .summary-card {
            flex: 1;
            padding: 16px;
            border-radius: 12px;
            text-align: center;
        }
        
        .summary-card.blue { background: #dbeafe; }
        .summary-card.green { background: #d1fae5; }
        .summary-card.yellow { background: #fef3c7; }
        .summary-card.purple { background: #e9d5ff; }
        .summary-card.orange { background: #fed7aa; }
        
        .summary-label {
            font-size: 13px;
            color: #6b7280;
            margin-bottom: 4px;
        }
        
        .summary-value {
            font-size: 28px;
            font-weight: 700;
        }
        
        .summary-card.blue .summary-value { color: #1e40af; }
        .summary-card.green .summary-value { color: #059669; }
        .summary-card.yellow .summary-value { color: #d97706; }
        .summary-card.purple .summary-value { color: #7c3aed; }
        .summary-card.orange .summary-value { color: #ea580c; }
        
        /* Print */
        @media print {
            .sidebar, .topbar, .left-panel { display: none !important; }
            .main { margin-left: 0 !important; }
            .content { padding: 0 !important; }
            .split-container { display: block; }
            .right-panel { box-shadow: none; padding: 0; }
            .student-info-header { background: #333 !important; -webkit-print-color-adjust: exact; }
        }
        
        /* Responsive */
        @media (max-width: 900px) {
            .split-container {
                flex-direction: column;
                height: auto;
            }
            .left-panel {
                width: 100%;
                max-height: 300px;
            }
        }
    </style>

</body>
</html>
