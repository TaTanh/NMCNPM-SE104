<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Phân công giảng dạy</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/layout/styles.css">
    <script src="/js/toast.js"></script>
    <script src="/js/auth.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
</head>

<body class="dashboard-body">

    <!-- SIDEBAR -->
    <aside class="sidebar">
        <div class="sidebar-logo">
            <img src="/assets/uit_logo.png" alt="UIT Logo">
            <span>QL Học Sinh</span>
        </div>

        <nav class="sidebar-menu">
            <a href="/pages/dashboard.html">Dashboard</a>
            <a href="/pages/students.html">Quản lý học sinh</a>
            <a href="/pages/classes.html" id="menuClasses" style="display:none;">Quản lý lớp học</a>
            <a href="/pages/subject_list.html" id="menuSubjects" style="display:none;">Quản lý môn học</a>
            <a href="/pages/grade_entry_select.html">Nhập điểm</a>
            <a href="/pages/hanhkiem_entry.html" id="menuHanhKiem" style="display:none;">Nhập hạnh kiểm</a>
            <a href="/pages/grade_select.html">Bảng điểm</a>
            <a href="/pages/student_transcript.html">Tra cứu điểm HS</a>
            <a href="/pages/class_summary.html">Tổng kết lớp</a>
            <a href="/pages/reports.html">Báo cáo tổng kết</a>
            <a href="/pages/teaching_assignment.html" id="menuTeaching" style="display:none;" class="active">Phân công giảng dạy</a>
            <a href="/pages/exam_types.html" id="menuExamTypes" style="display:none;">Loại hình kiểm tra</a>
            <a href="/pages/users.html" id="menuUsers" style="display:none;">Quản lý người dùng</a>
        </nav>

    </aside>

    <!-- MAIN -->
    <div class="main">

        <!-- HEADER -->
        <header class="topbar">
            <div class="page-title">Phân công giảng dạy</div>
            <div class="user-info">
                <span id="userGreeting">Xin chào, Admin</span>
                <img src="/assets/user.png" class="avatar" alt="user">
                <button class="btn btn-outline btn-sm" onclick="logout()" style="margin-left:10px;">Đăng xuất</button>
            </div>
        </header>

        <!-- CONTENT -->
        <div class="content">
            <!-- FILTER: NĂM HỌC + HỌC KỲ -->
            <div class="filters-row">
                <div class="filter-item">
                    <label class="filter-label" for="yearFilter">Năm học</label>
                    <select id="yearFilter">
                        <option value="">-- Tất cả năm học --</option>
                    </select>
                </div>

                <div class="filter-item">
                    <label class="filter-label" for="semesterFilter">Học kỳ</label>
                    <select id="semesterFilter">
                        <option value="">-- Tất cả học kỳ --</option>
                        <option value="HK1">Học kỳ 1</option>
                        <option value="HK2">Học kỳ 2</option>
                    </select>
                </div>

                <div class="filter-item" style="display:flex; align-items:flex-end;">
                    <button class="btn btn-primary" id="btnFilter">Lọc</button>
                </div>
            </div>

            <!-- TOOLBAR -->
            <div class="toolbar">
                <div class="search-box">
                    <input type="text" id="searchBox" placeholder="Tìm theo tên giáo viên, lớp, môn học...">
                </div>

                <div class="toolbar-actions">
                    <button class="btn btn-primary" id="btnAddAssign">Thêm phân công</button>
                    <button class="btn btn-outline" id="btnExport">Xuất Excel</button>
                </div>
            </div>

            <!-- VIEWS: Table / Teacher-centric -->
            <div class="view-toggle" style="margin-bottom:10px;">
                <button class="btn btn-outline" id="btnViewList">Danh sách</button>
                <button class="btn btn-outline" id="btnViewByTeacher">Giáo viên - Môn</button>
            </div>

            <!-- TABLE -->
            <div class="table-wrapper" id="assignmentsView">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th style="width:50px;">STT</th>
                            <th>Giáo viên</th>
                            <th>Lớp</th>
                            <th>Môn học</th>
                            <th>Học kỳ</th>
                            <th>Năm học</th>
                            <th style="width:100px;">Thao tác</th>
                        </tr>
                    </thead>

                    <tbody id="assignmentTableBody">
                        <tr>
                            <td colspan="7" style="text-align:center;">Đang tải dữ liệu...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- TEACHER-CENTRIC VIEW -->
            <div id="teacherView" style="display:none;">
                <div id="teacherContainer"></div>
                <div style="margin-top: 10px;">
                    <button class="btn btn-outline" id="btnBackToList">Quay lại danh sách</button>
                </div>
            </div>

        </div><!-- content -->
    </div><!-- main -->

    <!-- ========== MODAL THÊM PHÂN CÔNG ========== -->
    <div class="modal-overlay" id="assignModal">
        <div class="modal">
            <div class="modal-header">
                <h2>Thêm phân công giảng dạy</h2>
                <button class="modal-close" id="closeAssignModal">&times;</button>
            </div>

            <div class="modal-body">
                <form id="assignForm" novalidate>
                    <div class="modal-grid">
                        <div class="form-group">
                            <label class="required-label">Năm học</label>
                            <select id="yearAdd" required>
                                <option value="">-- Chọn năm học --</option>
                            </select>
                            <span class="error-message" id="errorYearAdd">Vui lòng chọn năm học</span>
                        </div>

                        <div class="form-group">
                            <label class="required-label">Học kỳ</label>
                            <select id="semesterAdd" required>
                                <option value="">-- Chọn học kỳ --</option>
                                <option value="HK1">Học kỳ 1</option>
                                <option value="HK2">Học kỳ 2</option>
                            </select>
                            <span class="error-message" id="errorSemesterAdd">Vui lòng chọn học kỳ</span>
                        </div>

                        <div class="form-group">
                            <label class="required-label">Lớp</label>
                            <select id="classAdd" required>
                                <option value="">-- Chọn lớp --</option>
                            </select>
                            <span class="error-message" id="errorClassAdd">Vui lòng chọn lớp</span>
                        </div>

                        <div class="form-group">
                            <label class="required-label">Môn học</label>
                            <select id="subjectAdd" required>
                                <option value="">-- Chọn môn học --</option>
                            </select>
                            <span class="error-message" id="errorSubjectAdd">Vui lòng chọn môn học</span>
                        </div>

                        <div class="form-group">
                            <label class="required-label">Giáo viên</label>
                            <select id="teacherAdd" required>
                                <option value="">-- Chọn giáo viên --</option>
                            </select>
                            <span class="error-message" id="errorTeacherAdd">Vui lòng chọn giáo viên</span>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline" id="btnCancelAssign">Hủy</button>
                        <button type="submit" class="btn btn-primary">Lưu</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ========== MODAL XÓA ========== -->
    <div class="modal-overlay" id="deleteModal">
        <div class="modal" style="max-width:500px;">
            <div class="modal-header">
                <h2>Xác nhận xóa</h2>
                <button class="modal-close" id="closeDeleteModalBtn">&times;</button>
            </div>

            <div class="modal-body">
                <p id="deleteMessage" style="text-align:center; padding:20px;">
                    Bạn có chắc chắn muốn xóa phân công này không?
                </p>
            </div>

            <div class="modal-footer">
                <button class="btn btn-outline" id="btnCancelDelete">Hủy</button>
                <button class="btn btn-danger" id="btnConfirmDelete">Xóa</button>
            </div>
        </div>
    </div>

    <script>
        let allAssignments = [];
        let currentDeleteItem = null;

        // ========== KIỂM TRA QUYỀN ==========
        document.addEventListener('DOMContentLoaded', () => {
            const user = getCurrentUser();
            console.log('Current user:', user);
            console.log('User vaiTro:', user?.vaiTro);
            
            if (!user || !user.maNguoiDung) {
                console.error('No user info found, redirecting to login');
                window.location.href = '/pages/login.html';
                return;
            }

            // Hiển thị menu cho ADMIN
            if (user.vaiTro === 'ADMIN') {
                document.getElementById('menuClasses').style.display = 'block';
                document.getElementById('menuSubjects').style.display = 'block';
                document.getElementById('menuHanhKiem').style.display = 'block';
                document.getElementById('menuTeaching').style.display = 'block';
                document.getElementById('menuExamTypes').style.display = 'block';
                document.getElementById('menuConductRules').style.display = 'block';
                document.getElementById('menuUsers').style.display = 'block';
            }
            
            // Chỉ ADMIN mới được quản lý phân công
            if (user.vaiTro !== 'ADMIN') {
                console.error('Access denied. User role:', user.vaiTro);
                toastError('Bạn không có quyền truy cập trang này');
                setTimeout(() => {
                    window.location.href = '/pages/dashboard.html';
                }, 2000);
                return;
            }

            console.log('Access granted, loading page...');
            document.getElementById('userGreeting').textContent = `Xin chào, ${user.hoTen}`;
            loadFilters();
            loadAssignments();
        });

        // ========== LOAD FILTERS ==========
        async function loadFilters() {
            try {
                // Load năm học
                const yearsRes = await authFetch('/api/settings/school-years');
                const years = await yearsRes.json();
                
                ['yearFilter', 'yearAdd'].forEach(id => {
                    const select = document.getElementById(id);
                    years.forEach(y => {
                        const option = document.createElement('option');
                        option.value = y.manamhoc;
                        option.textContent = y.tennamhoc;
                        select.appendChild(option);
                    });
                });

                // Load lớp
                const classesRes = await authFetch('/api/classes');
                const classes = await classesRes.json();
                const classSelect = document.getElementById('classAdd');
                classes.forEach(c => {
                    const option = document.createElement('option');
                    option.value = c.malop;
                    option.textContent = c.tenlop;
                    classSelect.appendChild(option);
                });

                // Load môn học
                const subjectsRes = await authFetch('/api/subjects');
                const subjects = await subjectsRes.json();
                const subjectSelect = document.getElementById('subjectAdd');
                subjects.forEach(s => {
                    const option = document.createElement('option');
                    option.value = s.mamonhoc;
                    option.textContent = s.tenmonhoc;
                    subjectSelect.appendChild(option);
                });

                // Load giáo viên (GVBM + GVCN)
                const teachersRes = await authFetch('/api/auth/users?role=teacher');
                const teachers = await teachersRes.json();
                const teacherSelect = document.getElementById('teacherAdd');
                // Filter to ensure only teacher roles are shown (safety check)
                const filtered = (Array.isArray(teachers) ? teachers : []).filter(t => {
                    const role = t.mavaitro || t.MaVaiTro || '';
                    const roleName = (t.tenvaitro || t.TenVaiTro || '').toLowerCase();
                    return role === 'GVBM' || role === 'GVCN' || roleName.includes('giáo');
                });
                filtered.forEach(t => {
                    const option = document.createElement('option');
                    option.value = t.manguoidung;
                    option.textContent = `${t.hoten} (${t.tenvaitro || t.TenVaiTro || ''})`;
                    teacherSelect.appendChild(option);
                });

            } catch (error) {
                console.error('Lỗi load filters:', error);
                toastError('Không thể tải dữ liệu');
            }
        }

        // ========== LOAD DANH SÁCH PHÂN CÔNG ==========
        async function loadAssignments() {
            try {
                const maNamHoc = document.getElementById('yearFilter').value;
                const maHocKy = document.getElementById('semesterFilter').value;

                let url = '/api/giangday';
                const params = new URLSearchParams();
                if (maNamHoc) params.append('maNamHoc', maNamHoc);
                if (maHocKy) params.append('maHocKy', maHocKy);
                if (params.toString()) url += '?' + params.toString();

                console.log('Loading assignments from:', url);
                const token = getAuthToken();
                console.log('Using token:', token ? token.substring(0, 20) + '...' : 'NO TOKEN');
                
                const response = await authFetch(url, {
                    headers: { 
                        'Authorization': `Bearer ${token}`
                    }
                });

                console.log('Response status:', response.status);
                const result = await response.json();
                console.log('Response data:', result);
                
                if (!response.ok) {
                    console.error('API error:', response.status, result);
                    throw new Error(result.error || result.message || 'Lỗi tải dữ liệu');
                }

                allAssignments = result.data || [];
                console.log('Loaded assignments:', allAssignments.length);
                renderAssignments(allAssignments);

            } catch (error) {
                console.error('Lỗi load assignments:', error);
                document.getElementById('assignmentTableBody').innerHTML = 
                    `<tr><td colspan="7" style="text-align:center;color:red;">Lỗi: ${error.message}</td></tr>`;
            }
        }

        // ========== RENDER BẢNG ==========
        function renderAssignments(assignments) {
            const tbody = document.getElementById('assignmentTableBody');

            tbody.innerHTML = '';

            if (assignments.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">Không có dữ liệu</td></tr>';
                return;
            }

            assignments.forEach((item, index) => {
                const tr = document.createElement('tr');

                const tdIndex = document.createElement('td');
                tdIndex.style.textAlign = 'center';
                tdIndex.textContent = index + 1;
                tr.appendChild(tdIndex);

                const tdGV = document.createElement('td');
                tdGV.textContent = item.tengiaovien || '';
                
                // Thêm badge GVCN nếu giáo viên này là GVCN của lớp
                if (item.isgvcn === true || item.isgvcn === 't') {
                    const gvcnBadge = document.createElement('span');
                    gvcnBadge.className = 'badge-gvcn';
                    gvcnBadge.textContent = 'GVCN';
                    gvcnBadge.style.marginLeft = '8px';
                    tdGV.appendChild(gvcnBadge);
                }
                
                tr.appendChild(tdGV);

                const tdLop = document.createElement('td');
                tdLop.textContent = item.tenlop || '';
                tr.appendChild(tdLop);

                const tdMon = document.createElement('td');
                tdMon.textContent = item.tenmonhoc || '';
                tr.appendChild(tdMon);

                const tdHK = document.createElement('td');
                tdHK.textContent = item.tenhockydisplay ? item.tenhockydisplay : (item.tenhocky ? item.tenhocky : ('Học kỳ ' + (item.mahocky || '')));
                tr.appendChild(tdHK);

                const tdNam = document.createElement('td');
                tdNam.textContent = item.tennamhoc || item.manamhoc || '';
                tr.appendChild(tdNam);

                const tdActions = document.createElement('td');
                tdActions.style.textAlign = 'center';
                const btnDelete = document.createElement('button');
                btnDelete.className = 'btn btn-sm btn-danger';
                btnDelete.textContent = 'Xóa';
                btnDelete.addEventListener('click', () => {
                    openDeleteModal(item.malop, item.mamonhoc, item.magiaovien, item.mahocky, item.manamhoc, item.tengiaovien, item.tenlop, item.tenmonhoc);
                });
                tdActions.appendChild(btnDelete);
                tr.appendChild(tdActions);

                tbody.appendChild(tr);
            });
        }

        // ========== TEACHER-CENTRIC RENDER ==========
        function renderTeacherView(assignments) {
            const container = document.getElementById('teacherContainer');
            container.innerHTML = '';

            if (!assignments || assignments.length === 0) {
                container.innerHTML = '<div style="text-align:center; color:#666;">Không có phân công</div>';
                return;
            }

            // Group by teacher -> subject -> classes
            const grouped = {};
            assignments.forEach(item => {
                const teacherId = item.magiaovien;
                if (!grouped[teacherId]) {
                    grouped[teacherId] = {
                        magiaovien: item.magiaovien,
                        tengiaovien: item.tengiaovien,
                        email: item.email || item.emailgiaovien || '',
                        role: item.tenvaitro || '',
                        subjects: {},
                        gvcnClasses: [] // Lưu các lớp mà giáo viên là GVCN
                    };
                }
                
                // Lưu lại lớp nếu giáo viên là GVCN
                if ((item.isgvcn === true || item.isgvcn === 't') && !grouped[teacherId].gvcnClasses.find(c => c === item.tenlop)) {
                    grouped[teacherId].gvcnClasses.push(item.tenlop);
                }
                
                const subjId = item.mamonhoc;
                if (!grouped[teacherId].subjects[subjId]) {
                    grouped[teacherId].subjects[subjId] = {
                        mamonhoc: item.mamonhoc,
                        tenmonhoc: item.tenmonhoc,
                        classes: []
                    };
                }

                grouped[teacherId].subjects[subjId].classes.push({
                    malop: item.malop,
                    tenlop: item.tenlop,
                    mahocky: item.mahocky,
                    manamhoc: item.manamhoc
                });
            });

            Object.values(grouped).forEach(teacher => {
                const card = document.createElement('div');
                card.className = 'teacher-card';
                card.style.border = '1px solid #e5e7eb';
                card.style.padding = '12px';
                card.style.marginBottom = '10px';
                card.style.borderRadius = '6px';

                const header = document.createElement('div');
                header.style.display = 'flex';
                header.style.justifyContent = 'space-between';
                header.style.alignItems = 'center';

                const leftInfo = document.createElement('div');
                leftInfo.style.flex = '1';

                const info = document.createElement('div');
                let teacherLabel = `<strong>${teacher.tengiaovien}</strong> <span style="margin-left:8px; color:#6b7280;">${teacher.role}</span>`;
                
                // Hiển thị badge GVCN nếu có
                if (teacher.gvcnClasses.length > 0) {
                    teacherLabel += ` <span class="badge-gvcn" style="margin-left:8px;">GVCN: ${teacher.gvcnClasses.join(', ')}</span>`;
                }
                
                info.innerHTML = teacherLabel;
                leftInfo.appendChild(info);

                const email = document.createElement('div');
                email.style.color = '#6b7280';
                email.style.fontSize = '12px';
                email.textContent = teacher.email || '';
                leftInfo.appendChild(email);

                header.appendChild(leftInfo);

                const btnDeleteAll = document.createElement('button');
                btnDeleteAll.className = 'btn btn-danger btn-sm';
                btnDeleteAll.textContent = 'Xóa tất cả';
                btnDeleteAll.style.marginLeft = '12px';
                btnDeleteAll.onclick = () => deleteAllAssignments(teacher.magiaovien, teacher.tengiaovien);
                header.appendChild(btnDeleteAll);

                card.appendChild(header);

                // Subjects list
                const subjectList = document.createElement('div');
                subjectList.style.marginTop = '8px';
                Object.values(teacher.subjects).forEach(subj => {
                    const subjDiv = document.createElement('div');
                    subjDiv.style.marginBottom = '8px';

                    const subjTitle = document.createElement('div');
                    subjTitle.style.fontWeight = '600';
                    subjTitle.textContent = subj.tenmonhoc;
                    subjDiv.appendChild(subjTitle);

                    const classRow = document.createElement('div');
                    classRow.style.display = 'flex';
                    classRow.style.flexWrap = 'wrap';
                    classRow.style.marginTop = '6px';
                    subj.classes.forEach(c => {
                        const badge = document.createElement('div');
                        badge.className = 'badge';
                        badge.style.marginRight = '6px';
                        badge.style.marginBottom = '6px';
                        badge.textContent = c.tenlop;
                        classRow.appendChild(badge);
                    });
                    subjDiv.appendChild(classRow);

                    subjectList.appendChild(subjDiv);
                });

                card.appendChild(subjectList);
                container.appendChild(card);
            });
        }

        // ========== XUẤT EXCEL PHÂN CÔNG GIẢNG DẠY ==========
        document.getElementById('btnExport').addEventListener('click', () => {
            if (allAssignments.length === 0) {
                toastWarning('Không có dữ liệu để xuất!');
                return;
            }

            try {
                // Chuẩn bị dữ liệu
                const excelData = allAssignments.map((item, index) => ({
                    'STT': index + 1,
                    'Giáo viên': item.tengiaovien || item.tengv || '',
                    'Lớp': item.tenlop || '',
                    'Môn học': item.tenmonhoc || item.tenmon || '',
                    'Học kỳ': item.tenhocky || item.mahocky || '',
                    'Năm học': item.tennamhoc || item.manamhoc || ''
                }));

                // Tạo workbook
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(excelData);

                // Điều chỉnh độ rộng cột
                const colWidths = [
                    { wch: 5 },  // STT
                    { wch: 25 }, // Giáo viên
                    { wch: 15 }, // Lớp
                    { wch: 20 }, // Môn học
                    { wch: 12 }, // Học kỳ
                    { wch: 15 }  // Năm học
                ];
                ws['!cols'] = colWidths;

                XLSX.utils.book_append_sheet(wb, ws, 'Phân công giảng dạy');

                // Tên file
                const now = new Date();
                const filename = `PhanCongGiangDay_${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}.xlsx`;

                XLSX.writeFile(wb, filename);
                toastSuccess('Đã xuất danh sách phân công!');
            } catch (error) {
                console.error('Lỗi xuất Excel:', error);
                toastError('Lỗi khi xuất file Excel!');
            }
        });

        // ========== TÌM KIếM ==========
        document.getElementById('searchBox').addEventListener('input', (e) => {
            const keyword = e.target.value.toLowerCase().trim();

            if (!keyword) {
                if (document.getElementById('teacherView').style.display !== 'none') {
                    renderTeacherView(allAssignments);
                } else {
                    renderAssignments(allAssignments);
                }
                return;
            }

            const filtered = allAssignments.filter(item => {
                return (item.tengiaovien && item.tengiaovien.toLowerCase().includes(keyword)) ||
                       (item.tenlop && item.tenlop.toLowerCase().includes(keyword)) ||
                       (item.tenmonhoc && item.tenmonhoc.toLowerCase().includes(keyword));
            });

            if (document.getElementById('teacherView').style.display !== 'none') {
                renderTeacherView(filtered);
            } else {
                renderAssignments(filtered);
            }
        });

        // ========== LỌC ==========
        document.getElementById('btnFilter').addEventListener('click', loadAssignments);

        // ========== VIEW TOGGLE ========
        document.getElementById('btnViewList').addEventListener('click', () => {
            document.getElementById('assignmentsView').style.display = '';
            document.getElementById('teacherView').style.display = 'none';
        });

        document.getElementById('btnViewByTeacher').addEventListener('click', async () => {
            document.getElementById('assignmentsView').style.display = 'none';
            document.getElementById('teacherView').style.display = '';
            // Ensure assignments are loaded
            if (!allAssignments || allAssignments.length === 0) await loadAssignments();
            renderTeacherView(allAssignments);
        });

        document.getElementById('btnBackToList').addEventListener('click', () => {
            document.getElementById('assignmentsView').style.display = '';
            document.getElementById('teacherView').style.display = 'none';
        });

        // ========== THÊM PHÂN CÔNG ==========
        const assignModal = document.getElementById('assignModal');
        const assignForm = document.getElementById('assignForm');

        document.getElementById('btnAddAssign').addEventListener('click', () => {
            assignModal.classList.add('show');
        });

        document.getElementById('closeAssignModal').onclick =
        document.getElementById('btnCancelAssign').onclick = () => {
            assignModal.classList.remove('show');
            assignForm.reset();
            clearErrors();
        };

        assignModal.addEventListener('click', (e) => {
            if (e.target === assignModal) {
                assignModal.classList.remove('show');
                assignForm.reset();
                clearErrors();
            }
        });

        function clearErrors() {
            ['Year', 'Semester', 'Class', 'Subject', 'Teacher'].forEach(field => {
                const input = document.getElementById(field.toLowerCase() + 'Add');
                const error = document.getElementById('error' + field + 'Add');
                if (input) input.classList.remove('input-error');
                if (error) error.classList.remove('show');
            });
        }

        function showError(field) {
            const input = document.getElementById(field.toLowerCase() + 'Add');
            const error = document.getElementById('error' + field + 'Add');
            if (input) input.classList.add('input-error');
            if (error) error.classList.add('show');
        }

        assignForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            clearErrors();

            // Validate
            let isValid = true;
            ['Year', 'Semester', 'Class', 'Subject', 'Teacher'].forEach(field => {
                if (!document.getElementById(field.toLowerCase() + 'Add').value) {
                    showError(field);
                    isValid = false;
                }
            });

            if (!isValid) return;

            const data = {
                maLop: document.getElementById('classAdd').value,
                maMonHoc: document.getElementById('subjectAdd').value,
                maGiaoVien: parseInt(document.getElementById('teacherAdd').value, 10),
                maHocKy: document.getElementById('semesterAdd').value,
                maNamHoc: document.getElementById('yearAdd').value
            };

            try {
                const token = getAuthToken();
                const response = await authFetch('/api/giangday', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.message || 'Lỗi thêm phân công');
                }

                toastSuccess('Thêm phân công thành công!');
                assignModal.classList.remove('show');
                assignForm.reset();
                loadAssignments();

            } catch (error) {
                console.error('Lỗi:', error);
                toastError('Lỗi: ' + error.message);
            }
        });

        // ========== XÓA TẤT CẢ PHÂN CÔNG CỦA GIÁO VIÊN ==========
        async function deleteAllAssignments(teacherId, teacherName) {
            if (!confirm(`Xóa TẤT CẢ phân công của ${teacherName}?\n\nCảnh báo: Hành động này không thể hoàn tác!`)) return;
            
            try {
                const token = getAuthToken();
                const response = await authFetch(`/api/giangday/teacher/${teacherId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    toastSuccess(`Đã xóa ${result.deletedCount} phân công!`);
                    loadAssignments();
                } else {
                    toastError(result.message);
                }
            } catch (error) {
                console.error('Lỗi xóa tất cả phân công:', error);
                toastError('Lỗi: ' + error.message);
            }
        }

        // ========== XÓA PHÂN CÔNG ==========
        const deleteModal = document.getElementById('deleteModal');

        function openDeleteModal(maLop, maMonHoc, maGiaoVien, maHocKy, maNamHoc, tenGV, tenLop, tenMon) {
            currentDeleteItem = { maLop, maMonHoc, maGiaoVien, maHocKy, maNamHoc };
            document.getElementById('deleteMessage').textContent = 
                `Bạn có chắc chắn muốn xóa phân công giáo viên "${tenGV}" dạy môn "${tenMon}" cho lớp "${tenLop}" không?`;
            deleteModal.classList.add('show');
        }

        document.getElementById('closeDeleteModalBtn').onclick =
        document.getElementById('btnCancelDelete').onclick = () => {
            deleteModal.classList.remove('show');
            currentDeleteItem = null;
        };

        deleteModal.addEventListener('click', (e) => {
            if (e.target === deleteModal) {
                deleteModal.classList.remove('show');
                currentDeleteItem = null;
            }
        });

        document.getElementById('btnConfirmDelete').addEventListener('click', async () => {
            if (!currentDeleteItem) return;

            try {
                const { maLop, maMonHoc, maGiaoVien, maHocKy, maNamHoc } = currentDeleteItem;
                const token = getAuthToken();

                const response = await authFetch(`/api/giangday?maLop=${maLop}&maMonHoc=${maMonHoc}&maGiaoVien=${maGiaoVien}&maHocKy=${maHocKy}&maNamHoc=${maNamHoc}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.message || 'Lỗi xóa phân công');
                }

                toastSuccess('Đã xóa phân công');
                deleteModal.classList.remove('show');
                currentDeleteItem = null;
                loadAssignments();

            } catch (error) {
                console.error('Lỗi:', error);
                toastError('Lỗi: ' + error.message);
            }
        });
    </script>

    <style>
        .teacher-card .badge { display: inline-block; padding: 4px 8px; border-radius: 8px; background: #e5e7eb; color: #374151; margin-right:6px; }
        .teacher-card .badge + .badge { margin-left: 6px; }
        .teacher-card { background: #ffffff; }
        
        .badge-gvcn {
            display: inline-block;
            padding: 4px 10px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            font-size: 11px;
            font-weight: 600;
            border-radius: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.2);
        }
    </style>

</body>
</html>
