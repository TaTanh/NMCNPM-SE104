<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Quản lý môn học</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/layout/styles.css">
    <script src="/js/toast.js"></script>
    <script src="/js/auth.js"></script>
</head>

<body class="dashboard-body">

    <!-- SIDEBAR -->
    <aside class="sidebar">
        <div class="sidebar-logo">
            <img src="/assets/uit_logo.png" alt="UIT Logo">
            <span>QL Học Sinh</span>
        </div>

        <nav class="sidebar-menu">
            <a href="/pages/dashboard.html">Dashboard</a>
            <a href="/pages/students.html">Quản lý học sinh</a>
            <a href="/pages/classes.html" id="menuClasses" style="display:none;">Quản lý lớp học</a>
            <a href="/pages/subject_list.html" class="active" id="menuSubjects" style="display:none;">Quản lý môn học</a>
            <a href="/pages/grade_entry_select.html">Nhập điểm</a>
            <a href="/pages/hanhkiem_entry.html" id="menuHanhKiem" style="display:none;">Nhập hạnh kiểm</a>
            <a href="/pages/grade_select.html">Bảng điểm</a>
            <a href="/pages/student_transcript.html">Tra cứu điểm HS</a>
            <a href="/pages/class_summary.html">Tổng kết lớp</a>
            <a href="/pages/reports.html">Báo cáo tổng kết</a>
            <a href="/pages/teaching_assignment.html" id="menuTeaching" style="display:none;">Phân công giảng dạy</a>
            <a href="/pages/users.html" id="menuUsers" style="display:none;">Quản lý người dùng</a>
        </nav>
    </aside>

    <!-- MAIN -->
    <div class="main">

        <!-- HEADER -->
        <header class="topbar">
            <div class="page-title">Quản lý môn học</div>
            <div class="user-info">
                <span id="userGreeting">Xin chào, Admin</span>
                <img src="/assets/user.png" class="avatar" alt="user">
                <button class="btn btn-outline btn-sm" onclick="logout()" style="margin-left:10px;">Đăng xuất</button>
            </div>
        </header>

        <!-- CONTENT -->
        <div class="content">

            <!-- TOOLBAR: search trái, nút phải (giống trang học sinh, bỏ Xuất Excel) -->
            <div class="toolbar">
                <div class="search-box">
                    <input type="text" placeholder="Tìm theo tên hoặc mã môn...">
                </div>

                <div class="toolbar-actions">
                    
                    <div class="toolbar-actions-main">
                        <button class="btn btn-primary" id="btnAddSubject">Thêm</button>
                        <!-- nút Sửa đổi: dùng class .btn-edit để dùng lại style như trang học sinh -->
                        <button class="btn btn-edit" id="btnToggleEditMode">Sửa đổi</button>
                    </div>
                </div>
            </div>

            <!-- THANH 2 NÚT SỬA / XÓA – ẩn, chỉ hiện khi bấm Sửa đổi -->
            <div class="edit-actions" id="editActions">
                <button class="btn btn-secondary" id="btnEditSubject">Sửa</button>
                <button class="btn btn-danger" id="btnDeleteSubject">Xóa</button>
            </div>

            <!-- TABLE -->
            <div class="table-wrapper">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th class="select-col"></th>
                            <th>Mã môn</th>
                            <th>Tên môn</th>
                            <th>Hệ số</th>
                        </tr>
                    </thead>
                    <tbody id="subjectTableBody">
                        <tr><td colspan="4" style="text-align:center;">Đang tải dữ liệu...</td></tr>
                    </tbody>
                </table>
            </div>

        </div><!-- content -->
    </div><!-- main -->

    <!-- ========== POPUP THÊM MÔN HỌC ========== -->
    <div class="modal-overlay" id="addSubjectModal">
        <div class="modal">
            <div class="modal-header">
                <h2>Thêm môn học</h2>
                <button class="modal-close" id="closeAddSubjectModalBtn">&times;</button>
            </div>

            <div class="modal-body">
                <form id="addSubjectForm" novalidate>
                    <div class="modal-grid">
                        <div class="form-group">
                            <label class="required-label">Mã môn học</label>
                            <input type="text" id="subjectIdAdd" placeholder="VD: MH001" required>
                            <span class="error-message">Vui lòng nhập mã môn học</span>
                        </div>

                        <div class="form-group">
                            <label class="required-label">Tên môn học</label>
                            <input type="text" id="subjectNameAdd" required>
                            <span class="error-message">Vui lòng nhập tên môn học</span>
                        </div>

                        <div class="form-group">
                            <label class="required-label">Hệ số</label>
                            <input type="number" id="subjectCoefficientAdd" min="1" max="3" value="1" required>
                            <span class="input-hint">Hệ số từ 1 đến 3</span>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline" id="btnCancelAddSubject">Hủy</button>
                        <button type="submit" class="btn btn-primary">Lưu</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ========== POPUP SỬA MÔN HỌC ========== -->
    <div class="modal-overlay" id="editSubjectModal">
        <div class="modal">
            <div class="modal-header">
                <h2>Sửa môn học</h2>
                <button class="modal-close" id="closeEditSubjectModalBtn">&times;</button>
            </div>

            <div class="modal-body">
                <form id="editSubjectForm" novalidate>
                    <div class="modal-grid">
                        <div class="form-group">
                            <label>Mã môn học</label>
                            <input type="text" id="subjectIdEdit" readonly>
                        </div>

                        <div class="form-group">
                            <label class="required-label">Tên môn học</label>
                            <input type="text" id="subjectNameEdit" required>
                            <span class="error-message">Vui lòng nhập tên môn học</span>
                        </div>

                        <div class="form-group">
                            <label class="required-label">Hệ số</label>
                            <input type="number" id="subjectCoefficientEdit" min="1" max="3" required>
                            <span class="input-hint">Hệ số từ 1 đến 3</span>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline" id="btnCancelEditSubject">Hủy</button>
                        <button type="submit" class="btn btn-primary">Lưu</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ========== POPUP XÓA MÔN HỌC ========== -->
    <div class="modal-overlay" id="deleteSubjectModal">
        <div class="modal">
            <div class="modal-header">
                <h2>Xóa môn học</h2>
                <button class="modal-close" id="closeDeleteSubjectModalBtn">&times;</button>
            </div>

            <div class="modal-body">
                <p id="deleteSubjectMessage">Bạn có chắc chắn muốn xóa môn học này không?</p>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-outline" id="btnCancelDeleteSubject">Hủy</button>
                <button type="button" class="btn btn-danger" id="btnConfirmDeleteSubject">Xóa</button>
            </div>
        </div>
    </div>

    <!-- SCRIPT: chế độ Sửa đổi + chọn môn giống trang học sinh -->
    <script>
        const tableBody   = document.getElementById('subjectTableBody');
        const searchInput = document.querySelector('.search-box input');

        const btnAdd      = document.getElementById('btnAddSubject');
        const btnToggle   = document.getElementById('btnToggleEditMode');
        const btnEdit     = document.getElementById('btnEditSubject');
        const btnDelete   = document.getElementById('btnDeleteSubject');

        let selectedRow   = null;
        let selectModeOn  = false;
        let allSubjects = []; // Lưu toàn bộ dữ liệu để tìm kiếm

        // ========== TÌM KIẾM MÔN HỌC ==========
        searchInput.addEventListener('input', () => {
            const keyword = searchInput.value.toLowerCase().trim();
            if (!keyword) {
                renderSubjectTable(allSubjects);
                return;
            }
            const filtered = allSubjects.filter(mh => 
                mh.mamonhoc.toLowerCase().includes(keyword) ||
                mh.tenmonhoc.toLowerCase().includes(keyword)
            );
            renderSubjectTable(filtered);
        });

        // ========== LOAD DỮ LIỆU TỪ DATABASE ==========
        async function loadSubjects() {
            try {
                const response = await authFetch('/api/subjects');
                if (!response.ok) throw new Error('Lỗi tải dữ liệu');
                
                const subjects = await response.json();
                allSubjects = subjects; // Lưu lại để tìm kiếm
                renderSubjectTable(subjects);
            } catch (error) {
                console.error('Lỗi:', error);
                tableBody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:red;">Lỗi kết nối database</td></tr>';
            }
        }

        function renderSubjectTable(subjects) {
            if (subjects.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Không có dữ liệu</td></tr>';
                return;
            }
            
            tableBody.innerHTML = subjects.map(mh => `
                <tr data-id="${mh.mamonhoc}">
                    <td class="select-cell">
                        <input type="checkbox" class="row-select-checkbox">
                    </td>
                    <td>${mh.mamonhoc}</td>
                    <td>${mh.tenmonhoc}</td>
                    <td>${mh.heso}</td>
                </tr>
            `).join('');
            
            attachRowEvents();
        }

        // ========== GẮN EVENT CHO ROWS ==========
        function attachRowEvents() {
            const rows = tableBody.querySelectorAll('tr');
            const checkboxes = tableBody.querySelectorAll('.row-select-checkbox');
            
            checkboxes.forEach(cb => {
                cb.addEventListener('change', () => {
                    if (!selectModeOn) {
                        cb.checked = false;
                        return;
                    }
                    if (cb.checked) {
                        checkboxes.forEach(other => {
                            if (other !== cb) {
                                other.checked = false;
                                other.closest('tr').classList.remove('row-selected');
                            }
                        });
                        selectedRow = cb.closest('tr');
                        selectedRow.classList.add('row-selected');
                    } else {
                        cb.closest('tr').classList.remove('row-selected');
                        if (selectedRow === cb.closest('tr')) selectedRow = null;
                    }
                });
            });

            rows.forEach(row => {
                row.addEventListener('click', (e) => {
                    if (!selectModeOn) return;
                    if (e.target.classList.contains('row-select-checkbox')) return;

                    const cb = row.querySelector('.row-select-checkbox');
                    if (cb) {
                        cb.checked = !cb.checked;
                        cb.dispatchEvent(new Event('change'));
                    }
                });
            });
        }

        function resetSelection() {
            selectedRow = null;
            const checkboxes = tableBody.querySelectorAll('.row-select-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = false;
                cb.closest('tr').classList.remove('row-selected');
            });
        }

        function enterSelectMode() {
            selectModeOn = true;
            document.body.classList.add('select-mode');
            btnToggle.classList.add('btn-toggle-active');
            resetSelection();
        }

        function exitSelectMode() {
            selectModeOn = false;
            document.body.classList.remove('select-mode');
            btnToggle.classList.remove('btn-toggle-active');
            resetSelection();
        }

        btnToggle.addEventListener('click', (e) => {
            e.preventDefault();
            if (selectModeOn) exitSelectMode();
            else enterSelectMode();
        });

        /* ========= POPUP THÊM MÔN HỌC ========= */
        const addSubjectModal = document.getElementById('addSubjectModal');
        const addSubjectForm  = document.getElementById('addSubjectForm');

        btnAdd.addEventListener('click', (e) => {
            e.preventDefault();
            addSubjectModal.classList.add('show');
        });

        document.getElementById('closeAddSubjectModalBtn').onclick =
        document.getElementById('btnCancelAddSubject').onclick = () => {
            addSubjectModal.classList.remove('show');
            addSubjectForm.reset();
        };

        addSubjectModal.addEventListener('click', (e) => {
            if (e.target === addSubjectModal) {
                addSubjectModal.classList.remove('show');
                addSubjectForm.reset();
            }
        });

        addSubjectForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const data = {
                MaMonHoc: document.getElementById('subjectIdAdd').value,
                TenMonHoc: document.getElementById('subjectNameAdd').value,
                HeSo: document.getElementById('subjectCoefficientAdd').value
            };
            
            try {
                const response = await authFetch('/api/subjects', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || 'Lỗi thêm môn học');
                }
                
                toastSuccess('Thêm môn học thành công!');
                addSubjectModal.classList.remove('show');
                addSubjectForm.reset();
                loadSubjects();
            } catch (error) {
                toastError(error.message);
            }
        });

        /* ========= POPUP SỬA MÔN HỌC ========= */
        const editSubjectModal = document.getElementById('editSubjectModal');
        const editSubjectForm  = document.getElementById('editSubjectForm');

        btnEdit.addEventListener('click', (e) => {
            e.preventDefault();

            if (!selectModeOn) {
                toastWarning('Hãy bấm "Sửa đổi" và chọn một môn học trước.');
                return;
            }
            if (!selectedRow) {
                toastWarning('Vui lòng chọn một môn học để sửa.');
                return;
            }

            const cells = selectedRow.querySelectorAll('td');
            document.getElementById('subjectIdEdit').value          = cells[1].textContent.trim();
            document.getElementById('subjectNameEdit').value        = cells[2].textContent.trim();
            document.getElementById('subjectCoefficientEdit').value = cells[3].textContent.trim();

            editSubjectModal.classList.add('show');
        });

        document.getElementById('closeEditSubjectModalBtn').onclick =
        document.getElementById('btnCancelEditSubject').onclick = () => {
            editSubjectModal.classList.remove('show');
            editSubjectForm.reset();
        };

        editSubjectModal.addEventListener('click', (e) => {
            if (e.target === editSubjectModal) {
                editSubjectModal.classList.remove('show');
                editSubjectForm.reset();
            }
        });

        editSubjectForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const maMonHoc = document.getElementById('subjectIdEdit').value;
            const data = {
                TenMonHoc: document.getElementById('subjectNameEdit').value,
                HeSo: document.getElementById('subjectCoefficientEdit').value
            };
            
            try {
                const response = await authFetch(`/api/subjects/${maMonHoc}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || 'Lỗi cập nhật môn học');
                }
                
                toastSuccess('Cập nhật môn học thành công!');
                editSubjectModal.classList.remove('show');
                editSubjectForm.reset();
                exitSelectMode();
                loadSubjects();
            } catch (error) {
                toastError(error.message);
            }
        });

        /* ========= POPUP XÓA MÔN HỌC ========= */
        const deleteSubjectModal   = document.getElementById('deleteSubjectModal');
        const deleteSubjectMessage = document.getElementById('deleteSubjectMessage');

        btnDelete.addEventListener('click', (e) => {
            e.preventDefault();

            if (!selectModeOn) {
                toastWarning('Hãy bấm "Sửa đổi" và chọn một môn học trước.');
                return;
            }
            if (!selectedRow) {
                toastWarning('Vui lòng chọn một môn học để xóa.');
                return;
            }

            const cells  = selectedRow.querySelectorAll('td');
            const maMon  = cells[1].textContent.trim();
            const tenMon = cells[2].textContent.trim();

            deleteSubjectMessage.textContent =
                `Bạn có chắc chắn muốn xóa môn học ${tenMon} (Mã: ${maMon}) không?`;

            deleteSubjectModal.classList.add('show');
        });

        document.getElementById('closeDeleteSubjectModalBtn').onclick =
        document.getElementById('btnCancelDeleteSubject').onclick = () => {
            deleteSubjectModal.classList.remove('show');
        };

        deleteSubjectModal.addEventListener('click', (e) => {
            if (e.target === deleteSubjectModal) {
                deleteSubjectModal.classList.remove('show');
            }
        });

        document.getElementById('btnConfirmDeleteSubject').onclick = async () => {
            const maMonHoc = selectedRow.querySelectorAll('td')[1].textContent.trim();
            
            try {
                const response = await authFetch(`/api/subjects/${maMonHoc}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || 'Lỗi xóa môn học');
                }
                
                toastSuccess('Đã xóa môn học!');
                deleteSubjectModal.classList.remove('show');
                exitSelectMode();
                loadSubjects();
            } catch (error) {
                toastError(error.message);
            }
        };

        // ========== KHỞI TẠO ==========
        document.addEventListener('DOMContentLoaded', () => {
            // Check user role and show/hide menu items
            const user = getCurrentUser();
            if (user && user.vaiTro === 'ADMIN') {
                document.getElementById('menuClasses').style.display = 'block';
                document.getElementById('menuSubjects').style.display = 'block';
                document.getElementById('menuHanhKiem').style.display = 'block';
                document.getElementById('menuTeaching').style.display = 'block';
                document.getElementById('menuUsers').style.display = 'block';
            }
            
            loadSubjects();
        });
    </script>

</body>
</html>
