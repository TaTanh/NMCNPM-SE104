<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Quản lý môn học</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/layout/styles.css">
</head>

<body class="dashboard-body">

    <!-- SIDEBAR -->
    <aside class="sidebar">
        <div class="sidebar-logo">
            <img src="/assets/uit_logo.png" alt="UIT Logo">
            <span>QL Học Sinh</span>
        </div>

        <nav class="sidebar-menu">
            <a href="/pages/dashboard.html">Dashboard</a>
            <a href="/pages/students.html">Quản lý học sinh</a>
            <a href="/pages/classes.html">Quản lý lớp học</a>
            <a href="/pages/subject_list.html" class="active">Quản lý môn học</a>
            <a href="/pages/grade_select.html">Bảng điểm</a>
            <a href="/pages/reports.html">Báo cáo tổng kết</a>
            <a href="/pages/settings.html">Cài đặt hệ thống</a>
        </nav>
    </aside>

    <!-- MAIN -->
    <div class="main">

        <!-- HEADER -->
        <header class="topbar">
            <div class="page-title">Quản lý môn học</div>
            <div class="user-info">
                <span>Xin chào, Admin</span>
                <img src="/assets/user.png" class="avatar" alt="user">
            </div>
        </header>

        <!-- CONTENT -->
        <div class="content">

            <!-- TOOLBAR: search trái, nút phải (giống trang học sinh, bỏ Xuất Excel) -->
            <div class="toolbar">
                <div class="search-box">
                    <input type="text" placeholder="Tìm theo tên hoặc mã môn...">
                </div>

                <div class="toolbar-actions">
                    <div class="toolbar-actions-main">
                        <button class="btn btn-primary" id="btnAddSubject">Thêm</button>
                        <!-- nút Sửa đổi: dùng class .btn-edit để dùng lại style như trang học sinh -->
                        <button class="btn btn-edit" id="btnToggleEditMode">Sửa đổi</button>
                    </div>
                </div>
            </div>

            <!-- THANH 2 NÚT SỬA / XÓA – ẩn, chỉ hiện khi bấm Sửa đổi -->
            <div class="edit-actions" id="editActions">
                <button class="btn btn-secondary" id="btnEditSubject">Sửa</button>
                <button class="btn btn-danger" id="btnDeleteSubject">Xóa</button>
            </div>

            <!-- TABLE -->
            <div class="table-wrapper">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th class="select-col"></th>
                            <th>Mã môn</th>
                            <th>Tên môn</th>
                            <th>Hệ số</th>
                        </tr>
                    </thead>
                    <tbody id="subjectTableBody">
                        <tr>
                            <td class="select-cell">
                                <input type="checkbox" class="row-select-checkbox">
                            </td>
                            <td>MH001</td>
                            <td>Toán</td>
                            <td>2</td>
                        </tr>
                        <tr>
                            <td class="select-cell">
                                <input type="checkbox" class="row-select-checkbox">
                            </td>
                            <td>MH002</td>
                            <td>Vật lý</td>
                            <td>1</td>
                        </tr>
                        <tr>
                            <td class="select-cell">
                                <input type="checkbox" class="row-select-checkbox">
                            </td>
                            <td>MH003</td>
                            <td>Ngữ văn</td>
                            <td>2</td>
                        </tr>
                        <tr>
                            <td class="select-cell">
                                <input type="checkbox" class="row-select-checkbox">
                            </td>
                            <td>MH004</td>
                            <td>Hóa học</td>
                            <td>1</td>
                        </tr>
                        <tr>
                            <td class="select-cell">
                                <input type="checkbox" class="row-select-checkbox">
                            </td>
                            <td>MH005</td>
                            <td>Tiếng Anh</td>
                            <td>2</td>
                        </tr>
                    </tbody>
                </table>
            </div>

        </div><!-- content -->
    </div><!-- main -->

    <!-- ========== POPUP THÊM MÔN HỌC ========== -->
    <div class="modal-overlay" id="addSubjectModal">
        <div class="modal">
            <div class="modal-header">
                <h2>Thêm môn học</h2>
                <button class="modal-close" id="closeAddSubjectModalBtn">&times;</button>
            </div>

            <div class="modal-body">
                <form id="addSubjectForm">
                    <div class="modal-grid">
                        <div class="form-group">
                            <label>Mã môn học</label>
                            <input type="text" id="subjectIdAdd" placeholder="VD: MH001" required>
                        </div>

                        <div class="form-group">
                            <label>Tên môn học</label>
                            <input type="text" id="subjectNameAdd" required>
                        </div>

                        <div class="form-group">
                            <label>Hệ số</label>
                            <input type="number" id="subjectCoefficientAdd" min="1" max="3" value="1" required>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline" id="btnCancelAddSubject">Hủy</button>
                        <button type="submit" class="btn btn-primary">Lưu</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ========== POPUP SỬA MÔN HỌC ========== -->
    <div class="modal-overlay" id="editSubjectModal">
        <div class="modal">
            <div class="modal-header">
                <h2>Sửa môn học</h2>
                <button class="modal-close" id="closeEditSubjectModalBtn">&times;</button>
            </div>

            <div class="modal-body">
                <form id="editSubjectForm">
                    <div class="modal-grid">
                        <div class="form-group">
                            <label>Mã môn học</label>
                            <input type="text" id="subjectIdEdit" readonly>
                        </div>

                        <div class="form-group">
                            <label>Tên môn học</label>
                            <input type="text" id="subjectNameEdit" required>
                        </div>

                        <div class="form-group">
                            <label>Hệ số</label>
                            <input type="number" id="subjectCoefficientEdit" min="1" max="3" required>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline" id="btnCancelEditSubject">Hủy</button>
                        <button type="submit" class="btn btn-primary">Lưu</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ========== POPUP XÓA MÔN HỌC ========== -->
    <div class="modal-overlay" id="deleteSubjectModal">
        <div class="modal">
            <div class="modal-header">
                <h2>Xóa môn học</h2>
                <button class="modal-close" id="closeDeleteSubjectModalBtn">&times;</button>
            </div>

            <div class="modal-body">
                <p id="deleteSubjectMessage">Bạn có chắc chắn muốn xóa môn học này không?</p>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-outline" id="btnCancelDeleteSubject">Hủy</button>
                <button type="button" class="btn btn-danger" id="btnConfirmDeleteSubject">Xóa</button>
            </div>
        </div>
    </div>

    <!-- SCRIPT: chế độ Sửa đổi + chọn môn giống trang học sinh -->
    <script>
        const tableBody   = document.getElementById('subjectTableBody');
        const rows        = tableBody.querySelectorAll('tr');
        const checkboxes  = tableBody.querySelectorAll('.row-select-checkbox');

        const btnAdd      = document.getElementById('btnAddSubject');
        const btnToggle   = document.getElementById('btnToggleEditMode');
        const btnEdit     = document.getElementById('btnEditSubject');
        const btnDelete   = document.getElementById('btnDeleteSubject');

        let selectedRow   = null;
        let selectModeOn  = false;

        function resetSelection() {
            selectedRow = null;
            checkboxes.forEach(cb => {
                cb.checked = false;
                cb.closest('tr').classList.remove('row-selected');
            });
        }

        function enterSelectMode() {
            selectModeOn = true;
            document.body.classList.add('select-mode');
            btnToggle.classList.add('btn-toggle-active');
            resetSelection();
        }

        function exitSelectMode() {
            selectModeOn = false;
            document.body.classList.remove('select-mode');
            btnToggle.classList.remove('btn-toggle-active');
            resetSelection();
        }

        btnToggle.addEventListener('click', (e) => {
            e.preventDefault();
            if (selectModeOn) exitSelectMode();
            else enterSelectMode();
        });

        // Checkbox: chỉ cho chọn 1 dòng khi đang ở chế độ sửa đổi
        checkboxes.forEach(cb => {
            cb.addEventListener('change', () => {
                if (!selectModeOn) {
                    cb.checked = false;
                    return;
                }
                if (cb.checked) {
                    checkboxes.forEach(other => {
                        if (other !== cb) {
                            other.checked = false;
                            other.closest('tr').classList.remove('row-selected');
                        }
                    });
                    selectedRow = cb.closest('tr');
                    selectedRow.classList.add('row-selected');
                } else {
                    cb.closest('tr').classList.remove('row-selected');
                    if (selectedRow === cb.closest('tr')) selectedRow = null;
                }
            });
        });

        // Click cả dòng để toggle checkbox (khi đang select-mode)
        rows.forEach(row => {
            row.addEventListener('click', (e) => {
                if (!selectModeOn) return;
                if (e.target.classList.contains('row-select-checkbox')) return;

                const cb = row.querySelector('.row-select-checkbox');
                cb.checked = !cb.checked;
                cb.dispatchEvent(new Event('change'));
            });
        });

        /* ========= POPUP THÊM MÔN HỌC ========= */
        const addSubjectModal = document.getElementById('addSubjectModal');
        const addSubjectForm  = document.getElementById('addSubjectForm');

        btnAdd.addEventListener('click', (e) => {
            e.preventDefault();
            addSubjectModal.classList.add('show');
        });

        document.getElementById('closeAddSubjectModalBtn').onclick =
        document.getElementById('btnCancelAddSubject').onclick = () => {
            addSubjectModal.classList.remove('show');
            addSubjectForm.reset();
        };

        addSubjectModal.addEventListener('click', (e) => {
            if (e.target === addSubjectModal) {
                addSubjectModal.classList.remove('show');
                addSubjectForm.reset();
            }
        });

        addSubjectForm.addEventListener('submit', (e) => {
            e.preventDefault();
            // TODO: gửi dữ liệu lên server thêm môn học
            alert('Đã nhấn Lưu (Thêm môn học) – demo UI, chưa kết nối DB.');
            addSubjectModal.classList.remove('show');
            addSubjectForm.reset();
        });

        /* ========= POPUP SỬA MÔN HỌC ========= */
        const editSubjectModal = document.getElementById('editSubjectModal');
        const editSubjectForm  = document.getElementById('editSubjectForm');

        btnEdit.addEventListener('click', (e) => {
            e.preventDefault();

            if (!selectModeOn) {
                alert('Hãy bấm "Sửa đổi" và chọn một môn học trước.');
                return;
            }
            if (!selectedRow) {
                alert('Vui lòng chọn một môn học để sửa.');
                return;
            }

            // Cột: 0=checkbox, 1=Mã môn, 2=Tên môn, 3=Hệ số
            const cells = selectedRow.querySelectorAll('td');
            document.getElementById('subjectIdEdit').value          = cells[1].textContent.trim();
            document.getElementById('subjectNameEdit').value        = cells[2].textContent.trim();
            document.getElementById('subjectCoefficientEdit').value = cells[3].textContent.trim();

            editSubjectModal.classList.add('show');
        });

        document.getElementById('closeEditSubjectModalBtn').onclick =
        document.getElementById('btnCancelEditSubject').onclick = () => {
            editSubjectModal.classList.remove('show');
            editSubjectForm.reset();
        };

        editSubjectModal.addEventListener('click', (e) => {
            if (e.target === editSubjectModal) {
                editSubjectModal.classList.remove('show');
                editSubjectForm.reset();
            }
        });

        editSubjectForm.addEventListener('submit', (e) => {
            e.preventDefault();
            // TODO: gửi dữ liệu cập nhật lên server
            alert('Đã nhấn Lưu (Sửa môn học) – demo UI, chưa kết nối DB.');
            editSubjectModal.classList.remove('show');
            editSubjectForm.reset();
            exitSelectMode();
        });

        /* ========= POPUP XÓA MÔN HỌC ========= */
        const deleteSubjectModal   = document.getElementById('deleteSubjectModal');
        const deleteSubjectMessage = document.getElementById('deleteSubjectMessage');

        btnDelete.addEventListener('click', (e) => {
            e.preventDefault();

            if (!selectModeOn) {
                alert('Hãy bấm "Sửa đổi" và chọn một môn học trước.');
                return;
            }
            if (!selectedRow) {
                alert('Vui lòng chọn một môn học để xóa.');
                return;
            }

            const cells  = selectedRow.querySelectorAll('td');
            const maMon  = cells[1].textContent.trim();
            const tenMon = cells[2].textContent.trim();

            deleteSubjectMessage.textContent =
                `Bạn có chắc chắn muốn xóa môn học ${tenMon} (Mã: ${maMon}) không?`;

            deleteSubjectModal.classList.add('show');
        });

        document.getElementById('closeDeleteSubjectModalBtn').onclick =
        document.getElementById('btnCancelDeleteSubject').onclick = () => {
            deleteSubjectModal.classList.remove('show');
        };

        deleteSubjectModal.addEventListener('click', (e) => {
            if (e.target === deleteSubjectModal) {
                deleteSubjectModal.classList.remove('show');
            }
        });

        document.getElementById('btnConfirmDeleteSubject').onclick = () => {
            // TODO: gọi API xóa môn học
            alert('Đã nhấn Xóa môn học – demo UI, chưa kết nối DB.');
            deleteSubjectModal.classList.remove('show');
            exitSelectMode();
        };
    </script>

</body>
</html>
