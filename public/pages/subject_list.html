<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Qu·∫£n l√Ω m√¥n h·ªçc</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/layout/styles.css">
    <script src="/js/toast.js"></script>
</head>

<body class="dashboard-body">

    <!-- SIDEBAR -->
    <aside class="sidebar">
        <div class="sidebar-logo">
            <img src="/assets/uit_logo.png" alt="UIT Logo">
            <span>QL H·ªçc Sinh</span>
        </div>

        <nav class="sidebar-menu">
            <a href="/pages/dashboard.html">Dashboard</a>
            <a href="/pages/students.html">Qu·∫£n l√Ω h·ªçc sinh</a>
            <a href="/pages/classes.html">Qu·∫£n l√Ω l·ªõp h·ªçc</a>
            <a href="/pages/subject_list.html" class="active">Qu·∫£n l√Ω m√¥n h·ªçc</a>
            <a href="/pages/grade_select.html">B·∫£ng ƒëi·ªÉm</a>
            <a href="/pages/reports.html">B√°o c√°o t·ªïng k·∫øt</a>
        </nav>
    </aside>

    <!-- MAIN -->
    <div class="main">

        <!-- HEADER -->
        <header class="topbar">
            <div class="page-title">Qu·∫£n l√Ω m√¥n h·ªçc</div>
            <div class="user-info">
                <span>Xin ch√†o, Admin</span>
                <img src="/assets/user.png" class="avatar" alt="user">
            </div>
        </header>

        <!-- CONTENT -->
        <div class="content">

            <!-- TOOLBAR: search tr√°i, n√∫t ph·∫£i (gi·ªëng trang h·ªçc sinh, b·ªè Xu·∫•t Excel) -->
            <div class="toolbar">
                <div class="search-box">
                    <input type="text" placeholder="T√¨m theo t√™n ho·∫∑c m√£ m√¥n...">
                </div>

                <div class="toolbar-actions">
                    <button class="btn btn-print" onclick="window.print()">üñ®Ô∏è In</button>
                    <div class="toolbar-actions-main">
                        <button class="btn btn-primary" id="btnAddSubject">Th√™m</button>
                        <!-- n√∫t S·ª≠a ƒë·ªïi: d√πng class .btn-edit ƒë·ªÉ d√πng l·∫°i style nh∆∞ trang h·ªçc sinh -->
                        <button class="btn btn-edit" id="btnToggleEditMode">S·ª≠a ƒë·ªïi</button>
                    </div>
                </div>
            </div>

            <!-- THANH 2 N√öT S·ª¨A / X√ìA ‚Äì ·∫©n, ch·ªâ hi·ªán khi b·∫•m S·ª≠a ƒë·ªïi -->
            <div class="edit-actions" id="editActions">
                <button class="btn btn-secondary" id="btnEditSubject">S·ª≠a</button>
                <button class="btn btn-danger" id="btnDeleteSubject">X√≥a</button>
            </div>

            <!-- TABLE -->
            <div class="table-wrapper">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th class="select-col"></th>
                            <th>M√£ m√¥n</th>
                            <th>T√™n m√¥n</th>
                            <th>H·ªá s·ªë</th>
                        </tr>
                    </thead>
                    <tbody id="subjectTableBody">
                        <tr><td colspan="4" style="text-align:center;">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
                    </tbody>
                </table>
            </div>

        </div><!-- content -->
    </div><!-- main -->

    <!-- ========== POPUP TH√äM M√îN H·ªåC ========== -->
    <div class="modal-overlay" id="addSubjectModal">
        <div class="modal">
            <div class="modal-header">
                <h2>Th√™m m√¥n h·ªçc</h2>
                <button class="modal-close" id="closeAddSubjectModalBtn">&times;</button>
            </div>

            <div class="modal-body">
                <form id="addSubjectForm" novalidate>
                    <div class="modal-grid">
                        <div class="form-group">
                            <label class="required-label">M√£ m√¥n h·ªçc</label>
                            <input type="text" id="subjectIdAdd" placeholder="VD: MH001" required>
                            <span class="error-message">Vui l√≤ng nh·∫≠p m√£ m√¥n h·ªçc</span>
                        </div>

                        <div class="form-group">
                            <label class="required-label">T√™n m√¥n h·ªçc</label>
                            <input type="text" id="subjectNameAdd" required>
                            <span class="error-message">Vui l√≤ng nh·∫≠p t√™n m√¥n h·ªçc</span>
                        </div>

                        <div class="form-group">
                            <label class="required-label">H·ªá s·ªë</label>
                            <input type="number" id="subjectCoefficientAdd" min="1" max="3" value="1" required>
                            <span class="input-hint">H·ªá s·ªë t·ª´ 1 ƒë·∫øn 3</span>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline" id="btnCancelAddSubject">H·ªßy</button>
                        <button type="submit" class="btn btn-primary">L∆∞u</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ========== POPUP S·ª¨A M√îN H·ªåC ========== -->
    <div class="modal-overlay" id="editSubjectModal">
        <div class="modal">
            <div class="modal-header">
                <h2>S·ª≠a m√¥n h·ªçc</h2>
                <button class="modal-close" id="closeEditSubjectModalBtn">&times;</button>
            </div>

            <div class="modal-body">
                <form id="editSubjectForm" novalidate>
                    <div class="modal-grid">
                        <div class="form-group">
                            <label>M√£ m√¥n h·ªçc</label>
                            <input type="text" id="subjectIdEdit" readonly>
                        </div>

                        <div class="form-group">
                            <label class="required-label">T√™n m√¥n h·ªçc</label>
                            <input type="text" id="subjectNameEdit" required>
                            <span class="error-message">Vui l√≤ng nh·∫≠p t√™n m√¥n h·ªçc</span>
                        </div>

                        <div class="form-group">
                            <label class="required-label">H·ªá s·ªë</label>
                            <input type="number" id="subjectCoefficientEdit" min="1" max="3" required>
                            <span class="input-hint">H·ªá s·ªë t·ª´ 1 ƒë·∫øn 3</span>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline" id="btnCancelEditSubject">H·ªßy</button>
                        <button type="submit" class="btn btn-primary">L∆∞u</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ========== POPUP X√ìA M√îN H·ªåC ========== -->
    <div class="modal-overlay" id="deleteSubjectModal">
        <div class="modal">
            <div class="modal-header">
                <h2>X√≥a m√¥n h·ªçc</h2>
                <button class="modal-close" id="closeDeleteSubjectModalBtn">&times;</button>
            </div>

            <div class="modal-body">
                <p id="deleteSubjectMessage">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a m√¥n h·ªçc n√†y kh√¥ng?</p>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-outline" id="btnCancelDeleteSubject">H·ªßy</button>
                <button type="button" class="btn btn-danger" id="btnConfirmDeleteSubject">X√≥a</button>
            </div>
        </div>
    </div>

    <!-- SCRIPT: ch·∫ø ƒë·ªô S·ª≠a ƒë·ªïi + ch·ªçn m√¥n gi·ªëng trang h·ªçc sinh -->
    <script>
        const tableBody   = document.getElementById('subjectTableBody');
        const searchInput = document.querySelector('.search-box input');

        const btnAdd      = document.getElementById('btnAddSubject');
        const btnToggle   = document.getElementById('btnToggleEditMode');
        const btnEdit     = document.getElementById('btnEditSubject');
        const btnDelete   = document.getElementById('btnDeleteSubject');

        let selectedRow   = null;
        let selectModeOn  = false;
        let allSubjects = []; // L∆∞u to√†n b·ªô d·ªØ li·ªáu ƒë·ªÉ t√¨m ki·∫øm

        // ========== T√åM KI·∫æM M√îN H·ªåC ==========
        searchInput.addEventListener('input', () => {
            const keyword = searchInput.value.toLowerCase().trim();
            if (!keyword) {
                renderSubjectTable(allSubjects);
                return;
            }
            const filtered = allSubjects.filter(mh => 
                mh.mamonhoc.toLowerCase().includes(keyword) ||
                mh.tenmonhoc.toLowerCase().includes(keyword)
            );
            renderSubjectTable(filtered);
        });

        // ========== LOAD D·ªÆ LI·ªÜU T·ª™ DATABASE ==========
        async function loadSubjects() {
            try {
                const response = await fetch('/api/subjects');
                if (!response.ok) throw new Error('L·ªói t·∫£i d·ªØ li·ªáu');
                
                const subjects = await response.json();
                allSubjects = subjects; // L∆∞u l·∫°i ƒë·ªÉ t√¨m ki·∫øm
                renderSubjectTable(subjects);
            } catch (error) {
                console.error('L·ªói:', error);
                tableBody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:red;">L·ªói k·∫øt n·ªëi database</td></tr>';
            }
        }

        function renderSubjectTable(subjects) {
            if (subjects.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>';
                return;
            }
            
            tableBody.innerHTML = subjects.map(mh => `
                <tr data-id="${mh.mamonhoc}">
                    <td class="select-cell">
                        <input type="checkbox" class="row-select-checkbox">
                    </td>
                    <td>${mh.mamonhoc}</td>
                    <td>${mh.tenmonhoc}</td>
                    <td>${mh.heso}</td>
                </tr>
            `).join('');
            
            attachRowEvents();
        }

        // ========== G·∫ÆN EVENT CHO ROWS ==========
        function attachRowEvents() {
            const rows = tableBody.querySelectorAll('tr');
            const checkboxes = tableBody.querySelectorAll('.row-select-checkbox');
            
            checkboxes.forEach(cb => {
                cb.addEventListener('change', () => {
                    if (!selectModeOn) {
                        cb.checked = false;
                        return;
                    }
                    if (cb.checked) {
                        checkboxes.forEach(other => {
                            if (other !== cb) {
                                other.checked = false;
                                other.closest('tr').classList.remove('row-selected');
                            }
                        });
                        selectedRow = cb.closest('tr');
                        selectedRow.classList.add('row-selected');
                    } else {
                        cb.closest('tr').classList.remove('row-selected');
                        if (selectedRow === cb.closest('tr')) selectedRow = null;
                    }
                });
            });

            rows.forEach(row => {
                row.addEventListener('click', (e) => {
                    if (!selectModeOn) return;
                    if (e.target.classList.contains('row-select-checkbox')) return;

                    const cb = row.querySelector('.row-select-checkbox');
                    if (cb) {
                        cb.checked = !cb.checked;
                        cb.dispatchEvent(new Event('change'));
                    }
                });
            });
        }

        function resetSelection() {
            selectedRow = null;
            const checkboxes = tableBody.querySelectorAll('.row-select-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = false;
                cb.closest('tr').classList.remove('row-selected');
            });
        }

        function enterSelectMode() {
            selectModeOn = true;
            document.body.classList.add('select-mode');
            btnToggle.classList.add('btn-toggle-active');
            resetSelection();
        }

        function exitSelectMode() {
            selectModeOn = false;
            document.body.classList.remove('select-mode');
            btnToggle.classList.remove('btn-toggle-active');
            resetSelection();
        }

        btnToggle.addEventListener('click', (e) => {
            e.preventDefault();
            if (selectModeOn) exitSelectMode();
            else enterSelectMode();
        });

        /* ========= POPUP TH√äM M√îN H·ªåC ========= */
        const addSubjectModal = document.getElementById('addSubjectModal');
        const addSubjectForm  = document.getElementById('addSubjectForm');

        btnAdd.addEventListener('click', (e) => {
            e.preventDefault();
            addSubjectModal.classList.add('show');
        });

        document.getElementById('closeAddSubjectModalBtn').onclick =
        document.getElementById('btnCancelAddSubject').onclick = () => {
            addSubjectModal.classList.remove('show');
            addSubjectForm.reset();
        };

        addSubjectModal.addEventListener('click', (e) => {
            if (e.target === addSubjectModal) {
                addSubjectModal.classList.remove('show');
                addSubjectForm.reset();
            }
        });

        addSubjectForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const data = {
                MaMonHoc: document.getElementById('subjectIdAdd').value,
                TenMonHoc: document.getElementById('subjectNameAdd').value,
                HeSo: document.getElementById('subjectCoefficientAdd').value
            };
            
            try {
                const response = await fetch('/api/subjects', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || 'L·ªói th√™m m√¥n h·ªçc');
                }
                
                toastSuccess('Th√™m m√¥n h·ªçc th√†nh c√¥ng!');
                addSubjectModal.classList.remove('show');
                addSubjectForm.reset();
                loadSubjects();
            } catch (error) {
                toastError(error.message);
            }
        });

        /* ========= POPUP S·ª¨A M√îN H·ªåC ========= */
        const editSubjectModal = document.getElementById('editSubjectModal');
        const editSubjectForm  = document.getElementById('editSubjectForm');

        btnEdit.addEventListener('click', (e) => {
            e.preventDefault();

            if (!selectModeOn) {
                toastWarning('H√£y b·∫•m "S·ª≠a ƒë·ªïi" v√† ch·ªçn m·ªôt m√¥n h·ªçc tr∆∞·ªõc.');
                return;
            }
            if (!selectedRow) {
                toastWarning('Vui l√≤ng ch·ªçn m·ªôt m√¥n h·ªçc ƒë·ªÉ s·ª≠a.');
                return;
            }

            const cells = selectedRow.querySelectorAll('td');
            document.getElementById('subjectIdEdit').value          = cells[1].textContent.trim();
            document.getElementById('subjectNameEdit').value        = cells[2].textContent.trim();
            document.getElementById('subjectCoefficientEdit').value = cells[3].textContent.trim();

            editSubjectModal.classList.add('show');
        });

        document.getElementById('closeEditSubjectModalBtn').onclick =
        document.getElementById('btnCancelEditSubject').onclick = () => {
            editSubjectModal.classList.remove('show');
            editSubjectForm.reset();
        };

        editSubjectModal.addEventListener('click', (e) => {
            if (e.target === editSubjectModal) {
                editSubjectModal.classList.remove('show');
                editSubjectForm.reset();
            }
        });

        editSubjectForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const maMonHoc = document.getElementById('subjectIdEdit').value;
            const data = {
                TenMonHoc: document.getElementById('subjectNameEdit').value,
                HeSo: document.getElementById('subjectCoefficientEdit').value
            };
            
            try {
                const response = await fetch(`/api/subjects/${maMonHoc}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || 'L·ªói c·∫≠p nh·∫≠t m√¥n h·ªçc');
                }
                
                toastSuccess('C·∫≠p nh·∫≠t m√¥n h·ªçc th√†nh c√¥ng!');
                editSubjectModal.classList.remove('show');
                editSubjectForm.reset();
                exitSelectMode();
                loadSubjects();
            } catch (error) {
                toastError(error.message);
            }
        });

        /* ========= POPUP X√ìA M√îN H·ªåC ========= */
        const deleteSubjectModal   = document.getElementById('deleteSubjectModal');
        const deleteSubjectMessage = document.getElementById('deleteSubjectMessage');

        btnDelete.addEventListener('click', (e) => {
            e.preventDefault();

            if (!selectModeOn) {
                toastWarning('H√£y b·∫•m "S·ª≠a ƒë·ªïi" v√† ch·ªçn m·ªôt m√¥n h·ªçc tr∆∞·ªõc.');
                return;
            }
            if (!selectedRow) {
                toastWarning('Vui l√≤ng ch·ªçn m·ªôt m√¥n h·ªçc ƒë·ªÉ x√≥a.');
                return;
            }

            const cells  = selectedRow.querySelectorAll('td');
            const maMon  = cells[1].textContent.trim();
            const tenMon = cells[2].textContent.trim();

            deleteSubjectMessage.textContent =
                `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a m√¥n h·ªçc ${tenMon} (M√£: ${maMon}) kh√¥ng?`;

            deleteSubjectModal.classList.add('show');
        });

        document.getElementById('closeDeleteSubjectModalBtn').onclick =
        document.getElementById('btnCancelDeleteSubject').onclick = () => {
            deleteSubjectModal.classList.remove('show');
        };

        deleteSubjectModal.addEventListener('click', (e) => {
            if (e.target === deleteSubjectModal) {
                deleteSubjectModal.classList.remove('show');
            }
        });

        document.getElementById('btnConfirmDeleteSubject').onclick = async () => {
            const maMonHoc = selectedRow.querySelectorAll('td')[1].textContent.trim();
            
            try {
                const response = await fetch(`/api/subjects/${maMonHoc}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || 'L·ªói x√≥a m√¥n h·ªçc');
                }
                
                toastSuccess('ƒê√£ x√≥a m√¥n h·ªçc!');
                deleteSubjectModal.classList.remove('show');
                exitSelectMode();
                loadSubjects();
            } catch (error) {
                toastError(error.message);
            }
        };

        // ========== KH·ªûI T·∫†O ==========
        document.addEventListener('DOMContentLoaded', loadSubjects);
    </script>

</body>
</html>
