<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>T·ªïng k·∫øt l·ªõp</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/layout/styles.css">
    <script src="/js/toast.js"></script>
    <script src="/js/auth.js"></script>
</head>

<body class="dashboard-body">

    <!-- SIDEBAR -->
    <aside class="sidebar">
        <div class="sidebar-logo">
            <img src="/assets/uit_logo.png" alt="UIT Logo">
            <span>QL H·ªçc Sinh</span>
        </div>

        <nav class="sidebar-menu">
            <a href="/pages/dashboard.html">Dashboard</a>
            <a href="/pages/students.html">Qu·∫£n l√Ω h·ªçc sinh</a>
            <a href="/pages/classes.html">Qu·∫£n l√Ω l·ªõp h·ªçc</a>
            <a href="/pages/subject_list.html">Qu·∫£n l√Ω m√¥n h·ªçc</a>
            <a href="/pages/grade_entry_select.html">Nh·∫≠p ƒëi·ªÉm</a>
            <a href="/pages/hanhkiem_entry.html">Nh·∫≠p h·∫°nh ki·ªÉm</a>
            <a href="/pages/grade_select.html">B·∫£ng ƒëi·ªÉm</a>
            <a href="/pages/student_transcript.html">Tra c·ª©u ƒëi·ªÉm HS</a>
            <a href="/pages/class_summary.html" class="active">T·ªïng k·∫øt l·ªõp</a>
            <a href="/pages/reports.html">B√°o c√°o t·ªïng k·∫øt</a>
            <a href="/pages/teaching_assignment.html">Ph√¢n c√¥ng gi·∫£ng d·∫°y</a>
            <a href="/pages/users.html" id="menuUsers" style="display:none;">Qu·∫£n l√Ω ng∆∞·ªùi d√πng</a>
        </nav>
    </aside>

    <!-- MAIN -->
    <div class="main">

        <!-- HEADER -->
        <header class="topbar">
            <div class="page-title">T·ªïng k·∫øt l·ªõp</div>
            <div class="user-info">
                <span id="userGreeting">Xin ch√†o, Admin</span>
                <img src="/assets/user.png" class="avatar" alt="user">
                <button class="btn btn-outline btn-sm" onclick="logout()" style="margin-left:10px;">ƒêƒÉng xu·∫•t</button>
            </div>
        </header>

        <!-- CONTENT -->
        <div class="content">

            <!-- Filters: NƒÉm h·ªçc, H·ªçc k·ª≥, Kh·ªëi, L·ªõp -->
            <div class="filters-row">
                <div class="filter-item">
                    <label class="filter-label" for="yearFilter">NƒÉm h·ªçc</label>
                    <select id="yearFilter">
                        <option value="">-- Ch·ªçn nƒÉm h·ªçc --</option>
                    </select>
                </div>

                <div class="filter-item">
                    <label class="filter-label" for="semesterFilter">H·ªçc k·ª≥</label>
                    <select id="semesterFilter">
                        <option value="">-- Ch·ªçn h·ªçc k·ª≥ --</option>
                    </select>
                </div>

                <div class="filter-item">
                    <label class="filter-label" for="gradeFilter">Kh·ªëi</label>
                    <select id="gradeFilter">
                        <option value="">-- Ch·ªçn kh·ªëi --</option>
                    </select>
                </div>

                <div class="filter-item">
                    <label class="filter-label" for="classFilter">L·ªõp</label>
                    <select id="classFilter">
                        <option value="">-- Ch·ªçn l·ªõp --</option>
                    </select>
                </div>

                <button class="btn btn-primary" id="btnLoadSummary">Xem t·ªïng k·∫øt</button>
            </div>

            <!-- Empty state -->
            <div id="emptyState" class="empty-state">
                <h3>Ch·ªçn l·ªõp ƒë·ªÉ xem t·ªïng k·∫øt</h3>
                <p>Vui l√≤ng ch·ªçn nƒÉm h·ªçc, h·ªçc k·ª≥, kh·ªëi v√† l·ªõp ƒë·ªÉ xem b√°o c√°o t·ªïng k·∫øt</p>
            </div>

            <!-- Class info section (hidden until loaded) -->
            <div id="classInfoSection" style="display:none;">

                <!-- Class info card -->
                <div class="info-card">
                    <h4>Th√¥ng tin l·ªõp</h4>
                    <div style="display:flex;gap:1.5rem;flex-wrap:wrap;">
                        <div><strong>L·ªõp:</strong> <span id="className">-</span></div>
                        <div><strong>Kh·ªëi:</strong> <span id="gradeLevel">-</span></div>
                        <div><strong>GVCN:</strong> <span id="homeRoomTeacher">-</span></div>
                        <div><strong>Sƒ© s·ªë:</strong> <span id="totalStudents">-</span></div>
                    </div>
                </div>

                <!-- Quick statistics -->
                <div class="section-card">
                    <h4>Th·ªëng k√™ nhanh</h4>
                    <div style="display:flex;gap:1rem;flex-wrap:wrap;">
                        <div class="stat-box">
                            <div class="stat-label">ƒêi·ªÉm TB l·ªõp</div>
                            <div class="stat-value" id="classAvgScore">-</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">H·ªçc sinh gi·ªèi</div>
                            <div class="stat-value" id="excellentCount">-</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">H·ªçc sinh ƒë·∫°t</div>
                            <div class="stat-value" id="passedCount">-</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">H·∫°nh ki·ªÉm t·ªët</div>
                            <div class="stat-value" id="goodBehaviorCount">-</div>
                        </div>
                    </div>
                </div>

                <!-- Subject performance table -->
                <div class="section-card">
                    <h4>üìö K·∫øt qu·∫£ theo m√¥n</h4>
                    <div class="table-wrapper">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>M√¥n</th>
                                    <th>ƒêTB m√¥n</th>
                                    <th>S·ªë HS ƒë·∫°t</th>
                                    <th>T·ª∑ l·ªá %</th>
                                </tr>
                            </thead>
                            <tbody id="subjectPerformanceBody">
                                <tr><td colspan="4" class="text-center">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Student ranking table -->
                <div class="section-card">
                    <h4>üë• Danh s√°ch h·ªçc sinh</h4>
                    
                    <!-- S·∫Øp x·∫øp -->
                    <div style="margin-bottom: 10px; display: none;" id="sortOptions">
                        <label style="font-weight: 500; margin-right: 8px;">S·∫Øp x·∫øp theo:</label>
                        <select id="sortSelect" style="padding: 6px 10px; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="name">T√™n h·ªçc sinh (A-Z)</option>
                            <option value="score">ƒêi·ªÉm TB (Cao ‚Üí Th·∫•p)</option>
                        </select>
                    </div>
                    
                    <div class="table-wrapper">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>STT</th>
                                    <th>M√£ HS</th>
                                    <th>H·ªç t√™n</th>
                                    <th>ƒêTB</th>
                                    <th>X·∫øp lo·∫°i</th>
                                    <th>H·∫°nh ki·ªÉm</th>
                                    <th>Danh hi·ªáu</th>
                                </tr>
                            </thead>
                            <tbody id="studentRankingBody">
                                <tr><td colspan="7" class="text-center">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>

        </div>

    </div>

    <style>
        .empty-state {
            text-align: center;
            padding: 2rem;
            background: #f8f9fa;
            border-radius: 8px;
            color: #666;
        }
        
        .stat-box {
            background: #fff;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.04);
            flex: 1;
            min-width: 150px;
            text-align: center;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 0.5rem;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #0066cc;
        }
        
        .section-card {
            background: #fff;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.04);
            margin-bottom: 1.5rem;
        }
        
        .section-card h4 {
            margin-top: 0;
            margin-bottom: 1rem;
            color: #333;
        }
        
        .text-center {
            text-align: center !important;
        }
        
        .info-card {
            background: #f0f7ff;
            padding: 1rem;
            border-radius: 8px;
            border-left: 4px solid #0066cc;
            margin-bottom: 1.5rem;
        }
    </style>

    <script>
        let currentStudentStats = [];
        
        // Initialize page when DOM is ready
        document.addEventListener('DOMContentLoaded', async () => {
            // Check authentication
            const user = getCurrentUser();
            if (!user) {
                window.location.href = 'login.html';
                return;
            }
            
            // Update user greeting
            document.getElementById('userGreeting').textContent = `Xin ch√†o, ${user.hotendangnhap || 'B·∫°n'}`;
            
            // Update admin menu visibility
            if (user.mavaitro === 'ADMIN') {
                document.getElementById('menuUsers').style.display = 'block';
            }
            
            // Load initial filters
            await loadFilters();
            
            // Add event listeners
            document.getElementById('gradeFilter').addEventListener('change', loadClasses);
            document.getElementById('btnLoadSummary').addEventListener('click', loadClassSummary);
        });

        // Load filter options from API
        async function loadFilters() {
            try {
                const [yearsRes, semestersRes, gradesRes] = await Promise.all([
                    authFetch('/api/settings/school-years'),
                    authFetch('/api/settings/semesters'),
                    authFetch('/api/settings/grade-levels')
                ]);
                
                const years = await yearsRes.json();
                const semesters = await semestersRes.json();
                const grades = await gradesRes.json();
                
                // Populate year filter
                const yearSelect = document.getElementById('yearFilter');
                years.forEach(year => {
                    const option = new Option(year.tennamhoc, year.manamhoc);
                    yearSelect.appendChild(option);
                });
                
                // Populate semester filter
                const semSelect = document.getElementById('semesterFilter');
                semesters.forEach(sem => {
                    const option = new Option(sem.tenhocky, sem.mahocky);
                    semSelect.appendChild(option);
                });
                
                // Populate grade filter
                const gradeSelect = document.getElementById('gradeFilter');
                grades.forEach(grade => {
                    const option = new Option(grade.tenkhoilop, grade.makhoilop);
                    gradeSelect.appendChild(option);
                });
                
            } catch (err) {
                console.error('Error loading filters:', err);
                toastError('L·ªói t·∫£i b·ªô l·ªçc');
            }
        }

        // Load classes when grade is selected
        async function loadClasses() {
            const gradeId = document.getElementById('gradeFilter').value;
            const classSelect = document.getElementById('classFilter');
            
            // Reset class select
            classSelect.innerHTML = '<option value="">-- Ch·ªçn l·ªõp --</option>';
            
            if (!gradeId) {
                return;
            }
            
            try {
                const res = await authFetch(`/api/classes?khoi=${gradeId}`);
                const classList = await res.json();
                
                classList.forEach(cls => {
                    const option = new Option(cls.tenlop, cls.malop);
                    classSelect.appendChild(option);
                });
            } catch (err) {
                console.error('Error loading classes:', err);
                toastError('L·ªói t·∫£i danh s√°ch l·ªõp');
            }
        }

        // Load and display class summary
        async function loadClassSummary() {
            const year = document.getElementById('yearFilter').value;
            const semester = document.getElementById('semesterFilter').value;
            const classId = document.getElementById('classFilter').value;
            
            if (!year || !semester || !classId) {
                toastWarning('Vui l√≤ng ch·ªçn ƒë·∫ßy ƒë·ªß th√¥ng tin');
                return;
            }
            
            try {
                // Hide empty state and show results section
                document.getElementById('emptyState').style.display = 'none';
                document.getElementById('classInfoSection').style.display = 'block';
                
                // Fetch class data and student list
                const [classRes, studentsRes] = await Promise.all([
                    authFetch(`/api/classes/${classId}`),
                    authFetch(`/api/classes/${classId}/students`)
                ]);
                
                const classData = await classRes.json();
                const students = await studentsRes.json();
                
                // Display class info
                document.getElementById('className').textContent = classData.tenlop || '-';
                document.getElementById('gradeLevel').textContent = classData.khoi || '-';
                document.getElementById('homeRoomTeacher').textContent = classData.tengvcn || 'Ch∆∞a c√≥';
                document.getElementById('totalStudents').textContent = students.length;
                
                // Load academic performance (will also calculate behavior stats from hanhkiemMap)
                await loadAcademicPerformance(classId, year, semester, students);
                
            } catch (err) {
                console.error('Error loading class summary:', err);
                toastError('L·ªói t·∫£i t·ªïng k·∫øt l·ªõp');
                document.getElementById('emptyState').style.display = 'block';
                document.getElementById('classInfoSection').style.display = 'none';
            }
        }

        // Load behavior statistics for class
        async function loadBehaviorStats(classId, yearId, semesterId) {
            try {
                // N·∫øu ch·ªçn c·∫£ nƒÉm: t√≠nh d·ª±a tr√™n d·ªØ li·ªáu ƒë√£ g·ªôp trong loadAcademicPerformance
                if (semesterId === 'CN') {
                    // T·∫°m th·ªùi hi·ªÉn th·ªã placeholder, s·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t sau
                    document.getElementById('goodBehaviorCount').textContent = '-';
                    return;
                }

                const res = await authFetch(`/api/hanhkiem/thongke/lop/${classId}?maNamHoc=${yearId}&maHocKy=${semesterId}`);
                const result = await res.json();
                
                console.log('üîç DEBUG H·∫°nh ki·ªÉm th·ªëng k√™ API response:', result);
                console.log('üîç DEBUG result.data:', result.data);
                
                if (result.data) {
                    const goodCount = result.data.tot || 0;
                    const totalStudents = result.data.tongSoHocSinh || 0;
                    console.log('üîç DEBUG goodCount:', goodCount, 'totalStudents:', totalStudents);
                    document.getElementById('goodBehaviorCount').textContent = `${goodCount}/${totalStudents}`;
                } else {
                    console.log('‚ö†Ô∏è DEBUG result.data is falsy, setting 0/0');
                    document.getElementById('goodBehaviorCount').textContent = '0/0';
                }
            } catch (err) {
                console.error('Error loading behavior stats:', err);
                document.getElementById('goodBehaviorCount').textContent = '-';
            }
        }

        // Load and calculate academic performance
        async function loadAcademicPerformance(classId, yearId, semesterId, students) {
            try {
                // Helper: fetch grades for a student & semester
                const fetchStudentGrades = async (studentId, semId) => {
                    const url = semId ? `/api/grades/student/${studentId}?hocky=${semId}` : `/api/grades/student/${studentId}`;
                    try {
                        const res = await authFetch(url);
                        return await res.json();
                    } catch {
                        return [];
                    }
                };

                // Fetch h·∫°nh ki·ªÉm for all students
                const hanhkiemMap = {}; // MaHocSinh -> { diemhanhkiem, xeploai }
                try {
                    if (semesterId === 'CN') {
                        // C·∫£ nƒÉm: l·∫•y c·∫£ HK1 v√† HK2, ch·ªçn x·∫øp lo·∫°i th·∫•p h∆°n
                        const [hk1Res, hk2Res] = await Promise.all([
                            authFetch(`/api/hanhkiem/lop/${classId}?maNamHoc=${yearId}&maHocKy=HK1`),
                            authFetch(`/api/hanhkiem/lop/${classId}?maNamHoc=${yearId}&maHocKy=HK2`)
                        ]);
                        const hk1Data = await hk1Res.json();
                        const hk2Data = await hk2Res.json();
                        console.log('üîç DEBUG HK1 Data:', hk1Data);
                        console.log('üîç DEBUG HK2 Data:', hk2Data);
                        
                        // Map HK1
                        const hk1Map = {};
                        if (hk1Data.success && hk1Data.data) {
                            hk1Data.data.forEach(row => {
                                const mhs = row.mahocsinh || row.MaHocSinh;
                                hk1Map[mhs] = {
                                    diem: row.diemhanhkiem || row.DiemHanhKiem || 0,
                                    xeploai: row.xeploai || row.XepLoai || '-'
                                };
                            });
                        }
                        
                        // Map HK2
                        const hk2Map = {};
                        if (hk2Data.success && hk2Data.data) {
                            hk2Data.data.forEach(row => {
                                const mhs = row.mahocsinh || row.MaHocSinh;
                                hk2Map[mhs] = {
                                    diem: row.diemhanhkiem || row.DiemHanhKiem || 0,
                                    xeploai: row.xeploai || row.XepLoai || '-'
                                };
                            });
                        }
                        
                        // G·ªôp: Ch·ªçn x·∫øp lo·∫°i th·∫•p h∆°n (theo TT 58/2011)
                        const xepLoaiOrder = { 'T·ªët': 4, 'Kh√°': 3, 'Trung b√¨nh': 2, 'Y·∫øu': 1, '-': 0 };
                        students.forEach(student => {
                            const mhs = student.mahocsinh;
                            const hk1Info = hk1Map[mhs];
                            const hk2Info = hk2Map[mhs];
                            
                            if (hk1Info && hk2Info) {
                                // Ch·ªçn x·∫øp lo·∫°i th·∫•p h∆°n
                                const minOrder = Math.min(xepLoaiOrder[hk1Info.xeploai] || 0, xepLoaiOrder[hk2Info.xeploai] || 0);
                                let xeploaiCN = '-';
                                if (minOrder === 4) xeploaiCN = 'T·ªët';
                                else if (minOrder === 3) xeploaiCN = 'Kh√°';
                                else if (minOrder === 2) xeploaiCN = 'Trung b√¨nh';
                                else if (minOrder === 1) xeploaiCN = 'Y·∫øu';
                                
                                hanhkiemMap[mhs] = {
                                    diem: Math.round((hk1Info.diem + hk2Info.diem) / 2),
                                    xeploai: xeploaiCN
                                };
                            } else if (hk1Info) {
                                hanhkiemMap[mhs] = hk1Info;
                            } else if (hk2Info) {
                                hanhkiemMap[mhs] = hk2Info;
                            }
                        });
                    } else {
                        // Ch·ªâ 1 h·ªçc k·ª≥
                        const hkRes = await authFetch(`/api/hanhkiem/lop/${classId}?maNamHoc=${yearId}&maHocKy=${semesterId}`);
                        const hkData = await hkRes.json();
                        console.log('üîç DEBUG Single Semester HK Data:', hkData);
                        if (hkData.success && hkData.data) {
                            hkData.data.forEach(row => {
                                const mhs = row.mahocsinh || row.MaHocSinh;
                                hanhkiemMap[mhs] = {
                                    diem: row.diemhanhkiem || row.DiemHanhKiem || 0,
                                    xeploai: row.xeploai || row.XepLoai || '-'
                                };
                            });
                        }
                    }
                } catch (err) {
                    console.error('Error loading hanhkiem:', err);
                }
                
                console.log('üîç DEBUG Final hanhkiemMap:', hanhkiemMap);
                console.log('üîç DEBUG Students sample:', students.slice(0, 3).map(s => s.mahocsinh));
                
                // T√≠nh th·ªëng k√™ h·∫°nh ki·ªÉm t·ªët t·ª´ hanhkiemMap (cho c·∫£ HK1, HK2, v√† CN)
                const goodCount = Object.values(hanhkiemMap).filter(hk => hk.xeploai === 'T·ªët').length;
                document.getElementById('goodBehaviorCount').textContent = `${goodCount}/${students.length}`;
                console.log('‚úÖ DEBUG H·∫°nh ki·ªÉm t·ªët:', goodCount, '/', students.length);

                // N·∫øu ch·ªçn c·∫£ nƒÉm: l·∫•y HK1 + HK2 v√† g·ªôp
                const allGrades = await Promise.all(students.map(async (student) => {
                    if (semesterId === 'CN') {
                        const [hk1, hk2] = await Promise.all([
                            fetchStudentGrades(student.mahocsinh, 'HK1'),
                            fetchStudentGrades(student.mahocsinh, 'HK2')
                        ]);
                        return [...(hk1 || []), ...(hk2 || [])];
                    }
                    return await fetchStudentGrades(student.mahocsinh, semesterId);
                }));

                // T√≠nh to√°n th·ªëng k√™ h·ªçc sinh
                const studentStats = students.map((student, idx) => {
                    const grades = allGrades[idx] || [];

                    // Gom theo m√¥n ƒë·ªÉ t√≠nh ƒêTB c·∫£ nƒÉm (trung b√¨nh c√°c h·ªçc k·ª≥ c√≥ d·ªØ li·ªáu)
                    const subjectMap = {};
                    grades.forEach(g => {
                        const avg = calculateSubjectAverage(g);
                        if (avg === null) return;
                        if (!subjectMap[g.MaMonHoc]) subjectMap[g.MaMonHoc] = { scores: [], name: g.TenMonHoc };
                        subjectMap[g.MaMonHoc].scores.push(avg);
                    });

                    const subjectAverages = Object.values(subjectMap).map(s => s.scores.reduce((a,b)=>a+b,0)/s.scores.length);
                    const totalScore = subjectAverages.reduce((a,b)=>a+b,0);
                    const subjectCount = subjectAverages.length;
                    const avgScore = subjectCount ? totalScore / subjectCount : null;
                    const passedCount = subjectAverages.filter(v => v >= 5).length;

                    // T√≠nh h·ªçc l·ª±c theo TT58/2011
                    let ranking = '-';
                    if (avgScore !== null && subjectAverages.length > 0) {
                        // L·∫•y ƒëi·ªÉm To√°n v√† VƒÉn (n·∫øu c√≥)
                        const toanScore = Object.entries(subjectMap).find(([k, v]) => v.name === 'To√°n')?.[1]?.scores;
                        const vanScore = Object.entries(subjectMap).find(([k, v]) => v.name === 'Ng·ªØ VƒÉn')?.[1]?.scores;
                        const toan = toanScore ? toanScore.reduce((a,b)=>a+b,0)/toanScore.length : undefined;
                        const van = vanScore ? vanScore.reduce((a,b)=>a+b,0)/vanScore.length : undefined;
                        
                        const minScore = Math.min(...subjectAverages);
                        const anyGE = (score, thr) => (score !== undefined && !isNaN(score) && score >= thr);
                        
                        // Gi·ªèi: ƒêTB >= 8.0 && (To√°n ho·∫∑c VƒÉn >= 8.0) && kh√¥ng c√≥ m√¥n < 6.5
                        if (avgScore >= 8.0 && (anyGE(toan, 8.0) || anyGE(van, 8.0)) && minScore >= 6.5) {
                            ranking = 'Gi·ªèi';
                        }
                        // Kh√°: ƒêTB >= 6.5 && (To√°n ho·∫∑c VƒÉn >= 6.5) && kh√¥ng c√≥ m√¥n < 5.0
                        else if (avgScore >= 6.5 && (anyGE(toan, 6.5) || anyGE(van, 6.5)) && minScore >= 5.0) {
                            ranking = 'Kh√°';
                        }
                        // Trung b√¨nh: ƒêTB >= 5.0 && (To√°n ho·∫∑c VƒÉn >= 5.0) && kh√¥ng c√≥ m√¥n < 3.5
                        else if (avgScore >= 5.0 && (anyGE(toan, 5.0) || anyGE(van, 5.0)) && minScore >= 3.5) {
                            ranking = 'Trung b√¨nh';
                        }
                        // Y·∫øu: ƒêTB >= 3.5 && kh√¥ng c√≥ m√¥n < 2.0
                        else if (avgScore >= 3.5 && minScore >= 2.0) {
                            ranking = 'Y·∫øu';
                        }
                        // K√©m: c√≤n l·∫°i
                        else {
                            ranking = 'K√©m';
                        }
                    }

                    // L·∫•y h·∫°nh ki·ªÉm
                    const hkInfo = hanhkiemMap[student.mahocsinh] || { diem: 0, xeploai: '-' };
                    
                    // T√≠nh danh hi·ªáu theo TT 58/2011 (logic t·ª´ reportModel.js)
                    let danhHieu = '-';
                    if (ranking !== '-' && hkInfo.xeploai !== '-') {
                        // H·ªçc sinh Gi·ªèi: CH√çNH X√ÅC Gi·ªèi (>=8.0) + H·∫°nh ki·ªÉm T·ªët
                        if (ranking === 'Gi·ªèi' && hkInfo.xeploai === 'T·ªët') {
                            danhHieu = 'H·ªçc sinh Gi·ªèi';
                        }
                        // H·ªçc sinh Kh√°: (Gi·ªèi + Kh√°) OR (Kh√° + T·ªët) OR (Kh√° + Kh√°)
                        else if (
                            (ranking === 'Gi·ªèi' && hkInfo.xeploai === 'Kh√°') ||
                            (ranking === 'Kh√°' && (hkInfo.xeploai === 'T·ªët' || hkInfo.xeploai === 'Kh√°'))
                        ) {
                            danhHieu = 'H·ªçc sinh Kh√°';
                        }
                        // H·ªçc sinh Trung b√¨nh: (Gi·ªèi + TB) OR (TB + T·ªët) OR (TB + Kh√°)
                        else if (
                            (ranking === 'Gi·ªèi' && hkInfo.xeploai === 'Trung b√¨nh') ||
                            (ranking === 'Trung b√¨nh' && (hkInfo.xeploai === 'T·ªët' || hkInfo.xeploai === 'Kh√°'))
                        ) {
                            danhHieu = 'H·ªçc sinh Trung b√¨nh';
                        }
                        // T·∫•t c·∫£ tr∆∞·ªùng h·ª£p c√≤n l·∫°i
                        else {
                            danhHieu = 'H·ªçc sinh Y·∫øu';
                        }
                    }

                    return {
                        mahocsinh: student.mahocsinh,
                        hoten: student.hoten,
                        avgScore,
                        ranking,
                        hanhkiem: hkInfo.xeploai,
                        danhHieu,
                        passedCount,
                        totalSubjects: subjectCount,
                        isPassed: subjectCount > 0 && passedCount === subjectCount // ƒê·∫°t khi kh√¥ng c√≥ m√¥n n√†o d∆∞·ªõi 5
                    };
                });

                // ƒêTB l·ªõp
                const validScores = studentStats.filter(s => s.avgScore !== null);
                const classAvg = validScores.length > 0
                    ? (validScores.reduce((sum, s) => sum + s.avgScore, 0) / validScores.length).toFixed(2)
                    : '-';

                document.getElementById('classAvgScore').textContent = classAvg;
                document.getElementById('excellentCount').textContent = 
                    `${validScores.filter(s => s.avgScore >= 8).length}/${students.length}`;
                document.getElementById('passedCount').textContent =
                    `${studentStats.filter(s => s.isPassed).length}/${students.length}`;

                // L∆∞u v√†o bi·∫øn global ƒë·ªÉ d√πng cho sorting
                currentStudentStats = studentStats;
                
                // Hi·ªÉn th·ªã dropdown s·∫Øp x·∫øp
                document.getElementById('sortOptions').style.display = 'block';

                // Render b·∫£ng x·∫øp h·∫°ng HS
                renderStudentTable();

                // Th·ªëng k√™ theo m√¥n
                const subjectStats = {};
                allGrades.forEach(studentGrades => {
                    // nh√≥m theo m√¥n v√† t√≠nh trung b√¨nh c√°c h·ªçc k·ª≥
                    const subjMap = {};
                    studentGrades.forEach(g => {
                        const avg = calculateSubjectAverage(g);
                        if (avg === null) return;
                        if (!subjMap[g.MaMonHoc]) subjMap[g.MaMonHoc] = { name: g.TenMonHoc, scores: [] };
                        subjMap[g.MaMonHoc].scores.push(avg);
                    });

                    Object.values(subjMap).forEach(s => {
                        const avg = s.scores.reduce((a,b)=>a+b,0) / s.scores.length;
                        if (!subjectStats[s.name]) subjectStats[s.name] = { total: 0, count: 0, passed: 0 };
                        subjectStats[s.name].total += avg;
                        subjectStats[s.name].count += 1;
                        if (avg >= 5) subjectStats[s.name].passed += 1;
                    });
                });

                const subBody = document.getElementById('subjectPerformanceBody');
                const subjectList = Object.entries(subjectStats).map(([name, v]) => ({ name, ...v }));

                if (subjectList.length > 0) {
                    subBody.innerHTML = subjectList
                        .map(s => {
                            const avgScore = s.count > 0 ? (s.total / s.count).toFixed(2) : '-';
                            const passPercentage = s.count > 0 ? ((s.passed / s.count) * 100).toFixed(1) : '-';
                            return `
                                <tr>
                                    <td>${s.name}</td>
                                    <td>${avgScore}</td>
                                    <td>${s.passed}/${s.count}</td>
                                    <td>${passPercentage}%</td>
                                </tr>
                            `;
                        })
                        .join('');
                } else {
                    subBody.innerHTML = '<tr><td colspan="4" class="text-center">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>';
                }

            } catch (err) {
                console.error('Error loading academic performance:', err);
                toastError('L·ªói t·∫£i h·ªçc l·ª±c');
            }
        }

        // Render student table with sorting
        function renderStudentTable() {
            const tbody = document.getElementById('studentRankingBody');
            const sortBy = document.getElementById('sortSelect').value;
            
            if (currentStudentStats.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>';
                return;
            }
            
            // Helper: l·∫•y t√™n (t·ª´ cu·ªëi c√πng)
            const getTen = (hoten) => {
                const parts = hoten.trim().split(/\s+/);
                return parts[parts.length - 1];
            };
            
            // S·∫Øp x·∫øp theo l·ª±a ch·ªçn
            let sortedData = [...currentStudentStats];
            if (sortBy === 'score') {
                // S·∫Øp x·∫øp theo ƒëi·ªÉm TB (cao ‚Üí th·∫•p)
                sortedData.sort((a, b) => (b.avgScore || 0) - (a.avgScore || 0));
            } else {
                // S·∫Øp x·∫øp theo T√äN (A-Z)
                sortedData.sort((a, b) => {
                    const tenA = getTen(a.hoten);
                    const tenB = getTen(b.hoten);
                    const compare = tenA.localeCompare(tenB, 'vi');
                    if (compare === 0) {
                        return a.hoten.localeCompare(b.hoten, 'vi');
                    }
                    return compare;
                });
            }
            
            tbody.innerHTML = sortedData
                .map((s, i) => `
                    <tr>
                        <td>${i + 1}</td>
                        <td>${s.mahocsinh}</td>
                        <td>${s.hoten}</td>
                        <td>${s.avgScore !== null ? s.avgScore.toFixed(2) : '-'}</td>
                        <td>${s.ranking}</td>
                        <td>${s.hanhkiem}</td>
                        <td><strong>${s.danhHieu}</strong></td>
                    </tr>
                `)
                .join('');
        }
        
        // Event listener for sort dropdown
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('sortSelect')?.addEventListener('change', renderStudentTable);
        });
        
        // Calculate weighted average for a subject
        function calculateSubjectAverage(gradeData) {
            if (!gradeData || !gradeData.Diem) {
                return null;
            }
            
            const examTypes = [
                'Th∆∞·ªùng xuy√™n 1',
                'Th∆∞·ªùng xuy√™n 2',
                'Th∆∞·ªùng xuy√™n 3',
                'Th∆∞·ªùng xuy√™n 4',
                'Thi gi·ªØa k·ª≥',
                'Thi cu·ªëi k·ª≥'
            ];
            
            let totalScore = 0;
            let totalWeight = 0;
            
            examTypes.forEach((examType, idx) => {
                const gradeList = gradeData.Diem[examType];
                const weight = idx < 4 ? 1 : (idx === 4 ? 2 : 3);
                
                if (gradeList && gradeList.length > 0) {
                    gradeList.forEach(grade => {
                        totalScore += grade.diem * weight;
                        totalWeight += weight;
                    });
                }
            });
            
            return totalWeight > 0 ? totalScore / totalWeight : null;
        }
    </script>

</body>
</html>
