<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Xem điểm – Chi tiết</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/layout/styles.css">
    <script src="/js/toast.js"></script>
    <script src="/js/auth.js"></script>
</head>

<body class="dashboard-body">

    <!-- SIDEBAR -->
    <aside class="sidebar">
        <div class="sidebar-logo">
            <img src="/assets/uit_logo.png" alt="UIT Logo">
            <span>QL Học Sinh</span>
        </div>

        <nav class="sidebar-menu">
            <a href="/pages/dashboard.html">Dashboard</a>
            <a href="/pages/students.html">Quản lý học sinh</a>
            <a href="/pages/classes.html" id="menuClasses" style="display:none;">Quản lý lớp học</a>
            <a href="/pages/subject_list.html" id="menuSubjects" style="display:none;">Quản lý môn học</a>
            <a href="/pages/grade_entry_select.html">Nhập điểm</a>
            <a href="/pages/hanhkiem_entry.html" id="menuHanhKiem" style="display:none;">Nhập hạnh kiểm</a>
            <a href="/pages/grade_select.html" class="active">Bảng điểm</a>
            <a href="/pages/student_transcript.html">Tra cứu điểm HS</a>
            <a href="/pages/class_summary.html">Tổng kết lớp</a>
            <a href="/pages/reports.html">Báo cáo tổng kết</a>
            <a href="/pages/teaching_assignment.html" id="menuTeaching" style="display:none;">Phân công giảng dạy</a>
            <a href="/pages/users.html" id="menuUsers" style="display:none;">Quản lý người dùng</a>
        </nav>
    </aside>

    <!-- MAIN -->
    <div class="main">

        <!-- HEADER -->
        <header class="topbar">
            <div class="page-title">
                <span id="pageTitle">Bảng điểm</span>
                <span class="tag-pill">Xem điểm</span>
            </div>
            <div class="user-info">
                <span id="userGreeting">Xin chào, Admin</span>
                <img src="/assets/user.png" class="avatar" alt="user">
                <button class="btn btn-outline btn-sm" onclick="logout()" style="margin-left:10px;">Đăng xuất</button>
            </div>
        </header>

        <!-- CONTENT -->
        <div class="content">

            <!-- HÀNG TIÊU ĐỀ -->
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                <div style="font-size:14px; color:#6b7280;" id="gradeSubtitle">
                    Đang tải...
                </div>
                <a href="/pages/grade_select.html" class="btn btn-outline">← Quay lại</a>
            </div>

            <!-- THANH TÌM KIẾM HỌC SINH -->
            <div class="toolbar" style="margin-bottom: 16px;">
                <div class="search-box">
                    <input type="text" id="searchStudent" placeholder="Tìm theo mã hoặc tên học sinh...">
                </div>
            </div>

            <!-- BẢNG NHẬP ĐIỂM -->
            <div class="table-wrapper">
                <table class="data-table">
                    <thead>
                        <tr id="gradeTableHead">
                            <th>Mã HS</th>
                            <th>Họ tên</th>
                            <th>Điểm TB Môn</th>
                        </tr>
                    </thead>
                    <tbody id="gradeTableBody">
                        <tr><td colspan="3" style="text-align:center;">Đang tải dữ liệu...</td></tr>
                    </tbody>
                </table>
            </div>

            <div class="modal-footer" style="margin-top: 14px;">
                <button class="btn btn-print" onclick="window.print()">In</button>
                <button class="btn btn-outline">Xuất Excel</button>
            </div>

        </div><!-- content -->
    </div><!-- main -->

    <!-- SCRIPT XEM ĐIỂM -->
    <script>
        // ========== LẤY THAM SỐ TỪ URL ==========
        const urlParams = new URLSearchParams(window.location.search);
        const subjectId = urlParams.get('subject');
        const classId = urlParams.get('class');
        const semester = urlParams.get('semester');

        let examTypes = [];
        let allStudents = [];

        // ========== TÌM KIẾM HỌC SINH ==========
        document.getElementById('searchStudent').addEventListener('input', function() {
            const keyword = this.value.toLowerCase().trim();
            if (!keyword) {
                renderGradeTable(allStudents);
                return;
            }
            const filtered = allStudents.filter(hs => 
                hs.MaHocSinh.toLowerCase().includes(keyword) ||
                hs.HoTen.toLowerCase().includes(keyword)
            );
            renderGradeTable(filtered);
        });

        // ========== LOAD DỮ LIỆU ==========
        async function loadGradeData() {
            if (!subjectId || !classId || !semester) {
                toastWarning('Thiếu tham số. Vui lòng chọn lại từ trang bảng điểm.');
                window.location.href = '/pages/grade_select.html';
                return;
            }

            try {
                // Lấy thông tin môn học
                const subjectRes = await authFetch(`/api/subjects/${subjectId}`);
                const subject = await subjectRes.json();

                // Cập nhật tiêu đề
                document.getElementById('pageTitle').textContent = 
                    `Bảng điểm – ${classId} – ${subject.tenmonhoc}`;
                document.getElementById('gradeSubtitle').textContent = 
                    `Lớp ${classId} – Môn ${subject.tenmonhoc} – ${semester}`;

                // Lấy loại hình kiểm tra
                const examTypesRes = await authFetch('/api/grades/exam-types');
                examTypes = await examTypesRes.json();

                // Cập nhật header bảng
                const thead = document.getElementById('gradeTableHead');
                thead.innerHTML = `
                    <th>Mã HS</th>
                    <th>Họ tên</th>
                    ${examTypes.map(et => `<th>${et.tenlhkt} (x${et.heso})</th>`).join('')}
                    <th>Điểm TB Môn</th>
                `;

                // Lấy học sinh và điểm
                const gradesRes = await authFetch(`/api/grades/class/${classId}/subject/${subjectId}?hocky=${semester}`);
                const grades = await gradesRes.json();
                
                allStudents = grades;
                
                // Sắp xếp theo TÊN (từ cuối cùng của họ tên)
                allStudents.sort((a, b) => {
                    const getTen = (hoten) => {
                        const parts = hoten.trim().split(/\s+/);
                        return parts[parts.length - 1]; // Lấy từ cuối cùng (tên)
                    };
                    const tenA = getTen(a.HoTen);
                    const tenB = getTen(b.HoTen);
                    const compare = tenA.localeCompare(tenB, 'vi');
                    // Nếu tên giống nhau, sắp xếp theo họ tên đầy đủ
                    if (compare === 0) {
                        return a.HoTen.localeCompare(b.HoTen, 'vi');
                    }
                    return compare;
                });
                
                renderGradeTable(allStudents);
            } catch (error) {
                console.error('Lỗi:', error);
                document.getElementById('gradeTableBody').innerHTML = 
                    '<tr><td colspan="6" style="text-align:center;color:red;">Lỗi tải dữ liệu</td></tr>';
            }
        }

        function renderGradeTable(students) {
            const tbody = document.getElementById('gradeTableBody');
            
            if (students.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Không có học sinh trong lớp</td></tr>';
                return;
            }

            tbody.innerHTML = students.map(hs => {
                // Determine data format: new format (HK1, HK2, CN objects) or old format (array)
                const isNewFormat = hs.Diem && Object.keys(hs.Diem).length > 0 && 
                                   Object.values(hs.Diem)[0] && 
                                   typeof Object.values(hs.Diem)[0] === 'object' && 
                                   'HK1' in Object.values(hs.Diem)[0];
                
                // Hiển thị điểm dạng text (chỉ xem, không nhập)
                const gradeDisplay = examTypes.map(et => {
                    let diem = '–';
                    
                    if (isNewFormat) {
                        // New format: { TenLHKT: { HK1: x, HK2: y, CN: z } }
                        const semesterKey = semester === 'HK1' ? 'HK1' : semester === 'HK2' ? 'HK2' : 'CN';
                        diem = hs.Diem && hs.Diem[et.tenlhkt] && hs.Diem[et.tenlhkt][semesterKey] !== null
                            ? hs.Diem[et.tenlhkt][semesterKey]
                            : '–';
                    } else {
                        // Old format: { TenLHKT: [array of scores] }
                        diem = hs.Diem && hs.Diem[et.tenlhkt] && hs.Diem[et.tenlhkt][0] !== undefined
                            ? hs.Diem[et.tenlhkt][0]
                            : '–';
                    }
                    
                    return `<td>${diem}</td>`;
                }).join('');

                // Tính điểm TB
                let avg = '–';
                if (hs.Diem && Object.keys(hs.Diem).length > 0) {
                    let totalWeight = 0;
                    let totalScore = 0;
                    
                    examTypes.forEach(et => {
                        let score = null;
                        
                        if (isNewFormat) {
                            const semesterKey = semester === 'HK1' ? 'HK1' : semester === 'HK2' ? 'HK2' : 'CN';
                            score = hs.Diem[et.tenlhkt] && hs.Diem[et.tenlhkt][semesterKey] !== null
                                ? hs.Diem[et.tenlhkt][semesterKey]
                                : null;
                        } else {
                            score = hs.Diem[et.tenlhkt] && hs.Diem[et.tenlhkt][0] !== undefined
                                ? hs.Diem[et.tenlhkt][0]
                                : null;
                        }
                        
                        if (score !== null) {
                            totalScore += score * et.heso;
                            totalWeight += et.heso;
                        }
                    });
                    
                    if (totalWeight > 0) {
                        avg = (totalScore / totalWeight).toFixed(1);
                    }
                }

                // Màu cho điểm TB
                let avgClass = '';
                if (avg !== '–') {
                    const avgNum = parseFloat(avg);
                    if (avgNum >= 8) avgClass = 'rate-excellent';
                    else if (avgNum >= 6.5) avgClass = 'rate-good';
                    else if (avgNum >= 5) avgClass = 'rate-average';
                    else avgClass = 'rate-low';
                }

                return `
                    <tr>
                        <td>${hs.MaHocSinh}</td>
                        <td>${hs.HoTen}</td>
                        ${gradeDisplay}
                        <td><span class="${avgClass}">${avg}</span></td>
                    </tr>
                `;
            }).join('');
        }

        // ========== KHỞI TẠO ==========
        document.addEventListener('DOMContentLoaded', () => {
            loadGradeData();
            
            // Kiểm tra role và hiển thị menu cho ADMIN
            const user = getCurrentUser();
            if (user && user.vaiTro === 'ADMIN') {
                document.getElementById('menuClasses').style.display = 'block';
                document.getElementById('menuSubjects').style.display = 'block';
                document.getElementById('menuHanhKiem').style.display = 'block';
                document.getElementById('menuTeaching').style.display = 'block';
                document.getElementById('menuUsers').style.display = 'block';
            }
        });
    </script>

    <style>
        .rate-excellent { color: #059669; font-weight: 600; }
        .rate-good { color: #2563eb; font-weight: 500; }
        .rate-average { color: #d97706; }
        .rate-low { color: #dc2626; font-weight: 500; }
    </style>

</body>
</html>
