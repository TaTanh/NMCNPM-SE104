<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Xem ƒëi·ªÉm ‚Äì Chi ti·∫øt</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/layout/styles.css">
    <script src="/js/toast.js"></script>
    <script src="/js/auth.js"></script>
</head>

<body class="dashboard-body">

    <!-- SIDEBAR -->
    <aside class="sidebar">
        <div class="sidebar-logo">
            <img src="/assets/uit_logo.png" alt="UIT Logo">
            <span>QL H·ªçc Sinh</span>
        </div>

        <nav class="sidebar-menu">
            <a href="/pages/dashboard.html">Dashboard</a>
            <a href="/pages/students.html">Qu·∫£n l√Ω h·ªçc sinh</a>
            <a href="/pages/classes.html">Qu·∫£n l√Ω l·ªõp h·ªçc</a>
            <a href="/pages/subject_list.html">Qu·∫£n l√Ω m√¥n h·ªçc</a>
            <a href="/pages/grade_entry_select.html">Nh·∫≠p ƒëi·ªÉm</a>
            <a href="/pages/grade_select.html" class="active">B·∫£ng ƒëi·ªÉm</a>
            <a href="/pages/student_transcript.html">Tra c·ª©u ƒëi·ªÉm HS</a>
            <a href="/pages/reports.html">B√°o c√°o t·ªïng k·∫øt</a>
            <a href="/pages/users.html" id="menuUsers" style="display:none;">Qu·∫£n l√Ω ng∆∞·ªùi d√πng</a>
        </nav>
    </aside>

    <!-- MAIN -->
    <div class="main">

        <!-- HEADER -->
        <header class="topbar">
            <div class="page-title">
                <span id="pageTitle">B·∫£ng ƒëi·ªÉm</span>
                <span class="tag-pill">Xem ƒëi·ªÉm</span>
            </div>
            <div class="user-info">
                <span id="userGreeting">Xin ch√†o, Admin</span>
                <img src="/assets/user.png" class="avatar" alt="user">
                <button class="btn btn-outline btn-sm" onclick="logout()" style="margin-left:10px;">ƒêƒÉng xu·∫•t</button>
            </div>
        </header>

        <!-- CONTENT -->
        <div class="content">

            <!-- H√ÄNG TI√äU ƒê·ªÄ -->
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                <div style="font-size:14px; color:#6b7280;" id="gradeSubtitle">
                    ƒêang t·∫£i...
                </div>
                <a href="/pages/grade_select.html" class="btn btn-outline">‚Üê Quay l·∫°i</a>
            </div>

            <!-- THANH T√åM KI·∫æM H·ªåC SINH -->
            <div class="toolbar" style="margin-bottom: 16px;">
                <div class="search-box">
                    <input type="text" id="searchStudent" placeholder="T√¨m theo m√£ ho·∫∑c t√™n h·ªçc sinh...">
                </div>
            </div>

            <!-- B·∫¢NG NH·∫¨P ƒêI·ªÇM -->
            <div class="table-wrapper">
                <table class="data-table">
                    <thead>
                        <tr id="gradeTableHead">
                            <th>M√£ HS</th>
                            <th>H·ªç t√™n</th>
                            <th>ƒêi·ªÉm TB M√¥n</th>
                        </tr>
                    </thead>
                    <tbody id="gradeTableBody">
                        <tr><td colspan="3" style="text-align:center;">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
                    </tbody>
                </table>
            </div>

            <div class="modal-footer" style="margin-top: 14px;">
                <button class="btn btn-print" onclick="window.print()">üñ®Ô∏è In</button>
                <button class="btn btn-outline">Xu·∫•t Excel</button>
            </div>

        </div><!-- content -->
    </div><!-- main -->

    <!-- SCRIPT XEM ƒêI·ªÇM -->
    <script>
        // ========== L·∫§Y THAM S·ªê T·ª™ URL ==========
        const urlParams = new URLSearchParams(window.location.search);
        const subjectId = urlParams.get('subject');
        const classId = urlParams.get('class');
        const semester = urlParams.get('semester');

        let examTypes = [];
        let allStudents = [];

        // ========== T√åM KI·∫æM H·ªåC SINH ==========
        document.getElementById('searchStudent').addEventListener('input', function() {
            const keyword = this.value.toLowerCase().trim();
            if (!keyword) {
                renderGradeTable(allStudents);
                return;
            }
            const filtered = allStudents.filter(hs => 
                hs.MaHocSinh.toLowerCase().includes(keyword) ||
                hs.HoTen.toLowerCase().includes(keyword)
            );
            renderGradeTable(filtered);
        });

        // ========== LOAD D·ªÆ LI·ªÜU ==========
        async function loadGradeData() {
            if (!subjectId || !classId || !semester) {
                toastWarning('Thi·∫øu tham s·ªë. Vui l√≤ng ch·ªçn l·∫°i t·ª´ trang b·∫£ng ƒëi·ªÉm.');
                window.location.href = '/pages/grade_select.html';
                return;
            }

            try {
                // L·∫•y th√¥ng tin m√¥n h·ªçc
                const subjectRes = await fetch(`/api/subjects/${subjectId}`);
                const subject = await subjectRes.json();

                // C·∫≠p nh·∫≠t ti√™u ƒë·ªÅ
                document.getElementById('pageTitle').textContent = 
                    `B·∫£ng ƒëi·ªÉm ‚Äì ${classId} ‚Äì ${subject.tenmonhoc}`;
                document.getElementById('gradeSubtitle').textContent = 
                    `L·ªõp ${classId} ‚Äì M√¥n ${subject.tenmonhoc} ‚Äì ${semester}`;

                // L·∫•y lo·∫°i h√¨nh ki·ªÉm tra
                const examTypesRes = await fetch('/api/grades/exam-types');
                examTypes = await examTypesRes.json();

                // C·∫≠p nh·∫≠t header b·∫£ng
                const thead = document.getElementById('gradeTableHead');
                thead.innerHTML = `
                    <th>M√£ HS</th>
                    <th>H·ªç t√™n</th>
                    ${examTypes.map(et => `<th>${et.tenlhkt} (x${et.heso})</th>`).join('')}
                    <th>ƒêi·ªÉm TB M√¥n</th>
                `;

                // L·∫•y h·ªçc sinh v√† ƒëi·ªÉm
                const gradesRes = await fetch(`/api/grades/class/${classId}/subject/${subjectId}?hocky=${semester}`);
                const grades = await gradesRes.json();
                
                allStudents = grades;
                renderGradeTable(grades);
            } catch (error) {
                console.error('L·ªói:', error);
                document.getElementById('gradeTableBody').innerHTML = 
                    '<tr><td colspan="6" style="text-align:center;color:red;">L·ªói t·∫£i d·ªØ li·ªáu</td></tr>';
            }
        }

        function renderGradeTable(students) {
            const tbody = document.getElementById('gradeTableBody');
            
            if (students.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Kh√¥ng c√≥ h·ªçc sinh trong l·ªõp</td></tr>';
                return;
            }

            tbody.innerHTML = students.map(hs => {
                // Hi·ªÉn th·ªã ƒëi·ªÉm d·∫°ng text (ch·ªâ xem, kh√¥ng nh·∫≠p)
                const gradeDisplay = examTypes.map(et => {
                    const diem = hs.Diem && hs.Diem[et.tenlhkt] ? hs.Diem[et.tenlhkt][0] : '‚Äì';
                    return `<td>${diem}</td>`;
                }).join('');

                // T√≠nh ƒëi·ªÉm TB
                let avg = '‚Äì';
                if (hs.Diem && Object.keys(hs.Diem).length > 0) {
                    let totalWeight = 0;
                    let totalScore = 0;
                    examTypes.forEach(et => {
                        if (hs.Diem[et.tenlhkt] && hs.Diem[et.tenlhkt].length > 0) {
                            totalScore += hs.Diem[et.tenlhkt][0] * et.heso;
                            totalWeight += et.heso;
                        }
                    });
                    if (totalWeight > 0) {
                        avg = (totalScore / totalWeight).toFixed(1);
                    }
                }

                // M√†u cho ƒëi·ªÉm TB
                let avgClass = '';
                if (avg !== '‚Äì') {
                    const avgNum = parseFloat(avg);
                    if (avgNum >= 8) avgClass = 'rate-excellent';
                    else if (avgNum >= 6.5) avgClass = 'rate-good';
                    else if (avgNum >= 5) avgClass = 'rate-average';
                    else avgClass = 'rate-low';
                }

                return `
                    <tr>
                        <td>${hs.MaHocSinh}</td>
                        <td>${hs.HoTen}</td>
                        ${gradeDisplay}
                        <td><span class="${avgClass}">${avg}</span></td>
                    </tr>
                `;
            }).join('');
        }

        // ========== KH·ªûI T·∫†O ==========
        document.addEventListener('DOMContentLoaded', loadGradeData);
    </script>

    <style>
        .rate-excellent { color: #059669; font-weight: 600; }
        .rate-good { color: #2563eb; font-weight: 500; }
        .rate-average { color: #d97706; }
        .rate-low { color: #dc2626; font-weight: 500; }
    </style>

</body>
</html>
