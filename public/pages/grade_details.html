<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Nh·∫≠p ƒëi·ªÉm ‚Äì Chi ti·∫øt</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/layout/styles.css">
    <script src="/js/toast.js"></script>
</head>

<body class="dashboard-body">

    <!-- SIDEBAR -->
    <aside class="sidebar">
        <div class="sidebar-logo">
            <img src="/assets/uit_logo.png" alt="UIT Logo">
            <span>QL H·ªçc Sinh</span>
        </div>

        <nav class="sidebar-menu">
            <a href="/pages/dashboard.html">Dashboard</a>
            <a href="/pages/students.html">Qu·∫£n l√Ω h·ªçc sinh</a>
            <a href="/pages/classes.html">Qu·∫£n l√Ω l·ªõp h·ªçc</a>
            <a href="/pages/subject_list.html">Qu·∫£n l√Ω m√¥n h·ªçc</a>
            <a href="/pages/grade_select.html" class="active">B·∫£ng ƒëi·ªÉm</a>
            <a href="/pages/reports.html">B√°o c√°o t·ªïng k·∫øt</a>
        </nav>
    </aside>

    <!-- MAIN -->
    <div class="main">

        <!-- HEADER -->
        <header class="topbar">
            <div class="page-title">
                <span id="pageTitle">B·∫£ng nh·∫≠p ƒëi·ªÉm</span>
                <span class="tag-pill">B·∫£ng nh·∫≠p ƒëi·ªÉm</span>
            </div>
            <div class="user-info">
                <span>Xin ch√†o, Admin</span>
                <img src="/assets/user.png" class="avatar" alt="user">
            </div>
        </header>

        <!-- CONTENT -->
        <div class="content">

            <!-- H√ÄNG TI√äU ƒê·ªÄ + N√öT QUY ƒê·ªäNH -->
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                <div style="font-size:14px; color:#6b7280;" id="gradeSubtitle">
                    ƒêang t·∫£i...
                </div>
                <button id="btn-open-rules" class="btn btn-outline">
                    Thay ƒë·ªïi quy ƒë·ªãnh
                </button>
            </div>

            <!-- THANH T√åM KI·∫æM H·ªåC SINH -->
            <div class="toolbar" style="margin-bottom: 16px;">
                <div class="search-box">
                    <input type="text" id="searchStudent" placeholder="T√¨m theo m√£ ho·∫∑c t√™n h·ªçc sinh...">
                </div>
            </div>

            <!-- B·∫¢NG NH·∫¨P ƒêI·ªÇM -->
            <div class="table-wrapper">
                <table class="data-table">
                    <thead>
                        <tr id="gradeTableHead">
                            <th>M√£ HS</th>
                            <th>H·ªç t√™n</th>
                            <th>ƒêi·ªÉm TB M√¥n</th>
                        </tr>
                    </thead>
                    <tbody id="gradeTableBody">
                        <tr><td colspan="3" style="text-align:center;">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
                    </tbody>
                </table>
            </div>

            <div class="modal-footer" style="margin-top: 14px;">
                <button class="btn btn-print" onclick="window.print()">üñ®Ô∏è In</button>
                <button class="btn btn-outline">Xu·∫•t Excel</button>
                <button class="btn btn-primary" id="btnSaveGrades">L∆∞u</button>
            </div>

        </div><!-- content -->
    </div><!-- main -->

    <!-- POPUP QUY ƒê·ªäNH ƒêI·ªÇM S·ªê -->
    <div id="rules-modal"
         style="display:none; position:fixed; inset:0; background:rgba(15,23,42,0.45); 
                z-index:50; align-items:center; justify-content:center;">
        <div style="background:white; border-radius:12px; padding:20px 24px; max-width:680px; width:100%;
                    box-shadow:0 20px 40px rgba(15,23,42,0.35); max-height:90vh; overflow-y:auto;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                <h2 style="font-size:18px; margin:0;">‚öôÔ∏è Quy ƒë·ªãnh v·ªÅ ƒëi·ªÉm s·ªë</h2>
                <button id="btn-close-rules" class="btn btn-outline" style="padding:4px 10px;">‚úï</button>
            </div>

            <!-- PH·∫¶N 1: ƒêI·ªÇM S·ªê -->
            <h3 style="font-size:14px; color:#374151; margin-bottom:12px;">üìä Gi·ªõi h·∫°n ƒëi·ªÉm</h3>
            <div class="config-grid">
                <div class="config-card">
                    <div class="config-label">ƒêi·ªÉm t·ªëi thi·ªÉu</div>
                    <input type="number" id="ruleDiemToiThieu" value="0" min="0" max="10" step="0.5">
                    <div class="config-hint">ƒêi·ªÉm th·∫•p nh·∫•t c√≥ th·ªÉ nh·∫≠p</div>
                </div>

                <div class="config-card">
                    <div class="config-label">ƒêi·ªÉm t·ªëi ƒëa</div>
                    <input type="number" id="ruleDiemToiDa" value="10" min="0" max="10" step="0.5">
                    <div class="config-hint">ƒêi·ªÉm cao nh·∫•t c√≥ th·ªÉ nh·∫≠p</div>
                </div>

                <div class="config-card">
                    <div class="config-label">ƒêi·ªÉm ƒë·∫°t m√¥n</div>
                    <input type="number" id="ruleDiemDatMon" value="5" min="0" max="10" step="0.5">
                    <div class="config-hint">ƒêi·ªÉm t·ªëi thi·ªÉu ƒë·ªÉ ƒë·∫°t m√¥n h·ªçc</div>
                </div>

                <div class="config-card">
                    <div class="config-label">ƒêi·ªÉm ƒë·∫°t (x·∫øp lo·∫°i)</div>
                    <input type="number" id="ruleDiemDat" value="5" min="0" max="10" step="0.5">
                    <div class="config-hint">ƒêi·ªÉm t·ªëi thi·ªÉu ƒë·ªÉ x·∫øp lo·∫°i ƒë·∫°t</div>
                </div>
            </div>

            <!-- PH·∫¶N 2: LO·∫†I H√åNH KI·ªÇM TRA -->
            <h3 style="font-size:14px; color:#374151; margin:20px 0 12px;">üìù Lo·∫°i h√¨nh ki·ªÉm tra & H·ªá s·ªë</h3>
            <div class="table-wrapper">
                <table class="data-table" id="examTypeTable">
                    <thead>
                        <tr>
                            <th>M√£</th>
                            <th>T√™n lo·∫°i ki·ªÉm tra</th>
                            <th>H·ªá s·ªë</th>
                        </tr>
                    </thead>
                    <tbody id="examTypeBody">
                        <tr><td colspan="3" style="text-align:center;">ƒêang t·∫£i...</td></tr>
                    </tbody>
                </table>
            </div>

            <div style="margin-top:16px; text-align:right;">
                <button class="btn btn-outline" id="btn-cancel-rules" style="margin-right:8px;">H·ªßy</button>
                <button class="btn btn-primary" id="btn-save-rules">L∆∞u thay ƒë·ªïi</button>
            </div>
        </div>
    </div>

    <!-- JS SHOW/HIDE POPUP QUY ƒê·ªäNH -->
    <script>
        const btnOpenRules  = document.getElementById('btn-open-rules');
        const btnCloseRules = document.getElementById('btn-close-rules');
        const btnCancelRules = document.getElementById('btn-cancel-rules');
        const btnSaveRules = document.getElementById('btn-save-rules');
        const rulesModal    = document.getElementById('rules-modal');

        // Load quy ƒë·ªãnh ƒëi·ªÉm t·ª´ database
        async function loadGradeRules() {
            try {
                // Load tham s·ªë ƒëi·ªÉm
                const response = await fetch('/api/settings/params');
                const params = await response.json();
                
                params.forEach(p => {
                    const map = {
                        'DiemToiThieu': 'ruleDiemToiThieu',
                        'DiemToiDa': 'ruleDiemToiDa',
                        'DiemDatMon': 'ruleDiemDatMon',
                        'DiemDat': 'ruleDiemDat'
                    };
                    if (map[p.tenthamso]) {
                        document.getElementById(map[p.tenthamso]).value = p.giatri;
                    }
                });

                // Load lo·∫°i h√¨nh ki·ªÉm tra
                const examRes = await fetch('/api/settings/exam-types');
                const examTypes = await examRes.json();
                const examBody = document.getElementById('examTypeBody');
                
                if (examTypes.length === 0) {
                    examBody.innerHTML = '<tr><td colspan="3" style="text-align:center;">Ch∆∞a c√≥ lo·∫°i h√¨nh ki·ªÉm tra</td></tr>';
                } else {
                    examBody.innerHTML = examTypes.map(et => `
                        <tr data-id="${et.malhkt}">
                            <td>${et.malhkt}</td>
                            <td><input type="text" class="exam-name" value="${et.tenlhkt}" style="width:100%;padding:4px 8px;border:1px solid #d1d5db;border-radius:4px;"></td>
                            <td><input type="number" class="exam-heso" value="${et.heso}" min="1" max="5" style="width:60px;padding:4px 8px;border:1px solid #d1d5db;border-radius:4px;"></td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('L·ªói load quy ƒë·ªãnh:', error);
            }
        }

        // L∆∞u quy ƒë·ªãnh ƒëi·ªÉm
        async function saveGradeRules() {
            const rules = [
                { name: 'DiemToiThieu', value: document.getElementById('ruleDiemToiThieu').value },
                { name: 'DiemToiDa', value: document.getElementById('ruleDiemToiDa').value },
                { name: 'DiemDatMon', value: document.getElementById('ruleDiemDatMon').value },
                { name: 'DiemDat', value: document.getElementById('ruleDiemDat').value }
            ];

            try {
                // L∆∞u tham s·ªë ƒëi·ªÉm
                for (const rule of rules) {
                    await fetch(`/api/settings/params/${rule.name}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ GiaTri: rule.value })
                    });
                }

                // L∆∞u lo·∫°i h√¨nh ki·ªÉm tra
                const examRows = document.querySelectorAll('#examTypeBody tr');
                for (const row of examRows) {
                    const id = row.dataset.id;
                    const name = row.querySelector('.exam-name')?.value;
                    const heso = row.querySelector('.exam-heso')?.value;
                    
                    if (id && name && heso) {
                        await fetch(`/api/settings/exam-types/${id}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ TenLHKT: name, HeSo: heso })
                        });
                    }
                }

                toastSuccess('ƒê√£ l∆∞u quy ƒë·ªãnh th√†nh c√¥ng!');
                rulesModal.style.display = 'none';
            } catch (error) {
                console.error('L·ªói l∆∞u quy ƒë·ªãnh:', error);
                toastError('L·ªói khi l∆∞u quy ƒë·ªãnh!');
            }
        }

        if (btnOpenRules && rulesModal) {
            btnOpenRules.addEventListener('click', () => {
                loadGradeRules();
                rulesModal.style.display = 'flex';
            });

            btnCloseRules.addEventListener('click', () => rulesModal.style.display = 'none');
            btnCancelRules.addEventListener('click', () => rulesModal.style.display = 'none');
            btnSaveRules.addEventListener('click', saveGradeRules);

            rulesModal.addEventListener('click', (e) => {
                if (e.target === rulesModal) rulesModal.style.display = 'none';
            });
        }

        // ========== L·∫§Y THAM S·ªê T·ª™ URL ==========
        const urlParams = new URLSearchParams(window.location.search);
        const subjectId = urlParams.get('subject');
        const classId = urlParams.get('class');
        const semester = urlParams.get('semester');

        let examTypes = [];
        let maBangDiem = null;
        let allStudents = []; // L∆∞u to√†n b·ªô d·ªØ li·ªáu ƒë·ªÉ t√¨m ki·∫øm

        // ========== T√åM KI·∫æM H·ªåC SINH ==========
        document.getElementById('searchStudent').addEventListener('input', function() {
            const keyword = this.value.toLowerCase().trim();
            if (!keyword) {
                renderGradeTable(allStudents);
                return;
            }
            const filtered = allStudents.filter(hs => 
                hs.MaHocSinh.toLowerCase().includes(keyword) ||
                hs.HoTen.toLowerCase().includes(keyword)
            );
            renderGradeTable(filtered);
        });

        // ========== LOAD D·ªÆ LI·ªÜU ==========
        async function loadGradeData() {
            if (!subjectId || !classId || !semester) {
                toastWarning('Thi·∫øu tham s·ªë. Vui l√≤ng ch·ªçn l·∫°i t·ª´ trang b·∫£ng ƒëi·ªÉm.');
                window.location.href = '/pages/grade_select.html';
                return;
            }

            try {
                // L·∫•y th√¥ng tin m√¥n h·ªçc
                const subjectRes = await fetch(`/api/subjects/${subjectId}`);
                const subject = await subjectRes.json();

                // L·∫•y th√¥ng tin l·ªõp
                const classRes = await fetch(`/api/classes/${classId}`);
                const classInfo = await classRes.json();

                // C·∫≠p nh·∫≠t ti√™u ƒë·ªÅ
                document.getElementById('pageTitle').textContent = 
                    `${classId} ‚Äì ${subject.tenmonhoc} ‚Äì ${semester}`;
                document.getElementById('gradeSubtitle').textContent = 
                    `Nh·∫≠p ƒëi·ªÉm cho l·ªõp ${classId} ‚Äì m√¥n ${subject.tenmonhoc} ‚Äì ${semester}`;

                // L·∫•y lo·∫°i h√¨nh ki·ªÉm tra
                const examTypesRes = await fetch('/api/grades/exam-types');
                examTypes = await examTypesRes.json();

                // T·∫°o ho·∫∑c l·∫•y b·∫£ng ƒëi·ªÉm
                const bdmRes = await fetch('/api/grades/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        MaLop: classId,
                        MaMonHoc: subjectId,
                        MaHocKy: semester
                    })
                });
                const bdm = await bdmRes.json();
                maBangDiem = bdm.mabangdiem;

                // C·∫≠p nh·∫≠t header b·∫£ng
                const thead = document.getElementById('gradeTableHead');
                thead.innerHTML = `
                    <th>M√£ HS</th>
                    <th>H·ªç t√™n</th>
                    ${examTypes.map(et => `<th>${et.tenlhkt} (x${et.heso})</th>`).join('')}
                    <th>ƒêi·ªÉm TB M√¥n</th>
                `;

                // L·∫•y h·ªçc sinh v√† ƒëi·ªÉm
                const gradesRes = await fetch(`/api/grades/class/${classId}/subject/${subjectId}?hocky=${semester}`);
                const grades = await gradesRes.json();
                
                allStudents = grades; // L∆∞u l·∫°i ƒë·ªÉ t√¨m ki·∫øm
                renderGradeTable(grades);
            } catch (error) {
                console.error('L·ªói:', error);
                document.getElementById('gradeTableBody').innerHTML = 
                    '<tr><td colspan="6" style="text-align:center;color:red;">L·ªói t·∫£i d·ªØ li·ªáu</td></tr>';
            }
        }

        function renderGradeTable(students) {
            const tbody = document.getElementById('gradeTableBody');
            
            if (students.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Kh√¥ng c√≥ h·ªçc sinh trong l·ªõp</td></tr>';
                return;
            }

            tbody.innerHTML = students.map(hs => {
                const gradeInputs = examTypes.map(et => {
                    const diem = hs.Diem && hs.Diem[et.tenlhkt] ? hs.Diem[et.tenlhkt][0] : '';
                    return `<td>
                        <input type="number" min="0" max="10" step="0.1" 
                               data-student="${hs.MaHocSinh}" 
                               data-examtype="${et.malhkt}"
                               data-heso="${et.heso}"
                               value="${diem}"
                               onchange="validateAndCalculate(this)"
                               oninput="validateGradeInput(this)">
                    </td>`;
                }).join('');

                // T√≠nh ƒëi·ªÉm TB
                let avg = '‚Äì';
                if (hs.Diem && Object.keys(hs.Diem).length > 0) {
                    let totalWeight = 0;
                    let totalScore = 0;
                    examTypes.forEach(et => {
                        if (hs.Diem[et.tenlhkt] && hs.Diem[et.tenlhkt].length > 0) {
                            totalScore += hs.Diem[et.tenlhkt][0] * et.heso;
                            totalWeight += et.heso;
                        }
                    });
                    if (totalWeight > 0) {
                        avg = (totalScore / totalWeight).toFixed(1);
                    }
                }

                return `
                    <tr data-student="${hs.MaHocSinh}">
                        <td>${hs.MaHocSinh}</td>
                        <td>${hs.HoTen}</td>
                        ${gradeInputs}
                        <td class="grade-avg">${avg}</td>
                    </tr>
                `;
            }).join('');
        }

        // ========== VALIDATION ƒêI·ªÇM ==========
        function validateGradeInput(input) {
            let value = parseFloat(input.value);
            
            // Kh√¥ng cho nh·∫≠p s·ªë √¢m
            if (value < 0) {
                input.value = 0;
                input.classList.add('input-error');
                return false;
            }
            
            // Kh√¥ng cho nh·∫≠p qu√° 10
            if (value > 10) {
                input.value = 10;
                input.classList.add('input-error');
                return false;
            }
            
            input.classList.remove('input-error');
            return true;
        }

        function validateAndCalculate(input) {
            if (validateGradeInput(input)) {
                calculateAvg(input);
            }
        }

        function calculateAvg(input) {
            const row = input.closest('tr');
            const inputs = row.querySelectorAll('input[type="number"]');
            let totalWeight = 0;
            let totalScore = 0;

            inputs.forEach(inp => {
                const val = parseFloat(inp.value);
                const heso = parseInt(inp.dataset.heso) || 1;
                if (!isNaN(val)) {
                    totalScore += val * heso;
                    totalWeight += heso;
                }
            });

            const avgCell = row.querySelector('.grade-avg');
            if (totalWeight > 0) {
                avgCell.textContent = (totalScore / totalWeight).toFixed(1);
            } else {
                avgCell.textContent = '‚Äì';
            }
        }

        // ========== L∆ØU ƒêI·ªÇM ==========
        document.getElementById('btnSaveGrades').addEventListener('click', async () => {
            const inputs = document.querySelectorAll('#gradeTableBody input[type="number"]');
            const updates = [];

            inputs.forEach(input => {
                const value = parseFloat(input.value);
                if (!isNaN(value)) {
                    updates.push({
                        MaBangDiem: maBangDiem,
                        MaHocSinh: input.dataset.student,
                        MaLHKT: input.dataset.examtype,
                        Diem: value
                    });
                }
            });

            try {
                for (const update of updates) {
                    await fetch('/api/grades/update', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(update)
                    });
                }
                toastSuccess('ƒê√£ l∆∞u ƒëi·ªÉm th√†nh c√¥ng!');
            } catch (error) {
                console.error('L·ªói:', error);
                toastError('L·ªói khi l∆∞u ƒëi·ªÉm!');
            }
        });

        // ========== KH·ªûI T·∫†O ==========
        document.addEventListener('DOMContentLoaded', loadGradeData);
    </script>

</body>
</html>
